var xr=Object.freeze,we=Object.defineProperty,Cn=Object.defineProperties;var An=Object.getOwnPropertyDescriptors;var wr=Object.getOwnPropertySymbols;var Pn=Object.prototype.hasOwnProperty,Fn=Object.prototype.propertyIsEnumerable;var Tr=(r,t,e)=>t in r?we(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,B=(r,t)=>{for(var e in t||(t={}))Pn.call(t,e)&&Tr(r,e,t[e]);if(wr)for(var e of wr(t))Fn.call(t,e)&&Tr(r,e,t[e]);return r},j=(r,t)=>Cn(r,An(t));var Mn=(r,t)=>{for(var e in t)we(r,e,{get:t[e],enumerable:!0})};var Nt=(r,t)=>xr(we(r,"raw",{value:xr(t||r.slice())}));import{App as ua}from"@tinyhttp/app";import pa from"compression";import Z,{Dirent as Ta}from"fs";var kr=!0;function vr(r){kr=r}var P=new Proxy(console,{get(r,t,e){return kr?r[t]:()=>{}}});import _n from"path";function Wt(r){return new Promise(t=>{Z.stat(r,(e,i)=>{t(Boolean(i))})})}function Cr(r,t,e,i={}){return new Promise(n=>{Z.stat(r,(o,s)=>{o&&!e&&P.error(o),n(t&&s?s[t]:s||i)})})}async function Bn(r,t=!0){return(await Cr(r,null,!0)).isFile?.()&&t}function Ar(r){return new Promise(t=>{Z.mkdir(r,e=>{e&&P.error(e),t(!e)})})}function $n(r){return new Promise(t=>{Z.rmdir(r,e=>{e&&P.error(e),t(!e)})})}function Pr(r){return new Promise(t=>{Z.unlink(r,e=>{e&&P.error(e),t(!e)})})}async function Ln(r){return await Wt(r)?await Pr(r):!1}function In(r,t={}){return new Promise(e=>{Z.readdir(r,t,(i,n)=>{i&&P.error(i),e(n||[])})})}async function Fr(r){return await Wt(r)?!1:await Ar(r)}function Mr(r,t){return new Promise(e=>{Z.writeFile(r,t,i=>{i&&P.error(i),e(!i)})})}async function Dn(r,t){try{return await Mr(r,JSON.stringify(t))}catch(e){P.error(e)}return!1}function _r(r,t="utf8"){return new Promise(e=>{Z.readFile(r,t,(i,n)=>{i&&P.error(i),e(n||"")})})}async function Rn(r,t){try{return JSON.parse(await _r(r,t))}catch(e){P.error(e)}return{}}async function En(r,t=""){if(r=_n.dirname(r),!await Wt(t+r)){let e=r.split(/\\|\//),i="";for(let n of e)i.length&&(i+="/"),i+=n,await Fr(t+i)}}var m=j(B({},Z.promises),{exists:Wt,existsFile:Bn,stat:Cr,mkdir:Ar,mkdirIfNotExists:Fr,writeFile:Mr,writeJsonFile:Dn,readFile:_r,readJsonFile:Rn,rmdir:$n,unlink:Pr,unlinkIfExists:Ln,readdir:In,makePathReal:En});import{cwd as On}from"process";import Jt from"path";import{fileURLToPath as jn}from"url";function Nn(r){return Jt.dirname(jn(r))}var D=Jt.join(Nn(import.meta.url),"/SystemData"),Te="WebSite",St="WWW",Ut="Logs",Br="node_modules",Wn=D+`/${St}Compile/`,qn=D+`/${Ut}Compile/`,Un=D+`/${Br}Compile/`,R=On()+"/";function ke(){return Jt.join(R,Te,"/")}var qt=ke();function yt(r){return ke()+r+"/"}var y={Static:[yt(St),Wn,St],Logs:[yt(Ut),qn,Ut],node_modules:[yt("node_modules"),Un,Br],get[St](){return y.Static}},at={page:"page",model:"mode",component:"inte"},x={pageTypes:at,pageTypesArray:[],pageCodeFile:{page:[at.page+".js",at.page+".ts"],model:[at.model+".js",at.model+".ts"],component:[at.component+".js",at.component+".ts"]},pageCodeFileArray:[],partExtensions:["serv","api"],ReqFileTypes:{js:"serv.js",ts:"serv.ts","api-ts":"api.js","api-js":"api.ts"},ReqFileTypesArray:[],get WebSiteFolder(){return Te},get fullWebSitePath(){return qt},set WebSiteFolder(r){Te=r,qt=ke(),y.Static[0]=yt(St),y.Logs[0]=yt(Ut)},get tsConfig(){return qt+"tsconfig.json"},async tsConfigFile(){if(await m.existsFile(this.tsConfig))return await m.readFile(this.tsConfig)},relative(r){return Jt.relative(qt,r)}};x.pageTypesArray=Object.values(x.pageTypes);x.pageCodeFileArray=Object.values(x.pageCodeFile).flat();x.ReqFileTypesArray=Object.values(x.ReqFileTypes);async function bt(r){let t=await m.readdir(r,{withFileTypes:!0});for(let e of t){let i=e.name;if(e.isDirectory()){let n=r+i+"/";await bt(n),await m.rmdir(n)}else await m.unlink(r+i)}}import Jr from"path";var d=class{constructor(t,e){this.DataArray=[];this.InfoText=null;this.OnLine=1;this.OnChar=1;typeof t=="string"?this.InfoText=t:t&&this.setDefault(t),e&&this.AddFileText(e,this.DefaultInfoText.info)}static get emptyInfo(){return{info:"",line:0,char:0}}setDefault(t=this.DefaultInfoText){this.InfoText=t.info,this.OnLine=t.line,this.OnChar=t.char}getDataArray(){return this.DataArray}get DefaultInfoText(){return!this.DataArray.find(t=>t.info)&&this.InfoText!=null?{info:this.InfoText,line:this.OnLine,char:this.OnChar}:this.DataArray[this.DataArray.length-1]??d.emptyInfo}get StartInfo(){return this.DataArray[0]??this.DefaultInfoText}get OneString(){let t="";for(let e of this.DataArray)t+=e.text;return t}get eq(){return this.OneString}get lineInfo(){let t=this.DefaultInfoText,e=t.info.split("<line>");return e.push(x.fullWebSitePath+e.pop()),`${e.join("<line>")}:${t.line}:${t.char}`}get length(){return this.DataArray.length}Clone(){let t=new d(this.StartInfo);for(let e of this.DataArray)t.AddTextAfter(e.text,e.info,e.line,e.char);return t}AddClone(t){this.DataArray.push(...t.DataArray),this.setDefault({info:t.InfoText,line:t.OnLine,char:t.OnChar})}static concat(...t){let e=new d;for(let i of t)i instanceof d?e.AddClone(i):e.AddTextAfter(String(i));return e}ClonePlus(...t){return d.concat(this.Clone(),...t)}Plus(...t){let e=this.DefaultInfoText;for(let i of t)i instanceof d?(e=i.DefaultInfoText,this.AddClone(i)):this.AddTextAfter(String(i),e.info,e.line,e.char);return this}Plus$(t,...e){let i=this.DefaultInfoText;for(let n in e){let o=t[n],s=e[n];this.AddTextAfter(o,i?.info,i?.line,i?.char),s instanceof d?(this.AddClone(s),i=s.DefaultInfoText):s!=null&&this.AddTextAfter(String(s),i?.info,i?.line,i?.char)}return this.AddTextAfter(t[t.length-1],i?.info,i?.line,i?.char),this}AddTextAction(t,e,i=this.DefaultInfoText.info,n=0,o=1){let s=[];for(let a of[...t])s.push({text:a,info:i,line:n,char:o}),o++,a==`
`&&(n++,o=1);this.DataArray[e](...s)}AddTextAfter(t,e,i,n){return this.AddTextAction(t,"push",e,i,n),this}AddTextAfterNoTrack(t){for(let e of t)this.DataArray.push({text:e,info:"",line:0,char:0});return this}AddTextBefore(t,e,i,n){return this.AddTextAction(t,"unshift",e,i,n),this}AddTextBeforeNoTrack(t){let e=[];for(let i of t)e.push({text:i,info:"",line:0,char:0});return this.DataArray.unshift(...e),this}AddFileText(t,e=this.DefaultInfoText.info){let i=1,n=1;for(let o of[...t])this.DataArray.push({text:o,info:e,line:i,char:n}),n++,o==`
`&&(i++,n=1)}CutString(t=0,e=this.length){let i=new d(this.StartInfo);return i.DataArray.push(...this.DataArray.slice(t,e)),i}substring(t,e){return isNaN(e)?e=void 0:e=Math.abs(e),isNaN(t)?t=void 0:t=Math.abs(t),this.CutString(t,e)}substr(t,e){return t<0&&(t=this.length-t),this.substring(t,e!=null?e+t:e)}slice(t,e){return t<0&&(t=this.length-t),e<0&&(t=this.length-t),this.substring(t,e)}charAt(t){return t||(t=0),this.CutString(t,t+1)}at(t){return this.charAt(t)}charCodeAt(t){return this.charAt(t).OneString.charCodeAt(0)}codePointAt(t){return this.charAt(t).OneString.codePointAt(0)}*[Symbol.iterator](){for(let t of this.DataArray){let e=new d;e.DataArray.push(t),yield e}}getLine(t,e=!0){return this.split(`
`)[t-+e]}charLength(t){if(t<=0)return t;let e=0;for(let i of this.DataArray)if(e++,t-=i.text.length,t<=0)return e}indexOf(t){return this.charLength(this.OneString.indexOf(t))}lastIndexOf(t){return this.charLength(this.OneString.lastIndexOf(t))}unicodeMe(t){let e="";for(let i of t)e+="\\u"+("000"+i.charCodeAt(0).toString(16)).slice(-4);return e}get unicode(){let t=new d;for(let e of this.DataArray)t.AddTextAfter(this.unicodeMe(e.text),e.info,e.line,e.char);return t}search(t){return this.charLength(this.OneString.search(t))}startsWith(t,e){return this.OneString.startsWith(t,e)}endsWith(t,e){return this.OneString.endsWith(t,e)}includes(t,e){return this.OneString.includes(t,e)}trimStart(){let t=this.Clone();t.setDefault();for(let e=0;e<t.DataArray.length;e++){let i=t.DataArray[e];if(i.text.trim()=="")t.DataArray.shift(),e--;else{i.text=i.text.trimStart();break}}return t}trimLeft(){return this.trimStart()}trimEnd(){let t=this.Clone();t.setDefault();for(let e=t.DataArray.length-1;e>=0;e--){let i=t.DataArray[e];if(i.text.trim()=="")t.DataArray.pop();else{i.text=i.text.trimEnd();break}}return t}trimRight(){return this.trimEnd()}trim(){return this.trimStart().trimEnd()}SpaceOne(t){let e=this.at(0),i=this.at(this.length-1),n=this.Clone().trim();return e.eq&&n.AddTextBefore(t||e.eq,e.DefaultInfoText.info,e.DefaultInfoText.line,e.DefaultInfoText.char),i.eq&&n.AddTextAfter(t||i.eq,i.DefaultInfoText.info,i.DefaultInfoText.line,i.DefaultInfoText.char),n}ActionString(t){let e=this.Clone();for(let i of e.DataArray)i.text=t(i.text);return e}toLocaleLowerCase(t){return this.ActionString(e=>e.toLocaleLowerCase(t))}toLocaleUpperCase(t){return this.ActionString(e=>e.toLocaleUpperCase(t))}toUpperCase(){return this.ActionString(t=>t.toUpperCase())}toLowerCase(){return this.ActionString(t=>t.toLowerCase())}normalize(){return this.ActionString(t=>t.normalize())}StringIndexer(t,e){t instanceof RegExp&&(t=new RegExp(t,t.flags.replace("g","")));let i=[],n=this.OneString,o=n.match(t),s=0,a=0;for(;(e==null||a<e)&&o?.[0]?.length;){let l=[...o[0]].length,c=this.charLength(o.index);i.push({index:c+s,length:l}),n=n.slice(o.index+o[0].length),s+=c+l,o=n.match(t),a++}return i}RegexInString(t){return t instanceof RegExp?t:new d("n",t).unicode.eq}split(t,e){let i=this.StringIndexer(this.RegexInString(t),e),n=[],o=0;for(let s of i)n.push(this.CutString(o,s.index)),o=s.index+s.length;return n.push(this.CutString(o)),n}repeat(t){let e=this.Clone();for(let i=0;i<t;i++)e.AddClone(this.Clone());return e}replaceWithTimes(t,e,i){let n=this.StringIndexer(t,i),o=new d,s=0;for(let a of n)o=o.ClonePlus(this.CutString(s,a.index),e),s=a.index+a.length;return o.AddClone(this.CutString(s)),o}replace(t,e){return this.replaceWithTimes(this.RegexInString(t),e,t instanceof RegExp?void 0:1)}replacer(t,e){let i=this.Clone(),n;function o(){n=i.match(t)}o();let s=new d(i.StartInfo);for(;n;)s.Plus(i.substring(0,n.index)),s.Plus(e(n)),i=i.substring(n.index+n[0].length),o();return s.Plus(i),s}replaceAll(t,e){return this.replaceWithTimes(this.RegexInString(t),e)}matchAll(t){let e=this.StringIndexer(t),i=[];for(let n of e)i.push(this.substr(n.index,n.length));return i}match(t){if(t instanceof RegExp&&t.global)return this.matchAll(t);let e=this.OneString.match(t);if(e==null)return null;let i=[];i[0]=this.substr(e.index,e.shift().length),i.index=e.index,i.input=this.Clone();let n=i[0].Clone();for(let o in e){if(isNaN(Number(o)))break;let s=e[o];if(s==null){i.push(s);continue}let a=n.indexOf(s);i.push(n.substr(a,s.length)),n=n.substring(a+s.length)}return i}toString(){return this.OneString}extractInfo(t="<line>"){return this.DefaultInfoText.info.split(t).pop().trim()}debugLine({message:t,loc:e,line:i,col:n,sassStack:o}){if(o){let c=o.match(/[0-9]+:[0-9]+/)[0].split(":").map(u=>Number(u));i=c[0],n=c[1]}let s=this.getLine(i??e?.line??1),a=n??e?.column??0;s.startsWith("//")&&(s=this.getLine((i??e?.line)-1),a=0);let l=s.DefaultInfoText;return`${t}, on file -> ${x.fullWebSitePath}${l.info.split("<line>").shift()}:${l.line}:${a}`}};import{promises as Vn}from"fs";import{fileURLToPath as zn}from"url";var Gn="/../static/wasm/component/",Hn=new WebAssembly.Module(await Vn.readFile(zn(import.meta.url+Gn+"build.wasm"))),Qn=new WebAssembly.Instance(Hn,{}),N=Qn.exports,lt=0,Vt=null;function ve(){return(Vt===null||Vt.buffer!==N.memory.buffer)&&(Vt=new Uint8Array(N.memory.buffer)),Vt}var Xn=typeof TextEncoder>"u"?(0,module.require)("util").TextEncoder:TextEncoder,zt=new Xn("utf-8"),Zn=typeof zt.encodeInto=="function"?function(r,t){return zt.encodeInto(r,t)}:function(r,t){let e=zt.encode(r);return t.set(e),{read:r.length,written:e.length}};function xt(r,t,e){if(e===void 0){let a=zt.encode(r),l=t(a.length);return ve().subarray(l,l+a.length).set(a),lt=a.length,l}let i=r.length,n=t(i),o=ve(),s=0;for(;s<i;s++){let a=r.charCodeAt(s);if(a>127)break;o[n+s]=a}if(s!==i){s!==0&&(r=r.slice(s)),n=e(n,i,i=s+r.length*3);let a=ve().subarray(n+s,n+i);s+=Zn(r,a).written}return lt=s,n}var Kn=typeof TextDecoder>"u"?(0,module.require)("util").TextDecoder:TextDecoder,Yn=new Kn("utf-8",{ignoreBOM:!0,fatal:!0});Yn.decode();function $r(r,t){var e=xt(r,N.__wbindgen_malloc,N.__wbindgen_realloc),i=lt,n=xt(t,N.__wbindgen_malloc,N.__wbindgen_realloc),o=lt,s=N.find_end_block(e,i,n,o);return s}function Lr(r,t){var e=xt(r,N.__wbindgen_malloc,N.__wbindgen_realloc),i=lt,n=xt(t,N.__wbindgen_malloc,N.__wbindgen_realloc),o=lt,s=N.find_end_of_def(e,i,n,o);return s}function Ir(r,t){var e=xt(r,N.__wbindgen_malloc,N.__wbindgen_realloc),i=lt,n=N.find_end_of_q(e,i,t.codePointAt(0));return n>>>0}var Dr=["textarea","script","style"],Rr=[["%","%"],["#{debug}","{debug}#"]];import es from"workerpool";import{cpus as rs}from"os";var is=Math.max(1,Math.floor(rs().length/2)),wt=es.pool(D+"/../static/wasm/component/workerInsertComponent.js",{maxWorkers:is}),z=class{static findEntOfQ(t,e){return Ir(t,e)}static findEndOfDef(t,e){return Array.isArray(e)||(e=[e]),Lr(t,JSON.stringify(e))}static FindEndOfBlock(t,e,i){return $r(t,e+i)}},Ce=class{constructor(t){this.printNew=t;this.SimpleSkip=Dr;this.SkipSpecialTag=Rr}printErrors(t,e){if(!!this.printNew)for(let i of JSON.parse(e).reverse())this.printNew({text:`
Warning, you didn't write right this tag: "${i.type_name}", used in: ${t.at(Number(i.index)).lineInfo}
(the system will auto close it)`,errorName:"close-tag"})}async FindCloseChar(t,e){let[i,n]=await wt.exec("FindCloseChar",[t.eq,e]);return this.printErrors(t,n),i}async FindCloseCharHTML(t,e){let[i,n]=await wt.exec("FindCloseCharHTML",[t.eq,e]);return this.printErrors(t,n),i}};async function Er(r){return JSON.parse(await wt.exec("RazorToEJS",[r]))}async function Or(r,t){return JSON.parse(await wt.exec("RazorToEJSMini",[r,t]))}async function jr(r,t,e){return JSON.parse(await wt.exec("EJSParser",[r,t,e]))}import ns from"workerpool";import{cpus as ss}from"os";var os=Math.max(1,Math.floor(ss().length/2)),as=ns.pool(D+"/../static/wasm/reader/worker.js",{maxWorkers:os});async function Gt(r){return JSON.parse(await as.exec("build_stream",[r]))}var Nr=class{ReplaceAll(t,e,i){let n="";for(let o of t.split(e))n+=i+o;return n.substring(i.length)}},Wr=class extends Nr{constructor(t){super();this.ParseArray=t}BuildCode(){let t="";for(let e of this.ParseArray)t+=e.text;return this.ReplaceAll(t,"<|-|>","<||>")}},Tt=class extends Wr{constructor(t){super(t);this.DataCode={text:"",inputs:[]},this.CreateDataCode()}get CodeBuildText(){return this.DataCode.text}set CodeBuildText(t){this.DataCode.text=t}get AllInputs(){return this.DataCode.inputs}CreateDataCode(){for(let t of this.ParseArray)t.is_skip?(this.DataCode.text+=`<|${this.DataCode.inputs.length}|${t.type_name??""}|>`,this.DataCode.inputs.push(t.text)):this.DataCode.text+=t.text}BuildCode(){let t=this.DataCode.text.replace(/<\|([0-9]+)\|[\w]*\|>/gi,(e,i)=>this.DataCode.inputs[i]);return super.ReplaceAll(t,"<|-|>","<||>")}};var M=class{constructor(t,e,i="<%",n="%>",o="script"){this.start=i,this.text=t,this.end=n,this.type=o,this.path=e}ReplaceValues(t,e){this.text=this.text.replaceAll(t,e)}findEndOfDefGlobal(t){let e=t.eq,i=z.findEndOfDef(e,[";",`
`,this.end]);return i!=-1?i+1:e.length}ScriptWithInfo(t){let e=new d(t.StartInfo),i=t.split(`
`),n=i.length;e.Plus(`
`);let o=1;for(let s of i)e.Plus(new d(null,`//!${s.lineInfo}
`),s),o!=n&&(e.Plus(`
`),o++);return e}async findScripts(){let t=await jr(this.text.eq,this.start,this.end);this.values=[];for(let e of t){let i=this.text.substring(e.start,e.end),n=e.name;switch(e.name){case"print":i=new d().Plus$`write(${i});`,n="script";break;case"escape":i=new d().Plus$`writeSafe(${i});`,n="script";break;case"debug":i=new d().Plus$`\nrun_script_name = \`${M.fixText(i)}\`;`,n="no-track";break}this.values.push({text:i,type:n})}}static fixText(t){return t.replace(/\\/gi,"\\\\").replace(/`/gi,"\\`").replace(/\$/gi,"\\u0024")}static fixTextSimpleQuotes(t){return t.replace(/\\/gi,"\\\\").replace(/"/gi,'\\"')}ReBuildText(){let t=new d(this.values[0]?.text?.StartInfo);for(let e of this.values)e.type=="text"?e.text.eq!=""&&t.Plus(e.text):e.type=="no-track"?t.Plus(this.start,"!",e.text,this.end):t.Plus(this.start,e.text,this.end);return t}BuildAll(t){let e=new d(this.values[0]?.text?.StartInfo);if(!this.values.length)return e;for(let i of this.values)i.type=="text"?i.text.eq!=""&&e.Plus$`\nout_run_script.text+=\`${M.fixText(i.text)}\`;`:t&&i.type=="script"?e.Plus(new d(null,`
run_script_code=\`${M.fixText(i.text)}\`;`),this.ScriptWithInfo(i.text)):e.Plus(i.text);return e}static printError(t){return`<p style="color:red;text-align:left;font-size:16px;">${t}</p>`}static async RunAndExport(t,e,i){let n=new M(t,e);return await n.findScripts(),n.BuildAll(i)}static split2FromEnd(t,e,i=1){for(let n=t.length-1;n>=0;n--)if(t[n]==e&&i--,i==0)return[t.substring(0,n),t.substring(n+1)];return[t]}static RestoreTrack(t,e){let i=new d(e),n=t.split(`
//!`);i.Plus(n.shift());for(let o of n){let s=o.split(`
`,1).pop(),a=o.substring(s.length),[l,c]=M.split2FromEnd(s,":",2),[u,p]=c.split(":");i.Plus(new d(null,`
//!`+s)),i.AddTextAfter(a,l,Number(u)-1,Number(p))}return i}},kt=class{constructor(t=""){this.addText=t;this.savedBuildData=[];this.replacer=RegExp(`${t}\\/\\*!system--<\\|ejs\\|([0-9])\\|>\\*\\/|system--<\\|ejs\\|([0-9])\\|>`)}async load(t,e){this.buildCode=new Tt(await Gt(await this.ExtractAndSaveCode(t))),this.path=e}async ExtractAndSaveCode(t){let e=new M(t,this.path);await e.findScripts();let i="",n=0;for(let o of e.values)o.type=="text"?i+=o.text:(this.savedBuildData.push({type:o.type,text:o.text}),i+=`system--<|ejs|${n++}|>`);return i}ParseOutsideOfComment(t){return t.replacer(/system--<\|ejs\|([0-9])\|>/,e=>{let i=e[1];return new d(i.StartInfo).Plus$`${this.addText}/*!system--<|ejs|${i}|>*/`})}async StartBuild(){let t=new M(new d(null,this.buildCode.CodeBuildText),this.path,"/*","*/");await t.findScripts();for(let e of t.values)e.type=="text"&&(e.text=this.ParseOutsideOfComment(e.text));return this.buildCode.CodeBuildText=t.ReBuildText().eq,this.buildCode.BuildCode()}RestoreAsCode(t){return new d(t.text.StartInfo).Plus$`<%${t.type=="no-track"?"!":""}${t.text}%>`}RestoreCode(t){return t.replacer(this.replacer,e=>{let i=Number(e[1]??e[2]);return this.RestoreAsCode(this.savedBuildData[i])})}};function W(r,t){let e=t.indexOf(r);return e==-1?[t]:[t.substring(0,e),t.substring(e+r.length)]}function qr(r,t){return t.substring(0,t.lastIndexOf(r))}function Ur(r,t){for(;t.startsWith(r);)t=t.substring(r.length);for(;t.endsWith(r);)t=t.substring(0,t.length-r.length);return t}async function ls(r,t){let e=new M(r,t,"<#{debug}","{debug}#>","debug info");await e.findScripts();let i=new d(r.DefaultInfoText);for(let n of e.values)n.type=="text"?i.Plus(n.text):i.Plus$`<%{?debug_file?}${n.text}%>`;return i}async function zr(r,t){let e=new M(r,t,"<#{debug}","{debug}#>","debug info");await e.findScripts();let i=new d(r.DefaultInfoText);for(let n of e.values)n.type=="text"?i.Plus(n.text):i.Plus$`run_script_name=\`${M.fixText(n.text)}\`;`;return i}async function Gr(r,t){let e=new M(r,t);await e.findScripts();for(let i of e.values)i.type=="text"?i.text=await ls(i.text,t):i.text=await zr(i.text,t);return e.start="<%",e.end="%>",e.ReBuildText()}async function Hr(r,t,e,i){r=await zr(r,t),r=await M.RunAndExport(r,t,e);let n=await i(r),o=M.RestoreTrack(n,r.DefaultInfoText);return o.AddTextBeforeNoTrack("<%!{"),o.AddTextAfterNoTrack("}%>"),o}async function ft(r,t,e,i={}){return i.value||(i.value=await m.readFile(t,"utf8")),{allData:new d(`${r}<line>${e}`,i.value),stringInfo:`<%run_script_name=\`${M.fixText(r)}\`;%>`}}function Vr(r,t,e,i,n=0){if(i&&!t.endsWith("."+i)&&(t=`${t}.${i}`),t[0]=="^"){let[o,s]=W("/",t.substring(1));return(n==0?R:"")+`node_modules/${o}/${e}/${s}`}return t[0]=="."?(t[1]=="/"&&(t=t.substring(2)),t=`${Jr.dirname(r)}/${t}`):t[0]=="/"?t=`${y.Static[n]}${t}`:t=`${n==0?R+x.WebSiteFolder+"/":""}${e}/${t}`,Jr.normalize(t)}function mt(r,t,e,i,n){return{SmallPath:Vr(t,e,i,n,2),FullPath:Vr(r,e,i,n)}}import{minify as ps}from"terser";var Ht={PreventErrors:[]},Ae=[],Pe=()=>Ae.length=0;function C({id:r,text:t,type:e="warn",errorName:i}){!Ae.includes(r??t)&&!Ht.PreventErrors.includes(i)&&(P[e](t.replace(/<line>/gi," -> "),`

Error code: ${i}

`),Ae.push(r??t))}var Qr=["number","num","integer","int"],Xr=["boolean","bool"],cs=["email","string","text",...Qr,...Xr],us=/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/,Qt={"string-length-range":[/^[0-9]+-[0-9]+$/,r=>r.split("-").map(t=>Number(t)),([r,t],e)=>e.length>=r&&e.length<=t,"string"],"number-range":[/^[0-9]+..[0-9]+$/,r=>r.split("..").map(t=>Number(t)),([r,t],e)=>e>=r&&e<=t,"number"],"multiple-choice-string":[/^string|text+[ ]*=>[ ]*(\|?[^|]+)+$/,r=>r.split("=>").pop().split("|").map(t=>`"${t.trim().replace(/"/gi,'\\"')}"`),(r,t)=>r.includes(t),"string"],"multiple-choice-number":[/^number|num|integer|int+[ ]*=>[ ]*(\|?[^|]+)+$/,r=>r.split("=>").pop().split("|").map(t=>parseFloat(t)),(r,t)=>r.includes(t),"number"]},Fe=[...Qr];for(let r in Qt){let t=Qt[r][3];Fe.includes(t)&&Fe.push(r)}function Xt(r){if(r=r.toLowerCase().trim(),cs.includes(r))return`["${r}"]`;for(let[t,[e,i]]of Object.entries(Qt))if(e.test(r))return`["${t}", ${i(r)}]`;return`[${r}]`}async function Zt(r,t){for(let e in t){let[i,...n]=t[e],o=r[e],s=!1,a=!1;switch(i){case"number":case"num":s=typeof o!="number";break;case"boolean":case"bool":s=typeof o!="boolean";break;case"integer":case"int":s=!Number.isInteger(o);break;case"string":case"text":s=typeof o!="string";break;case"email":s=!us.test(o);break;default:{let l=o!=null&&Qt[i];if(l){s=!l[2](n,o);break}a=!0,i instanceof RegExp?s=i.test(o):typeof i=="function"&&(s=!await i(o))}}if(s){let l=`failed at ${e} filed - ${a?s:"expected "+i}`;return n.length&&(l+=`, arguments: ${JSON.stringify(n)}`),l+=`, input: ${JSON.stringify(o)}`,[l,i,n,o]}}return!0}function Zr(r,t){let e=[];for(let i in t){let[n]=t[i],o=r[i];Fe.includes(n)?e.push(parseFloat(o)):Xr.includes(n)?e.push(o==="true"):e.push(o)}return e}function $(r,t,e=null){let i=r.have(t),n=r.remove(t);return i&&n!="false"?n||i:n==="false"?!1:i?n:e}function fs(r,t){return r=r.replace('"use strict";Object.defineProperty(exports, "__esModule", {value: true});',t),r}var ms="/serv/temp.js";async function gs(r,t,e,i,n,o,s){let a=await M.RunAndExport(n,o,s);return`function ${t}({${e}}, selector = "${i}", out_run_script = {text: ''}){
        const {write, writeSafe, setResponse, sendToSelector} = new buildTemplate(out_run_script);
        ${fs(await r(a),`var exports = ${t}.exports;`)}
        return sendToSelector(selector, out_run_script.text);
    }
${t}.exports = {};`}async function Me(r,t,e,i,n,o,s,a,l,c,u){o=await l.StartReplace(o,t,r,e,a,s,g=>g.eq,u),u.script(ms,{async:null});let p=await gs(c,n.getValue("name"),n.getValue("params"),n.getValue("selector"),o,t,a&&!l.SomePlugins("SafeDebug"));if(l.SomePlugins("MinJS")||l.SomePlugins("MinAll"))try{p=(await ps(p,{module:!1,format:{comments:"all"}})).code}catch(g){C({errorName:"minify",text:o.debugLine(g)})}return u.addScriptStyle("script",$(n,"page")?e:i.extractInfo()).addText(p),{compiledString:new d}}import{transform as ds}from"sucrase";import{minify as hs}from"terser";var wl;async function _e(r,t,e,i,n,o,s,a,l,c){let u="",p=s,f=new kt("serv");await f.load(s,e);let g=await f.StartBuild(),S=B({transforms:[]},c.GetPlugin("transformOptions"));try{switch(r){case"ts":S.transforms.push("typescript");break;case"jsx":S.transforms.push("jsx"),Object.assign(S,c.GetPlugin("JSXOptions")??{});break;case"tsx":S.transforms.push("typescript"),S.transforms.push("jsx"),Object.assign(S,c.GetPlugin("TSXOptions")??{});break}if(u=ds(g,S).code,c.SomePlugins("Min"+r.toUpperCase())||c.SomePlugins("MinAll"))try{u=(await hs(u,{module:!1,format:{comments:"all"}})).code}catch(b){C({errorName:"minify",text:s.debugLine(b)})}p=f.RestoreCode(new d(s.StartInfo,u))}catch(b){C({errorName:"compilation-error",text:s.debugLine(b)})}return{compiledString:new d(n.DefaultInfoText).Plus$(wl||(wl=Nt(["<script",">","<\/script>"])),c.ReBuildTagData(s.DefaultInfoText,o),p)}}import{transform as Ss}from"sucrase";import{minify as ys}from"terser";async function Be(r,t,e,i,n,o,s){let a=i.eq,l=a.trim(),c=t.getValue("type")=="module",u=c?"scriptModule":"script";if(s.cache[u].includes(l))return{compiledString:new d};s.cache[u].push(l);let p="",f=B({transforms:[]},o.GetPlugin("transformOptions"));try{switch(r){case"ts":f.transforms.push("typescript");break;case"jsx":f.transforms.push("jsx"),Object.assign(f,o.GetPlugin("JSXOptions")??{});break;case"tsx":f.transforms.push("typescript"),f.transforms.push("jsx"),Object.assign(f,o.GetPlugin("TSXOptions")??{});break}if(p=Ss(i.eq,f).code,o.SomePlugins("Min"+r.toUpperCase())||o.SomePlugins("MinAll"))try{p=(await ys(p,{module:!1,format:{comments:"all"}})).code}catch(S){C({errorName:"minify",text:i.debugLine(S)})}}catch(S){C({errorName:"compilation-error",text:i.debugLine(S)})}return s.addScriptStyle(c?"module":"script",$(t,"page")?e:i.extractInfo()).addStringTracker(i,{text:p}),{compiledString:new d}}var Ll;async function $e(r,t,e,i,n,o,s,a,l,c,u){if(n.have("src"))return{compiledString:new d(i.DefaultInfoText).Plus$(Ll||(Ll=Nt(["<script",">","<\/script>"])),l.ReBuildTagData(o.DefaultInfoText,n),o)};let p=n.remove("lang")||"js";return n.have("server")?(n.remove("server"),_e(p,r,t,e,i,n,o,s,a,l)):Be(p,n,e,o,t,l,u)}import{fileURLToPath as bs,pathToFileURL as Le}from"url";import Kr from"sass";function vt(r){return{findFileUrl(t){return t[0]=="/"||t[0]=="~"?new URL(t.substring(1),Le(t[0]=="/"?y.Static[0]:y.node_modules[0])):new URL(t,Le(r))}}}function Yr(r,t){return["scss","sass"].includes(r)?t("MinAll","MinSass"):t("MinCss","MinAll")}function Kt(r,t){return Yr(r,t)?"compressed":"expanded"}function Ct(r){return r=="sass"?"indented":r}function Ie(r,t){if(!!r)for(let e in r.sources)r.sources[e].startsWith("data:")&&(r.sources[e]=t)}async function Yt(r,t,e,i,n,o=t.eq){let s=x.fullWebSitePath+t.extractInfo(),a=Le(s),l=Yr(r,i.SomePlugins),c;try{c=await Kr.compileStringAsync(o,{sourceMap:n,syntax:Ct(r),style:l?"compressed":"expanded",importer:vt(s),logger:Kr.Logger.silent}),o=c?.css??o}catch(u){C({text:t.debugLine(u),errorName:u?.status==5?"sass-warning":"sass-error",type:u?.status==5?"warn":"error"})}if(c?.loadedUrls)for(let u of c.loadedUrls){let p=bs(u);e[x.relative(p)]=await m.stat(p,"mtimeMs")}return Ie(c.sourceMap,a.href),{result:c,outStyle:o,compressed:l}}async function De(r,t,e,i,n,o,s,a,l,c){let u=new kt;await u.load(s.trimStart(),e);let{outStyle:p,compressed:f}=await Yt(r,s,a,c,l,await u.StartBuild());f||(p=`
${p}
`);let g=u.RestoreCode(new d(s.StartInfo,p));return{compiledString:new d(n.DefaultInfoText).Plus$`<style${c.ReBuildTagData(s.DefaultInfoText,o)}>${g}</style>`}}import{SourceMapGenerator as xs,SourceMapConsumer as ws}from"source-map-js";import te from"path";import{fileURLToPath as Ts}from"url";var ee=class{constructor(t,e=!0,i=!1){this.filePath=t;this.httpSource=e;this.isCss=i;this.lineCount=0;this.map=new xs({file:t.split(/\/|\\/).pop()}),e||(this.fileDirName=te.dirname(this.filePath))}getSource(t){return t=t.split("<line>").pop().trim(),this.httpSource?(x.pageTypesArray.includes(te.extname(t).substring(1))?t+=".source":t=W("/",t).pop()+"?source=true",te.join("/",t.replace(/\\/gi,"/"))):te.relative(this.fileDirName,x.fullWebSitePath+t)}mapAsURLComment(){let t=`sourceMappingURL=data:application/json;charset=utf-8;base64,${Buffer.from(this.map.toString()).toString("base64")}`;return this.isCss?t=`/*# ${t}*/`:t="//# "+t,`\r
`+t}},G=class extends ee{constructor(t,e=!0,i=!1,n=!0){super(t,n,i);this.debug=e;this.storeString="";this.actionLoad=[]}notEmpty(){return this.actionLoad.length>0}addStringTracker(t,{text:e=t.eq}={}){this.actionLoad.push({name:"addStringTracker",data:[t,{text:e}]})}_addStringTracker(t,{text:e=t.eq}={}){if(!this.debug)return this._addText(e);let i=t.getDataArray(),n=i.length,o=!1;for(let s=0;s<n;s++){let{text:a,line:l,info:c}=i[s];if(a==`
`){this.lineCount++,o=!1;continue}!o&&l&&c&&(o=!0,this.map.addMapping({original:{line:l,column:0},generated:{line:this.lineCount,column:0},source:this.getSource(c)}))}this.storeString+=e}addText(t){this.actionLoad.push({name:"addText",data:[t]})}_addText(t){this.debug&&(this.lineCount+=t.split(`
`).length-1),this.storeString+=t}static fixURLSourceMap(t){for(let e=0;e<t.sources.length;e++)t.sources[e]=x.relative(Ts(t.sources[e]));return t}async addSourceMapWithStringTracker(t,e,i){this.actionLoad.push({name:"addSourceMapWithStringTracker",data:[t,e,i]})}async _addSourceMapWithStringTracker(t,e,i){if(!this.debug)return this._addText(i);new ws(t).eachMapping(n=>{let o=e.getLine(n.originalLine).getDataArray()[0];n.source==this.filePath?this.map.addMapping({source:this.getSource(n.source),original:{line:o.line,column:n.originalColumn},generated:{line:n.generatedLine+this.lineCount,column:n.generatedColumn}}):this.map.addMapping({source:this.getSource(n.source),original:{line:n.originalLine,column:n.originalColumn},generated:{line:n.generatedLine,column:n.generatedColumn}})}),this._addText(i)}buildAll(){for(let{name:t,data:e}of this.actionLoad)switch(t){case"addStringTracker":this._addStringTracker(...e);break;case"addText":this._addText(...e);break;case"addSourceMapWithStringTracker":this._addSourceMapWithStringTracker(...e);break}}mapAsURLComment(){return this.buildAll(),super.mapAsURLComment()}createDataWithMap(){return this.buildAll(),this.debug?this.storeString+super.mapAsURLComment():this.storeString}clone(){let t=new G(this.filePath,this.debug,this.isCss,this.httpSource);return t.actionLoad.push(...this.actionLoad),t}};async function Re(r,t,e,i,n,o,s,a,l,c){let u=o.eq.trim();if(c.cache.style.includes(u))return{compiledString:new d};c.cache.style.push(u);let{result:p,outStyle:f}=await Yt(r,o,s,l,a),g=c.addScriptStyle("style",$(n,"page")?i:o.extractInfo());return p?.sourceMap?g.addSourceMapWithStringTracker(G.fixURLSourceMap(p.sourceMap),o,f):g.addStringTracker(o,{text:f}),{compiledString:new d}}async function Ee(r,t,e,i,n,o,s,a,l,c){let u=n.remove("lang")||"css";return n.have("server")?(n.remove("server"),De(u,r,t,e,i,n,o,s,a,l)):Re(u,r,t,e,n,o,s,a,l,c)}import ks from"path";var tt=class{constructor(t,e=!0){this.store={};this.savePath=`${D}/${t}.json`,e&&this.loadFile(),this.save=this.save.bind(this),process.on("SIGINT",this.save),process.on("exit",this.save)}async loadFile(){await m.existsFile(this.savePath)&&(this.store=JSON.parse(await m.readFile(this.savePath)||"{}"))}update(t,e){this.store[t]=e}have(t,e){let i=this.store[t];return i||!e||(i=e(),this.update(t,i)),i}clear(){for(let t in this.store)this.store[t]=void 0,delete this.store[t]}save(){return m.writeJsonFile(this.savePath,this.store)}};var H=new tt("PagesInfo");async function et(r,t=H.store[r]){for(let e in t){let i=e;e=="thisPage"&&(i=r+"."+x.pageTypes.page);let n=x.fullWebSitePath+i;if(await m.stat(n,"mtimeMs",!0)!=t[e])return!0}return!t}function vs(r,t){if(r[0]=="."){r[1]=="/"?r=r.substring(2):r=r.substring(1);let i=ks.dirname(t).substring(y.Static[0].length);i&&(i+="/"),r=i+r}else r[0]=="/"&&(r=r.substring(1));let e="."+x.pageTypes.page;return r.endsWith(e)||(r+=e),r}var Oe={};async function je(r,t,e,i,n,o,s,a,l,c){let u=n.getValue("from"),p=vs(u,r),f=y.Static[0]+p,g=y.Static[2]+"/"+p;if(!(await m.stat(f,null,!0)).isFile?.())return C({text:`
Page not found: ${i.at(0).lineInfo} -> ${f}`,errorName:"page-not-found",type:"error"}),{compiledString:new d(i.DefaultInfoText,`<p style="color:red;text-align:left;font-size:16px;">Page not found: ${i.lineInfo} -> ${g}</p>`)};let S,b=Oe[p];if(!b||await et(null,b.dependence)){let{CompiledData:h,dependenceObject:w,sessionInfo:T}=await l.CompileInFile(p,y.Static,null,t,n.remove("object"));w[g]=w.thisPage,delete w.thisPage,c.extends(T),Oe[p]={CompiledData:h,dependence:w,newSession:T},Object.assign(s,w),S=h}else{let{CompiledData:h,dependence:w,newSession:T}=Oe[p];Object.assign(s,w),c.extends(T),S=h}return{compiledString:S}}async function Ne(r){let t=new d(r.StartInfo);return t.Plus$`<%{%>${r}<%}%>`,{compiledString:t,checkComponents:!0}}import{relative as $s}from"path";function At(r,t=10){return Buffer.from(r).toString("base64").substring(0,t).replace(/\+/,"_").replace(/\//,"_")}import Ls from"path";import{transform as Cs}from"sucrase";import{minify as As}from"terser";import*as gt from"svelte/compiler";import{extname as Ps}from"path";import ti from"sass";import{v4 as Fs}from"uuid";import re from"path";import{fileURLToPath as Ms}from"url";async function ei(r,t,e={},i,n=""){let o=await m.readFile(r),s=[],{code:a,dependencies:l,map:c}=await gt.preprocess(o,{async style({content:p,attributes:f,filename:g}){try{let{css:S,loadedUrls:b}=await ti.compileStringAsync(p,{syntax:Ct(f.lang),style:Kt(f.lang,Q),importer:vt(r),logger:ti.Logger.silent});return{code:S,dependencies:b.map(h=>Ms(h))}}catch(S){C({text:`${S.message}, on file -> ${r}${S.line?":"+S.line:""}`,errorName:S?.status==5?"sass-warning":"sass-error",type:S?.status==5?"warn":"error"})}return{code:""}},async script({content:p,attributes:f}){let g={};if(p=p.replace(/((import({|[ ]*\(?)|((import|export)({|[ ]+)[\W\w]+?(}|[ ]+)from))(}|[ ]*))(["|'|`])([\W\w]+?)\9([ ]*\)?)/gmi,(b,...h)=>{let w=Ps(h[9]);w==".svelte"?s.push(h[9]):w==""&&(f.lang=="ts"?h[9]+=".ts":h[9]+=".js");let T=h[0]+h[8]+(i?i(h[9]):h[9])+(w==".svelte"?n:"")+h[8]+(h[10]??"");if(f.lang!=="ts")return T;let _=Fs();return g[_]=T,T+`/*uuid-${_}*/`}),f.lang!=="ts")return{code:p,dependencies:[]};let S;try{S=Cs(p,j(B({},q("transformOptions")),{transforms:["typescript"]})).code}catch(b){return C({errorName:"compilation-error",text:`${b.message}, on file -> ${r}:${b?.loc?.line??0}:${b?.loc?.column??0}`}),{code:""}}return S=S.replace(/\/\*uuid-([\w\W]+?)\*\//gmi,(b,...h)=>{let w=g[h[0]]??"";return S.includes(w)?"":w}),{code:S,dependencies:[]}}});l.push(y.Static[0]+re.relative(y.Static[2],t));for(let p of l)e[x.relative(p)]=await m.stat(p,"mtimeMs");let u=a;if(s.length){let p=s.map(g=>`@import "${g}.css";`).join(""),{code:f}=await gt.preprocess(u,{style({content:g}){let S={code:p+g,dependencies:[]};return p="",S}});u=f,p&&(u+=`<style>${p}</style>`)}return{code:u,dependenceObject:e,map:c}}function We(r){return r[0].toUpperCase()+r.slice(1)}async function qe(r,t,e,i){let n=re.parse(r).name.replace(/^\d/,"_$&").replace(/[^a-zA-Z0-9_$]/g,""),o={filename:r,name:We(n),generate:"ssr",format:"cjs",dev:i},s=[];function a(h){s.push(qe(y.Static[0]+h,y.Static[2]+"/"+h,e,i))}let l=re.relative(y.Static[2],t),c=l+"/..",u=y.Static[1]+l,p=await ei(r,t,e,h=>{let w=re.relative(c,h);return a(w),"./"+w.replace(/\\/gi,"/")},".ssr.cjs");await Promise.all(s);let{js:f,css:g,warnings:S}=gt.compile(p.code,o);i&&S.forEach(h=>{C({errorName:h.code,type:"warn",text:h.message+`
`+h.frame})});let b=u+".ssr.cjs";return await m.writeFile(b,f.code),g.code&&(g.map.sources[0]="/"+l.split(/\/|\//).pop()+"?source=true",g.code+=`
/*# sourceMappingURL=`+g.map.toUrl()+"*/"),await m.writeFile(u+".css",g.code??""),b}async function Ue(r,t){let e=y.Static[0]+r,i=y.Static[1]+r,{code:n,dependenceObject:o,map:s}=await ei(e,y.Static[2]+"/"+r),{js:a,css:l}=gt.compile(n,{filename:e,dev:t,sourcemap:s,css:!1,hydratable:!0,sveltePath:"/serv/svelte"});if(Q("MinJS")||Q("MinAll"))try{a.code=(await As(a.code,{module:!1})).code}catch(c){C({errorName:"minify",text:`${c.message} on file -> ${e}`})}return t&&(a.map.sources[0]=e.split(/\/|\//).pop()+"?source=true",a.code+=`
//# sourceMappingURL=`+a.map.toUrl(),l.code&&(l.map.sources[0]=a.map.sources[0],l.code+=`
/*# sourceMappingURL=`+l.map.toUrl()+"*/")),await m.makePathReal(r,y.Static[1]),await m.writeFile(i+".js",a.code),await m.writeFile(i+".css",l.code??""),j(B({},o),{thisFile:await m.stat(e,"mtimeMs")})}import{createRequire as _s}from"module";import Je from"clear-module";import Bs from"path";var ri=_s(import.meta.url),ii=r=>ri.resolve(r);function rt(r){r=Bs.normalize(r);let t=ri(r);return Je(r),t}async function Is(dataTag,FullPath,smallPath,dependenceObject,sessionInfo,isDebug){let getV=name=>{let gv=r=>dataTag.getValue(r).trim(),value=gv("ssr"+We(name))||gv(name);return value?eval(`(${value.charAt(0)=="{"?value:`{${value}}`})`):{}},newDeps={},buildPath=await qe(FullPath,smallPath,newDeps,isDebug);Object.assign(dependenceObject,newDeps);let mode=await rt(buildPath);for(let r in newDeps)["sass","scss","css"].includes(Ls.extname(r).substring(1))||Je(ii(y.Static[1]+r.substring(y.Static[2].length+1)+".ssr.cjs"));let{html,head}=mode.default.render(getV("props"),getV("options"));return sessionInfo.headHTML+=head,html}async function Ve(r,t,e,i,n,o,s){let{SmallPath:a,FullPath:l}=mt(r,t,n.remove("from"),y.Static[2],"svelte"),c=$s(y.Static[2],a).replace(/\\/gi,"/");s.style("/"+c+".css");let u=n.remove("id")||At(c),p=S=>{let b=n.getValue(S).trim();return b?`,${S}:${b.charAt(0)=="{"?b:`{${b}}`}`:""},f=n.remove("selector"),g=!f&&n.have("ssr")?await Is(n,l,a,o,s,e):"";return s.addScriptStyle("module",$(n,"page")?t:i.extractInfo()).addText(`import App${u} from '/${c}';
const target${u} = document.querySelector("${f||"#"+u}");
target${u} && new App${u}({
    target: target${u}
    ${p("props")+p("options")}${g?", hydrate: true":""}
});`),{compiledString:new d(null,f?"":`<div id="${u}">${g}</div>`),checkComponents:!0}}import Ds from"markdown-it";import ni from"highlight.js";import ie from"path";import si from"markdown-it-anchor";import Rs from"@sindresorhus/slugify";import Es from"markdown-it-attrs";import Os from"markdown-it-abbr";function js(r){function t(e){return(...i)=>`<div class="code-copy">
                <div>
                    <a href="#copy-clipboard" onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText)">copy</a>
                </div>
                ${e(...i)}
            </div>`}r.renderer.rules.code_block=t(r.renderer.rules.code_block),r.renderer.rules.fence=t(r.renderer.rules.fence)}async function ze(r,t,e,i,n,o){let s=i.GetPlugin("markdown"),a=$(t,"hljs-class",s?.hljsClass??!0)?' class="hljs"':"",l=!1,c=Ds({html:!0,xhtmlOut:!0,linkify:Boolean($(t,"linkify",s?.linkify)),breaks:Boolean($(t,"breaks",s?.breaks??!0)),typographer:Boolean($(t,"typographer",s?.typographer??!0)),highlight:function(h,w){if(w&&ni.getLanguage(w)){l=!0;try{return`<pre${a}><code>${ni.highlight(h,{language:w,ignoreIllegals:!0}).value}</code></pre>`}catch(T){C({text:T,type:"error",errorName:"markdown-parser"})}}return`<pre${a}><code>${c.utils.escapeHtml(h)}</code></pre>`}});$(t,"copy-code",s?.copyCode??!0)&&c.use(js),$(t,"header-link",s?.headerLink??!0)&&c.use(si,{slugify:h=>Rs(h),permalink:si.permalink.headerLink()}),$(t,"attrs",s?.attrs??!0)&&c.use(Es),$(t,"abbr",s?.abbr??!0)&&c.use(Os);let u=e?.eq;if(!u){let h=ie.join(ie.dirname(r.extractInfo("<line>")),t.remove("file"));ie.extname(h)||(h+=".serv.md");let w=ie.join(x.fullWebSitePath,h);u=await m.readFile(w),o[h]=await m.stat(w,"mtimeMs")}let p=c.render(u),f=new d(r.DefaultInfoText),g=await Ws(t.remove("code-theme")||s?.codeTheme||"atom-one");if(l){let h="/serv/md/code-theme/"+g+".css";n.style(h)}t.addClass("markdown-body");let S=$(t,"theme",s?.theme??"auto"),b="/serv/md/theme/"+S+".css";return S!="none"&&n.style(b),t.length?f.Plus$`<div${i.ReBuildTagData(e.DefaultInfoText,t)}>${p}</div>`:f.AddTextAfter(p),{compiledString:f,checkComponents:!1}}var gu=R+"node_modules/github-markdown-css/github-markdown";function Ns(r,t){let[e,i,n]=r.split(/(}|\*\/).hljs{/),o=r[e.length]=="}"?"}":"*/";return[e+o,".hljs{"+(n??i),".hljs{"+t.split(/(}|\*\/).hljs{/).pop()]}var ne=R+"node_modules/highlight.js/styles/";async function Ws(r){let t=r.split("|");if(t.length==1)return r;let e=t[2]||t.slice(0,2).join("~").replace("/","-");if(await m.existsFile(ne+e+".css"))return e;let i=await m.readFile(ne+t[0]+".css"),n=await m.readFile(ne+t[1]+".css"),[o,s,a]=Ns(n,i),l=`${o}@media(prefers-color-scheme:dark){${s}}@media(prefers-color-scheme:light){${a}}`;return await m.writeFile(ne+e+".css",l),e}async function Ge(r,t,e,i,n,o,s,a,l,c,u){return{compiledString:new d(i.DefaultInfoText).Plus$`<head${l.ReBuildTagData(o.DefaultInfoText,n)}>${await l.StartReplace(o,t,r,e,a,s,c,u)}@DefaultInsertBundle</head>`,checkComponents:!1}}async function oi(r,t,e){let i=t.buildHead(),n=[/@InsertBundle(;?)/,/@DefaultInsertBundle(;?)/],o=()=>(n.forEach(l=>r=r.replace(l,"")),r);if(!i)return o();let s=new d(null,i),a=!1;for(let l=0;l<n.length&&!a;l++)r=r.replacer(n[l],()=>(a=!0)&&s);return a?o():r.Plus$`\nout_run_script.text+='${s}';`}var qs="/serv/connect.js";function Us(r){return`function ${r}(...args){return connector("${r}", args)}`}async function He(r,t,e,i,n,{SomePlugins:o},s){let a=e.getValue("name"),l=e.getValue("sendTo"),c=e.getValue("validate"),u=e.remove("notValid"),p=$(e,"message");return p===null&&(p=n&&!o("SafeDebug")),s.script(qs,{async:null}),s.addScriptStyle("script",$(e,"page")?r:t.extractInfo()).addText(Us(a)),s.connectorArray.push({type:"connect",name:a,sendTo:l,message:p,notValid:u,validator:c&&c.split(",").map(f=>f.trim())}),{compiledString:i,checkComponents:!0}}function ai(r,t){if(!t.connectorArray.length)return r;let e="";for(let n of t.connectorArray)n.type=="connect"&&(e+=`,
        {
            name:"${n.name}",
            sendTo:${n.sendTo},
            notValid: ${n.notValid||"null"},
            message:${typeof n.message=="string"?`"${n.message}"`:n.message},
            validator:[${n.validator&&n.validator.map(Xt).join(",")||""}]
        }`);e=`[${e.substring(1)}]`;let i=`
        if(Post?.connectorCall){
            if(await handelConnector("connect", page, ${e})){
                return;
            }
        }`;return r.includes("@ConnectHere")?r=r.replacer(/@ConnectHere(;?)/,()=>new d(null,i)):r.AddTextAfterNoTrack(i),r}async function li(r,t){if(!r.Post?.connectorCall)return!1;let e=t.find(s=>s.name==r.Post.connectorCall.name);if(!e)return!1;let i=r.Post.connectorCall.values,n=e.validator.length&&await Zt(i,e.validator);r.setResponse("");let o=s=>{r.Response.setHeader("Content-Type","application/json"),r.Response.end(JSON.stringify(s))};return!e.validator.length||n===!0?o(await e.sendTo(...i)):e.notValid?o(await e.notValid(...n)):e.message?o({error:typeof e.message=="string"?e.message:n.shift()}):r.Response.status(400),!0}import{v4 as Js}from"uuid";async function Qe(r,t,e,i,n,o,s,a,l,c,u){let p=n.remove("sendTo").trim();if(!p)return{compiledString:new d(i.DefaultInfoText).Plus$`<form${l.ReBuildTagData(o.DefaultInfoText,n)}>${await l.StartReplace(o,t,r,e,a,s,c,u)}</form>`,checkComponents:!1};let f=n.remove("name").trim()||Js(),g=n.remove("validate"),S=n.remove("order"),b=n.remove("notValid"),h=n.have("safe"),w=$(n,"message");w===null&&(w=a&&!l.SomePlugins("SafeDebug"));let T=[],_=g&&g.split(",").map(v=>{let I=W(":",v.trim());return I.length>1&&T.push(I.shift()),I.pop()});return S&&(T=S.split(",").map(v=>v.trim())),u.connectorArray.push({type:"form",name:f,sendTo:p,validator:_,order:T.length&&T,notValid:b,message:w,responseSafe:h}),n.have("method")||n.push({n:new d(null,"method"),v:new d(null,"post")}),{compiledString:new d(i.DefaultInfoText).Plus$`<%!
@?ConnectHereForm(${p});
%><form${l.ReBuildTagData(o.DefaultInfoText,n)}>
    <input type="hidden" name="connectorFormCall" value="${f}"/>${await l.StartReplace(o,t,r,e,a,s,c,u)}</form>`,checkComponents:!1}}function ci(r,t){if(!t.connectorArray.length)return r;for(let e of t.connectorArray){if(e.type!="form")continue;let i=new d(null,e.sendTo).unicode.eq,n=new RegExp(`@ConnectHereForm\\([ ]*${i}[ ]*\\)(;?)`),o=new RegExp(`@\\?ConnectHereForm\\([ ]*${i}[ ]*\\)(;?)`),s=0,a=l=>(s++,new d(l[0].StartInfo).Plus$`
                if(Post?.connectorFormCall == "${e.name}"){
                    await handelConnector("form", page, 
                        {
                            sendTo:${e.sendTo},
                            notValid: ${e.notValid||"null"},
                            validator:[${e.validator?.map?.(Xt)?.join(",")??""}],
                            order: [${e.order?.map?.(c=>`"${c}"`)?.join(",")??""}],
                            message:${typeof e.message=="string"?`"${e.message}"`:e.message},
                            safe:${e.responseSafe}
                        }
                    );
                }`);r=r.replacer(n,a),s?r=r.replace(o,""):r=r.replacer(o,a)}return r}async function ui(r,t){delete r.Post.connectorFormCall;let e=[];if(t.order.length)for(let o of t.order)e.push(r.Post[o]);else e.push(...Object.values(r.Post));let i=!0;t.validator.length&&(e=Zr(e,t.validator),i=await Zt(e,t.validator));let n;i===!0?n=await t.sendTo(...e):t.notValid&&(n=await t.notValid(...i)),!i&&!n&&(t.message===!0?r.writeSafe(t.message):n=t.message),n&&(t.safe?r.writeSafe(n):r.write(n))}var Xe=["client","script","style","page","connect","isolate","form","head","svelte","markdown"];function pi(r,t,e,i,n,o,s,a,l,c,u){let p;switch(i.eq.toLowerCase()){case"client":p=Me(r,t,e,i,n,o,s,a,l,c,u);break;case"script":p=$e(r,t,e,i,n,o,s,a,l,c,u);break;case"style":p=Ee(r,t,e,i,n,o,s,a,l,u);break;case"page":p=je(r,t,e,i,n,o,s,a,l,u);break;case"connect":p=He(e,i,n,o,a,l,u);break;case"form":p=Qe(r,t,e,i,n,o,s,a,l,c,u);break;case"isolate":p=Ne(o);break;case"head":p=Ge(r,t,e,i,n,o,s,a,l,c,u);break;case"svelte":p=Ve(r,e,a,i,n,s,u);break;case"markdown":p=ze(i,n,o,l,u,s);break;default:console.error("Component is not build yet")}return p}function fi(r){return Xe.includes(r.toLowerCase())}async function mi(r,t,e){return r=ai(r,t),r=ci(r,t),r=r.replace(/@ConnectHere(;?)/gi,"").replace(/@ConnectHereForm(;?)/gi,""),r=await oi(r,t,e),r}function gi(r,t,e){return r=="connect"?li(t,e):ui(t,e)}import no from"path";function Vs(r){let t="";for(let e of r)t+="\\u"+("000"+e.charCodeAt(0).toString(16)).substr(-4);return t}function Pt(r,t,e,i,n){let o="";for(let s of t)o+=Vs(e)+s+"|";return o=o.substring(0,o.length-1),o=`<(${o})${n?"([\\p{L}0-9_\\-\\.]+)":""}(\\u0020)*\\u002F?>`,hi(r,new RegExp(o,"u"),e,i)}function zs(r){let t=r.indexOf(">");for(r=r.substring(0,t);r.endsWith(" ")||r.endsWith("/");)r=r.substring(0,r.length-1);return r}function hi(r,t,e,i=!0,n=new d,o=[]){let s=r,a=r.search(t);if(a==-1)return{data:n.Plus(r),found:o};n.Plus(r.substring(0,a)),r=r.substring(a+1);let l=zs(r.eq);r=r.substring(di(">",r));let c;if(i){let u=Ze(["<"+l,"</"+l],r);if(u!=-1)c=r.substring(0,u),r=r.substring(u),r=r.substring(di(">",r));else{let p=r.search(t);p==-1?(c=r,r=new d):(c=r.substring(0,p),r=r.substring(p))}}return o.push({tag:l,data:c,loc:a}),s==r?{error:!0}:hi(r,t,e,i,n,o)}function di(r,t){return t.indexOf(r)+r.length}function Ze(r,t){let e=t.indexOf(r[0]),i=t.indexOf(r[1]);if(i==-1)return-1;if(e<i&&e!=-1){e++;let n=e+Ze(r,t.substring(e))+r[0].length;return n+Ze(r,t.substring(n))}else return i}import le from"path";import ro from"path";import{transform as Qs}from"sucrase";import{minify as Xs}from"terser";function Si(r){return m.readJsonFile(r)}import{promises as Hs}from"fs";async function yi(r){let t=new WebAssembly.Module(await Hs.readFile(r));return new WebAssembly.Instance(t,{}).exports}var se=["json","wasm"];async function bi(r,t,e){switch(t){case"json":return Si(r);case"wasm":return yi(r);default:return import(r)}}var it=class{async load(t){let e=await Gt(t);this.Build=new Tt(e),this.actionStringExport=this.actionStringExport.bind(this),this.actionStringExportAll=this.actionStringExportAll.bind(this)}actionStringImport(t,e,i){return`const ${e} = await ${t}(<|${i}||>)`}actionStringExport(t,e,i){return`${this.actionStringImport(t,e,i)};Object.assign(exports, ${e})`}actionStringImportAll(t,e){return`await ${t}(<|${e}||>)`}actionStringExportAll(t,e){return`Object.assign(exports, ${this.actionStringImportAll(t,e)})`}BuildImportType(t,e=t,i=this.actionStringImport){let n="",o=this.Build.CodeBuildText,s;function a(){s=o.match(new RegExp(`${t}[ \\n]+([\\*]{0,1}[\\p{L}0-9_,\\{\\} \\n]+)[ \\n]+from[ \\n]+<\\|([0-9]+)\\|\\|>`,"u"))}for(a();s;){let l=s[1].trim();n+=o.substring(0,s.index),o=o.substring(s.index+s[0].length);let c;if(l[0]=="*")c=l.substring(1).replace(" as ","").trimStart();else{let u=[];if(l[0]=="{"?(u=l.split("}",2),u[0]+="}",u[1]&&(u[1]=u[1].split(",").pop())):u=l.split(",",1).reverse(),u=u.map(p=>p.trim()).filter(p=>p.length),u.length==1)if(u[0][0]=="{")c=u[0];else{let p=this.Build.AllInputs[s[2]];p=p.substring(p.lastIndexOf(".")+1,p.length-1),se.includes(p)?c=u[0]:c=`{default:${u[0]}}`}else c=u[0],c=`${c.substring(0,c.length-1)},default:${u[1]}}`;c=c.replace(/ as /,":")}n+=i(e,c,s[2]),a()}n+=o,this.Build.CodeBuildText=n}BuildInOneWord(t,e=t,i=this.actionStringImportAll){let n="",o=this.Build.CodeBuildText,s;function a(){s=o.match(new RegExp(t+"[ \\n]+<\\|([0-9]+)\\|\\|>"))}for(a();s;)n+=o.substring(0,s.index),o=o.substring(s.index+s[0].length),n+=i(e,s[1]),a();n+=o,this.Build.CodeBuildText=n}replaceWithSpace(t){this.Build.CodeBuildText=t(" "+this.Build.CodeBuildText).substring(1)}Define(t){for(let[e,i]of Object.entries(t))this.replaceWithSpace(n=>n.replace(new RegExp(`([^\\p{L}])${e}([^\\p{L}])`,"gui"),(...o)=>o[1]+i+o[2]))}BuildInAsFunction(t,e){this.replaceWithSpace(i=>i.replace(new RegExp(`([^\\p{L}])${t}([ \\n]*\\()`,"gui"),(...n)=>n[1]+e+n[2]))}BuildImports(t){this.BuildImportType("import","require"),this.BuildImportType("export","require",this.actionStringExport),this.BuildImportType("include"),this.BuildInOneWord("import","require"),this.BuildInOneWord("export","require",this.actionStringExportAll),this.BuildInOneWord("include"),this.BuildInAsFunction("import","require"),this.Define(t)}BuiltString(){return this.Build.BuildCode()}static async BuildAndExportImports(t,e={}){let i=new it;return await i.load(` ${t} `),i.BuildImports(e),t=i.BuiltString(),t.substring(1,t.length-1)}};import L from"path";import{v4 as Zs}from"uuid";async function Ks(r,t){return r=await it.BuildAndExportImports(r,t),r}function Ys(r,t,e,i,n){return`${t?"require('source-map-support').install();":""}var __dirname="${M.fixTextSimpleQuotes(e)}",__filename="${M.fixTextSimpleQuotes(i)}";module.exports = (async (require${n?","+n:""})=>{var module={exports:{}},exports=module.exports;${r}
return module.exports;});`}async function Ke(r,t,e,i,{params:n,haveSourceMap:o=i,fileCode:s,templatePath:a=r,codeMinify:l=!0}={}){let c=t&&t.split(/\/|\\/).pop(),u={transforms:["imports"],sourceMapOptions:o?{compiledFilename:c}:void 0,filePath:o?t&&L.relative(L.dirname(t),r):void 0},p={debug:""+i};e&&u.transforms.push("typescript");let f=await Ks(s||await m.readFile(r),p),g;try{let{code:S,sourceMap:b}=Qs(f,u);f=S,g=JSON.stringify(b)}catch(S){C({errorName:"compilation-error",text:`${S.message}, on file -> ${r}`})}if(f=Ys(f,i,L.dirname(a),a,n),i)o&&(f+=`\r
//# sourceMappingURL=data:application/json;charset=utf-8;base64,`+Buffer.from(g).toString("base64"));else if(l)try{f=(await Xs(f,{module:!1})).code}catch(S){C({errorName:"minify",text:`${S.message} on file -> ${r}`})}return t&&(await m.makePathReal(L.dirname(t)),await m.writeFile(t,f)),f}function xi(r){return r.endsWith(".ts")}async function to(r,t,e=!1){return await m.makePathReal(r,t[1]),await Ke(t[0]+r,t[1]+r+".cjs",xi(r),e)}function Ft(r){let t=L.extname(r);return x.partExtensions.includes(t.substring(1))?r+="."+(dt()?"ts":"js"):t==""&&(r+="."+x.ReqFileTypes[dt()?"ts":"js"]),r}var X={};async function U(r,t,e,i=!1,n,o=[]){let s;t=L.join(Ft(t).toLowerCase());let a=L.extname(t).substring(1),l=se.includes(a)||!["js","ts"].includes(a),c=L.join(e[2],t),u=L.join(e[0],t),p;X[c]?X[c]instanceof Promise&&await X[c]:X[c]=new Promise(h=>p=h);let f=!H.store[c]||H.store[c]!=(s=await m.stat(u,"mtimeMs",!0,null));if(f){if(s=s??await m.stat(u,"mtimeMs",!0,null),s==null)return C({type:"warn",errorName:"import-not-exists",text:`Import '${t}' does not exists from '${r}'`}),X[c]=null,null;l||await to(t,e,i),H.update(c,s)}n&&(n[t]={thisFile:s},n=n[t]);let g=o[0]==t;if(g)o.shift();else if(!f&&X[c]&&!(X[c]instanceof Promise))return X[c];function S(h){if(L.isAbsolute(h))h=L.normalize(h).substring(L.normalize(e[0]).length);else if(h[0]=="."){let w=L.dirname(t);h=(w!="/"?w+"/":"")+h}else if(h[0]!="/")return import(h);return U(u,h,e,i,n,g?o:[])}let b;if(l)b=await bi(u,a,S);else{let h=L.join(e[1],t+".cjs");b=await rt(h),b=await b(S)}return X[c]=b,p?.(),b}function oe(r,t,e,i=!1,n,o){if(!i){let s=X[L.join(e[2],t.toLowerCase())];if(s!==void 0)return s}return U(r,t,e,i,n,o)}async function wi(r,t){let e=L.join(D,`temp-${Zs()}.cjs`);await Ke(r,e,xi(r),t);let i=await rt(e);return m.unlink(e),await i(n=>import(n))}async function Ti(r,t,e,i,n,o,s,a){await m.makePathReal(e,i[1]);let l=t+".cjs",c=i[0]+e,u=await Ke(t,void 0,n,o,{params:r,haveSourceMap:!1,fileCode:s,templatePath:c,codeMinify:!1});await m.makePathReal(L.dirname(l)),await m.writeFile(l,u+a);function p(g){if(L.isAbsolute(g))g=L.normalize(g).substring(L.normalize(i[0]).length);else if(g[0]=="."){let S=L.dirname(e);g=(S!="/"?S+"/":"")+g}else if(g[0]!="/")return import(g);return U(c,g,i,o)}let f=await rt(l);return async(...g)=>await f(p,...g)}var eo={include:"await ",import:"await ",transfer:"return await "};async function Ye(r,t){let e=await Er(r.eq),i=new d;for(let n of e){let o=r.substring(n.start,n.end);switch(n.name){case"text":i.Plus(o);break;case"script":i.Plus$`<%${o}%>`;break;case"print":i.Plus$`<%=${o}%>`;break;case"escape":i.Plus$`<%:${o}%>`;break;default:i.Plus$`<%${eo[n.name]}${o}%>`}}return i}async function ki(r,t,e){let i=await Or(r.eq,t),n=new d;for(let o=0;o<i.length;o+=4){i[o]!=i[o+1]&&n.Plus(r.substring(i[o],i[o+1]));let s=r.substring(i[o+2],i[o+3]);n.Plus$`<%${e}${s}%>`}return n.Plus(r.substring((i.at(-1)??-1)+1)),n}var ae=class{constructor(t,e,i,n,o){this.script=t;this.sessionInfo=e;this.smallPath=i;this.debug=n;this.isTs=o;this.define={}}templateScript(t){let e=new d;e.AddTextAfterNoTrack(`const __writeArray = []
        var __write;

        function write(text){
            __write.text += text;
        }`);for(let i of t)e.AddTextAfterNoTrack(`__write = {text: ''};
            __writeArray.push(__write);`),e.Plus(i);return e.AddTextAfterNoTrack("return __writeArray"),e}methods(t){let e=x.fullWebSitePath+this.smallPath;return{string:"script,style,define,store,page__filename,page__dirname,attributes",funcs:[this.sessionInfo.script.bind(this.sessionInfo),this.sessionInfo.style.bind(this.sessionInfo),(i,n)=>this.define[String(i)]=n,this.sessionInfo.compileRunTimeStore,e,ro.dirname(e),t]}}rebuildCode(t,e){let i=new d;for(let n of t.values){if(n.type=="text"){i.Plus(n.text);continue}i.AddTextAfterNoTrack(e.pop().text)}return i}async compile(t){let e=this.sessionInfo.cacheCompileScript[this.smallPath];if(e)return(await e)();let i;this.sessionInfo.cacheCompileScript[this.smallPath]=new Promise(h=>i=h),this.script=await ki(this.script,"@compile","*");let n=new M(this.script,this.smallPath,"<%*","%>");if(await n.findScripts(),n.values.length==1&&n.values[0].type==="text"){let h=()=>this.script;return i(h),this.sessionInfo.cacheCompileScript[this.smallPath]=h,this.script}let[o,s]=W("/",this.smallPath),a=y[o]??y.Static,l=a[1]+s+".comp.js";await m.makePathReal(s,a[1]);let c=this.templateScript(n.values.filter(h=>h.type!="text").map(h=>h.text)),u=new G(l,this.debug,!1,!1);u.addStringTracker(c);let{funcs:p,string:f}=this.methods(t),g=await Ti(f,l,s,a,this.isTs,this.debug,c.eq,u.mapAsURLComment()),S=async()=>this.rebuildCode(n,await g(...p));this.sessionInfo.cacheCompileScript[this.smallPath]=S;let b=await S();return i(S),b}};var ce={define:{}},io=["'",'"',"`"],K=class{constructor(t,e,i){this.code=t;this.debug=e;this.isTs=i;this.scriptFile=new d;this.valueArray=[]}async loadSettings(t,e,i,n,o,s){let a=new ae(this.code,t,i,this.debug,this.isTs);this.code=await a.compile(s),this.parseBase(this.code),await this.loadCodeFile(e,i,this.isTs,n,o),this.loadDefine(B(B({},ce.define),a.define))}parseBase(t){let e;for(t=t.replacer(/@\[[ ]*(([A-Za-z_][A-Za-z_0-9]*=(("[^"]*")|(`[^`]*`)|('[^']*')|[A-Za-z0-9_]+)([ ]*,?[ ]*)?)*)\]/,i=>(e=i[1].trim(),new d));e?.length;){let i=e.indexOf("="),n=e.substring(0,i).trim().eq;n[0]==","&&(n=n.substring(1).trim());let o=e.substring(i+1),s,a=o.at(0).eq;if(io.includes(a)){let l=z.findEntOfQ(o.eq.substring(1),a);s=o.substring(1,l),o=o.substring(l+1).trim()}else{let l=o.search(/[_ ,]/);l==-1?(s=o,o=null):(s=o.substring(0,l),o=o.substring(l).trim())}e=o,this.valueArray.push({key:n,value:s})}this.clearData=t.trimStart()}rebuild(){if(!this.valueArray.length)return new d;let t=new d(null,"@[");for(let{key:e,value:i}of this.valueArray)t.Plus$`${e}="${i.replaceAll('"','\\"')}"`;t.Plus("]").Plus(this.clearData),this.clearData=t}static rebuildBaseInheritance(t){let e=new K,i=new d;e.parseBase(t);for(let n of e.byValue("inherit"))e.pop(n),i.Plus(`<@${n}><:${n}/></@${n}>`);return e.rebuild(),e.clearData.Plus(i)}pop(t){return this.valueArray.splice(this.valueArray.findIndex(e=>e.key===t),1)[0]?.value}popAny(t){let e=this.valueArray.findIndex(n=>n.key.toLowerCase()==t);if(e!=-1)return this.valueArray.splice(e,1)[0].value;let i=Pt(this.clearData,[t],"@");if(!!i.found[0])return this.clearData=i.data,i.found[0].data.trim()}byValue(t){return this.valueArray.filter(e=>e.value.eq===t).map(e=>e.key)}replaceValue(t,e){let i=this.valueArray.find(n=>n.key===t);i&&(i.value=e)}async loadCodeFile(t,e,i,n,o){let s=this.popAny("codefile")?.eq;if(!s)return;let a=this.popAny("lang")?.eq;s.toLowerCase()=="inherit"&&(s=t);let l=le.extname(s).substring(1);["js","ts"].includes(l)||(/(\\|\/)$/.test(s)?s+=t.split("/").pop():x.pageTypesArray.includes(l)||(s+=le.extname(t)),s+="."+(a||(i?"ts":"js"))),s[0]=="."&&(s=le.join(le.dirname(t),s));let c=x.relative(s),u=await m.stat(s,"mtimeMs",!0,null);if(u!=null){n[c]=u;let p=await ft(o,s,c);p.allData.AddTextBeforeNoTrack("<%"),p.allData.AddTextAfterNoTrack("%>"),p.allData.AddTextBeforeNoTrack(p.stringInfo),this.scriptFile=p.allData}else C({id:c,type:"error",errorName:"codeFileNotFound",text:`
Code file not found: ${t}<line>${c}`}),this.scriptFile=new d(o,`<%="<p style=\\"color:red;text-align:left;font-size:16px;\\">Code File Not Found: '${e}' -> '${c}'</p>"%>`)}loadSetting(t="define",e=2){let i=this.clearData.indexOf(`@${t}(`);if(i==-1)return!1;let n=[],o=this.clearData.substring(0,i),s=this.clearData.substring(i+8).trimStart();for(let a=0;a<e;a++){let l=s.at(0).eq,c=z.findEntOfQ(s.eq.substring(1),l);n.push(s.substring(1,c));let u=s.substring(c+1).trimStart();if(u.at(0).eq!=","){s=u;break}s=u.substring(1).trimStart()}return s=s.substring(s.indexOf(")")+1),this.clearData=o.trimEnd().Plus(s.trimStart()),n}loadDefine(t){let e=this.loadSetting(),i=Object.entries(t);for(;e;)i.unshift(e),e=this.loadSetting();for(let[n,o]of i)this.clearData=this.clearData.replaceAll(`:${n}:`,o)}};var ue=class extends Ce{constructor(t){super(C);this.dirFolder="Components",this.PluginBuild=t,this.regexSearch=new RegExp(`<([\\p{Lu}_\\-:0-9]|${Xe.join("|")})`,"u")}FindSpecialTagByStart(t){for(let e of this.SkipSpecialTag)if(t.substring(0,e[0].length)==e[0])return e}tagData(t){let e=[],i=[],n={};t=t.trim().replacer(/(<%)([\w\W]+?)(%>)/,f=>(e.push(f[2]),f[1].Plus(f[3])));let o=f=>f.replacer(/(<%)(%>)/,g=>g[1].Plus(e.shift()).Plus(g[2])),s=t.eq,a=['"',"'","`"],l=[["{","}"],["(",")"]];for(;s.length;){let f=0;for(;f<s.length;f++){let g=s.charAt(f);if(g=="="){let S=t.at(f+1),b=S.eq,h=t.substring(0,f),w,T,_;a.includes(b)?(T=z.findEntOfQ(s.substring(f+2),b)+1,w=t.substr(f+2,T-2)):(_=l.find(I=>I[0]==b)?.[1])!=null?(T=z.findEndOfDef(s.substring(f+2),[b,_])+1,w=t.substr(f+1,T+1)):(T=s.substring(f+1).search(/ |\n/),T==-1&&(T=s.length),w=t.substr(f+1,T),S=new d);let A=o(h),v=o(w);n[A.eq]=v.eq,i.push({n:A,v,char:S}),f+=1+T;break}else if(g==" "||f==s.length-1&&++f){let S=o(t.substring(0,f));i.push({n:S}),n[S.eq]=!0;break}}s=s.substring(f).trim(),t=t.substring(f).trim()}let c=f=>i.findIndex(g=>g.n.eq==f),u=f=>i.find(g=>g.n.eq==f)?.v?.eq??"",p=f=>{let g=c(f);return g==-1?"":i.splice(g,1).pop().v?.eq??""};return i.have=f=>c(f)!=-1,i.getValue=u,i.remove=p,i.addClass=f=>{let g=c("class");if(g==-1){i.push({n:new d(null,"class"),v:new d(null,f),char:new d(null,'"')});return}let S=i[g];S.v.length&&(f=" "+f),S.v.AddTextAfter(f)},{data:i,mapAttributes:n}}findIndexSearchTag(t,e){let i=t.split("."),n=0;for(let o of i){let s=e.indexOf(o);if(s==-1){C({text:`Waring, can't find all query in tag -> ${e.eq}
${e.lineInfo}`,errorName:"query-not-found"});break}n+=s+o.length,e=e.substring(s+o.length)}return n+e.search(/\ |\>/)}ReBuildTagData(t,e){let i=new d(t);for(let n of e)n.v?i.Plus$`${n.n}=${n.char}${n.v}${n.char} `:i.Plus(n.n," ");return e.length&&(i=new d(t," ").Plus(i.substring(0,i.length-1))),i}CheckMinHTML(t){return this.SomePlugins("MinHTML","MinAll")&&(t=t.SpaceOne(" ")),t}async ReBuildTag(t,e,i,n,o){n&&this.SomePlugins("MinHTML","MinAll")?(n=n.SpaceOne(" "),e=this.ReBuildTagData(t.DefaultInfoText,i)):e.eq.length&&(e=new d(t.DefaultInfoText," ").Plus(e));let s=new d(t.DefaultInfoText).Plus("<",t,e);return n?s.Plus$`>${await o(n)}</${t}>`:s.Plus("/>"),s}exportDefaultValues(t,e=[]){let i=t.match(/@default[ ]*\(([A-Za-z0-9{}()\[\]_\-$"'`%*&|\/\@ \n]*)\)[ ]*\[([A-Za-z0-9_\-,$ \n]+)\]/);if(i==null)return{fileData:t,foundSetters:e};let n=t.substring(0,i.index).Plus(t.substring(i.index+i[0].length)),o=i[2].eq.split(",").map(s=>s.trim());return e.push({value:i[1],elements:o}),this.exportDefaultValues(n,e)}addDefaultValues(t,e){for(let i of t)for(let n of i.elements)e=e.replaceAll("#"+n,i.value);return e}parseComponentProps(t,e){let{fileData:i,foundSetters:n}=this.exportDefaultValues(e);for(let o of t)if(o.n.eq=="&"){let s=o.n.substring(1),a;if(s.includes("&")){let u=s.indexOf("&");a=this.findIndexSearchTag(s.substring(0,u).eq,i),s=s.substring(u+1)}else a=i.search(/\ |\>/);let l=new d(i.DefaultInfoText),c=i.substring(0,a);l.Plus(c,new d(i.DefaultInfoText).Plus$` ${s}="${o.v??""}"`,c.endsWith(" ")?"":" ",i.substring(a)),i=l}else{let s=new RegExp("\\~"+o.n.eq,"gi");i=i.replace(s,o.v??o.n)}return this.addDefaultValues(n,i)}async buildTagBasic(t,e,i,n,o,s,a,l,c,u,p){return t=await this.PluginBuild.BuildComponent(t,i,n,u),t=this.parseComponentProps(e,t),t=t.replace(/<\:reader( )*\/>/gi,p??""),n=n+" -> "+s,t=await this.StartReplace(t,n,o,s,a,l,c,u),t=await Hr(t,`${n} ->
${s}`,a,c),t}async insertTagData(t,e,i,n,o,{BetweenTagData:s,dependenceObject:a,isDebug:l,buildScript:c,sessionInfo:u}){let{data:p,mapAttributes:f}=this.tagData(o),g=fi(n.eq),S,b=!0,h={},w;if(g){let{compiledString:T,checkComponents:_}=await pi(t,e,i,n,p,s??new d,a,l,this,c,u);S=T,b=_}else{let T=p.have("folder");T&&(T=p.remove("folder")||".");let _=(T?T+"/":"")+n.replace(/:/gi,"/").eq,A=n.extractInfo("<line>"),v=no.join(x.fullWebSitePath,A);if(h=mt(v,A,_,this.dirFolder,x.pageTypes.component),u.cacheComponent[h.SmallPath]===null||u.cacheComponent[h.SmallPath]===void 0&&!await m.existsFile(h.FullPath))return u.cacheComponent[h.SmallPath]=null,T&&C({text:`Component ${n.eq} not found! -> ${e}
-> ${n.lineInfo}
${h.SmallPath}`,errorName:"component-not-found",type:"error"}),this.ReBuildTag(n,o,p,s,jt=>this.StartReplace(jt,e,t,i,l,a,c,u));u.cacheComponent[h.SmallPath]?.mtimeMs||(u.cacheComponent[h.SmallPath]={mtimeMs:await m.stat(h.FullPath,"mtimeMs")}),a[h.SmallPath]=u.cacheComponent[h.SmallPath].mtimeMs;let{allData:I,stringInfo:Y}=await ft(e,h.FullPath,h.SmallPath,u.cacheComponent[h.SmallPath]),ot=new K(I,l,this.isTs());await ot.loadSettings(u,h.FullPath,h.SmallPath,a,e+" -> "+h.SmallPath,f),S=ot.scriptFile.Plus(ot.clearData),w=Y}if(b&&s){let{SmallPath:T,FullPath:_}=h;S=await this.buildTagBasic(S,p,t,e,g?n.eq:_,g?n.eq:T,l,a,c,u,s),w&&S.AddTextBeforeNoTrack(w)}return S}CheckDoubleSpace(...t){let e=this.SomePlugins("MinHTML","MinAll"),i=t.shift();e&&(i=i.SpaceOne(" "));for(let n of t)e&&i.endsWith(" ")&&n.startsWith(" ")&&(n=n.trimStart()),i.Plus(n);return e&&(i=i.SpaceOne(" ")),i}async StartReplace(t,e,i,n,o,s,a,l){let c,u=[];for(;(c=t.search(this.regexSearch))!=-1;){let f=t.eq,g=this.FindSpecialTagByStart(f.trim());if(g){let jt=f.indexOf(g[0])+g[0].length,br=f.substring(jt).indexOf(g[1])+jt+g[1].length;u.push(t.substring(0,br)),t=t.substring(br);continue}let S=t.substring(0,c),b=t.substring(c),h=b.search(" |/|>|(<%)"),w=b.substring(1,h),T=await this.FindCloseChar(b.substring(1),">")+1,_=b.substring(h+1,T),A=b.substring(T+1);if(_.at(_.length-1).eq=="/"&&(_=_.substring(0,_.length-1)),b.at(T-1).eq=="/"){u.push(this.CheckMinHTML(S),this.insertTagData(i,e,n,w,_,{dependenceObject:s,buildScript:a,isDebug:o,sessionInfo:l})),t=A;continue}let v;this.SimpleSkip.includes(w.eq)?v=A.indexOf("</"+w):(v=await this.FindCloseCharHTML(A,w.eq),v==-1&&(C({text:`
Warning, you didn't write right this tag: "${w}", used in: ${w.at(0).lineInfo}
(the system will auto close it)`,errorName:"close-tag"}),v=null));let I=v!=null&&A.substring(0,v),Y=A.substring(v),ot=v!=null?Y.substring(z.findEndOfDef(Y.eq,">")+1):Y;u.push(this.CheckMinHTML(S),this.insertTagData(i,e,n,w,_,{BetweenTagData:I,dependenceObject:s,buildScript:a,isDebug:o,sessionInfo:l})),t=ot}let p=new d(t.DefaultInfoText);for(let f of u)p=this.CheckDoubleSpace(p,await f);return this.CheckMinHTML(this.CheckDoubleSpace(p,t))}RemoveUnnecessarySpace(t){return t=t.trim(),t=t.replaceAll(/%>[ ]+<%(?![=:])/,"%><%"),t}async Insert(t,e,i,n,o,s,a,l){return t=t.replace(/<!--[\w\W]+?-->/,""),t=await this.StartReplace(t,i,e,n,o,s,a,l),t=t.replace(/<\:reader+( )*\/>/gi,'<%typeof page.codebase == "function" ? page.codebase(): write(page.codebase)%>'),this.RemoveUnnecessarySpace(t)}};import vi from"path";var Ci=class extends ee{constructor(t){super(t,!1)}addMappingFromTrack(t){let e=t.getDataArray(),i=e.length,n=!0;for(let o=0;o<i;o++){let{text:s,line:a,info:l}=e[o];if(s==`
`){this.lineCount++,n=!1;continue}!n&&a&&l&&(n=!0,this.map.addMapping({original:{line:a,column:0},generated:{line:this.lineCount,column:0},source:this.getSource(l)}))}}},J=class extends M{static CreateSourceMap(t,e){let i=new Ci(e);return i.addMappingFromTrack(t),i.mapAsURLComment()}static async AddPageTemplate(t,e,i,n,o){return t=await mi(t,o,n),e&&t.AddTextBeforeNoTrack(`try {
`),t.AddTextBeforeNoTrack(`
        module.exports = (_require, _include, _transfer, private_var, handelConnector) => {
            return (async function (page) {
                const __filename = "${M.fixTextSimpleQuotes(i)}", __dirname = "${M.fixTextSimpleQuotes(vi.dirname(i))}";
                const require = (p) => _require(__filename, __dirname, page, p);
                const include = (p, withObject) => _include(__filename, __dirname, page, p, withObject);
        
                var module = { exports: {} },
                    exports = module.exports,
                    { sendFile, writeSafe, write, echo, setResponse, out_run_script, run_script_name, Response, Request, Post, Query, Session, Files, Cookies, PageVar, GlobalVar} = page,

                    run_script_code = run_script_name;

                    const transfer = (p, preserveForm, withObject) => (out_run_script = {text: ''}, _transfer(p, preserveForm, withObject, __filename, __dirname, page));
                {`),e&&t.AddTextAfterNoTrack(`
}
                catch(e){
                    run_script_name += ' -> <line>' + e.stack.split(/\\n( )*at /)[2];
                    out_run_script.text += '${J.printError("<p>Error path: ' + run_script_name.replace(/<line>/gi, '<br/>') + '</p><p>Error message: ' + e.message + '</p>")}';
        
                    console.error("Error path: " + run_script_name.replace(/<line>/gi, '\\n'));
                    console.error("Error message: " + e.message);
                    console.error("Error runing this code: '" + run_script_code + "'");
                    console.error("Error stack: " + e.stack);
                }`),t.AddTextAfterNoTrack("}});}"),e&&t.Plus(J.CreateSourceMap(t,n)),t}static async BuildPage(t,e,i,n,o){let s=await J.RunAndExport(t,e,i);return J.AddPageTemplate(s,i,e,n,o)}static AddAfterBuild(t,e){return e&&(t="require('source-map-support').install();"+t),t}static InPageTemplate(t,e,i){return t.AddTextBeforeNoTrack(`<%!{
            const _page = page;
            {
            const page = {..._page${e?","+e:""}};
            const __filename = "${M.fixTextSimpleQuotes(i)}", __dirname = "${M.fixTextSimpleQuotes(vi.dirname(i))}";
            const require = (p) => _require(__filename, __dirname, page, p);
            const include = (p, withObject) => _include(__filename, __dirname, page, p, withObject);
            const transfer = (p, preserveForm, withObject) => (out_run_script = {text: ''}, _transfer(p, preserveForm, withObject, __filename, __dirname, page));
                {%>`),t.AddTextAfterNoTrack("<%!}}}%>"),t}};function tr(r){let t;switch(r.name||r){case"Razor":t=Ye;break}return t}var pe=class{constructor(t){this.SettingsObject=t}get defaultSyntax(){return this.SettingsObject.BasicCompilationSyntax.concat(this.SettingsObject.AddCompileSyntax)}async BuildBasic(t,e,i,n,o){if(!e)return t;Array.isArray(e)||(e=[e]);for(let s of e){let a=await tr(s);a&&(t=await a(t,s,i,n,o))}return t}async BuildPage(t,e,i,n){return t=await this.BuildBasic(t,this.defaultSyntax,e,i,n),t}async BuildComponent(t,e,i,n){return t=await this.BuildBasic(t,this.defaultSyntax,e,i,n),t}};import{transform as so}from"sucrase";import{minify as oo}from"terser";async function ao(r,t){return r=await it.BuildAndExportImports(r,t),r}function lo(r){return`module.exports = () => (DataObject) => DataObject.out_run_script.text += '<p style="color:red;text-align:left;font-size:16px;">Syntax Error: ${r.replaceAll(`
`,"<br/>")}</p>'`}function co(r){return r.replace('"use strict";',"").replace('Object.defineProperty(exports, "__esModule", {value: true});',"")}async function er(r,t,e,i){r=r.trim();let n={transforms:["imports"]},o={debug:""+e};t&&n.transforms.push("typescript");let s={code:""};try{s=so(await ao(r.eq,o),n),s.code=co(s.code)}catch(a){let l=r.debugLine(a);C({errorName:"compilation-error",text:l}),e&&(s.code=lo(l))}if(!e&&!i)try{s.code=(await oo(s.code,{module:!1})).code}catch(a){C({errorName:"minify",text:r.debugLine(a)})}return s.code}var Ai={plugins:[]};var V={AddCompileSyntax:[],plugins:[],BasicCompilationSyntax:["Razor"]},Pi=new pe(V),ct=new ue(Pi);function q(r){return V.plugins.find(t=>t==r||t?.name==r)}function Q(...r){return r.some(t=>q(t))}function dt(){return V.AddCompileSyntax.includes("TypeScript")}ct.MicroPlugins=V.plugins;ct.GetPlugin=q;ct.SomePlugins=Q;ct.isTs=dt;Ai.plugins=V.plugins;async function Fi(r,t,e,i,n,o,s,a){let l=new K(r,o,dt());await l.loadSettings(a,e,n,s,i);let c=l.popAny("model")?.eq;if(!c)return t.Plus(l.scriptFile,l.clearData);r=l.clearData;let{SmallPath:u,FullPath:p}=mt(e,n,c,"Models",x.pageTypes.model);if(!await m.existsFile(p)){let T=`Error model not found -> ${c} at page ${i}`;return P.error(T),new d(r.DefaultInfoText,J.printError(T))}s[u]=await m.stat(p,"mtimeMs");let f=await ft(i,p,u),g=K.rebuildBaseInheritance(f.allData);g.AddTextBeforeNoTrack(f.stringInfo),i+=" -> "+u;let S=Pt(g,[""],":",!1,!0);if(S.error)return P.error("Error within model ->",c,"at page: ",i),r;g=S.data;let b=S.found.map(T=>T.tag.substring(1)),h=Pt(r,b,"@");if(h.error)return P.error("Error With model ->",c,"at page: ",i),r;let w=new d;for(let T of S.found){T.tag=T.tag.substring(1);let _=h.found.find(A=>A.tag=="@"+T.tag);if(w.Plus(g.substring(0,T.loc)),g=g.substring(T.loc),_)w.Plus(_.data);else{let A=l.pop(T.tag);A&&A.eq.toLowerCase()!="inherit"&&w.Plus(A)}}return w.Plus(g),await Fi(w,t.Plus(l.scriptFile),p,i,u,o,s,a)}async function Mi(r,t,e,i,n,o,s,a,l){let c=(f,g=!0)=>er(f,dt(),n,g),u=new d(i,r);if(u=await Fi(u,new d(u.DefaultInfoText),e,i,i,n,o,l),u=await Pi.BuildPage(u,e,i,l),u=await ct.Insert(u,e,i,i,n,o,c,l),u=await Gr(u,i),s)return J.InPageTemplate(u,a,e);u=await J.BuildPage(u,e,n,t,l);let p=await c(u);return p=J.AddAfterBuild(p,n),p}import ut from"path";import{transform as uo}from"sucrase";import{minify as po}from"terser";async function fe(r,t,e,i,n=!0){let o=B(B({transforms:[],sourceMapOptions:{compiledFilename:"/"+r},filePath:r},q("transformOptions")),i),s=y.Static[0]+r,a=y.Static[1]+r,l=await m.readFile(s);try{let{code:c,sourceMap:u}=uo(l,o);l=c,e&&n&&(u.sources=u.sources.map(p=>p.split(/\/|\\/).pop()+"?source=true"),l+=`\r
//# sourceMappingURL=data:application/json;charset=utf-8;base64,`+Buffer.from(JSON.stringify(u)).toString("base64"))}catch(c){C({errorName:"compilation-error",text:`${c.message}, on file -> ${s}:${c?.loc?.line??0}:${c?.loc?.column??0}`})}if(Q("Min"+t.toUpperCase())||Q("MinAll"))try{l=(await po(l,{module:!1})).code}catch(c){C({errorName:"minify",text:`${c.message} on file -> ${s}`})}return await m.makePathReal(r,y.Static[1]),await m.writeFile(a,l),{thisFile:await m.stat(s,"mtimeMs")}}function _i(r,t){return fe(r,"js",t,void 0,!1)}function Bi(r,t){return fe(r,"ts",t,{transforms:["typescript"]})}function $i(r,t){return fe(r,"jsx",t,j(B({},q("JSXOptions")??{}),{transforms:["jsx"]}))}function Li(r,t){return fe(r,"tsx",t,B({transforms:["typescript","jsx"]},q("TSXOptions")??{}))}import Ii from"sass";import Di from"path";import{fileURLToPath as fo,pathToFileURL as mo}from"url";async function Ri(r,t,e){let i=y.Static[0]+r,n=y.Static[1]+r,o={thisFile:await m.stat(i,"mtimeMs")},s=await m.readFile(i),a=Di.dirname(i);try{let l=await Ii.compileStringAsync(s,{sourceMap:e,syntax:Ct(t),style:Kt(t,Q),logger:Ii.Logger.silent,importer:vt(i)}),c=l.css;e&&l.sourceMap&&(Ie(l.sourceMap,mo(s).href),l.sourceMap.sources=l.sourceMap.sources.map(u=>Di.relative(a,fo(u))+"?source=true"),c+=`\r
/*# sourceMappingURL=data:application/json;charset=utf-8;base64,${Buffer.from(JSON.stringify(l.sourceMap)).toString("base64")}*/`),await m.makePathReal(r,y.Static[1]),await m.writeFile(n,c)}catch(l){C({text:`${l.message}, on file -> ${i}${l.line?":"+l.line:""}`,errorName:l?.status==5?"sass-warning":"sass-error",type:l?.status==5?"warn":"error"})}return o}import go from"fs";import ho from"promptly";import{argv as So}from"process";var yo=["js","svelte","ts","jsx","tsx","css","sass","scss"],Oi=new tt("StaticFiles");async function bo(r){let t=Oi.store[r];for(let e in t){let i=e;e=="thisFile"&&(i=y.Static[2]+"/"+r);let n=x.fullWebSitePath+i;if(await m.stat(n,"mtimeMs",!0)!=t[e])return!0}return!t}async function _t(r,t,e){let i=ut.extname(r).substring(1).toLowerCase(),n;switch(i){case"js":n=await _i(r,t);break;case"ts":n=await Bi(r,t);break;case"jsx":n=await $i(r,t);break;case"tsx":n=await Li(r,t);break;case"css":case"sass":case"scss":n=await Ri(r,i,t);break;case"svelte":n=await Ue(r,t),e+=".js"}if(t&&await m.existsFile(e))return Oi.update(r,n),!0;if(!t)return!0}var Ei=D+"/../static/client/",xo=[{path:"serv/temp.js",type:"js",inServer:Ei+"buildTemplate.js"},{path:"serv/connect.js",type:"js",inServer:Ei+"makeConnection.js"}],wo=[{ext:".pub.js",type:"js"},{ext:".pub.mjs",type:"js"},{ext:".pub.css",type:"css"}];async function To(r,t,e){let i=wo.find(s=>t.endsWith(s.ext));if(!i)return;let n=r.query.t=="l"?y.Logs[1]:y.Static[1],o=ut.join(n,t);if(e||await m.existsFile(o))return j(B({},i),{inServer:o})}var Mt=null;So.includes("allowSourceDebug")&&(Mt=!0);async function ko(){if(typeof Mt=="boolean")return Mt;try{Mt=(await ho.prompt("Allow debugging JavaScript/CSS in source page? - exposing your source code (no)",{validator(r){if(["yes","no"].includes(r.trim().toLowerCase()))return r;throw new Error("yes or no")},timeout:1e3*30})).trim().toLowerCase()=="yes"}catch{}return Mt}var vo=[y.Static[2],y.Logs[2],"Models","Components"];async function Co(r,t,e){if(!r||q("SafeDebug")||ut.extname(t)!=".source"||!vo.includes(t.split(/\/|\\/).shift())||!await ko())return;let i=ut.join(x.fullWebSitePath,t.substring(0,t.length-7));if(e||await m.existsFile(i))return{type:"html",inServer:i}}async function ji(r,t,e){let i=r.substring(0,r.length-4),n=y.Static[1]+r,o;if(ut.extname(i)==".svelte"&&(t||(o=await m.existsFile(n))))return{type:"css",inServer:n};if(e&&o)return await _t(i,e,y.Static[1]+i),ji(r,t,!1)}async function Ao(r,t){if(!r.startsWith("serv/svelte/"))return;let e=R+"node_modules"+r.substring(4)+(ut.extname(r)?"":"/index.mjs");if(t||await m.existsFile(e))return{type:"js",inServer:e}}async function Po(r,t){if(!r.startsWith("serv/md/code-theme/"))return;let e=R+"node_modules/highlight.js/styles"+r.substring(18);if(t||await m.existsFile(e))return{type:"css",inServer:e}}async function Fo(r,t){if(!r.startsWith("serv/md/theme/"))return;let e=r.substring(14);e.startsWith("auto")?e=e.substring(4):e="-"+e;let i=R+"node_modules/github-markdown-css/github-markdown"+e.replace(".css",".min.css");if(t||await m.existsFile(i))return{type:"css",inServer:i}}async function rr(r,t,e,i=!1){return await Ao(e,i)||await ji(e,i,t)||await Co(t,e,i)||await To(r,e,i)||await Fo(e,i)||await Po(e,i)||xo.find(n=>n.path==e)}async function Ni(r,t,e,i){let n=await rr(e,t,r,!0);if(n){i.type(n.type),i.end(await m.readFile(n.inServer));return}let o=y.Static[1]+r,s=y.Static[0]+r,a=ut.extname(r).substring(1).toLowerCase();if(!yo.includes(a)){i.sendFile(s);return}["sass","scss","css"].includes(a)?i.type("css"):i.type("js");let l=o;t&&(e.query.source=="true"||await bo(r)&&!await _t(r,t,o))?l=s:a=="svelte"&&(l+=".js"),i.end(await go.promises.readFile(l,"utf8"))}import $o from"path";import Mo from"path";async function Wi(r,t){let e=[];for(let i of r){i=Ft(i);let n=await U("root folder (WWW)",i,y.Static,t);n&&typeof n.StartServer=="function"?e.push(n.StartServer):P.log(`Can't find StartServer function at module - ${i}
`)}return e}var ir;async function qi(r,t){await m.existsFile(r+".ts")?r+=".ts":r+=".js";let e=await m.stat(r,"mtimeMs",!0,null);return e==ir||!e?null:(ir=e,(await wi(r,t)).default)}function nr(){return ir}var me=class{constructor(){this.state={update:0,pageArray:[],importArray:[],fileArray:[]};this.state.update=nr()}get scripts(){return this.state.importArray}get pages(){return this.state.pageArray}get files(){return this.state.fileArray}addPage(t,e){this.state.pageArray.find(i=>i[0]==t&&i[1]==e)||this.state.pageArray.push([t,e])}addImport(t){this.state.importArray.includes(t)||this.state.importArray.push(t)}addFile(t){this.state.fileArray.includes(t)||this.state.fileArray.push(t)}export(){return m.writeJsonFile(me.filePath,this.state)}static async checkLoad(){if(!await m.existsFile(this.filePath))return;let t=new me;if(t.state=await m.readJsonFile(this.filePath),t.state.update==nr())return t}},nt=me;nt.filePath=Mo.join(D,"CompileState.json");var Ui=new tt("ShortScriptNames"),Bt=class{constructor(t,e,i){this.defaultPath=t;this.typeName=e;this.debug=i;this.connectorArray=[];this.scriptURLSet=[];this.styleURLSet=[];this.inScriptStyle=[];this.headHTML="";this.cache={style:[],script:[],scriptModule:[]};this.cacheCompileScript={};this.cacheComponent={};this.compileRunTimeStore={}}style(t,e){this.styleURLSet.find(i=>i.url==t&&JSON.stringify(i.attributes)==JSON.stringify(e))||this.styleURLSet.push({url:t,attributes:e})}script(t,e){this.scriptURLSet.find(i=>i.url==t&&JSON.stringify(i.attributes)==JSON.stringify(e))||this.scriptURLSet.push({url:t,attributes:e})}addScriptStyle(t,e=this.defaultPath){let i=this.inScriptStyle.find(n=>n.type==t&&n.path==e);return i||(i={type:t,path:e,value:new G(e,this.debug,t=="style",!0)},this.inScriptStyle.push(i)),i.value}static createName(t){let e=0,i,n=Object.values(Ui.store);for(;i==null||n.includes(i);)i=At(t,5+e).substring(e),e++;return i}addHeadTags(){let t=this.typeName==y.Logs[2],e=t?y.Logs[1]:y.Static[1],i=t?"?t=l":"";for(let n of this.inScriptStyle){let o=Ui.have(n.path,()=>Bt.createName(n.path))+".pub";switch(n.type){case"script":o+=".js",this.script("/"+o+i,{defer:null});break;case"module":o+=".mjs",this.script("/"+o+i,{type:"module"});break;case"style":o+=".css",this.style("/"+o+i);break}m.writeFile(e+o,n.value.createDataWithMap())}}buildHead(){this.addHeadTags();let t=n=>n.attributes?" "+Object.keys(n.attributes).map(o=>n.attributes[o]?o+`="${n.attributes[o]}"`:o).join(" "):"",e=this.typeName==y.Logs[2]?"?t=l":"",i="";for(let n of this.styleURLSet)i+=`<link rel="stylesheet" href="${n.url+e}"${t(n)}/>`;for(let n of this.scriptURLSet)i+=`<script src="${n.url+e}"${t(n)}><\/script>`;return i+this.headHTML}extends(t){this.connectorArray.push(...t.connectorArray),this.scriptURLSet.push(...t.scriptURLSet),this.styleURLSet.push(...t.styleURLSet);for(let e of t.inScriptStyle)this.inScriptStyle.push(j(B({},e),{value:e.value.clone()}));this.headHTML+=t.headHTML,this.cache.style.push(...t.cache.style),this.cache.script.push(...t.cache.script),this.cache.scriptModule.push(...t.cache.scriptModule),Object.assign(this.cacheComponent,t.cacheComponent)}};import{argv as Lo}from"process";import _o from"path";function ht(r,t){t=t.toLowerCase();for(let e of r)if(t.endsWith("."+e))return!0;return!1}function Ji(r){return r.substring(0,r.lastIndexOf("."))}async function sr(r,t,e){let i=await m.readdir(r[0]+t,{withFileTypes:!0}),n=[];for(let o of i){let s=o.name,a=t+s;o.isDirectory()?n.push(sr(r,a+"/",e)):ht(x.pageTypesArray,s)?e.addPage(a,r[2]):r==y.Static&&ht(x.ReqFileTypesArray,s)?e.addImport(a):e.addFile(a)}return Promise.all(n)}async function Bo(){let r=new nt;return await Promise.all([sr(y.Static,"",r),sr(y.Logs,"",r)]),r}async function Vi(r){return or(r,await Bo())}async function or(r,t){let{routing:e,development:i}=r;if(!e.sitemap)return;let n=e.sitemap===!0?{}:e.sitemap;Object.assign(n,{rules:!0,urlStop:!1,errorPages:!1,validPath:!0});let o=[];t:for(let[a,l]of t.pages)if(!(l!=y.Static[2]||!a.endsWith("."+x.pageTypes.page))&&(a="/"+a.substring(0,a.length-x.pageTypes.page.length-1),_o.extname(a)!=".serv")){if(n.urlStop)for(let c in e.urlStop){a.startsWith(c)&&(a=c);break}if(n.rules){for(let c in e.rules)if(a.startsWith(c)){a=await e.rules[c](a);break}}if(!(e.ignoreTypes.find(c=>a.endsWith("."+c))||e.ignorePaths.find(c=>a.startsWith(c)))){if(n.validPath){for(let c of e.validPath)if(!await c(a))continue t}if(!n.errorPages)for(let c in e.errorPages){let u="/"+e.errorPages[c].path;if(a.startsWith(u))continue t}o.push(a)}}let s=!0;if(n.file){let a=await oe("Sitemap Import",n.file,y.Static,i);a?.Sitemap?s=await a.Sitemap(o,t,r):dump.warn("'Sitemap' function not found on file -> "+n.file)}if(s&&o.length){let a=s===!0?"sitemap.txt":s;t.addFile(a),await m.writeFile(y.Static[0]+a,o.join(`
`))}}async function Gi(r,t,e,i,n,o){let s=$o.join(t[0],r),a=t[1]+r+".cjs",l={thisPage:await m.stat(s,"mtimeMs")},c=await m.readFile(s,"utf8"),u=(n?n+"<line>":"")+t[2]+"/"+r,p=i??new Bt(t[2]+"/"+r,t[2],e&&!q("SafeDebug")),f=await Mi(c,a,s,u,e,l,Boolean(n),o,p);return n||(await m.writeFile(a,f),H.update(Ji(u),l)),{CompiledData:f,dependenceObject:l,sessionInfo:p}}async function Hi(r,t,e){let i=await m.readdir(r[0]+t,{withFileTypes:!0});for(let n of i){let o=n.name,s=t+o;n.isDirectory()?(await m.mkdir(r[1]+s),await Hi(r,s+"/",e)):ht(x.pageTypesArray,o)?(e.addPage(s,r[2]),await et(r[2]+"/"+s)&&await Gi(s,r,!1)):r==y.Static&&ht(x.ReqFileTypesArray,o)?(e.addImport(s),await U("Production Loader - "+r[2],s,r,!1)):(e.addFile(s),await _t(s,!1))}}async function Io(r){for(let t of r)await U("Production Loader",t,y.Static,!1)}async function zi(r,t){let e=y[r];return await bt(e[1]),()=>Hi(e,"",t)}async function Qi(r,t,e,i,n){return await m.makePathReal(r,t[1]),await Gi(r,t,!0,e,i,n)}ct.CompileInFile=Qi;async function ge(r,t){await Qi(r,t),Pe()}async function Xi(r){let t=!Lo.includes("rebuild")&&await nt.checkLoad();if(t)return()=>Io(t.scripts);H.clear(),t=new nt;let e=[await zi(y.Static[2],t),await zi(y.Logs[2],t),Pe];return async()=>{for(let i of e)await i();await or(r,t),t.export()}}var ur={};Mn(ur,{BuildPage:()=>It,Export:()=>pt,LoadPage:()=>Lt,SplitFirst:()=>W,getFullPathCompile:()=>cr});import de from"path";import Zi from"path";var Ki={};async function ar(r,t,e="",i={}){let n={},o=[];for(let[s,a]of Object.entries(r))o.push((async()=>{s=="thisFile"?(i[e]||(i[e]=await m.stat(t[0]+e,"mtimeMs",!0)),n.thisFile=i[e]):n[s]=await ar(a,t,s,i)})());return await Promise.all(o),n}function lr(r,t){for(let e in r)if(e=="thisFile"){if(t[e]!=r[e])return!1}else if(!lr(r[e],t[e]))return!1;return!0}function Yi(r,t,e=""){let i=[];for(let n in r)if(n=="thisFile"){if(t[n]!=r[n]){i.push(e);break}}else if(t[n]){let o=Yi(r[n],t[n],n);if(o.length){e&&i.push(e),i.push(...o);break}}else{i.push(n);break}return i}async function $t(r,t,e,i,n,o){let s=n[r],a,l;if(s){if(!o||o&&s.status==-1)return s.model;if(a=await m.stat(i[0]+s.path,"mtimeMs",!0,0),a){if(l=await ar(s.dependencies,i),lr(s.dependencies,l))return s.model}else if(s.status==0)return s.model}let c=r,u=!1;if(s?(r=s.path,u=s.static):r[0]=="."?(r[1]=="/"&&(r=r.substring(2)),r=Zi.join(Zi.relative(e,i[0]),r)):r[0]!="/"?u=!0:r=r.substring(1),u)n[c]={model:await import(r),status:-1,static:!0,path:r};else{r=Ft(r);let f=i[0]+r;if(a=a??await m.stat(f,"mtimeMs",!0,0),a){let g=Ki[r];g&&lr(g.dependencies,l=l??await ar(g.dependencies,i))?n[c]=g:(l=l??{},n[c]={model:await oe(t,r,i,o,l,g&&Yi(g.dependencies,l)),dependencies:l,path:r})}else n[c]={model:{},status:0,path:r},C({type:"warn",errorName:"import-not-exists",text:`Import '${r}' does not exists from '${t}'`})}let p=n[c];return Ki[p.path]=p,p.model}var pt={PageLoadRam:{},PageRam:!0};async function Ro(r,t,e,i,n,o){let s=n[r],a=()=>s.model(o),l;if(s&&(!o.isDebug||s.date==-1&&(l=await m.existsFile(s.path),!l)))return a();let c=r,u=de.extname(r).substring(1);u||(u=x.pageTypes.page,r+="."+u);let p;if(r[0]=="."?(r[1]=="/"?r=r.substring(2):r=r.substring(1),p=de.join(e,r)):p=de.join(i[0],r),![x.pageTypes.page,x.pageTypes.component].includes(u)){let b=await m.readFile(p);return o.write(b),b}if(l=l??await m.existsFile(p),!l)return C({type:"warn",errorName:"import-not-exists",text:`Import '${c}' does not exists from '${t}'`}),n[c]={model:()=>{},date:-1,path:p},n[c].model;let f=i[2]+"/"+r.substring(0,r.length-u.length-1),g=o.isDebug&&(!await m.existsFile(i[1]+r+".cjs")||await et(f));if(g&&await ge(r,i),pt.PageLoadRam[f]&&!g)return n[c]={model:pt.PageLoadRam[f][0]},await n[c].model(o);let S=await Lt(f,u);return pt.PageRam&&(pt.PageLoadRam[f]||(pt.PageLoadRam[f]=[]),pt.PageLoadRam[f][0]=S),n[c]={model:S},await S(o)}var Eo={};function cr(r){let t=W("/",r);return y[t[0]][1]+t[1]+"."+x.pageTypes.page+".cjs"}async function Lt(r,t=x.pageTypes.page){let e=W("/",r),i=y[e[0]],n={};function o(u,p,f,g){return $t(g,u,p,i,n,f.isDebug)}function s(u,p,f,g,S={}){return Ro(g,u,p,i,n,B(B({},S),f))}function a(u,p,f,g,S,b){if(b.out_run_script.text="",!p){let h=b.Request.body?{}:null;b=j(B({},b),{Request:j(B({},b.Request),{files:{},query:{},body:h}),Post:h,Query:{},Files:{}})}return s(g,S,b,u,f)}let l=de.join(i[1],e[1]+"."+t+".cjs"),c={};try{return(await rt(l))(o,s,a,c,gi)}catch(u){let p=r+"."+t;return P.error("Error path -> ",p,"->",u.message),P.error(u.stack),f=>f.out_run_script.text+=`<div style="color:red;text-align:left;font-size:16px;"><p>Error path: ${p}</p><p>Error message: ${u.message}</p></div>`}}function It(r,t){let e={};return async function(i,n,o,s,a,l,c,u){let p={text:""};function f(A){let v=A?.toString?.();return v==null||v.startsWith("[object Object]")?JSON.stringify(A,null,2):v}function g(A){p.text=f(A)}function S(A=""){p.text+=f(A)}function b(A=""){A=f(A);for(let v of A)p.text+="&#"+v.charCodeAt(0)+";"}function h(A,v){for(let I in v)p.text+=A[I],b(v[I]);p.text+=A.at(-1)}let w=!1;i.redirect=(A,v)=>(w=String(A),v!=null&&i.status(v),i),i.reload=()=>{i.redirect(n.url)};function T(A,v=!1){w={file:A,deleteAfter:v}}return await r({sendFile:T,writeSafe:b,write:S,echo:h,setResponse:g,out_run_script:p,run_script_name:t,Response:i,Request:n,Post:o,Query:s,Session:l,Files:c,Cookies:a,isDebug:u,PageVar:e,GlobalVar:Eo,codebase:""}),{out_run_script:p.text,redirectPath:w}}}import Oo from"path";import jo from"http";var pr={};function No(r,t){let e=Object.keys(pr);for(let i of e){let n=pr[i];if(r.startsWith(i)&&n.pathSplit==t)return{staticPath:i,dataInfo:n}}return{}}async function Wo(r){for(;r.length;){let t=Oo.join(y.Static[0],r+".api"),e=async n=>await m.existsFile(t+"."+n)&&n,i=(await Promise.all([e("ts"),e("js")])).filter(n=>n).shift();if(i)return r+".api."+i;r=qr("/",r)}return r}async function rn(r,t,e,i,n){let o=e.split("/").length,{staticPath:s,dataInfo:a}=No(e,o);if(a||(s=await Wo(e),s&&(a={pathSplit:o,depsMap:{}},pr[s]=a)),a)return await Uo(await $t("/"+s,"api-call","",y.Static,a.depsMap,i),r,t,e.substring(s.length-6),i,n)}var qo=["validateURL","validateFunc","func","define",...jo.METHODS];function tn(r,t){let e=0,i="";for(let n in r){let o=n.length;e<o&&t.startsWith(n)&&!qo.includes(n)&&(e=o,i=n)}return i}async function nn(r,t,e,i,n){let o=t,s=!0,a;switch(r){case Number:case parseFloat:case parseInt:o=r(t),s=!isNaN(o);break;case Boolean:o=t!="false",t=t.toLowerCase(),s=t=="true"||t=="false";break;case"any":break;default:if(Array.isArray(r)&&(s=r.includes(t)),typeof r=="function")try{let l=await r(t,e,i);l&&typeof l=="object"?(s=l.valid,o=l.parse??t):s=l}catch(l){a="Error on function validator, filed - "+n(l)}r instanceof RegExp&&(s=r.test(t))}return s||(a="Error validate filed - "+t),[a,o]}async function en(r,t,e,i,n,o){if(!r.define)return t;let s=r.define.validateFunc;r.define.validateFunc=null,delete r.define.validateFunc;for(let a in r.define){let[l,c]=W("/",t);t=c;let[u,p]=await nn(r.define[a],l,i,n,o);if(u)return{error:u};e[a]=p}if(s){let a;try{a=await s(e,i,n)}catch(l){a="Error on function validator"+o(l)}return{error:typeof a=="string"?a:"Error validating URL"}}return t}async function Uo(r,t,e,i,n,o){let s=!q("SafeDebug")&&n,a=v=>(n?P.error(v):null)+(s?`, message: ${v.message}`:""),l=t.method,c=r[l]||r.default[l],u=!0;c||(u=!1,c=r.default||r);let p=c,f={},g=await en(c,i,f,t,e,a);if(g.error)return e.json(g);i=g;let S=tn(c,i);for(let v=0;v<2;v++){for(;S=tn(c,i);){let I=await en(c,i,f,t,e,a);if(I.error)return e.json(I);i=I,i=Ur("/",i.substring(S.length)),c=c[S]}u||(u=!0,c=c[l])}if(c=c?.func&&c||p,!c?.func)return!1;let b=i.split("/"),h=[],w;if(c.validateURL)for(let[v,I]of Object.entries(c.validateURL)){let[Y,ot]=await nn(I,b[v],t,e,a);if(Y){w=Y;break}h.push(ot)}else h.push(...b);if(!w&&c.validateFunc){let v;try{v=await c.validateFunc(b,t,e,h)}catch(I){v="Error on function validator"+a(I)}typeof v=="string"?w=v:v||(w="Error validating URL")}if(w)return e.json({error:w});let T=await o(),_,A;try{_=await c.func(t,e,h,f,b)}catch(v){s?A={error:v.message}:A={error:"500 - Internal Server Error"}}return typeof _=="string"?A={text:_}:A=_,T(),A!=null&&e.json(A),!0}var{Export:O}=ur,F={CacheDays:1,PageRam:!1,DevMode:!0,ErrorPages:{}};async function Jo(r){await m.existsFile(cr(r))&&(O.PageLoadRam[r]=[],O.PageLoadRam[r][0]=await Lt(r),O.PageLoadRam[r][1]=It(O.PageLoadRam[r][0],r))}async function on(){for(let r in H.store)Vo(r,x.ReqFileTypesArray)||await Jo(r)}function an(){for(let r in O.PageLoadRam)O.PageLoadRam[r]=void 0,delete O.PageLoadRam[r]}function Vo(r,...t){r=r.toLowerCase();for(let e of t)for(let i of e)if(r.substring(r.length-i.length-1)=="."+i)return!0;return!1}function he(r,t){let e,i;return F.ErrorPages[t]?(e=y.Static,i=F.ErrorPages[t].path,r=F.ErrorPages[t].code??r):(e=y.Logs,i="e"+r),{url:i,arrayType:e,code:r}}async function zo(r,t,e){if(r.method=="POST"?(!r.body||!Object.keys(r.body).length)&&(r.body=r.fields||{}):r.body=!1,r.closed)return;await new Promise(n=>F.Cookies(r,t,n)),await new Promise(n=>F.CookieEncrypter(r,t,n)),await new Promise(n=>F.SessionStore(r,t,n)),r.signedCookies=r.signedCookies||{},r.files=r.files||{};let i=JSON.parse(JSON.stringify(r.signedCookies));return r.cookies=r.signedCookies,t.statusCode=201,()=>{t.statusCode===201&&(t.statusCode=e);for(let n in r.signedCookies)(typeof r.signedCookies[n]!="object"&&r.signedCookies[n]!=i[n]||JSON.stringify(r.signedCookies[n])!=JSON.stringify(i[n]))&&t.cookie(n,r.signedCookies[n],F.CookieSettings);for(let n in i)r.signedCookies[n]===void 0&&t.clearCookie(n)}}function Go(r){if(!r.files)return[];let t=[];for(let e in r.files){let i=r.files[e];if(Array.isArray(i))for(let n in i)t.push(i[n].filepath);else t.push(i.filepath)}return t}async function sn(r){for(let t in r)await m.unlinkIfExists(t)}async function Ho(r,t,e,i){let n=e[2],o=!1;return i==200&&(n=y.Static[0]+t,await rr(r,F.DevMode,t)||await m.existsFile(n)?o=!0:n=e[2]),{file:o,fullPageUrl:n}}async function fr(r){let t=[await Lt(r)];return t[1]=It(t[0],r),F.PageRam&&(O.PageLoadRam[r]=t),t[1]}async function Qo(r,t,e,i){let n;if(await m.existsFile(r[0]+t+"."+x.pageTypes.page))n=r[1]+t+"."+x.pageTypes.page+".cjs";else{let o=he(404,"notFound");t=o.url,r=o.arrayType,i=o.code,e=r[2]+"/"+t,n=t+"."+x.pageTypes.page,await m.existsFile(r[0]+n)?n=r[1]+n+".cjs":n=null}return{arrayType:r,fullPageUrl:n,smallPath:e,code:i,url:t}}async function Xo(r,t,e,i,n){let o=async()=>{let a=await Qo(r,t,i,n);return i=a.smallPath,t=a.url,n=a.code,e=a.fullPageUrl,r=a.arrayType,!0},s;if(F.DevMode&&await o()&&e)!await m.existsFile(e)||await et(i)?(await ge(t+"."+x.pageTypes.page,r),s=await fr(i)):O.PageLoadRam[i]?O.PageLoadRam[i][1]?s=O.PageLoadRam[i][1]:(s=It(O.PageLoadRam[i][0],i),F.PageRam&&(O.PageLoadRam[i][1]=s)):s=await fr(i);else if(O.PageLoadRam[i])s=O.PageLoadRam[i][1];else if(!F.PageRam&&await o()&&e)s=await fr(i);else{n=F.ErrorPages.notFound?.code??404;let a=F.ErrorPages.notFound&&O.PageLoadRam[y.Static[2]+"/"+F.ErrorPages.notFound.path]||O.PageLoadRam[y.Logs[2]+"/e404"];a?s=a[1]:e=null}return{DynamicFunc:s,code:n,fullPageUrl:e}}async function Zo(r,t){if(r.redirectPath?.file)t.sendFile(r.redirectPath.file),await new Promise(e=>t.on("finish",e));else if(r.redirectPath)t.writeHead(302,{Location:r.redirectPath}),t.end();else{let e=r.out_run_script.trim();e?t.send(e):t.end()}r.redirectPath.deleteAfter&&await m.unlinkIfExists(t.redirectPath.file)}async function Ko(r,t,e,i,n,o,s){let{DynamicFunc:a,fullPageUrl:l,code:c}=await Xo(e,i,n.fullPageUrl,n.fullPageUrl+"/"+i,o);if(!l||!a&&o==500)return t.sendStatus(c);try{let u=await s(),p=await a(t,r,r.body,r.query,r.cookies,r.session,r.files,F.DevMode);u(),await Zo(p,t)}catch(u){P.error(u),r.error=u;let p=he(500,"serverError");return Se(r,t,p.url,p.arrayType,p.code),!1}return!0}async function Se(r,t,e,i=y.Static,n=200){let o=await Ho(r,e,i,n),s=Go(r);if(o.file){F.CacheDays&&t.setHeader("Cache-Control","max-age="+F.CacheDays*24*60*60),await Ni(e,F.DevMode,r,t),sn(s);return}let a=()=>zo(r,t,n);!await rn(r,t,e,F.DevMode,a)&&!await Ko(r,t,i,e,o,n,a)||sn(s)}function ln(r){return r=r.substring(0,r.lastIndexOf("?"))||r,r=="/"&&(r="/index"),decodeURIComponent(r)}import{v4 as un}from"uuid";import{cookieParser as Yo}from"@tinyhttp/cookie-parser";import ta from"cookie-encrypter";import pn from"express-session";import ea from"body-parser";import ra from"memorystore";var gr=un().substring(0,32),fn=un(),ia=ra(pn),mn=Yo(gr),gn=ta(gr,{}),na={httpOnly:!0,signed:!0,maxAge:864e5*30};F.Cookies=mn;F.CookieEncrypter=gn;F.CookieSettings=na;var Dt=!0,ye,mr,dn,hn,E={sessionTotalRamMB:150,sessionTimeMinutes:40,sessionCheckPeriodMinutes:30,fileLimitMB:10,requestLimitMB:4},be;function Sn(){return be}var yn=[...x.ReqFileTypesArray,...x.pageTypesArray,...x.pageCodeFileArray],bn=[r=>r.split(".").at(-2)!="serv"],k={get settingsPath(){return R+x.WebSiteFolder+"/Settings"},set development(r){Dt!=r&&(Dt=r,r||(ye=Xi(k),process.env.NODE_ENV="production"),F.DevMode=r,vr(r))},get development(){return Dt},middleware:{get cookies(){return mn},get cookieEncrypter(){return gn},get session(){return mr},get formidable(){return dn},get bodyParser(){return hn}},secret:{get cookies(){return gr},get session(){return fn}},general:{importOnLoad:[],set pageInRam(r){if(F.PageRam!=r){be=async()=>(await ye)?.();return}F.PageRam=r,be=async()=>{await(await ye)?.(),F.PageRam?r||an():await on()}},get pageInRam(){return F.PageRam}},compile:{set compileSyntax(r){V.AddCompileSyntax=r},get compileSyntax(){return V.AddCompileSyntax},set ignoreError(r){Ht.PreventErrors=r},get ignoreError(){return Ht.PreventErrors},set plugins(r){V.plugins.length=0,V.plugins.push(...r)},get plugins(){return V.plugins},get define(){return ce.define},set define(r){ce.define=r}},routing:{rules:{},urlStop:[],validPath:bn,ignoreTypes:yn,ignorePaths:[],sitemap:!0,get errorPages(){return F.ErrorPages},set errorPages(r){F.ErrorPages=r}},serveLimits:{cacheDays:3,cookiesExpiresDays:1,set sessionTotalRamMB(r){E.sessionTotalRamMB!=r&&(E.sessionTotalRamMB=r,Rt())},get sessionTotalRamMB(){return E.sessionTotalRamMB},set sessionTimeMinutes(r){E.sessionTimeMinutes!=r&&(E.sessionTimeMinutes=r,Rt())},get sessionTimeMinutes(){return E.sessionTimeMinutes},set sessionCheckPeriodMinutes(r){E.sessionCheckPeriodMinutes!=r&&(E.sessionCheckPeriodMinutes=r,Rt())},get sessionCheckPeriodMinutes(){return E.sessionCheckPeriodMinutes},set fileLimitMB(r){E.fileLimitMB!=r&&(E.fileLimitMB=r,xe())},get fileLimitMB(){return E.fileLimitMB},set requestLimitMB(r){E.requestLimitMB!=r&&(E.requestLimitMB=r,xe(),dr())},get requestLimitMB(){return E.requestLimitMB}},serve:{port:8080,http2:!1,greenLock:{staging:null,cluster:null,email:null,agent:null,agreeToTerms:!1,sites:[]}}};function xe(){dn={maxFileSize:k.serveLimits.fileLimitMB*1048576,uploadDir:D+"/UploadFiles/",multiples:!0,maxFieldsSize:k.serveLimits.requestLimitMB*1048576}}function dr(){hn=ea.json({limit:k.serveLimits.requestLimitMB+"mb"})}function Rt(){if(!k.serveLimits.sessionTimeMinutes||!k.serveLimits.sessionTotalRamMB){mr=(r,t,e)=>e();return}mr=pn({cookie:{maxAge:k.serveLimits.sessionTimeMinutes*60*1e3,sameSite:!0},secret:fn,resave:!1,saveUninitialized:!1,store:new ia({checkPeriod:k.serveLimits.sessionCheckPeriodMinutes*60*1e3,max:k.serveLimits.sessionTotalRamMB*1048576})})}function st(r,t,e=[],i="ignore"){if(!t)return!1;let n=!1;for(let o in t){let s=e.includes(o);(i=="only"&&s||i=="ignore"&&!s)&&(n=!0,r[o]=t[o])}return n}async function hr(){let r=await qi(k.settingsPath,Dt);if(r==null)return;r.development?Object.assign(r,r.implDev):Object.assign(r,r.implProd),st(k.compile,r.compile),st(k.routing,r.routing,["ignoreTypes","validPath"]);let t=(e,i)=>r.routing?.[e]&&(k.routing[e]=r.routing[e].concat(i));t("ignoreTypes",yn),t("validPath",bn),st(k.serveLimits,r.serveLimits,["cacheDays","cookiesExpiresDays"],"only"),st(E,r.serveLimits,["sessionTotalRamMB","sessionTimeMinutes","sessionCheckPeriodMinutes"],"only")&&Rt(),st(E,r.serveLimits,["fileLimitMB","requestLimitMB"],"only")&&xe(),st(E,r.serveLimits,["requestLimitMB"],"only")&&dr(),st(k.serve,r.serve),k.development=r.development,r.general?.importOnLoad&&(k.general.importOnLoad=await Wi(r.general.importOnLoad,Dt)),!st(k.general,r.general,["pageInRam"],"only")&&r.development&&(be=await ye),k.development&&k.routing.sitemap&&Vi(k)}function xn(){Rt(),xe(),dr()}import fa from"formidable";import sa from"http";import oa from"http2";import*as wn from"selfsigned";import*as Tn from"greenlock-express";async function aa(r,t){let e=R+"/SystemSave/";if(await m.mkdirIfNotExists(e),e+=r,await m.mkdirIfNotExists(e),t){e+="/";let i=e+t.name;await m.existsFile(i)?t.exits&&await m.writeFile(i,await t.exits(await m.readFile(i,"utf8"),i,e)):await m.writeFile(i,t.value)}}async function la(){let r,t=D+"/Certificate.json";return await m.existsFile(t)?r=m.readJsonFile(t):(r=await new Promise(e=>{wn.generate(null,{days:36500},(i,n)=>{if(i)throw i;e({key:n.private,cert:n.cert})})}),m.writeJsonFile(t,r)),r}function ca(r){let t=sa.createServer(r.attach);return{server:t,listen(e){return new Promise(i=>{t.listen(e,i)})},close(){t.close()}}}async function kn(r){if(!(k.serve.http2||k.serve.greenLock?.agreeToTerms))return await ca(r);if(!k.serve.greenLock.agreeToTerms){let n=oa.createSecureServer(j(B({},await la()),{allowHTTP1:!0}),r.attach);return{server:n,listen(o){n.listen(o)},stop(){n.close()}}}await aa("greenlock",{name:"config.json",value:JSON.stringify({sites:k.serve.greenLock.sites}),async exits(n,o,s){n=JSON.parse(n);for(let l in n.sites){let c=n.sites[l],u;for(let p of k.serve.greenLock.sites)if(p.subject==c.subject){u=!0,(p.altnames.length!=c.altnames.length||p.altnames.some(f=>c.altnames.includes(f)))&&(c.altnames=p.altnames,delete c.renewAt);break}if(!u){n.sites.splice(l,l);let p=s+"live/"+c.subject;await m.exists(p)&&(await bt(p),await m.rmdir(p))}}let a=k.serve.greenLock.sites.filter(l=>!n.sites.find(c=>c.subject==l.subject));return n.sites.push(...a),JSON.stringify(n)}});let t=await m.readJsonFile(R+"package.json"),e=await new Promise(n=>Tn.init({packageRoot:R,configDir:"SystemSave/greenlock",packageAgent:k.serve.greenLock.agent||t.name+"/"+t.version,maintainerEmail:k.serve.greenLock.email,cluster:k.serve.greenLock.cluster,staging:k.serve.greenLock.staging}).ready(n));function i(n,o,s){let a=()=>{},l=e[n](s,o);return{server:l,listen:p=>{let f=e.httpServer();return a=()=>f.close(),Promise.all([new Promise(g=>l.listen(443,"0.0.0.0",g)),new Promise(g=>f.listen(p,"0.0.0.0",g))])},close:()=>{l.close(),a()}}}return k.serve.http2?i("http2Server",r.attach,{allowHTTP1:!0}):i("httpsServer",r.attach)}async function Sr(r,t){return k.development&&await hr(),await ma(r,t)}async function ma(r,t){let e=ln(r.url);for(let n of k.routing.urlStop)if(e.startsWith(n))return n.endsWith("/")&&(n=n.substring(0,n.length-1)),await vn(r,t,n);let i=Object.keys(k.routing.rules).find(n=>e.startsWith(n));i&&(e=await k.routing.rules[i](e,r,t)),await vn(r,t,e)}async function vn(r,t,e){let i=k.routing.ignorePaths.find(n=>e.startsWith(n))||k.routing.ignoreTypes.find(n=>e.endsWith("."+n));if(!i){for(let n of k.routing.validPath)if(!await n(e,r,t)){i=!0;break}}if(i){let n=he(404,"notFound");return await Se(r,t,n.url,n.arrayType,n.code)}await Se(r,t,e.substring(1))}var Et;async function ga(r){let t=new ua;k.serve.http2||t.use(pa()),F.SessionStore=async(i,n,o)=>k.middleware.session(i,n,o);let e=await ha(t,r);for(let i of k.general.importOnLoad)await i(t,Et.server,k);await Sn()?.(),t.all("*",da),await e(k.serve.port),console.log("App listing at port: "+k.serve.port)}async function da(r,t){r.method=="POST"?r.headers["content-type"]?.startsWith?.("application/json")?k.middleware.bodyParser(r,t,()=>Sr(r,t)):new fa.IncomingForm(k.middleware.formidable).parse(r,(e,i,n)=>{e&&P.error(e),r.fields=i,r.files=n,Sr(r,t)}):Sr(r,t)}async function ha(r,t){Et&&Et.close&&await Et.close();let{server:e,listen:i,close:n}=await t(r);return Et={server:e,close:n},i}async function yr({SitePath:r="Website",HttpServer:t=kn}={}){x.WebSiteFolder=r,xn(),await hr(),ga(t)}import Sa from"sql.js";import ya from"path";var Ot=class{constructor(t,e=10){this.hadChange=!1;this.loaded=!1;this.savePath=t??R+"SystemSave/DataBase.db",this.updateLocalFile=this.updateLocalFile.bind(this),setInterval(this.updateLocalFile,1e3*60*e),process.on("SIGINT",this.updateLocalFile),process.on("exit",this.updateLocalFile)}notLoaded(){if(!this.loaded)return C({errorName:"dn-not-loaded",text:"DataBase is not loaded, please use 'await db.load()'",type:"error"}),!0}async load(){let t=await m.mkdirIfNotExists(ya.dirname(this.savePath)),e=await Sa(),i;!t&&await m.existsFile(this.savePath)&&(i=await m.readFile(this.savePath,"binary")),this.db=new e.Database(i)}updateLocalFile(){!this.hadChange||(this.hadChange=!1,m.writeFile(this.savePath,this.db.export()))}buildQueryTemplate(t,e){let i="";for(let n in e)i+=t[n]+"?";return i+=t.at(-1),i}insert(t,...e){if(this.notLoaded())return;let i=this.db.prepare(this.buildQueryTemplate(t,e));try{let n=i.get(e)[0];return this.hadChange=!0,i.free(),n}catch(n){P.error(n)}}affected(t,...e){if(this.notLoaded())return;let i=this.db.prepare(this.buildQueryTemplate(t,e));try{i.run(e);let n=this.db.getRowsModified();return this.hadChange||=n>0,i.free(),n}catch(n){P.error(n)}}select(t,...e){if(this.notLoaded())return;let i=this.buildQueryTemplate(t,e);try{return this.db.exec(i)}catch(n){P.error(n)}}selectOne(t,...e){if(this.notLoaded())return;let i=this.db.prepare(this.buildQueryTemplate(t,e));try{i.step();let n=i.getAsObject();return i.free(),n}catch(n){P.error(n)}}};global.LocalSql=Ot;global.dump=P;var id=(r,t="async import")=>U(t,r,y.Static,k.development),nd=yr;export{id as AsyncImport,Ot as LocalSql,nd as Server,k as Settings,P as dump};
