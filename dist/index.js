var Vr=Object.freeze,Me=Object.defineProperty,bs=Object.defineProperties;var ws=Object.getOwnPropertyDescriptors;var zr=Object.getOwnPropertySymbols;var Ts=Object.prototype.hasOwnProperty,ks=Object.prototype.propertyIsEnumerable;var Gr=(r,t,e)=>t in r?Me(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,B=(r,t)=>{for(var e in t||(t={}))Ts.call(t,e)&&Gr(r,e,t[e]);if(zr)for(var e of zr(t))ks.call(t,e)&&Gr(r,e,t[e]);return r},I=(r,t)=>bs(r,ws(t));var Ps=(r,t)=>{for(var e in t)Me(r,e,{get:t[e],enumerable:!0})};var Vt=(r,t)=>Vr(Me(r,"raw",{value:Vr(t||r.slice())}));import{App as sl}from"@tinyhttp/app";import ol from"compression";import tt,{Dirent as dl}from"fs";var Qr=!0;function Xr(r){Qr=r}var b=new Proxy(console,{get(r,t,e){return t=="important"?r.error:Qr&&t!="do-nothing"?r[t]:()=>{}}});import vs from"path";function zt(r){return new Promise(t=>{tt.stat(r,(e,i)=>{t(Boolean(i))})})}function Zr(r,t,e,i={}){return new Promise(n=>{tt.stat(r,(s,o)=>{s&&!e&&b.error(s),n(t&&o?o[t]:o||i)})})}async function Cs(r,t=!0){return(await Zr(r,void 0,!0)).isFile?.()&&t}function Kr(r){return new Promise(t=>{tt.mkdir(r,e=>{e&&b.error(e),t(!e)})})}function As(r){return new Promise(t=>{tt.rmdir(r,e=>{e&&b.error(e),t(!e)})})}function Yr(r){return new Promise(t=>{tt.unlink(r,e=>{e&&b.error(e),t(!e)})})}async function _s(r){return await zt(r)?await Yr(r):!1}function Bs(r,t={}){return new Promise(e=>{tt.readdir(r,t,(i,n)=>{i&&b.error(i),e(n||[])})})}async function ti(r){return await zt(r)?!1:await Kr(r)}function ei(r,t){return new Promise(e=>{tt.writeFile(r,t,i=>{i&&b.error(i),e(!i)})})}async function Ms(r,t){try{return await ei(r,JSON.stringify(t))}catch(e){b.error(e)}return!1}function ri(r,t="utf8"){return new Promise(e=>{tt.readFile(r,t,(i,n)=>{i&&b.error(i),e(n||"")})})}async function Fs(r,t){try{return JSON.parse(await ri(r,t))}catch(e){b.error(e)}return{}}async function $s(r,t=""){if(r=vs.dirname(r),!await zt(t+r)){let e=r.split(/\\|\//),i="";for(let n of e)i.length&&(i+="/"),i+=n,await ti(t+i)}}var m=I(B({},tt.promises),{exists:zt,existsFile:Cs,stat:Zr,mkdir:Kr,mkdirIfNotExists:ti,writeFile:ei,writeJsonFile:Ms,readFile:ri,readJsonFile:Fs,rmdir:As,unlink:Yr,unlinkIfExists:_s,readdir:Bs,makePathReal:$s});import{cwd as Ds}from"process";import Zt from"path";import{fileURLToPath as Ls}from"url";function O(r,t){let e=t.indexOf(r);return e==-1?[t]:[t.substring(0,e),t.substring(e+r.length)]}function Gt(r,t){return t.substring(0,t.lastIndexOf(r))}function ii(r,t){for(;t.startsWith(r);)t=t.substring(r.length);for(;t.endsWith(r);)t=t.substring(0,t.length-r.length);return t}function Es(r){return Zt.dirname(Ls(r))}var D=Zt.join(Es(import.meta.url),"/SystemData"),Fe="WebSite",wt="WWW",Xt="Logs",ni="node_modules",Is=D+`/${wt}Compile/`,Rs=D+`/${Xt}Compile/`,Os=D+`/${ni}Compile/`,R=Ds()+"/";function $e(){return Zt.join(R,Fe,"/")}var Qt=$e();function Tt(r){return $e()+r+"/"}var d={Static:[Tt(wt),Is,wt],Logs:[Tt(Xt),Rs,Xt],node_modules:[Tt("node_modules"),Os,ni],get[wt](){return d.Static}},lt={page:"page",model:"mode",component:"inte"},S={pageTypes:lt,pageTypesArray:[],pageCodeFile:{page:[lt.page+".js",lt.page+".ts"],model:[lt.model+".js",lt.model+".ts"],component:[lt.component+".js",lt.component+".ts"]},pageCodeFileArray:[],partExtensions:["serv","api"],ReqFileTypes:{js:"serv.js",ts:"serv.ts","api-ts":"api.js","api-js":"api.ts"},ReqFileTypesArray:[],get WebSiteFolder(){return Fe},get fullWebSitePath(){return Qt},set WebSiteFolder(r){Fe=r,Qt=$e(),d.Static[0]=Tt(wt),d.Logs[0]=Tt(Xt)},get tsConfig(){return Qt+"tsconfig.json"},async tsConfigFile(){if(await m.existsFile(this.tsConfig))return await m.readFile(this.tsConfig)},relative(r){return Zt.relative(Qt,r)}};S.pageTypesArray=Object.values(S.pageTypes);S.pageCodeFileArray=Object.values(S.pageCodeFile).flat();S.ReqFileTypesArray=Object.values(S.ReqFileTypes);async function kt(r){let t=await m.readdir(r,{withFileTypes:!0});for(let e of t){let i=e.name;if(e.isDirectory()){let n=r+i+"/";await kt(n),await m.rmdir(n)}else await m.unlink(r+i)}}function ct(r){return Gt(".",O("/",r).pop())}import bi from"path";import{SourceMapGenerator as Ns,SourceMapConsumer as Ws}from"source-map";import Kt from"path";import{fileURLToPath as qs}from"url";import{SourceMapConsumer as si,SourceMapGenerator as js}from"source-map";function ut(r,t){let e=`sourceMappingURL=data:application/json;charset=utf-8;base64,${Buffer.from(r.toString()).toString("base64")}`;return t?e=`/*# ${e}*/`:e="//# "+e,`\r
`+e}async function oi(r,t){let e=await new si(t),i=new js;return(await new si(r)).eachMapping(n=>{let s=e.originalPositionFor({line:n.originalLine,column:n.originalColumn});!s.source||i.addMapping({generated:{column:n.generatedColumn,line:n.generatedLine},original:{column:s.column,line:s.line},source:s.source})}),i}var Yt=class{constructor(t,e=!0,i=!1,n=!1){this.filePath=t;this.httpSource=e;this.relative=i;this.isCss=n;this.lineCount=0;this.map=new Ns({file:t.split(/\/|\\/).pop()}),e||(this.fileDirName=Kt.dirname(this.filePath))}getSource(t){return t=t.split("<line>").pop().trim(),this.httpSource?(S.pageTypesArray.includes(Kt.extname(t).substring(1))?t+=".source":t=O("/",t).pop()+"?source=true",Kt.normalize((this.relative?"":"/")+t.replace(/\\/gi,"/"))):Kt.relative(this.fileDirName,S.fullWebSitePath+t)}getRowSourceMap(){return this.map.toJSON()}mapAsURLComment(){return ut(this.map,this.isCss)}},rt=class extends Yt{constructor(t,e=!0,i=!1,n=!0){super(t,n,!1,i);this.debug=e;this.storeString="";this.actionLoad=[]}notEmpty(){return this.actionLoad.length>0}addStringTracker(t,{text:e=t.eq}={}){this.actionLoad.push({name:"addStringTracker",data:[t,{text:e}]})}_addStringTracker(t,{text:e=t.eq}={}){if(!this.debug)return this._addText(e);let i=t.getDataArray(),n=i.length,s=!1;for(let o=0;o<n;o++){let{text:a,line:l,info:c}=i[o];if(a==`
`){this.lineCount++,s=!1;continue}!s&&l&&c&&(s=!0,this.map.addMapping({original:{line:l,column:0},generated:{line:this.lineCount,column:0},source:this.getSource(c)}))}this.storeString+=e}addText(t){this.actionLoad.push({name:"addText",data:[t]})}_addText(t){this.debug&&(this.lineCount+=t.split(`
`).length-1),this.storeString+=t}static fixURLSourceMap(t){for(let e=0;e<t.sources.length;e++)t.sources[e]=S.relative(qs(t.sources[e]));return t}addSourceMapWithStringTracker(t,e,i){this.actionLoad.push({name:"addSourceMapWithStringTracker",data:[t,e,i]})}async _addSourceMapWithStringTracker(t,e,i){if(!this.debug)return this._addText(i);(await new Ws(t)).eachMapping(n=>{let s=e.getLine(n.originalLine).getDataArray()[0];n.source==this.filePath?this.map.addMapping({source:this.getSource(n.source),original:{line:s.line,column:n.originalColumn},generated:{line:n.generatedLine+this.lineCount,column:n.generatedColumn}}):this.map.addMapping({source:this.getSource(n.source),original:{line:n.originalLine,column:n.originalColumn},generated:{line:n.generatedLine,column:n.generatedColumn}})}),this._addText(i)}async buildAll(){for(let{name:t,data:e}of this.actionLoad)switch(t){case"addStringTracker":this._addStringTracker(...e);break;case"addText":this._addText(...e);break;case"addSourceMapWithStringTracker":await this._addSourceMapWithStringTracker(...e);break}}mapAsURLComment(){return this.buildAll(),super.mapAsURLComment()}async createDataWithMap(){return await this.buildAll(),this.debug?this.storeString+super.mapAsURLComment():this.storeString}clone(){let t=new rt(this.filePath,this.debug,this.isCss,this.httpSource);return t.actionLoad.push(...this.actionLoad),t}};var De=class extends Yt{constructor(t,e=!1,i=!1){super(t,e,i);this.lineCount=1}addMappingFromTrack(t){let e=t.getDataArray(),i=e.length,n=!0;for(let s=0;s<i;s++){let{text:o,line:a,info:l}=e[s];if(o==`
`){this.lineCount++,n=!1;continue}!n&&a&&l&&(n=!0,this.map.addMapping({original:{line:a,column:0},generated:{line:this.lineCount,column:0},source:this.getSource(l)}))}}};function ai(r,t,e,i){let n=new De(t,e,i);return n.addMappingFromTrack(r),n.getRowSourceMap()}function li(r,t){let e=new De(t);return e.addMappingFromTrack(r),r.eq+e.mapAsURLComment()}var f=class{constructor(t,e){this.DataArray=[];this.InfoText=null;this.OnLine=1;this.OnChar=1;typeof t=="string"?this.InfoText=t:t&&this.setDefault(t),e&&this.AddFileText(e,this.DefaultInfoText.info)}static get emptyInfo(){return{info:"",line:0,char:0}}setDefault(t=this.DefaultInfoText){this.InfoText=t.info,this.OnLine=t.line,this.OnChar=t.char}getDataArray(){return this.DataArray}get DefaultInfoText(){return!this.DataArray.find(t=>t.info)&&this.InfoText!=null?{info:this.InfoText,line:this.OnLine,char:this.OnChar}:this.DataArray[this.DataArray.length-1]??f.emptyInfo}get StartInfo(){return this.DataArray[0]??this.DefaultInfoText}get OneString(){let t="";for(let e of this.DataArray)t+=e.text;return t}get eq(){return this.OneString}get lineInfo(){let t=this.DefaultInfoText,e=t.info.split("<line>");return e.push(S.fullWebSitePath+e.pop()),`${e.join("<line>")}:${t.line}:${t.char}`}get length(){return this.DataArray.length}Clone(){let t=new f(this.StartInfo);for(let e of this.DataArray)t.AddTextAfter(e.text,e.info,e.line,e.char);return t}AddClone(t){this.DataArray.push(...t.DataArray),this.setDefault({info:t.InfoText,line:t.OnLine,char:t.OnChar})}static concat(...t){let e=new f;for(let i of t)i instanceof f?e.AddClone(i):e.AddTextAfter(String(i));return e}ClonePlus(...t){return f.concat(this.Clone(),...t)}Plus(...t){let e=this.DefaultInfoText;for(let i of t)i instanceof f?(e=i.DefaultInfoText,this.AddClone(i)):this.AddTextAfter(String(i),e.info,e.line,e.char);return this}Plus$(t,...e){let i=this.DefaultInfoText;for(let n in e){let s=t[n],o=e[n];this.AddTextAfter(s,i?.info,i?.line,i?.char),o instanceof f?(this.AddClone(o),i=o.DefaultInfoText):o!=null&&this.AddTextAfter(String(o),i?.info,i?.line,i?.char)}return this.AddTextAfter(t[t.length-1],i?.info,i?.line,i?.char),this}AddTextAction(t,e,i=this.DefaultInfoText.info,n=0,s=1){let o=[];for(let a of[...t])o.push({text:a,info:i,line:n,char:s}),s++,a==`
`&&(n++,s=1);this.DataArray[e](...o)}AddTextAfter(t,e,i,n){return this.AddTextAction(t,"push",e,i,n),this}AddTextAfterNoTrack(t){for(let e of t)this.DataArray.push({text:e,info:"",line:0,char:0});return this}AddTextBefore(t,e,i,n){return this.AddTextAction(t,"unshift",e,i,n),this}AddTextBeforeNoTrack(t){let e=[];for(let i of t)e.push({text:i,info:"",line:0,char:0});return this.DataArray.unshift(...e),this}AddFileText(t,e=this.DefaultInfoText.info){let i=1,n=1;for(let s of[...t])this.DataArray.push({text:s,info:e,line:i,char:n}),n++,s==`
`&&(i++,n=1)}CutString(t=0,e=this.length){let i=new f(this.StartInfo);return i.DataArray.push(...this.DataArray.slice(t,e)),i}substring(t,e){return isNaN(e)?e=void 0:e=Math.abs(e),isNaN(t)?t=void 0:t=Math.abs(t),this.CutString(t,e)}substr(t,e){return t<0&&(t=this.length-t),this.substring(t,e!=null?e+t:e)}slice(t,e){return t<0&&(t=this.length-t),e<0&&(t=this.length-t),this.substring(t,e)}charAt(t){return t||(t=0),this.CutString(t,t+1)}at(t){return this.charAt(t)}charCodeAt(t){return this.charAt(t).OneString.charCodeAt(0)}codePointAt(t){return this.charAt(t).OneString.codePointAt(0)}*[Symbol.iterator](){for(let t of this.DataArray){let e=new f;e.DataArray.push(t),yield e}}getLine(t,e=!0){return this.split(`
`)[t-+e]}charLength(t){if(t<=0)return t;let e=0;for(let i of this.DataArray)if(e++,t-=i.text.length,t<=0)return e;return e}indexOf(t){return this.charLength(this.OneString.indexOf(t))}lastIndexOf(t){return this.charLength(this.OneString.lastIndexOf(t))}unicodeMe(t){let e="";for(let i of t)e+="\\u"+("000"+i.charCodeAt(0).toString(16)).slice(-4);return e}get unicode(){let t=new f;for(let e of this.DataArray)t.AddTextAfter(this.unicodeMe(e.text),e.info,e.line,e.char);return t}search(t){return this.charLength(this.OneString.search(t))}startsWith(t,e){return this.OneString.startsWith(t,e)}endsWith(t,e){return this.OneString.endsWith(t,e)}includes(t,e){return this.OneString.includes(t,e)}trimStart(){let t=this.Clone();t.setDefault();for(let e=0;e<t.DataArray.length;e++){let i=t.DataArray[e];if(i.text.trim()=="")t.DataArray.shift(),e--;else{i.text=i.text.trimStart();break}}return t}trimLeft(){return this.trimStart()}trimEnd(){let t=this.Clone();t.setDefault();for(let e=t.DataArray.length-1;e>=0;e--){let i=t.DataArray[e];if(i.text.trim()=="")t.DataArray.pop();else{i.text=i.text.trimEnd();break}}return t}trimRight(){return this.trimEnd()}trim(){return this.trimStart().trimEnd()}SpaceOne(t){let e=this.at(0),i=this.at(this.length-1),n=this.Clone().trim();return e.eq&&n.AddTextBefore(t||e.eq,e.DefaultInfoText.info,e.DefaultInfoText.line,e.DefaultInfoText.char),i.eq&&n.AddTextAfter(t||i.eq,i.DefaultInfoText.info,i.DefaultInfoText.line,i.DefaultInfoText.char),n}ActionString(t){let e=this.Clone();for(let i of e.DataArray)i.text=t(i.text);return e}toLocaleLowerCase(t){return this.ActionString(e=>e.toLocaleLowerCase(t))}toLocaleUpperCase(t){return this.ActionString(e=>e.toLocaleUpperCase(t))}toUpperCase(){return this.ActionString(t=>t.toUpperCase())}toLowerCase(){return this.ActionString(t=>t.toLowerCase())}normalize(){return this.ActionString(t=>t.normalize())}StringIndexer(t,e){t instanceof RegExp&&(t=new RegExp(t,t.flags.replace("g","")));let i=[],n=this.OneString,s=n.match(t),o=0,a=0;for(;(e==null||a<e)&&s?.[0]?.length;){let l=[...s[0]].length,c=this.charLength(s.index);i.push({index:c+o,length:l}),n=n.slice(s.index+s[0].length),o+=c+l,s=n.match(t),a++}return i}RegexInString(t){return t instanceof RegExp?t:new f("n",t).unicode.eq}split(t,e){let i=this.StringIndexer(this.RegexInString(t),e),n=[],s=0;for(let o of i)n.push(this.CutString(s,o.index)),s=o.index+o.length;return n.push(this.CutString(s)),n}repeat(t){let e=this.Clone();for(let i=0;i<t;i++)e.AddClone(this.Clone());return e}static join(t){let e=new f;for(let i of t)e.AddClone(i);return e}replaceWithTimes(t,e,i){let n=this.StringIndexer(t,i),s=new f,o=0;for(let a of n)s=s.ClonePlus(this.CutString(o,a.index),e),o=a.index+a.length;return s.AddClone(this.CutString(o)),s}replace(t,e){return this.replaceWithTimes(this.RegexInString(t),e,t instanceof RegExp?void 0:1)}replacer(t,e){let i=this.Clone(),n;function s(){n=i.match(t)}s();let o=new f(i.StartInfo);for(;n;)o.Plus(i.substring(0,n.index)),o.Plus(e(n)),i=i.substring(n.index+n[0].length),s();return o.Plus(i),o}async replacerAsync(t,e){let i=this.Clone(),n;function s(){n=i.match(t)}s();let o=new f(i.StartInfo);for(;n;)o.Plus(i.substring(0,n.index)),o.Plus(await e(n)),i=i.substring(n.index+n[0].length),s();return o.Plus(i),o}replaceAll(t,e){return this.replaceWithTimes(this.RegexInString(t),e)}matchAll(t){let e=this.StringIndexer(t),i=[];for(let n of e)i.push(this.substr(n.index,n.length));return i}match(t){if(t instanceof RegExp&&t.global)return this.matchAll(t);let e=this.OneString.match(t);if(e==null)return null;let i=[];i[0]=this.substr(e.index,e.shift().length),i.index=e.index,i.input=this.Clone();let n=i[0].Clone();for(let s in e){if(isNaN(Number(s)))break;let o=e[s];if(o==null){i.push(o);continue}let a=n.indexOf(o);i.push(n.substr(a,o.length)),n=n.substring(a)}return i}toString(){return this.OneString}extractInfo(t="<line>"){return this.DefaultInfoText.info.split(t).pop().trim()}debugLine({message:t,text:e,location:i,line:n,col:s}){let o=this.getLine(n??i?.line??1),a=s??i?.column??0;o.startsWith("//")&&(o=this.getLine((n??i?.line)-1),a=0);let l=o.at(a-1).DefaultInfoText;return`${e||t}, on file ->
${S.fullWebSitePath+o.extractInfo()}:${l.line}:${l.char}${i?.lineText?`
Line: "`+i.lineText.trim()+'"':""}`}StringWithTack(t){return li(this,t)}StringTack(t,e,i){return ai(this,t,e,i)}};import{promises as Us}from"fs";import{fileURLToPath as Js}from"url";var Hs="/../static/wasm/component/",Vs=new WebAssembly.Module(await Us.readFile(Js(import.meta.url+Hs+"build.wasm"))),zs=new WebAssembly.Instance(Vs,{}),W=zs.exports,pt=0,te=null;function Le(){return(te===null||te.buffer!==W.memory.buffer)&&(te=new Uint8Array(W.memory.buffer)),te}var Gs=typeof TextEncoder>"u"?(0,module.require)("util").TextEncoder:TextEncoder,ee=new Gs("utf-8"),Qs=typeof ee.encodeInto=="function"?function(r,t){return ee.encodeInto(r,t)}:function(r,t){let e=ee.encode(r);return t.set(e),{read:r.length,written:e.length}};function Pt(r,t,e){if(e===void 0){let a=ee.encode(r),l=t(a.length);return Le().subarray(l,l+a.length).set(a),pt=a.length,l}let i=r.length,n=t(i),s=Le(),o=0;for(;o<i;o++){let a=r.charCodeAt(o);if(a>127)break;s[n+o]=a}if(o!==i){o!==0&&(r=r.slice(o)),n=e(n,i,i=o+r.length*3);let a=Le().subarray(n+o,n+i);o+=Qs(r,a).written}return pt=o,n}var Xs=typeof TextDecoder>"u"?(0,module.require)("util").TextDecoder:TextDecoder,Zs=new Xs("utf-8",{ignoreBOM:!0,fatal:!0});Zs.decode();function ci(r,t){var e=Pt(r,W.__wbindgen_malloc,W.__wbindgen_realloc),i=pt,n=Pt(t,W.__wbindgen_malloc,W.__wbindgen_realloc),s=pt,o=W.find_end_block(e,i,n,s);return o}function ui(r,t){var e=Pt(r,W.__wbindgen_malloc,W.__wbindgen_realloc),i=pt,n=Pt(t,W.__wbindgen_malloc,W.__wbindgen_realloc),s=pt,o=W.find_end_of_def(e,i,n,s);return o}function pi(r,t){var e=Pt(r,W.__wbindgen_malloc,W.__wbindgen_realloc),i=pt,n=W.find_end_of_q(e,i,t.codePointAt(0));return n>>>0}var mi=["textarea","script","style"],fi=[["%","%"],["#{debug}","{debug}#"]];import Ys from"workerpool";import{cpus as to}from"os";var eo=Math.max(1,Math.floor(to().length/2)),et=Ys.pool(D+"/../static/wasm/component/workerInsertComponent.js",{maxWorkers:eo}),mt=class{static findEntOfQ(t,e){return pi(t,e)}static findEndOfDef(t,e){return Array.isArray(e)||(e=[e]),ui(t,JSON.stringify(e))}static FindEndOfBlock(t,e,i){return ci(t,e+i)}},Ee=class{constructor(t){this.printNew=t;this.SimpleSkip=mi;this.SkipSpecialTag=fi}printErrors(t,e){if(!!this.printNew)for(let i of JSON.parse(e).reverse())this.printNew({text:`
Warning, you didn't write right this tag: "${i.type_name}", used in: ${t.at(Number(i.index)).lineInfo}
(the system will auto close it)`,errorName:"close-tag"})}async FindCloseChar(t,e){let[i,n]=await et.exec("FindCloseChar",[t.eq,e]);return this.printErrors(t,n),i}async FindCloseCharHTML(t,e){let[i,n]=await et.exec("FindCloseCharHTML",[t.eq,e]);return this.printErrors(t,n),i}};async function gi(r){return JSON.parse(await et.exec("RazorToEJS",[r]))}async function di(r,t){return JSON.parse(await et.exec("RazorToEJSMini",[r,t]))}async function hi(r,t,e){return JSON.parse(await et.exec("EJSParser",[r,t,e]))}import ro from"workerpool";import{cpus as io}from"os";var no=Math.max(1,Math.floor(io().length/2)),Ie=ro.pool(D+"/../static/wasm/reader/worker.js",{maxWorkers:no});async function re(r){return JSON.parse(await Ie.exec("build_stream",[r]))}async function Re(r,t){return await Ie.exec("find_end_of_def_skip_block",[r,JSON.stringify(t)])}async function Si(r,t){return await Ie.exec("end_of_block",[r,t.join("")])}var yi=class{ReplaceAll(t,e,i){let n="";for(let s of t.split(e))n+=i+s;return n.substring(i.length)}},xi=class extends yi{constructor(t){super();this.ParseArray=t}BuildCode(){let t="";for(let e of this.ParseArray)t+=e.text;return this.ReplaceAll(t,"<|-|>","<||>")}},vt=class extends xi{constructor(t){super(t);this.DataCode={text:"",inputs:[]},this.CreateDataCode()}get CodeBuildText(){return this.DataCode.text}set CodeBuildText(t){this.DataCode.text=t}get AllInputs(){return this.DataCode.inputs}CreateDataCode(){for(let t of this.ParseArray)t.is_skip?(this.DataCode.text+=`<|${this.DataCode.inputs.length}|${t.type_name??""}|>`,this.DataCode.inputs.push(t.text)):this.DataCode.text+=t.text}BuildCode(){let t=this.DataCode.text.replace(/<\|([0-9]+)\|[\w]*\|>/gi,(e,i)=>this.DataCode.inputs[i]);return super.ReplaceAll(t,"<|-|>","<||>")}};var P=class{constructor(t,e,i="<%",n="%>",s="script"){this.start=i,this.text=t,this.end=n,this.type=s,this.path=e}ReplaceValues(t,e){this.text=this.text.replaceAll(t,e)}findEndOfDefGlobal(t){let e=t.eq,i=mt.findEndOfDef(e,[";",`
`,this.end]);return i!=-1?i+1:e.length}ScriptWithInfo(t){let e=new f(t.StartInfo),i=t.split(`
`),n=i.length;e.Plus(`
`);let s=1;for(let o of i)o.eq.trim().length&&e.Plus(new f(null,`//!${o.lineInfo}
`),o),s!=n&&(e.Plus(`
`),s++);return e}async findScripts(){let t=await hi(this.text.eq,this.start,this.end);this.values=[];for(let e of t){let i=this.text.substring(e.start,e.end),n=e.name;switch(e.name){case"print":i=new f().Plus$`write(${i});`,n="script";break;case"escape":i=new f().Plus$`writeSafe(${i});`,n="script";break;case"debug":i=new f().Plus$`\nrun_script_name = \`${P.fixText(i)}\`;`,n="no-track";break}this.values.push({text:i,type:n})}}static fixText(t){return t.replace(/\\/gi,"\\\\").replace(/`/gi,"\\`").replace(/\$/gi,"\\u0024")}static fixTextSimpleQuotes(t){return t.replace(/\\/gi,"\\\\").replace(/"/gi,'\\"')}ReBuildText(){let t=new f(this.values[0]?.text?.StartInfo);for(let e of this.values)e.type=="text"?e.text.eq!=""&&t.Plus(e.text):e.type=="no-track"?t.Plus(this.start,"!",e.text,this.end):t.Plus(this.start,e.text,this.end);return t}BuildAll(t){let e=new f(this.values[0]?.text?.StartInfo);if(!this.values.length)return e;for(let i of this.values)i.type=="text"?i.text.eq!=""&&e.Plus$`\nout_run_script.text+=\`${P.fixText(i.text)}\`;`:t&&i.type=="script"?e.Plus(new f(null,`
run_script_code=\`${P.fixText(i.text)}\`;`),this.ScriptWithInfo(i.text)):e.Plus(i.text);return e}static printError(t){return`<p style="color:red;text-align:left;font-size:16px;">${P.fixText(t)}</p>`}static async RunAndExport(t,e,i){let n=new P(t,e);return await n.findScripts(),n.BuildAll(i)}static split2FromEnd(t,e,i=1){for(let n=t.length-1;n>=0;n--)if(t[n]==e&&i--,i==0)return[t.substring(0,n),t.substring(n+1)];return[t]}},Ct=class{constructor(t=""){this.addText=t;this.savedBuildData=[];this.replacer=RegExp(`${t}\\/\\*!system--<\\|ejs\\|([0-9])\\|>\\*\\/|system--<\\|ejs\\|([0-9])\\|>`)}async load(t,e){this.buildCode=new vt(await re(await this.ExtractAndSaveCode(t))),this.path=e}async ExtractAndSaveCode(t){let e=new P(t,this.path);await e.findScripts();let i="",n=0;for(let s of e.values)s.type=="text"?i+=s.text:(this.savedBuildData.push({type:s.type,text:s.text}),i+=`system--<|ejs|${n++}|>`);return i}ParseOutsideOfComment(t){return t.replacer(/system--<\|ejs\|([0-9])\|>/,e=>{let i=e[1];return new f(i.StartInfo).Plus$`${this.addText}/*!system--<|ejs|${i}|>*/`})}async StartBuild(){let t=new P(new f(null,this.buildCode.CodeBuildText),this.path,"/*","*/");await t.findScripts();for(let e of t.values)e.type=="text"&&(e.text=this.ParseOutsideOfComment(e.text));return this.buildCode.CodeBuildText=t.ReBuildText().eq,this.buildCode.BuildCode()}RestoreAsCode(t){return new f(t.text.StartInfo).Plus$`<%${t.type=="no-track"?"!":""}${t.text}%>`}RestoreCode(t){return t.replacer(this.replacer,e=>{let i=Number(e[1]??e[2]);return this.RestoreAsCode(this.savedBuildData[i])})}};async function so(r,t){let e=new P(r,t,"<#{debug}","{debug}#>","debug info");await e.findScripts();let i=new f(r.DefaultInfoText);for(let n of e.values)n.type=="text"?i.Plus(n.text):i.Plus$`<%{?debug_file?}${n.text}%>`;return i}async function Ti(r,t){let e=new P(r,t,"<#{debug}","{debug}#>","debug info");await e.findScripts();let i=new f(r.DefaultInfoText);for(let n of e.values)n.type=="text"?i.Plus(n.text):i.Plus$`run_script_name=\`${P.fixText(n.text)}\`;`;return i}async function ki(r,t){let e=new P(r,t);await e.findScripts();for(let i of e.values)i.type=="text"?i.text=await so(i.text,t):i.text=await Ti(i.text,t);return e.start="<%",e.end="%>",e.ReBuildText()}async function Pi(r,t){return await Ti(r,t)}async function ht(r,t,e,i,n={}){return n.value||(n.value=await m.readFile(e,"utf8")),{allData:new f(`${t}<line>${i}`,r?`<%{%>${n.value}<%}%>`:n.value),stringInfo:`<%!
run_script_name=\`${P.fixText(t+" -> "+i)}\`;%>`}}function wi(r,t,e,i,n=0){if(i&&!t.endsWith("."+i)&&(t=`${t}.${i}`),t[0]=="^"){let[s,o]=O("/",t.substring(1));return(n==0?R:"")+`node_modules/${s}/${e}/${o}`}return t[0]=="."?(t[1]=="/"&&(t=t.substring(2)),t=`${bi.dirname(r)}/${t}`):t[0]=="/"?t=`${d.Static[n]}${t}`:t=`${n==0?R+S.WebSiteFolder+"/":""}${e}/${t}`,bi.normalize(t)}function St(r,t,e,i,n){return{SmallPath:wi(t,e,i,n,2),FullPath:wi(r,e,i,n)}}import{transform as ao}from"esbuild-wasm";import{SourceMapConsumer as oo}from"source-map";var ie={PreventErrors:[]},Oe=[],je=()=>Oe.length=0;function _({id:r,text:t,type:e="warn",errorName:i}){return!Oe.includes(r??t)&&!ie.PreventErrors.includes(i)?(Oe.push(r??t),[e=="error"?"important":e,t.replace(/<line>/gi," -> ")+`

Error-Code: ${i}

`]):["do-nothing"]}function At({errors:r},t){for(let e of r){let[i,n]=_({type:"error",errorName:"compilation-error",text:`${e.text}, on file -> ${t??e.location.file}:${e?.location?.line??0}:${e?.location?.column??0}`});b[i](n)}}async function vi({errors:r},t,e){let i=await new oo(t);for(let n of r){let s=i.originalPositionFor(n.location);s.source&&(n.location=s)}At({errors:r},e)}function ne(r,t){for(let e of r){let[i,n]=_({type:"warn",errorName:e.pluginName,text:`${e.text} on file -> ${t??e.location.file}:${e?.location?.line??0}:${e?.location?.column??0}`});b[i](n)}}function V(r,t){for(let e of t){let[i,n]=_({type:"warn",errorName:e.pluginName,text:r.debugLine(e)});b[i](n)}}function q(r,{errors:t}){for(let e of t){let[i,n]=_({errorName:"compilation-error",text:r.debugLine(e)});b[i](n)}}async function Ci(r,t){try{let{code:e,warnings:i}=await ao(r,{minify:!0});return V(t,i),e}catch(e){q(t,e)}return r}var lo="/serv/temp.js";async function co(r,t,e,i,n,s,o){let a=await P.RunAndExport(n,s,o);return new f().Plus$`function ${t}({${e}}, selector${i?` = "${i}"`:""}, out_run_script = {text: ''}){
        const {write, writeSafe, setResponse, sendToSelector} = new buildTemplate(out_run_script);
        ${await r(a)}
        var exports = ${t}.exports;
        return sendToSelector(selector, out_run_script.text);
    }\n${t}.exports = {};`}async function Ne(r,t,e,i,n,s){i=await n.StartReplace(i,r,s),s.script(lo,{async:null});let o=await co(s.BuildScriptWithPrams,e.popAnyTracker("name","connect"),e.popAnyTracker("params",""),e.popAnyDefault("selector",""),i,r,s.debug&&!n.SomePlugins("SafeDebug")),a=s.addScriptStylePage("script",e,t);return n.SomePlugins("MinJS")||n.SomePlugins("MinAll")?a.addText(await Ci(o.eq,i)):a.addStringTracker(o),{compiledString:new f}}import{transform as go}from"esbuild-wasm";import{SourceMapConsumer as uo}from"source-map";import{fileURLToPath as po}from"url";async function _t(r,t){let e=typeof t=="string"?JSON.parse(t):t,i=new f(null,r),n=i.split(`
`);return(await new uo(e)).eachMapping(s=>{let o=n[s.generatedLine-1];if(!o)return;let a=1;for(let l of o.substring(s.generatedColumn?s.generatedColumn-1:0).getDataArray())l.info=s.source,l.line=s.originalLine,l.char=a++}),i}function mo(r,t){let e=r.split(`
`);for(let i of t.getDataArray()){let{line:n,char:s,info:o}=e[i.line-1]?.DefaultInfoText??f.emptyInfo;i.line=n,i.info=o,i.char=s}}async function yt(r,t,e){let i=await _t(t,e);return mo(r,i),i}function fo(r,t,e){let i=r.split(`
`);for(let n of t.getDataArray())if(n.info==e){let{line:s,char:o,info:a}=i[n.line-1].at(n.char-1)?.DefaultInfoText??f.emptyInfo;n.line=s,n.info=a,n.char=o}else n.info&&(n.info=S.relative(po(n.info)))}async function Ai(r,t,e,i){let n=await _t(t,e);return fo(r,n,i),n}var Jc;async function We(r,t,e,i,n){let s=n,o=new Ct("serv");await o.load(n,t);let a=await o.StartBuild(),l=B({sourcefile:n.extractInfo(),minify:j("Min"+r.toUpperCase())||j("MinAll"),sourcemap:"external"},F("transformOptions"));try{switch(r){case"ts":l.loader="ts";break;case"jsx":l.loader="jsx",Object.assign(l,F("JSXOptions")??{});break;case"tsx":l.loader="tsx",Object.assign(l,F("TSXOptions")??{});break}let{map:c,code:u,warnings:p}=await go(a,l);V(n,p),s=o.RestoreCode(await _t(u,c))}catch(c){q(n,c)}return{compiledString:new f(e.DefaultInfoText).Plus$(Jc||(Jc=Vt(["<script",">","<\/script>"])),i.rebuildSpace(),s)}}import{transform as ho}from"esbuild-wasm";async function qe(r,t,e,i){let n=e.eq,s=n.trim(),o=t.popString("type")=="module",a=o?"scriptModule":"script";if(i.cache[a].includes(s))return{compiledString:new f};i.cache[a].push(s);let l="",c,u=B({sourcefile:e.extractInfo(),minify:j("Min"+r.toUpperCase())||j("MinAll"),sourcemap:i.debug?"external":!1},F("transformOptions"));try{switch(r){case"ts":u.loader="ts";break;case"jsx":u.loader="jsx",Object.assign(u,F("JSXOptions")??{});break;case"tsx":u.loader="tsx",Object.assign(u,F("TSXOptions")??{});break}let{map:g,code:h,warnings:y}=await ho(e.eq,u);V(e,y),l=h,c=g}catch(g){q(e,g)}let p=i.addScriptStylePage(o?"module":"script",t,e);return c?p.addSourceMapWithStringTracker(JSON.parse(c),e,l):p.addText(l),{compiledString:new f}}var eu;async function Ue(r,t,e,i,n){if(e.exists("src"))return{compiledString:new f(t.DefaultInfoText).Plus$(eu||(eu=Vt(["<script",">","<\/script>"])),e.rebuildSpace(),i)};let s=e.popAnyDefault("lang","js");return e.popBoolean("server")?We(s,r,t,e,i):qe(s,e,i,n)}import{fileURLToPath as Je,pathToFileURL as He}from"url";import _i from"sass";function Bt(r){return{findFileUrl(t){return t[0]=="/"||t[0]=="~"?new URL(t.substring(1),He(t[0]=="/"?d.Static[0]:d.node_modules[0])):new URL(t,He(r))}}}function Bi(r){return["scss","sass"].includes(r)?j("MinAll","MinSass"):j("MinCss","MinAll")}function se(r){return Bi(r)?"compressed":"expanded"}function Mt(r){return r=="sass"?"indented":r}function Ve(r,t){if(!!r)for(let e in r.sources)r.sources[e].startsWith("data:")&&(r.sources[e]=t)}function Mi({sassStack:r}){let t=r.match(/[0-9]+:[0-9]+/)[0].split(":").map(e=>Number(e));return{line:t[0],column:t[1]}}function ze(r,{line:t,column:e}=Mi(r)){let[i,n]=_({text:`${r.message},
on file -> ${Je(r.span.url)}:${t??0}:${e??0}`,errorName:r?.status==5?"sass-warning":"sass-error",type:r?.status==5?"warn":"error"});b[i](n)}function Ge(r,t){if(r.span.url)return ze(r);r.location=Mi(r);let[e,i]=_({text:t.debugLine(r),errorName:r?.status==5?"sass-warning":"sass-error",type:r?.status==5?"warn":"error"});b[e](i)}async function oe(r,t,e,i=t.eq){let n=S.fullWebSitePath+t.extractInfo(),s=He(n),o=Bi(r),a;try{a=await _i.compileStringAsync(i,{sourceMap:e.debug,syntax:Mt(r),style:o?"compressed":"expanded",importer:Bt(n),logger:_i.Logger.silent}),i=a?.css??i}catch(l){if(l.span.url){let c=Je(l.span.url);await e.dependence(S.relative(c),c)}return Ge(l,t),{outStyle:"Sass Error (see console)"}}if(a?.loadedUrls)for(let l of a.loadedUrls){let c=Je(l);await e.dependence(S.relative(c),c)}return a?.sourceMap&&Ve(a.sourceMap,s.href),{result:a,outStyle:i,compressed:o}}async function Qe(r,t,e,i,n,s){let o=new Ct;await o.load(n.trimStart(),t);let{outStyle:a,compressed:l}=await oe(r,n,s,await o.StartBuild());l||(a=`
${a}
`);let c=o.RestoreCode(new f(n.StartInfo,a));return{compiledString:new f(e.DefaultInfoText).Plus$`<style${i.rebuildSpace()}>${c}</style>`}}async function Xe(r,t,e,i){let n=e.eq.trim();if(i.cache.style.includes(n))return{compiledString:new f};i.cache.style.push(n);let{result:s,outStyle:o}=await oe(r,e,i),a=i.addScriptStylePage("style",t,e);return s?.sourceMap?a.addSourceMapWithStringTracker(rt.fixURLSourceMap(s.sourceMap),e,o):a.addStringTracker(e,{text:o}),{compiledString:new f}}async function Ze(r,t,e,i,n){let s=e.popAnyDefault("lang","css");return e.popBoolean("server")?Qe(s,r,t,e,i,n):Xe(s,e,i,n)}import Fi from"path";var z=class{constructor(t,e=!0){this.store={};this.savePath=`${D}/${t}.json`,e&&this.loadFile(),process.on("SIGINT",()=>{this.save(),setTimeout(()=>process.exit())}),process.on("exit",this.save.bind(this))}async loadFile(){await m.existsFile(this.savePath)&&(this.store=JSON.parse(await m.readFile(this.savePath)||"{}"))}update(t,e){this.store[t]=e}have(t,e){let i=this.store[t];return i||!e||(i=e(),this.update(t,i)),i}clear(){for(let t in this.store)this.store[t]=void 0,delete this.store[t]}save(){return m.writeJsonFile(this.savePath,this.store)}};var G=new z("PagesInfo");async function it(r,t=G.store[r]){for(let e in t){let i=S.fullWebSitePath+(e=="thisPage"?r:e);if(await m.stat(i,"mtimeMs",!0)!=t[e])return!0}return!t}function So(r,t){return r[0]=="."&&(r=Fi.join(t,"/../",r)),Fi.extname(r)||(r+="."+S.pageTypes.page),r}var Ke={};async function Ye(r,t,e,i,n,s){let o=e.popHaveDefault("from"),a=So(o,ct(t.extractInfo())),l=d.Static[0]+a,c=d.Static[2]+"/"+a;if(!(await m.stat(l,null,!0)).isFile?.()){let[g,h]=_({text:`
Page not found: ${t.at(0).lineInfo} -> ${l}`,errorName:"page-not-found",type:"error"});return b[g](h),{compiledString:new f(t.DefaultInfoText,P.printError(`Page not found: ${S.relative(t.lineInfo)} -> ${c}`))}}let u,p=Ke[a];if(!p||await it(null,p.newSession.dependencies)){let{CompiledData:g,sessionInfo:h}=await tr(a,d.Static,{nestedPage:r,nestedPageData:e.popHaveDefault("object")});h.dependencies[c]=h.dependencies.thisPage,delete h.dependencies.thisPage,s.extends(h),Ke[a]={CompiledData:g,newSession:h},u=g}else{let{CompiledData:g,newSession:h}=Ke[a];Object.assign(s.dependencies,h.dependencies),s.extends(h),u=g}return{compiledString:u}}async function er(r){let t=new f(r.StartInfo);return t.Plus$`<%{%>${r}<%}%>`,{compiledString:t,checkComponents:!0}}import{relative as Fo}from"path";function Ft(r,t=10){return Buffer.from(r).toString("base64").substring(0,t).replace(/\+/,"_").replace(/\//,"_")}import ji from"path";import{transform as wo}from"esbuild-wasm";import{extname as To}from"path";import Ei from"sass";import{v4 as ko}from"uuid";import Po from"path";import{fileURLToPath as vo}from"url";import{transform as xo}from"esbuild-wasm";function $i(r){return m.readJsonFile(r)}import{promises as yo}from"fs";async function Di(r){let t=new WebAssembly.Module(await yo.readFile(r));return new WebAssembly.Instance(t,{}).exports}var ae=["json","wasm"];async function rr(r,t){switch(t){case"json":return $i(r);case"wasm":return Di(r);default:return import(r)}}var nt=class{async load(t){let e=await re(t);this.Build=new vt(e),this.actionStringExport=this.actionStringExport.bind(this),this.actionStringExportAll=this.actionStringExportAll.bind(this)}actionStringImport(t,e,i){return`const ${e} = await ${t}(<|${i}||>)`}actionStringExport(t,e,i){return`${this.actionStringImport(t,e,i)};Object.assign(exports, ${e})`}actionStringImportAll(t,e){return`await ${t}(<|${e}||>)`}actionStringExportAll(t,e){return`Object.assign(exports, ${this.actionStringImportAll(t,e)})`}BuildImportType(t,e=t,i=this.actionStringImport){let n="",s=this.Build.CodeBuildText,o;function a(){o=s.match(new RegExp(`${t}[ \\n]+([\\*]{0,1}[\\p{L}0-9_,\\{\\} \\n]+)[ \\n]+from[ \\n]+<\\|([0-9]+)\\|\\|>`,"u"))}for(a();o;){let l=o[1].trim();n+=s.substring(0,o.index),s=s.substring(o.index+o[0].length);let c;if(l[0]=="*")c=l.substring(1).replace(" as ","").trimStart();else{let u=[];if(l[0]=="{"?(u=l.split("}",2),u[0]+="}",u[1]&&(u[1]=u[1].split(",").pop())):u=l.split(",",1).reverse(),u=u.map(p=>p.trim()).filter(p=>p.length),u.length==1)if(u[0][0]=="{")c=u[0];else{let p=this.Build.AllInputs[o[2]];p=p.substring(p.lastIndexOf(".")+1,p.length-1),ae.includes(p)?c=u[0]:c=`{default:${u[0]}}`}else c=u[0],c=`${c.substring(0,c.length-1)},default:${u[1]}}`;c=c.replace(/ as /,":")}n+=i(e,c,o[2]),a()}n+=s,this.Build.CodeBuildText=n}BuildInOneWord(t,e=t,i=this.actionStringImportAll){let n="",s=this.Build.CodeBuildText,o;function a(){o=s.match(new RegExp(t+"[ \\n]+<\\|([0-9]+)\\|\\|>"))}for(a();o;)n+=s.substring(0,o.index),s=s.substring(o.index+o[0].length),n+=i(e,o[1]),a();n+=s,this.Build.CodeBuildText=n}replaceWithSpace(t){this.Build.CodeBuildText=t(" "+this.Build.CodeBuildText).substring(1)}Define(t){for(let[e,i]of Object.entries(t))this.replaceWithSpace(n=>n.replace(new RegExp(`([^\\p{L}])${e}([^\\p{L}])`,"gui"),(...s)=>s[1]+i+s[2]))}BuildInAsFunction(t,e){this.replaceWithSpace(i=>i.replace(new RegExp(`([^\\p{L}])${t}([ \\n]*\\()`,"gui"),(...n)=>n[1]+e+n[2]))}async exportVariable(){let t=this.Build.CodeBuildText,e;function i(){e=t.match(/(export[ \n]+)(var|let|const)[ \n]+([\p{L}\$_][\p{L}0-9\$_]*)/u)}for(i();e;){let n=t.substring(0,e.index),s=e[0].substring(e[1].length),o=t.substring(e.index+e[0].length),a=await Re(o,[";",`
`]);a==-1&&(a=o.length);let l=o.substring(0,a),c=o.substring(a);t=`${n+s+l};exports.${e[3]}=${e[3]}${c}`,i()}this.Build.CodeBuildText=t}async exportBlock(){let t=this.Build.CodeBuildText,e;function i(){e=t.match(/(export[ \n]+)(default[ \n]+)?([^ \n])/u)}for(i();e;){let n=t.substring(0,e.index),s=e[0].substring(e[1].length+(e[2]||"").length),o=e[3][0],a=Boolean(e[2]);if(o=="{"){let l=t.substring(e.index+e[0].length);if(a)t=n+"exports.default="+s+l;else{let c=await Si(l,["{","}"]);n+=`Object.assign(exports, ${s+l.substring(0,c+1)})`,t=n+l.substring(c+1)}}else{let l=t.substring(e.index+e[0].length-1);s=s.slice(0,-1);let c=await Re(l,[";",`
`]);c==-1&&(c=l.trimEnd().length);let u=l.substring(0,c),p=u.match(/(function|class)[ |\n]+([\p{L}\$_][\p{L}0-9\$_]*)?/u);if(p?.[2]){let g=l.substring(c);t=`${n+s+u}exports.${a?"default":p[2]}=${p[2]}${g}`}else a?t=n+"exports.default="+s+l:t=`${n}exports.${u.split(/ |\n/,1).pop()}=${s+l}`}i()}this.Build.CodeBuildText=t}async BuildImports(t){this.BuildImportType("import","require"),this.BuildImportType("export","require",this.actionStringExport),this.BuildImportType("include"),this.BuildInOneWord("import","require"),this.BuildInOneWord("export","require",this.actionStringExportAll),this.BuildInOneWord("include"),this.BuildInAsFunction("import","require"),await this.exportVariable(),await this.exportBlock(),t&&this.Define(t)}BuiltString(){return this.Build.BuildCode()}static async BuildAndExportImports(t,e){let i=new nt;return await i.load(` ${t} `),await i.BuildImports(e),t=i.BuiltString(),t.substring(1,t.length-1)}};function bo(r){return`module.exports = () => (DataObject) => DataObject.out_run_script.text += \`${P.printError(`Syntax Error: ${P.fixTextSimpleQuotes(r.replaceAll(`
`,"<br/>"))}`)}\``}async function ir(r,t,e){r=r.trim();let i={format:"cjs",loader:t?"ts":"js",sourcemap:e.debug,sourcefile:e.smallPath,define:{debug:""+e.debug}},n;try{let{code:s,map:o,warnings:a}=await xo(await nt.BuildAndExportImports(r.eq),i);V(r,a),n=o?await yt(r,s,o):new f(null,s)}catch(s){if(q(r,s),e.debug){let o=s.errors[0];o.location&&(o.location.lineText=null),n=new f(null,bo(r.debugLine(o)))}}return n}var Li=new z("ShortScriptNames"),ft=class{constructor(t,e,i,n,s){this.smallPath=t;this.fullPath=e;this.typeName=i;this.debug=n;this._safeDebug=s;this.connectorArray=[];this.scriptURLSet=[];this.styleURLSet=[];this.inScriptStyle=[];this.headHTML="";this.cache={style:[],script:[],scriptModule:[]};this.cacheCompileScript={};this.cacheComponent={};this.compileRunTimeStore={};this.dependencies={};this.recordNames=[];this.BuildScriptWithPrams=this.BuildScriptWithPrams.bind(this)}get safeDebug(){return this.debug&&this._safeDebug}style(t,e){this.styleURLSet.find(i=>i.url==t&&JSON.stringify(i.attributes)==JSON.stringify(e))||this.styleURLSet.push({url:t,attributes:e})}script(t,e){this.scriptURLSet.find(i=>i.url==t&&JSON.stringify(i.attributes)==JSON.stringify(e))||this.scriptURLSet.push({url:t,attributes:e})}record(t){this.recordNames.includes(t)||this.recordNames.push(t)}async dependence(t,e=S.fullWebSitePath+t){if(this.dependencies[t])return;let i=await m.stat(e,"mtimeMs",!0,null);if(i)return this.dependencies[t]=i,!0}addScriptStyle(t,e=this.smallPath){let i=this.inScriptStyle.find(n=>n.type==t&&n.path==e);return i||(i={type:t,path:e,value:new rt(e,this.safeDebug,t=="style",!0)},this.inScriptStyle.push(i)),i.value}addScriptStylePage(t,e,i){return this.addScriptStyle(t,e.popString("page")?this.smallPath:i.extractInfo())}static createName(t){let e=0,i,n=Object.values(Li.store);for(;i==null||n.includes(i);)i=Ft(t,5+e).substring(e),e++;return i}async addHeadTags(){let t=this.typeName==d.Logs[2];for(let e of this.inScriptStyle){let i=t&&e.path==this.smallPath,n=i?d.Logs[1]:d.Static[1],s=i?"?t=l":"",o=Li.have(e.path,()=>ft.createName(e.path))+".pub";switch(e.type){case"script":o+=".js",this.script("/"+o+s,{defer:null});break;case"module":o+=".mjs",this.script("/"+o+s,{type:"module"});break;case"style":o+=".css",this.style("/"+o+s);break}m.writeFile(n+o,await e.value.createDataWithMap())}}async buildHead(){await this.addHeadTags();let t=i=>i.attributes?" "+Object.keys(i.attributes).map(n=>i.attributes[n]?n+`="${i.attributes[n]}"`:n).join(" "):"",e="";for(let i of this.styleURLSet)e+=`<link rel="stylesheet" href="${i.url}"${t(i)}/>`;for(let i of this.scriptURLSet)e+=`<script src="${i.url}"${t(i)}><\/script>`;return e+this.headHTML}extends(t){this.connectorArray.push(...t.connectorArray),this.scriptURLSet.push(...t.scriptURLSet),this.styleURLSet.push(...t.styleURLSet);for(let i of t.inScriptStyle)this.inScriptStyle.push(I(B({},i),{value:i.value.clone()}));let e=["cacheCompileScript","cacheComponent","dependencies"];for(let i of e)Object.assign(this[i],t[i]);this.recordNames.push(...t.recordNames.filter(i=>!this.recordNames.includes(i))),this.headHTML+=t.headHTML,this.cache.style.push(...t.cache.style),this.cache.script.push(...t.cache.script),this.cache.scriptModule.push(...t.cache.scriptModule)}BuildScriptWithPrams(t){return ir(t,gt(),this)}};async function Co(r,t,e){try{let{css:i,sourceMap:n,loadedUrls:s}=await Ei.compileStringAsync(r.eq,{syntax:Mt(t),style:se(t),importer:Bt(e),logger:Ei.Logger.silent,sourceMap:!0});return{code:await Ai(r,i,n,n.sources.find(o=>o.startsWith("data:"))),dependencies:s.map(o=>vo(o))}}catch(i){Ge(i,r)}return{code:new f}}async function Ao(r,t,e,i=""){let n={};if(r=r.replacer(/((import({|[ ]*\(?)|((import[ ]*type|import|export)({|[ ]+)[\W\w]+?(}|[ ]+)from))(}|[ ]*))(["|'|`])([\W\w]+?)\9([ ]*\))?/m,s=>{if(t=="ts"&&s[5].endsWith(" type"))return s[0];let o=To(s[10].eq);o==""&&(t=="ts"?s[10].AddTextAfterNoTrack(".ts"):s[10].AddTextAfterNoTrack(".js"));let a=s[1].Plus(s[9],s[10],o==".svelte"?i:"",s[9],s[11]??"");if(o==".svelte")e.push(s[10].eq);else if(t!=="ts"||!s[4])return a;let l=ko();return n[l]=a,new f(null,`___toKen\`${l}\``)}),t!=="ts")return r;try{let{code:s,map:o}=await wo(r.eq,I(B({},F("transformOptions")),{loader:"ts",sourcemap:!0}));r=await yt(r,s,o)}catch(s){return q(r,s),new f}return r=r.replacer(/___toKen`([\w\W]+?)`/mi,s=>n[s[1].eq]??new f),r}async function le(r,t,e=t,i=!0,n=""){let s=new f(t,await m.readFile(r)),o="js",a="css",l=[],c=[];s=await s.replacerAsync(/(<script)[ ]*( lang=('|")?([A-Za-z]+)('|")?)?[ ]*(>\n?)(.*?)(\n?<\/script>)/s,async y=>(o=y[4]?.eq??"js",y[1].Plus(y[6],await Ao(y[7],o,l,n),y[8])));let u=l.map(y=>`@import "${y}.css";`).join(""),p=!1;s=await s.replacerAsync(/(<style)[ ]*( lang=('|")?([A-Za-z]+)('|")?)?[ ]*(>\n?)(.*?)(\n?<\/style>)/s,async y=>{if(a=y[4]?.eq??"css",a=="css")return y[0];let{code:T,dependencies:k}=await Co(y[7],a,r);return k&&c.push(...k),p=!0,u&&T.AddTextBeforeNoTrack(u),y[1].Plus(y[6],T,y[8])}),!p&&u&&s.AddTextAfterNoTrack(`<style>${u}</style>`);let g=new ft(t,r),h=[g.dependence(t,r)];for(let y of c)h.push(g.dependence(S.relative(y),y));return{scriptLang:o,styleLang:a,code:s.eq,map:s.StringTack(e,i),dependencies:g.dependencies,svelteFiles:l.map(y=>y[0]=="/"?d.Static[0]+y:Po.normalize(r+"/../"+y))}}function ce(r){return r[0].toUpperCase()+r.slice(1)}import*as Ni from"svelte/compiler";import{createRequire as _o}from"module";import nr from"clear-module";import Bo from"path";var Ii=_o(import.meta.url),Ri=r=>Ii.resolve(r);function st(r){r=Bo.normalize(r);let t=Ii(r);return nr(r),t}import{SourceMapConsumer as Mo}from"source-map";var sr=class{constructor(t){this.map=new Mo(t)}async getLocation(t){let{line:e,column:i}=(await this.map).originalPositionFor(t);return`${e}:${i}`}};async function Oi({message:r,code:t,start:e,frame:i},n,s){let o=new sr(s),[a,l]=_({errorName:"svelte-"+t,type:"error",text:`${r}
${i}
${n}:${await o.getLocation(e)}`});b[a](l)}async function ue(r,t,e){let i=new sr(e);for(let{message:n,code:s,start:o,frame:a}of r){let[l,c]=_({errorName:"svelte-"+s,type:"warn",text:`${n}
${a}
${t}:${await i.getLocation(o)}`});b[l](c)}}async function pe(r,t,e){let i=ji.parse(r).name.replace(/^\d/,"_$&").replace(/[^a-zA-Z0-9_$]/g,""),n={filename:r,name:ce(i),generate:"ssr",format:"cjs",dev:e.debug,errorMode:"warn"},s=ji.relative(d.Static[2],t),o=d.Static[1]+s,a=o+".ssr.cjs",{svelteFiles:l,code:c,map:u,dependencies:p}=await le(r,t,a,!1,".ssr.cjs");Object.assign(e.dependencies,p),n.sourcemap=u;let g=[];for(let k of l)nr(Ri(k)),g.push(pe(k,S.relative(k),e));await Promise.all(g);let{js:h,css:y,warnings:T}=Ni.compile(c,n);return ue(T,r,u),await m.writeFile(a,h.code),y.code&&(y.map.sources[0]="/"+s.split(/\/|\//).pop()+"?source=true",y.code+=ut(y.map,!0)),await m.writeFile(o+".css",y.code??""),a}async function $o(dataTag,FullPath,smallPath,sessionInfo){let getV=name=>{let gv=r=>dataTag.popAnyDefault(r,"").trim(),value=gv("ssr"+ce(name))||gv(name);return value?eval(`({${value}})`):{}},buildPath=await pe(FullPath,smallPath,sessionInfo),mode=await st(buildPath),{html,head}=mode.default.render(getV("props"),getV("options"));return sessionInfo.headHTML+=head,html}async function or(r,t,e){let i=r.extractInfo(),n=S.fullWebSitePath+i,{SmallPath:s,FullPath:o}=St(n,i,t.popHaveDefault("from"),d.Static[2],"svelte"),a=Fo(d.Static[2],s).replace(/\\/gi,"/");e.style("/"+a+".css");let l=t.popAnyDefault("id",Ft(a)),c=g=>{let h=t.popAnyDefault(g,"").trim();return h?`,${g}:{${h}}`:""},u=t.popHaveDefault("selector"),p=!u&&t.popBoolean("ssr")?await $o(t,o,s,e):"";return e.addScriptStylePage("module",t,r).addText(`import App${l} from '/${a}';
const target${l} = document.querySelector("${u||"#"+l}");
target${l} && new App${l}({
    target: target${l}
    ${c("props")+c("options")}${p?", hydrate: true":""}
});`),{compiledString:new f(null,u?"":`<div id="${l}">${p}</div>`),checkComponents:!0}}import Do from"markdown-it";import Wi from"highlight.js";import $t from"path";import qi from"markdown-it-anchor";import Lo from"@sindresorhus/slugify";import Eo from"markdown-it-attrs";import Io from"markdown-it-abbr";function Ro(r,t){function e(i){return(...n)=>{let s=i(...n);return`<div class="code-copy">
                <div>
                    <a href="#copy-clipboard" onclick="markdownCopy(this)">${t}</a>
                </div>
                ${s}
            </div>`}}r.renderer.rules.code_block=e(r.renderer.rules.code_block),r.renderer.rules.fence=e(r.renderer.rules.fence)}async function ar(r,t,e,i,n){let s=i.GetPlugin("markdown"),o=t.popBoolean("hljs-class",s?.hljsClass??!0)?' class="hljs"':"",a=!1,l=Do({html:!0,xhtmlOut:!0,linkify:t.popBoolean("linkify",s?.linkify),breaks:t.popBoolean("breaks",s?.breaks??!0),typographer:t.popBoolean("typographer",s?.typographer??!0),highlight:function(x,C){if(C&&Wi.getLanguage(C)){a=!0;try{return`<pre${o}><code>${Wi.highlight(x,{language:C,ignoreIllegals:!0}).value}</code></pre>`}catch($){let[A,v]=_({text:$,type:"error",errorName:"markdown-parser"});b[A](v)}}return`<pre${o}><code>${l.utils.escapeHtml(x)}</code></pre>`}}),c=t.popAnyDefault("copy-code",s?.copyCode??"\u{1F4CB}");c&&l.use(x=>Ro(x,c)),t.popBoolean("header-link",s?.headerLink??!0)&&l.use(qi,{slugify:x=>Lo(x),permalink:qi.permalink.headerLink()}),t.popBoolean("attrs",s?.attrs??!0)&&l.use(Eo),t.popBoolean("abbr",s?.abbr??!0)&&l.use(Io);let u=e?.eq||"",p=t.popAnyDefault("file","./markdown");if(!u?.trim?.()&&p){let x=p[0]=="/"?$t.join(d.Static[2],p):$t.join($t.dirname(r.extractInfo("<line>")),p);$t.extname(x)||(x+=".serv.md");let C=$t.join(S.fullWebSitePath,x);u=await m.readFile(C),await n.dependence(x,C)}let g=l.render(u),h=new f(r.DefaultInfoText),y=await jo(t.popString("code-theme")||s?.codeTheme||"atom-one");if(a){if(y!="none"){let x="/serv/md/code-theme/"+y+".css";n.style(x)}c&&n.script("/serv/md.js")}t.addClass("markdown-body");let T=t.popAnyDefault("theme",s?.theme??"auto"),k="/serv/md/theme/"+T+".css";return T!="none"&&n.style(k),h.Plus$`<div${t.rebuildSpace()}>${g}</div>`,{compiledString:h,checkComponents:!1}}var km=R+"node_modules/github-markdown-css/github-markdown";function Oo(r,t){let[e,i,n]=r.split(/(}|\*\/).hljs{/),s=r[e.length]=="}"?"}":"*/";return[e+s,".hljs{"+(n??i),".hljs{"+t.split(/(}|\*\/).hljs{/).pop()]}var me=R+"node_modules/highlight.js/styles/";async function jo(r){let t=r.split("|");if(t.length==1)return r;let e=t[2]||t.slice(0,2).join("~").replace("/","-");if(await m.existsFile(me+e+".css"))return e;let i=await m.readFile(me+t[0]+".css"),n=await m.readFile(me+t[1]+".css"),[s,o,a]=Oo(n,i),l=`${s}@media(prefers-color-scheme:dark){${o}}@media(prefers-color-scheme:light){${a}}`;return await m.writeFile(me+e+".css",l),e}async function lr(r,t,e,i,n,s){return{compiledString:new f(t.DefaultInfoText).Plus$`<head${e.rebuildSpace()}>${await n.StartReplace(i,r,s)}@DefaultInsertBundle</head>`,checkComponents:!1}}async function Ui(r,t,e){let i=await t.buildHead(),n=[/@InsertBundle(;?)/,/@DefaultInsertBundle(;?)/],s=()=>(n.forEach(l=>r=r.replace(l,"")),r);if(!i)return s();let o=new f(null,i),a=!1;for(let l=0;l<n.length&&!a;l++)r=r.replacer(n[l],()=>(a=!0)&&o);return a?s():r.Plus$`\nout_run_script.text+='${o}';`}var Ji=["number","num","integer","int"],Hi=["boolean","bool"],No=["email","string","text",...Ji,...Hi],Wo=/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/,fe={"string-length-range":[/^[0-9]+-[0-9]+$/,r=>r.split("-").map(t=>Number(t)),([r,t],e)=>e.length>=r&&e.length<=t,"string"],"number-range":[/^[0-9]+..[0-9]+$/,r=>r.split("..").map(t=>Number(t)),([r,t],e)=>e>=r&&e<=t,"number"],"multiple-choice-string":[/^string|text+[ ]*=>[ ]*(\|?[^|]+)+$/,r=>r.split("=>").pop().split("|").map(t=>`"${t.trim().replace(/"/gi,'\\"')}"`),(r,t)=>r.includes(t),"string"],"multiple-choice-number":[/^number|num|integer|int+[ ]*=>[ ]*(\|?[^|]+)+$/,r=>r.split("=>").pop().split("|").map(t=>parseFloat(t)),(r,t)=>r.includes(t),"number"]},cr=[...Ji];for(let r in fe){let t=fe[r][3];cr.includes(t)&&cr.push(r)}function ge(r){if(r=r.toLowerCase().trim(),No.includes(r))return`["${r}"]`;for(let[t,[e,i]]of Object.entries(fe))if(e.test(r))return`["${t}", ${i(r)}]`;return`[${r}]`}async function de(r,t){for(let e in t){let[i,...n]=t[e],s=r[e],o=!1,a=!1;switch(i){case"number":case"num":o=typeof s!="number";break;case"boolean":case"bool":o=typeof s!="boolean";break;case"integer":case"int":o=!Number.isInteger(s);break;case"string":case"text":o=typeof s!="string";break;case"email":o=!Wo.test(s);break;default:{let l=s!=null&&fe[i];if(l){o=!l[2](n,s);break}a=!0,i instanceof RegExp?o=i.test(s):typeof i=="function"&&(o=!await i(s))}}if(o){let l=`failed at ${e} filed - ${a?o:"expected "+i}`;return n.length&&(l+=`, arguments: ${JSON.stringify(n)}`),l+=`, input: ${JSON.stringify(s)}`,[l,i,n,s]}}return!0}function Vi(r,t){let e=[];for(let i in t){let[n]=t[i],s=r[i];cr.includes(n)?e.push(parseFloat(s)):Hi.includes(n)?e.push(s==="true"):e.push(s)}return e}var qo="/serv/connect.js";function Uo(r){return`function ${r}(...args){return connector("${r}", args)}`}async function ur(r,t,e,{SomePlugins:i},n){let s=t.popHaveDefault("name"),o=t.popHaveDefault("sendTo"),a=t.popHaveDefault("validate"),l=t.popHaveDefault("notValid"),c=t.popAnyDefault("message",n.debug&&!i("SafeDebug"));return n.script(qo,{async:null}),n.addScriptStylePage("script",t,r).addText(Uo(s)),n.connectorArray.push({type:"connect",name:s,sendTo:o,message:c,notValid:l,validator:a&&a.split(",").map(u=>u.trim())}),{compiledString:e,checkComponents:!0}}function zi(r,t){if(!t.connectorArray.length)return r;let e="";for(let n of t.connectorArray)n.type=="connect"&&(e+=`,
        {
            name:"${n.name}",
            sendTo:${n.sendTo},
            notValid: ${n.notValid||"null"},
            message:${typeof n.message=="string"?`"${n.message}"`:n.message},
            validator:[${n.validator&&n.validator.map(ge).join(",")||""}]
        }`);e=`[${e.substring(1)}]`;let i=`
        if(Post?.connectorCall){
            if(await handelConnector("connect", page, ${e})){
                return;
            }
        }`;return r.includes("@ConnectHere")?r=r.replacer(/@ConnectHere(;?)/,()=>new f(null,i)):r.AddTextAfterNoTrack(i),r}async function Gi(r,t){if(!r.Post?.connectorCall)return!1;let e=t.find(o=>o.name==r.Post.connectorCall.name);if(!e)return!1;let i=r.Post.connectorCall.values,n=e.validator.length&&await de(i,e.validator);r.setResponse("");let s=o=>{r.Response.setHeader("Content-Type","application/json"),r.Response.end(JSON.stringify(o))};return!e.validator.length||n===!0?s(await e.sendTo(...i)):e.notValid?s(await e.notValid(...n)):e.message?s({error:typeof e.message=="string"?e.message:n.shift()}):r.Response.status(400),!0}import{v4 as Jo}from"uuid";async function pr(r,t,e,i,n,s){let o=e.popAnyDefault("sendTo","").trim();if(!o)return{compiledString:new f(t.DefaultInfoText).Plus$`<form${e.rebuildSpace()}>${await n.StartReplace(i,r,s)}</form>`,checkComponents:!1};let a=e.popAnyDefault("name",Jo()).trim(),l=e.popHaveDefault("validate"),c=e.popHaveDefault("order"),u=e.popHaveDefault("notValid"),p=e.popBoolean("safe"),g=e.popAnyDefault("message",s.debug&&!n.SomePlugins("SafeDebug")),h=[],y=l&&l.split(",").map(k=>{let x=O(":",k.trim());return x.length>1&&h.push(x.shift()),x.pop()});return c&&(h=c.split(",").map(k=>k.trim())),s.connectorArray.push({type:"form",name:a,sendTo:o,validator:y,order:h.length&&h,notValid:u,message:g,responseSafe:p}),e.pushValue("method","post"),{compiledString:new f(t.DefaultInfoText).Plus$`<%!
@?ConnectHereForm(${o});
%><form${e.rebuildSpace()}>
    <input type="hidden" name="connectorFormCall" value="${a}"/>${await n.StartReplace(i,r,s)}</form>`,checkComponents:!1}}function Qi(r,t){if(!t.connectorArray.length)return r;for(let e of t.connectorArray){if(e.type!="form")continue;let i=new f(null,e.sendTo).unicode.eq,n=new RegExp(`@ConnectHereForm\\([ ]*${i}[ ]*\\)(;?)`),s=new RegExp(`@\\?ConnectHereForm\\([ ]*${i}[ ]*\\)(;?)`),o=0,a=l=>(o++,new f(l[0].StartInfo).Plus$`
                if(Post?.connectorFormCall == "${e.name}"){
                    await handelConnector("form", page, 
                        {
                            sendTo:${e.sendTo},
                            notValid: ${e.notValid||"null"},
                            validator:[${e.validator?.map?.(ge)?.join(",")??""}],
                            order: [${e.order?.map?.(c=>`"${c}"`)?.join(",")??""}],
                            message:${typeof e.message=="string"?`"${e.message}"`:e.message},
                            safe:${e.responseSafe}
                        }
                    );
                }`);r=r.replacer(n,a),o?r=r.replace(s,""):r=r.replacer(s,a)}return r}async function Xi(r,t){delete r.Post.connectorFormCall;let e=[];if(t.order.length)for(let s of t.order)e.push(r.Post[s]);else e.push(...Object.values(r.Post));let i=!0;t.validator.length&&(e=Vi(e,t.validator),i=await de(e,t.validator));let n;i===!0?n=await t.sendTo(...e):t.notValid&&(n=await t.notValid(...i)),!i&&!n&&(t.message===!0?r.writeSafe(t.message):n=t.message),n&&(t.safe?r.writeSafe(n):r.write(n))}var Q=new z("Records");function Ho(r,t){return r.popAnyDefault("link",ct(t.smallPath))}function mr(r,t,e){let i=Ho(t,e),n=t.popAnyDefault("name",r);return Q.store[n]??={},Q.store[n][i]??="",e.record(n),{store:Q.store[n],current:Q.store[n][i],link:i}}async function fr(r,t,e,i,n){if(e=await i.StartReplace(e,r,n),!n.smallPath.endsWith("."+S.pageTypes.page))return{compiledString:e};let s=new P(e,e.extractInfo());await s.findScripts();let o="";for(let c of s.values)c.type=="text"&&(o+=c.text.eq);o=o.trim();let{store:a,link:l}=mr("records/record.serv",t,n);return a[l].includes(o)||(a[l]+=o),{compiledString:e}}function Zi(r){let t=ct(r);for(let e in Q.store){let i=Q.store[e];i[t]&&(i[t]=void 0,delete i[t])}}async function Ki(r){if(!!r.debug)for(let t of r.recordNames){let e=d.Static[0]+t+".json";await m.makePathReal(t,d.Static[0]),m.writeJsonFile(e,Q.store[t])}}function Yi(){Q.clear()}async function tn(){for(let r in Q.store){let t=d.Static[0]+r+".json";await m.makePathReal(r,d.Static[0]),m.writeJsonFile(t,Q.store[r])}}import{parse as Vo}from"node-html-parser";async function gr(r,t,e,i,n){if(e=await i.StartReplace(e,r,n),!n.smallPath.endsWith("."+S.pageTypes.page))return{compiledString:e};let s=new P(e,e.extractInfo());await s.findScripts();let o="";for(let p of s.values)p.type=="text"&&(o+=p.text.eq);let{store:a,link:l,current:c}=mr("records/search.serv",t,n),u=zo(o,t.popAnyDefault("match","h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]"));return c?(Object.assign(c.titles,u.titles),c.text.includes(u.text)||(c.text+=u.text)):a[l]=u,{compiledString:e}}function zo(r,t){let e=Vo(r,{blockTextElements:{script:!1,style:!1,noscript:!1}}),i={};for(let n of e.querySelectorAll(t)){let s=n.attributes.id;i[s]=n.innerText.trim(),n.remove()}return{titles:i,text:e.innerText.trim().replace(/[ \n]{2,}/g," ").replace(/[\n]/g," ")}}var dr=["client","script","style","page","connect","isolate","form","head","svelte","markdown","record","search"];function en(r,t,e,i,n,s){let o;switch(t.eq.toLowerCase()){case"client":o=Ne(r,t,e,i,n,s);break;case"record":o=fr(r,e,i,n,s);break;case"search":o=gr(r,e,i,n,s);break;case"script":o=Ue(r,t,e,i,s);break;case"style":o=Ze(r,t,e,i,s);break;case"page":o=Ye(r,t,e,i,n,s);break;case"connect":o=ur(t,e,i,n,s);break;case"form":o=pr(r,t,e,i,n,s);break;case"isolate":o=er(i);break;case"head":o=lr(r,t,e,i,n,s);break;case"svelte":o=or(t,e,s);break;case"markdown":o=ar(t,e,i,n,s);break;default:console.error("Component is not build yet")}return o}function rn(r){return dr.includes(r.toLowerCase())}async function nn(r,t,e){return Ki(t),r=zi(r,t),r=Qi(r,t),r=r.replace(/@ConnectHere(;?)/gi,"").replace(/@ConnectHereForm(;?)/gi,""),r=await Ui(r,t,e),r}function sn(r,t,e){return r=="connect"?Gi(t,e):Xi(t,e)}async function on(){Yi()}async function an(){tn()}async function ln(r,t){r.debug&&Zi(r.smallPath)}async function cn(r,t){}import la from"path";function Go(r){let t="";for(let e of r)t+="\\u"+("000"+e.charCodeAt(0).toString(16)).substr(-4);return t}function Dt(r,t,e,i,n){let s="";for(let o of t)s+=Go(e)+o+"|";return s=s.substring(0,s.length-1),s=`<(${s})${n?"([\\p{L}0-9_\\-\\.]+)":""}(\\u0020)*\\u002F?>`,pn(r,new RegExp(s,"u"),e,i)}function Qo(r){let t=r.indexOf(">");for(r=r.substring(0,t);r.endsWith(" ")||r.endsWith("/");)r=r.substring(0,r.length-1);return r}function pn(r,t,e,i=!0,n=new f,s=[]){let o=r,a=r.search(t);if(a==-1)return{data:n.Plus(r),found:s};n.Plus(r.substring(0,a)),r=r.substring(a+1);let l=Qo(r.eq);r=r.substring(un(">",r));let c;if(i){let u=hr(["<"+l,"</"+l],r);if(u!=-1)c=r.substring(0,u),r=r.substring(u),r=r.substring(un(">",r));else{let p=r.search(t);p==-1?(c=r,r=new f):(c=r.substring(0,p),r=r.substring(p))}}return s.push({tag:l,data:c,loc:a}),o==r?{error:!0}:pn(r,t,e,i,n,s)}function un(r,t){return t.indexOf(r)+r.length}function hr(r,t){let e=t.indexOf(r[0]),i=t.indexOf(r[1]);if(i==-1)return-1;if(e<i&&e!=-1){e++;let n=e+hr(r,t.substring(e))+r[0].length;return n+hr(r,t.substring(n))}else return i}import xe from"path";import na from"path";import{transform as Ko}from"esbuild-wasm";import L from"path";import{v4 as Yo}from"uuid";import Zo from"minisearch";var Lt=class{constructor(t){this.fullPath=d.Static[0]+t+".json"}async load(){this.indexData=await m.readJsonFile(this.fullPath);let t=[],e=0;for(let i in this.indexData){let n=this.indexData[i];for(let s in n.titles)t.push({id:e++,text:n.titles[s],url:`/${i}#${s}`});t.push({id:e++,text:n.text,url:`/${i}`})}this.miniSearch=new Zo({fields:["text"],storeFields:["id","text","url"]}),await this.miniSearch.addAllAsync(t)}search(t,e={fuzzy:!0,length:200,addAfterMaxLength:"..."},i="b"){let n=this.miniSearch.search(t,e);if(!i)return n;for(let s of n)for(let o of s.terms){if(e.length&&s.text.length>e.length){let p=s.text.substring(0,e.length);s.text[e.length].trim()!=""?s.text=p.substring(0,p.lastIndexOf(" "))+(e.addAfterMaxLength??""):s.text=p,s.text=s.text.trim()}let a=s.text.toLowerCase(),l="",c=a.indexOf(o),u=0;for(;c!=-1;)l+=s.text.substring(u,u+c)+`<${i}>${s.text.substring(c+u,c+o.length+u)}</${i}>`,a=a.substring(c+o.length),u+=c+o.length,c=a.indexOf(o);s.text=l+s.text.substring(u)}return n}suggest(t,e){return this.miniSearch.autoSuggest(t,e)}};function mn(){return{Settings:w,SearchRecord:Lt}}var fn=["@eas-framework/server"];function he(r){switch(r){case"@eas-framework/server":return mn();default:return!1}}function Et(r){let t=he(r);return t||import(r)}function gn(r,t){return ae.includes(t)||fn.includes(r)}async function Sr(r,t,e,i){let n=await he(r);return n||rr(t,e)}async function ta(r,t){return r=await nt.BuildAndExportImports(r,t),r}function ea(r,t,e,i,n){return`${t?"require('source-map-support').install();":""}var __dirname="${P.fixTextSimpleQuotes(e)}",__filename="${P.fixTextSimpleQuotes(i)}";module.exports = (async (require${n?","+n:""})=>{var module={exports:{}},exports=module.exports;${r}
return module.exports;});`}async function xr(r,t,e,i,{params:n,templatePath:s=r,codeMinify:o=!i,mergeTrack:a}={}){let l={format:"cjs",loader:e?"ts":"js",minify:o,sourcemap:i?a?"external":"inline":!1,sourcefile:t&&L.relative(L.dirname(t),r),define:{debug:""+i}},c=await ta(a?.eq||await m.readFile(r),{});c=ea(c,i,L.dirname(s),s,n);try{let{code:u,warnings:p,map:g}=await Ko(c,l);a&&g?(V(a,p),c=(await yt(a,u,g)).StringWithTack(t)):(ne(p,r),c=u)}catch(u){a?q(a,u):At(u,r)}return t&&(await m.makePathReal(L.dirname(t)),await m.writeFile(t,c)),c}function dn(r){return r.endsWith(".ts")}async function ra(r,t,e=!1){return await m.makePathReal(r,t[1]),await xr(t[0]+r,t[1]+r+".cjs",dn(r),e)}function It(r){let t=L.extname(r);return S.partExtensions.includes(t.substring(1))?r+="."+(gt()?"ts":"js"):t==""&&(r+="."+S.ReqFileTypes[gt()?"ts":"js"]),r}var U={},yr={};async function X(r,t,e,{isDebug:i=!1,useDeps:n,withoutCache:s=[],onlyPrepare:o}){let a,l=L.normalize(t.toLowerCase());t=It(t);let c=L.extname(t).substring(1),u=gn(l,c)||!["js","ts"].includes(c),p=L.join(e[2],t),g=L.join(e[0],t),h;o||(U[p]?U[p]instanceof Promise&&await U[p]:U[p]=new Promise(C=>h=C));let y=!G.store[p]||G.store[p]!=(a=await m.stat(g,"mtimeMs",!0,null));if(y){if(a=a??await m.stat(g,"mtimeMs",!0,null),a==null){let[C,$]=_({type:"warn",errorName:"import-not-exists",text:`Import '${t}' does not exists from '${r}'`});return b[C]($),U[p]=null,null}u||await ra(t,e,i),G.update(p,a)}n&&(n[t]={thisFile:a},n=n[t]);let T=s[0]==t;if(T)s.shift();else if(!y&&U[p]&&!(U[p]instanceof Promise))return U[p];function k(C){if(L.isAbsolute(C))C=L.relative(C,e[0]);else if(C[0]==".")C=L.join(L.dirname(t),C);else if(C[0]!="/")return Et(C);return X(g,C,e,{isDebug:i,useDeps:n,withoutCache:T?s:[]})}let x;if(u)x=await Sr(l,g,c,k);else{let C=L.join(e[1],t+".cjs");if(x=await st(C),o){yr[p]=()=>x(k);return}x=await x(k)}return U[p]=x,h?.(),x}async function Se(r,t,e,i=!1,n,s){if(!i){let o=L.join(e[2],t.toLowerCase()),a=U[o];if(a!=null)return a;if(yr[o]){let l=await yr[o]();return U[o]=l,l}}return X(r,t,e,{isDebug:i,useDeps:n,withoutCache:s})}async function hn(r,t){let e=L.join(D,`temp-${Yo()}.cjs`);await xr(r,e,dn(r),t);let i=await st(e);return m.unlink(e),await i(n=>import(n))}async function Sn(r,t,e,i,n,s,o){await m.makePathReal(e,i[1]);let a=t+".cjs",l=i[0]+e;await xr(t,a,n,s,{params:r,mergeTrack:o,templatePath:l,codeMinify:!1});function c(p){if(L.isAbsolute(p))p=L.relative(p,i[0]);else if(p[0]==".")p=L.join(e,p);else if(p[0]!="/")return Et(p);return X(l,p,i,{isDebug:s})}let u=await st(a);return async(...p)=>await u(c,...p)}var ia={include:"await ",import:"await ",transfer:"return await "};async function br(r,t){let e=await gi(r.eq),i=new f;for(let n of e){let s=r.substring(n.start,n.end);switch(n.name){case"text":i.Plus(s);break;case"script":i.Plus$`<%${s}%>`;break;case"print":i.Plus$`<%=${s}%>`;break;case"escape":i.Plus$`<%:${s}%>`;break;default:i.Plus$`<%${ia[n.name]}${s}%>`}}return i}async function yn(r,t,e){let i=await di(r.eq,t),n=new f;for(let s=0;s<i.length;s+=4){i[s]!=i[s+1]&&n.Plus(r.substring(i[s],i[s+1]));let o=r.substring(i[s+2],i[s+3]);n.Plus$`<%${e}${o}%>`}return n.Plus(r.substring((i.at(-1)??-1)+1)),n}var ye=class{constructor(t,e,i,n){this.script=t;this.sessionInfo=e;this.smallPath=i;this.isTs=n;this.define={}}templateScript(t){let e=new f;e.AddTextAfterNoTrack(`const __writeArray = []
        var __write;

        function write(text){
            __write.text += text;
        }`);for(let i of t)e.AddTextAfterNoTrack(`
__write = {text: ''};__writeArray.unshift(__write);`),e.Plus(i);return e.AddTextAfterNoTrack(`
return __writeArray`),e}methods(t){let e="/"+ct(this.sessionInfo.smallPath);return{string:"script,style,define,store,page__filename,page__dirname,__localpath,attributes",funcs:[this.sessionInfo.script.bind(this.sessionInfo),this.sessionInfo.style.bind(this.sessionInfo),(i,n)=>this.define[String(i)]=n,this.sessionInfo.compileRunTimeStore,this.sessionInfo.fullPath,na.dirname(this.sessionInfo.fullPath),e,t||{}]}}rebuildCode(t,e){let i=new f;for(let n of t.values){if(n.type=="text"){i.Plus(n.text);continue}i.AddTextAfterNoTrack(e.pop().text)}return i}async compile(t){let e=this.sessionInfo.cacheCompileScript[this.smallPath];if(e)return(await e)();let i;this.sessionInfo.cacheCompileScript[this.smallPath]=new Promise(T=>i=T),this.script=await yn(this.script,"@compile","*");let n=new P(this.script,this.smallPath,"<%*","%>");if(await n.findScripts(),n.values.length==1&&n.values[0].type==="text"){let T=()=>this.script;return i(T),this.sessionInfo.cacheCompileScript[this.smallPath]=T,this.script}let[s,o]=O("/",this.smallPath),a=d[s]??d.Static,l=a[1]+o+".comp.js";await m.makePathReal(o,a[1]);let c=this.templateScript(n.values.filter(T=>T.type!="text").map(T=>T.text)),{funcs:u,string:p}=this.methods(t),g=await Sn(p,l,o,a,this.isTs,this.sessionInfo.debug,c),h=async()=>{try{return this.rebuildCode(n,await g(...u))}catch(T){let[k,x]=_({errorName:T,text:T.message,type:"error"});b[k](x)}};this.sessionInfo.cacheCompileScript[this.smallPath]=h;let y=await h();return i(h),y}};var sa=["codefile"],be={define:{}};async function oa(r){let t=await et.exec("PageBaseParser",[r]);return JSON.parse(t)}var Z=class{constructor(t,e,i){this.sessionInfo=t;this.code=e;this.isTs=i;this.scriptFile=new f;this.valueArray=[]}nonDynamic(t){if(!(!t||this.popAny("dynamic")!=null)){if(this.sessionInfo.debug){let i=new Z;i.clearData=this.clearData,i.valueArray=[...this.valueArray,{key:"dynamic",value:!0}],i.rebuild(),m.writeFile(this.sessionInfo.fullPath,i.clearData.eq);let[n,s]=_({type:"warn",errorName:"dynamic-ssr-import",text:"Adding 'dynamic' attribute to file "+this.sessionInfo.smallPath});b[n](s)}return!0}}async loadSettings(t,e,i,{attributes:n,dynamicCheck:s}){let o=new ye(this.code,this.sessionInfo,e,this.isTs);return this.code=await o.compile(n),await this.parseBase(this.code),this.nonDynamic(s)?!1:(await this.loadCodeFile(t,e,this.isTs,i),this.loadDefine(B(B({},be.define),o.define)),!0)}async parseBase(t){let e=await oa(t.eq);if(e.start==e.end){this.clearData=t;return}for(let{char:i,end:n,key:s,start:o}of e.values)this.valueArray.push({key:s,value:o===n?!0:t.substring(o,n),char:i});this.clearData=t.substring(0,e.start).Plus(t.substring(e.end)).trimStart()}rebuild(){if(!this.valueArray.length)return this.clearData;let t=new f(null,"@[");for(let{key:e,value:i,char:n}of this.valueArray)i!==!0?t.Plus$`${e}=${n}${i}${n} `:t.Plus$`${e} `;this.clearData=t.substring(0,t.length-1).Plus(`]
`).Plus(this.clearData)}static async rebuildBaseInheritance(t){let e=new Z,i=new f;await e.parseBase(t);for(let n of e.byValue("inherit"))sa.includes(n.toLowerCase())||(e.pop(n),i.AddTextAfterNoTrack(`<@${n}><:${n}/></@${n}>`));return e.rebuild(),e.clearData.Plus(i)}get(t){return this.valueArray.find(e=>e.key===t)?.value}pop(t){return this.valueArray.splice(this.valueArray.findIndex(e=>e.key===t),1)[0]?.value}popAny(t){let e=this.valueArray.findIndex(n=>n.key.toLowerCase()==t);if(e!=-1)return this.valueArray.splice(e,1)[0].value;let i=Dt(this.clearData,[t],"@");if(!!i.found[0])return this.clearData=i.data,i.found[0].data.trim()}byValue(t){return this.valueArray.filter(e=>e.value!==!0&&e.value.eq===t).map(e=>e.key)}replaceValue(t,e){let i=this.valueArray.find(n=>n.key===t);i&&(i.value=e)}defaultValuePopAny(t,e){let i=this.popAny(t);return i===!0?e:i?.eq}async loadCodeFile(t,e,i,n){let s=this.defaultValuePopAny("codefile","inherit");if(!s)return;let o=this.defaultValuePopAny("lang","js"),a=s.toLowerCase();a=="inherit"&&(s=t);let l=xe.extname(s).substring(1);["js","ts"].includes(l)||(/(\\|\/)$/.test(s)?s+=t.split("/").pop():S.pageTypesArray.includes(l)||(s+=xe.extname(t)),s+="."+(o||(i?"ts":"js"))),s[0]=="."&&(s=xe.join(xe.dirname(t),s));let c=S.relative(s);if(await this.sessionInfo.dependence(c,s)){let u=await ht(!1,n,s,c);this.scriptFile=u.allData.replaceAll("@","@@"),this.scriptFile.AddTextBeforeNoTrack("<%"),this.scriptFile.AddTextAfterNoTrack("%>"),this.sessionInfo.debug&&this.scriptFile.AddTextBeforeNoTrack(u.stringInfo)}else if(a=="inherit"&&this.sessionInfo.debug){m.writeFile(s,"");let[u,p]=_({id:c,type:"warn",errorName:"create-code-file",text:`
Code file created: ${t}<line>${c}`});b[u](p)}else{let[u,p]=_({id:c,type:"error",errorName:"code-file-not-found",text:`
Code file not found: ${t}<line>${c}`});b[u](p),this.scriptFile=new f(n,P.printError(`Code File Not Found: '${e}' -> '${c}'`))}}loadSetting(t="define",e=2){let i=this.clearData.indexOf(`@${t}(`);if(i==-1)return!1;let n=[],s=this.clearData.substring(0,i),o=this.clearData.substring(i+8).trimStart();for(let a=0;a<e;a++){let l=o.at(0).eq,c=mt.findEntOfQ(o.eq.substring(1),l);n.push(o.substring(1,c));let u=o.substring(c+1).trimStart();if(u.at(0).eq!=","){o=u;break}o=u.substring(1).trimStart()}return o=o.substring(o.indexOf(")")+1),this.clearData=s.trimEnd().Plus(o.trimStart()),n}loadDefine(t){let e=this.loadSetting(),i=[];for(;e;)i.unshift(e),e=this.loadSetting();i.unshift(...Object.entries(t));for(let[n,s]of i)this.clearData=this.clearData.replaceAll(`:${n}:`,s)}};import ca from"path";async function aa(r){let t=await et.exec("HTMLAttrParser",[r]);return JSON.parse(t)}var we=class{constructor(t){this.text=t;this.valueArray=[]}async parser(){let t=await aa(this.text.eq);for(let{char:e,ek:i,ev:n,sk:s,space:o,sv:a}of t)this.valueArray.push({char:e,space:o,key:this.text.substring(s,i),value:a==n?!0:this.text.substring(a,n)})}popItem(t){t=t.toLowerCase();let e=this.valueArray.findIndex(i=>i.key.eq.toLowerCase()==t);return e==-1?null:this.valueArray.splice(e,1).shift()}popTracker(t){return this.popItem(t)?.value}popHaveDefaultTracker(t,e=""){let i=this.popTracker(t);return typeof i=="boolean"?e:i}popAnyTracker(t,e=""){let i=this.popTracker(t);return i instanceof f?i.eq:e}popString(t){let e=this.popItem(t)?.value;return e instanceof f?e.eq:e}popBoolean(t,e){return Boolean(this.popString(t)??e)}exists(t){return this.valueArray.find(e=>e.key.eq.toLowerCase()==t)!=null}popHaveDefault(t,e=""){let i=this.popString(t);return typeof i=="boolean"?e:i}popAnyDefault(t,e=""){let i=this.popString(t);return typeof i=="string"?i:e}addClass(t){let e=this.valueArray.find(i=>i.key.eq.toLowerCase()=="class");e?.value instanceof f?e.value.AddTextAfterNoTrack(" "+t).trimStart():e?.value===!0?e.value=new f(null,t):this.pushValue("class",t)}rebuildSpace(){let t=new f;for(let{value:e,char:i,key:n,space:s}of this.valueArray)s&&t.AddTextAfterNoTrack(" "),e===!0?t.Plus(n):t.Plus$`${n}=${i}${e}${i}`;return t}pushValue(t,e){let i=this.valueArray.find(n=>n.key.eq.toLowerCase()==t);if(i)return i.value=new f(null,e);this.valueArray.push({key:new f(null,t),value:new f(null,e),char:'"',space:!0})}map(){let t={};for(let{key:e,value:i}of this.valueArray)e&&(t[e.eq]=i===!0?!0:i.eq);return t}};var xt=class extends Ee{constructor(t){super();this.dirFolder="Components",this.PluginBuild=t,this.regexSearch=new RegExp(`<([\\p{Lu}_\\-:0-9]|${dr.join("|")})`,"u")}FindSpecialTagByStart(t){for(let e of this.SkipSpecialTag)if(t.substring(0,e[0].length)==e[0])return e}findIndexSearchTag(t,e){let i=t.split("."),n=0;for(let s of i){let o=e.indexOf(s);if(o==-1){let[a,l]=_({text:`Waring, can't find all query in tag -> ${e.eq}
${e.lineInfo}`,errorName:"query-not-found"});b[a](l);break}n+=o+s.length,e=e.substring(o+s.length)}return n+e.search(/\ |\>/)}CheckMinHTML(t){return this.SomePlugins("MinHTML","MinAll")&&(t=t.SpaceOne(" ")),t}async ReBuildTag(t,e,i,n,s){n&&this.SomePlugins("MinHTML","MinAll")?(n=n.SpaceOne(" "),e=i.rebuildSpace()):e.eq.length&&(e=new f(t.DefaultInfoText," ").Plus(e));let o=new f(t.DefaultInfoText).Plus("<",t,e);return n?o.Plus$`>${await s(n)}</${t}>`:o.Plus("/>"),o}exportDefaultValues(t,e=[]){let i=t.match(/@default[ ]*\(([A-Za-z0-9{}()\[\]_\-$"'`%*&|\/\@ \n]*)\)[ ]*\[([A-Za-z0-9_\-,$ \n]+)\]/);if(i==null)return{fileData:t,foundSetters:e};let n=t.substring(0,i.index).Plus(t.substring(i.index+i[0].length)),s=i[2].eq.split(",").map(o=>o.trim());return e.push({value:i[1],elements:s}),this.exportDefaultValues(n,e)}addDefaultValues(t,e){for(let i of t)for(let n of i.elements)e=e.replaceAll("#"+n,i.value);return e}parseComponentProps(t,e){let{fileData:i,foundSetters:n}=this.exportDefaultValues(e);for(let{key:s,value:o}of t.valueArray){let a=new RegExp("\\~"+s,"gi");i=i.replace(a,o)}return this.addDefaultValues(n,i)}async buildTagBasic(t,e,i,n,s,o,a){return t=await this.PluginBuild.BuildComponent(t,i,s,o),t=this.parseComponentProps(e,t),t=t.replace(/<\:reader( )*\/>/gi,a??""),s=s+" -> "+n,t=await this.StartReplace(t,s,o),t=await Pi(t,`${s} ->
${n}`),t}static addSpacialAttributes(t,e,i){let n="/"+e.extractInfo();t.pushValue("importSource",n),t.pushValue("importSourceDirectory",ca.dirname(n));let s=t.map();return s.reader=i?.eq,s}async insertTagData(t,e,i,{BetweenTagData:n,sessionInfo:s}){let o=new we(i),a=rn(e.eq);await o.parser();let l,c=!0,u={},p;if(a){let{compiledString:g,checkComponents:h}=await en(t,e,o,n??new f,this,s);l=g,c=h}else{let g=o.popHaveDefault("folder","."),h=(g?g+"/":"")+e.replace(/:/gi,"/").eq,y=e.extractInfo(),T=la.join(S.fullWebSitePath,y);if(u=St(T,y,h,this.dirFolder,S.pageTypes.component),s.cacheComponent[u.SmallPath]===null||s.cacheComponent[u.SmallPath]===void 0&&!await m.existsFile(u.FullPath)){if(s.cacheComponent[u.SmallPath]=null,g){let[A,v]=_({text:`Component ${e.eq} not found! -> ${t}
-> ${e.lineInfo}
${u.SmallPath}`,errorName:"component-not-found",type:"error"});b[A](v)}return this.ReBuildTag(e,i,o,n,A=>this.StartReplace(A,t,s))}s.cacheComponent[u.SmallPath]?.mtimeMs||(s.cacheComponent[u.SmallPath]={mtimeMs:await m.stat(u.FullPath,"mtimeMs")}),s.dependencies[u.SmallPath]=s.cacheComponent[u.SmallPath].mtimeMs;let{allData:k,stringInfo:x}=await ht(!0,t,u.FullPath,u.SmallPath,s.cacheComponent[u.SmallPath]),C=new Z(s,k,this.isTs()),$=xt.addSpacialAttributes(o,e,n);await C.loadSettings(u.FullPath,u.SmallPath,t+" -> "+u.SmallPath,{attributes:$}),l=C.scriptFile.Plus(C.clearData),p=s.debug&&x}if(c&&(l.length>0||n)){let{SmallPath:g,FullPath:h}=u;l=await this.buildTagBasic(l,o,a?e.eq:h,a?e.eq:g,t,s,n),p&&l.AddTextBeforeNoTrack(p)}return l}CheckDoubleSpace(...t){let e=this.SomePlugins("MinHTML","MinAll"),i=t.shift();e&&(i=i.SpaceOne(" "));for(let n of t)e&&i.endsWith(" ")&&n.startsWith(" ")&&(n=n.trimStart()),i.Plus(n);return e&&(i=i.SpaceOne(" ")),i}async StartReplace(t,e,i){let n,s=[];for(;(n=t.search(this.regexSearch))!=-1;){let a=t.eq,l=this.FindSpecialTagByStart(a.trim());if(l){let A=a.indexOf(l[0])+l[0].length,v=a.substring(A).indexOf(l[1])+A+l[1].length;s.push(t.substring(0,v)),t=t.substring(v);continue}let c=t.substring(0,n),u=t.substring(n),p=u.search(" |/|>|(<%)"),g=u.substring(1,p),h=await this.FindCloseChar(u.substring(1),">")+1,y=u.substring(p,h);y.at(y.length-1).eq=="/"&&(y=y.substring(0,y.length-1));let T=u.substring(h+1);if(u.at(h-1).eq=="/"){s.push(this.CheckMinHTML(c),this.insertTagData(e,g,y,{sessionInfo:i})),t=T;continue}let k;if(this.SimpleSkip.includes(g.eq))k=T.indexOf("</"+g);else if(k=await this.FindCloseCharHTML(T,g.eq),k==-1){let[A,v]=_({text:`
Warning, you didn't write right this tag: "${g}", used in: ${g.at(0).lineInfo}
(the system will auto close it)`,errorName:"close-tag"});b[A](v),k=null}let x=k!=null&&T.substring(0,k),C=T.substring(k),$=k!=null?C.substring(mt.findEndOfDef(C.eq,">")+1):C;s.push(this.CheckMinHTML(c),this.insertTagData(e,g,y,{BetweenTagData:x,sessionInfo:i})),t=$}let o=new f(t.DefaultInfoText);for(let a of s)o=this.CheckDoubleSpace(o,await a);return this.CheckMinHTML(this.CheckDoubleSpace(o,t))}RemoveUnnecessarySpace(t){return t=t.trim(),t=t.replaceAll(/%>[ ]+<%(?![=:])/,"%><%"),t}async Insert(t,e,i){return t=t.replace(/<!--[\w\W]+?-->/,""),t=await this.StartReplace(t,e,i),t=t.replace(/<\:reader+( )*\/>/gi,'<%typeof page.codebase == "function" ? page.codebase(): write(page.codebase)%>'),this.RemoveUnnecessarySpace(t)}};import xn from"path";var K=class extends P{static async AddPageTemplate(t,e){return e.debug&&t.AddTextBeforeNoTrack(`try {
`),t.AddTextBeforeNoTrack(`
        module.exports = (_require, _include, _transfer, private_var, handelConnector) => {
            return (async function (page) {
                const __filename = "${P.fixTextSimpleQuotes(e.fullPath)}", __dirname = "${P.fixTextSimpleQuotes(xn.dirname(e.fullPath))}";
                const require = (p) => _require(__filename, __dirname, page, p);
                const include = (p, withObject) => _include(__filename, __dirname, page, p, withObject);
        
                var module = { exports: {} },
                    exports = module.exports,
                    { sendFile, writeSafe, write, echo, setResponse, out_run_script, run_script_name, Response, Request, Post, Query, Session, Files, Cookies, PageVar, GlobalVar} = page,

                    run_script_code = run_script_name;

                    const transfer = (p, preserveForm, withObject) => (out_run_script = {text: ''}, _transfer(p, preserveForm, withObject, __filename, __dirname, page));
                {`),e.debug&&t.AddTextAfterNoTrack(`
}
                catch(e){
                    const last_file = run_script_name.split(/->|<line>/).pop();
                    run_script_name += ' -> <line>' + e.stack.split(/\\n( )*at /)[2];
                    out_run_script.text += '${K.printError("<p>Error path: ' + run_script_name.replace(/<line>/gi, '<br/>') + '</p><p>Error message: ' + e.message + '</p>")}';
        
                    console.error("Error path: " + run_script_name.slice(0, -last_file.length).replace(/<line>/gi, '\\n'));
                    console.error("${P.fixTextSimpleQuotes(S.fullWebSitePath)}" + last_file.trim());
                    console.error("Error message: " + e.message);
                    console.error("Error running this code: \\"" + run_script_code + '"');
                    console.error("Error stack: " + e.stack);
                }`),t.AddTextAfterNoTrack("}});}"),t}static async BuildPage(t,e){let i=await K.RunAndExport(t,e.fullPath,e.debug);return K.AddPageTemplate(i,e)}static AddAfterBuild(t,e){return e&&t.AddTextBeforeNoTrack("require('source-map-support').install();"),t}static InPageTemplate(t,e,i){return t.AddTextBeforeNoTrack(`<%!{
            const _page = page;
            {
            const page = {..._page${e?","+e:""}};
            const __filename = "${P.fixTextSimpleQuotes(i)}", __dirname = "${P.fixTextSimpleQuotes(xn.dirname(i))}";
            const require = (p) => _require(__filename, __dirname, page, p);
            const include = (p, withObject) => _include(__filename, __dirname, page, p, withObject);
            const transfer = (p, preserveForm, withObject) => (out_run_script = {text: ''}, _transfer(p, preserveForm, withObject, __filename, __dirname, page));
                {%>`),t.AddTextAfterNoTrack("<%!}}}%>"),t}};function wr(r){let t;switch(r.name||r){case"Razor":t=br;break}return t}var Te=class{constructor(t){this.SettingsObject=t}get defaultSyntax(){return this.SettingsObject.BasicCompilationSyntax.concat(this.SettingsObject.AddCompileSyntax)}async BuildBasic(t,e,i,n,s){if(!e)return t;Array.isArray(e)||(e=[e]);for(let o of e){let a=await wr(o);a&&(t=await a(t,o,i,n,s))}return t}async BuildPage(t,e,i,n){return t=await this.BuildBasic(t,this.defaultSyntax,e,i,n),t}async BuildComponent(t,e,i,n){return t=await this.BuildBasic(t,this.defaultSyntax,e,i,n),t}};var bn={plugins:[]};var J={AddCompileSyntax:[],plugins:[],BasicCompilationSyntax:["Razor"]},wn=new Te(J),Rt=new xt(wn);function F(r){return J.plugins.find(t=>t==r||t?.name==r)}function j(...r){return r.some(t=>F(t))}function gt(){return J.AddCompileSyntax.includes("TypeScript")}Rt.MicroPlugins=J.plugins;Rt.GetPlugin=F;Rt.SomePlugins=j;Rt.isTs=gt;bn.plugins=J.plugins;async function Tn(r,t,e,i,n,s,o){let a=new Z(s,r,gt());if(!await a.loadSettings(e,n,i,{dynamicCheck:o}))return;let l=a.defaultValuePopAny("model","website");if(!l)return t.Plus(a.scriptFile,a.clearData);r=a.clearData;let{SmallPath:c,FullPath:u}=St(e,n,l,"Models",S.pageTypes.model);if(!await m.existsFile(u)){let x=`Error model not found -> ${l} at page ${i}`;return b.error(x),new f(r.DefaultInfoText,K.printError(x))}await s.dependence(c,u);let p=await ht(!1,i,u,c),g=await Z.rebuildBaseInheritance(p.allData);s.debug&&g.AddTextBeforeNoTrack(p.stringInfo),i+=" -> "+c;let h=Dt(g,[""],":",!1,!0);if(h.error)return b.error("Error within model ->",l,"at page: ",i),r;g=h.data;let y=h.found.map(x=>x.tag.substring(1)),T=Dt(r,y,"@");if(T.error)return b.error("Error With model ->",l,"at page: ",i),r;let k=new f;for(let x of h.found){x.tag=x.tag.substring(1);let C=T.found.find($=>$.tag=="@"+x.tag);if(k.Plus(g.substring(0,x.loc)),g=g.substring(x.loc),C)k.Plus(C.data);else{let $=a.get(x.tag);$&&$!==!0&&$.eq.toLowerCase()!="inherit"&&k.Plus($)}}return k.Plus(g),await Tn(k,t.Plus(a.scriptFile),u,i,c,s)}async function kn(r,t,e,i,n,s){let o=new f(n.smallPath,r);if(o=await Tn(o,new f(o.DefaultInfoText),n.fullPath,n.smallPath,n.smallPath,n,s),o!=null)return o=await wn.BuildPage(o,n.fullPath,n.smallPath,n),o=await Rt.Insert(o,n.smallPath,n),o=await ki(o,n.smallPath),e?K.InPageTemplate(o,i,n.fullPath):(o=await nn(o,n,t),o=await K.BuildPage(o,n),o=await n.BuildScriptWithPrams(o),o=K.AddAfterBuild(o,n.debug),o)}import dt from"path";import{transform as ua}from"esbuild-wasm";async function ke(r,t,e,i){let n=d.Static[0]+r,s=d.Static[1]+r,o=B(B({sourcefile:r+"?source=true",sourcemap:e?"inline":!1,minify:j("Min"+t.toUpperCase())||j("MinAll")},F("transformOptions")),i),a=await m.readFile(n);try{let{code:l,warnings:c}=await ua(a,o);a=l,ne(c,n)}catch(l){At(l,n)}return await m.makePathReal(r,d.Static[1]),await m.writeFile(s,a),{thisFile:await m.stat(n,"mtimeMs")}}function Pn(r,t){return ke(r,"js",t,void 0)}function vn(r,t){return ke(r,"ts",t,{loader:"ts"})}function Cn(r,t){return ke(r,"jsx",t,I(B({},F("JSXOptions")??{}),{loader:"jsx"}))}function An(r,t){return ke(r,"tsx",t,B({loader:"tsx"},F("TSXOptions")??{}))}import*as _n from"svelte/compiler";import{transform as pa}from"esbuild-wasm";async function Tr(r,t){let e=d.Static[0]+r,i=d.Static[1]+r,{code:n,dependencies:s,map:o,scriptLang:a}=await le(e,d.Static[2]+"/"+r),l=e.split(/\/|\//).pop(),c,u;try{let g=_n.compile(n,{filename:l,dev:t,sourcemap:o,css:!1,hydratable:!0,sveltePath:"/serv/svelte"});ue(g.warnings,e,o),c=g.js,u=g.css}catch(g){return Oi(g,e,o),{thisFile:0}}let p=c.map.sources[0].substring(1);if(t&&(c.map.sources[0]=p),j("MinJS")||j("MinAll"))try{let{code:g,map:h}=await pa(c.code,{minify:!0,loader:a,sourcemap:t});c.code=g,h&&(c.map=await oi(JSON.parse(h),c.map))}catch(g){await vi(g,c.map,e)}return t&&(c.code+=ut(c.map),u.code&&(u.map.sources[0]=p,u.code+=ut(u.map,!0))),await m.makePathReal(r,d.Static[1]),await m.writeFile(i+".js",c.code),await m.writeFile(i+".css",u.code??""),I(B({},s),{thisFile:await m.stat(e,"mtimeMs")})}import Bn from"sass";import Mn from"path";import{fileURLToPath as Fn,pathToFileURL as ma}from"url";async function $n(r,t,e){let i=d.Static[0]+r,n=d.Static[1]+r,s={thisFile:await m.stat(i,"mtimeMs")},o=await m.readFile(i),a=Mn.dirname(i);try{let l=await Bn.compileStringAsync(o,{sourceMap:e,syntax:Mt(t),style:se(t),logger:Bn.Logger.silent,importer:Bt(i)});if(l?.loadedUrls)for(let u of l.loadedUrls){let p=Fn(u);s[S.relative(p)]=await m.stat(i,"mtimeMs",!0,null)}let c=l.css;e&&l.sourceMap&&(Ve(l.sourceMap,ma(o).href),l.sourceMap.sources=l.sourceMap.sources.map(u=>Mn.relative(a,Fn(u))+"?source=true"),c+=`\r
/*# sourceMappingURL=data:application/json;charset=utf-8;base64,${Buffer.from(JSON.stringify(l.sourceMap)).toString("base64")}*/`),await m.makePathReal(r,d.Static[1]),await m.writeFile(n,c)}catch(l){return ze(l),{}}return s}import fa from"fs";import ga from"promptly";import{argv as da}from"process";var ha=["js","svelte","ts","jsx","tsx","css","sass","scss"],Dn=new z("StaticFiles");async function Sa(r){let t=Dn.store[r];for(let e in t){let i=e;e=="thisFile"&&(i=d.Static[2]+"/"+r);let n=S.fullWebSitePath+i;if(await m.stat(n,"mtimeMs",!0)!=t[e])return!0}return!t}async function jt(r,t,e){let i=dt.extname(r).substring(1).toLowerCase(),n;switch(i){case"js":n=await Pn(r,t);break;case"ts":n=await vn(r,t);break;case"jsx":n=await Cn(r,t);break;case"tsx":n=await An(r,t);break;case"css":case"sass":case"scss":n=await $n(r,i,t);break;case"svelte":n=await Tr(r,t),e+=".js"}if(t&&await m.existsFile(e))return Dn.update(r,n),!0;if(!t)return!0}var kr=D+"/../static/client/",ya=[{path:"serv/temp.js",type:"js",inServer:kr+"buildTemplate.js"},{path:"serv/connect.js",type:"js",inServer:kr+"makeConnection.js"},{path:"serv/md.js",type:"js",inServer:kr+"markdownCopy.js"}],xa=[{ext:".pub.js",type:"js"},{ext:".pub.mjs",type:"js"},{ext:".pub.css",type:"css"}];async function ba(r,t,e){let i=xa.find(o=>t.endsWith(o.ext));if(!i)return;let n=r.query.t=="l"?d.Logs[1]:d.Static[1],s=dt.join(n,t);if(e||await m.existsFile(s))return I(B({},i),{inServer:s})}var Ot=null;da.includes("allowSourceDebug")&&(Ot=!0);async function wa(){if(typeof Ot=="boolean")return Ot;try{Ot=(await ga.prompt("Allow debugging JavaScript/CSS in source page? - exposing your source code (no)",{validator(r){if(["yes","no"].includes(r.trim().toLowerCase()))return r;throw new Error("yes or no")},timeout:1e3*30})).trim().toLowerCase()=="yes"}catch{}return Ot}var Ta=[d.Static[2],d.Logs[2],"Models","Components"];async function ka(r,t,e){if(!r||F("SafeDebug")||dt.extname(t)!=".source"||!Ta.includes(t.split(/\/|\\/).shift())||!await wa())return;let i=dt.join(S.fullWebSitePath,t.substring(0,t.length-7));if(e||await m.existsFile(i))return{type:"html",inServer:i}}async function Ln(r,t,e){let i=r.substring(0,r.length-4),n=d.Static[1]+r,s;if(dt.extname(i)==".svelte"&&(t||(s=await m.existsFile(n))))return{type:"css",inServer:n};if(e&&!s)return await jt(i,e,d.Static[1]+i),Ln(r,t,!1)}async function Pa(r,t){if(!r.startsWith("serv/svelte/"))return;let e=R+"node_modules"+r.substring(4)+(dt.extname(r)?"":"/index.mjs");if(t||await m.existsFile(e))return{type:"js",inServer:e}}async function va(r,t){if(!r.startsWith("serv/md/code-theme/"))return;let e=R+"node_modules/highlight.js/styles"+r.substring(18);if(t||await m.existsFile(e))return{type:"css",inServer:e}}async function Ca(r,t){if(!r.startsWith("serv/md/theme/"))return;let e=r.substring(14);e.startsWith("auto")?e=e.substring(4):e="-"+e;let i=R+"node_modules/github-markdown-css/github-markdown"+e.replace(".css",".min.css");if(t||await m.existsFile(i))return{type:"css",inServer:i}}async function Pr(r,t,e,i=!1){return await Pa(e,i)||await Ln(e,i,t)||await ka(t,e,i)||await ba(r,e,i)||await Ca(e,i)||await va(e,i)||ya.find(n=>n.path==e)}async function En(r,t,e,i){let n=await Pr(e,t,r,!0);if(n){i.type(n.type),i.end(await m.readFile(n.inServer));return}let s=d.Static[1]+r,o=d.Static[0]+r,a=dt.extname(r).substring(1).toLowerCase();if(!ha.includes(a)){i.sendFile(o);return}["sass","scss","css"].includes(a)?i.type("css"):i.type("js");let l=s;t&&(e.query.source=="true"||await Sa(r)&&!await jt(r,t,s))?l=o:a=="svelte"&&(l+=".js"),i.end(await fa.promises.readFile(l,"utf8"))}import Ma from"path";import Aa from"path";async function In(r,t){let e=[];for(let i of r){i=It(i);let n=await X("root folder (WWW)",i,d.Static,{isDebug:t});n&&typeof n.StartServer=="function"?e.push(n.StartServer):b.log(`Can't find StartServer function at module - ${i}
`)}return e}var vr;async function Rn(r,t){await m.existsFile(r+".ts")?r+=".ts":r+=".js";let e=await m.stat(r,"mtimeMs",!0,null);return e==vr||!e?null:(vr=e,(await hn(r,t)).default)}function Cr(){return vr}var Pe=class{constructor(){this.state={update:0,pageArray:[],importArray:[],fileArray:[]};this.state.update=Cr()}get scripts(){return this.state.importArray}get pages(){return this.state.pageArray}get files(){return this.state.fileArray}addPage(t,e){this.state.pageArray.find(i=>i[0]==t&&i[1]==e)||this.state.pageArray.push([t,e])}addImport(t){this.state.importArray.includes(t)||this.state.importArray.push(t)}addFile(t){this.state.fileArray.includes(t)||this.state.fileArray.push(t)}export(){return m.writeJsonFile(Pe.filePath,this.state)}static async checkLoad(){if(!await m.existsFile(this.filePath))return;let t=new Pe;if(t.state=await m.readJsonFile(this.filePath),t.state.update==Cr())return t}},ot=Pe;ot.filePath=Aa.join(D,"CompileState.json");import{argv as Fa}from"process";import _a from"path";function Ar(r,t){return r.endsWith("."+t)}function bt(r,t){t=t.toLowerCase();for(let e of r)if(Ar(t,e))return!0;return!1}function On(r){return r.substring(0,r.lastIndexOf("."))}async function _r(r,t,e){let i=await m.readdir(r[0]+t,{withFileTypes:!0}),n=[];for(let s of i){let o=s.name,a=t+o;s.isDirectory()?n.push(_r(r,a+"/",e)):bt(S.pageTypesArray,o)?e.addPage(a,r[2]):r==d.Static&&bt(S.ReqFileTypesArray,o)?e.addImport(a):e.addFile(a)}return Promise.all(n)}async function Ba(){let r=new ot;return await Promise.all([_r(d.Static,"",r),_r(d.Logs,"",r)]),r}async function jn(r){return Br(r,await Ba())}async function Br(r,t){let{routing:e,development:i}=r;if(!e.sitemap)return;let n=e.sitemap===!0?{}:e.sitemap;Object.assign(n,{rules:!0,urlStop:!1,errorPages:!1,validPath:!0});let s=[];t:for(let[a,l]of t.pages)if(!(l!=d.Static[2]||!a.endsWith("."+S.pageTypes.page))&&(a="/"+a.substring(0,a.length-S.pageTypes.page.length-1),_a.extname(a)!=".serv")){if(n.urlStop)for(let c in e.urlStop){a.startsWith(c)&&(a=c);break}if(n.rules){for(let c in e.rules)if(a.startsWith(c)){a=await e.rules[c](a);break}}if(!(e.ignoreTypes.find(c=>a.endsWith("."+c))||e.ignorePaths.find(c=>a.startsWith(c)))){if(n.validPath){for(let c of e.validPath)if(!await c(a))continue t}if(!n.errorPages)for(let c in e.errorPages){let u="/"+e.errorPages[c].path;if(a.startsWith(u))continue t}s.push(a)}}let o=!0;if(n.file){let a=await Se("Sitemap Import",n.file,d.Static,i);a?.Sitemap?o=await a.Sitemap(s,t,r):dump.warn("'Sitemap' function not found on file -> "+n.file)}if(o&&s.length){let a=o===!0?"sitemap.txt":o;t.addFile(a),await m.writeFile(d.Static[0]+a,s.join(`
`))}}async function Wn(r,t,{isDebug:e,hasSessionInfo:i,nestedPage:n,nestedPageData:s,dynamicCheck:o}={}){let a=Ma.join(t[0],r),l=t[1]+r+".cjs",c=await m.readFile(a,"utf8"),u=(n?n+"<line>":"")+t[2]+"/"+r,p=i??new ft(t[2]+"/"+r,a,t[2],e,F("SafeDebug"));await p.dependence("thisPage",a),await ln(p,l);let g=await kn(c,l,Boolean(n),s,p,o)??new f;return await cn(p,l),!n&&g.length&&(await m.writeFile(l,g.StringWithTack(l)),G.update(u,p.dependencies)),{CompiledData:g,sessionInfo:p}}function qn(r){return X("Production Loader",r,d.Static,{isDebug:!1,onlyPrepare:!0})}async function Un(r,t,e){let i=await m.readdir(r[0]+t,{withFileTypes:!0});for(let n of i){let s=n.name,o=t+s;n.isDirectory()?(await m.mkdir(r[1]+o),await Un(r,o+"/",e)):bt(S.pageTypesArray,s)?(e.addPage(o,r[2]),await it(r[2]+"/"+o)&&await Wn(o,r,{dynamicCheck:!Ar(s,S.pageTypes.page)})):r==d.Static&&bt(S.ReqFileTypesArray,s)?(e.addImport(o),await qn(o)):(e.addFile(o),await jt(o,!1))}}async function $a(r){for(let t of r)await qn(t)}async function Nn(r,t){let e=d[r];return await kt(e[1]),()=>Un(e,"",t)}async function tr(r,t,{hasSessionInfo:e,nestedPage:i,nestedPageData:n,dynamicCheck:s}={}){return await m.makePathReal(r,t[1]),await Wn(r,t,{isDebug:!0,hasSessionInfo:e,nestedPage:i,nestedPageData:n,dynamicCheck:s})}async function ve(r,t,e){await tr(r,t,{dynamicCheck:e}),je()}async function Jn(r){let t=!Fa.includes("rebuild")&&await ot.checkLoad();if(t)return()=>$a(t.scripts);G.clear(),t=new ot,on();let e=[await Nn(d.Static[2],t),await Nn(d.Logs[2],t),je];return async()=>{for(let i of e)await i();await Br(r,t),t.export(),an()}}var Dr={};Ps(Dr,{BuildPage:()=>Ce,Export:()=>Y,LoadPage:()=>qt,SplitFirst:()=>O,getFullPathCompile:()=>$r});import Wt from"path";import Hn from"path";var Vn={};async function Mr(r,t,e="",i={}){let n={},s=[];for(let[o,a]of Object.entries(r))s.push((async()=>{o=="thisFile"?(i[e]||(i[e]=await m.stat(t[0]+e,"mtimeMs",!0)),n.thisFile=i[e]):n[o]=await Mr(a,t,o,i)})());return await Promise.all(s),n}function Fr(r,t){for(let e in r)if(e=="thisFile"){if(t[e]!=r[e])return!1}else if(!Fr(r[e],t[e]))return!1;return!0}function zn(r,t,e=""){let i=[];for(let n in r)if(n=="thisFile"){if(t[n]!=r[n]){i.push(e);break}}else if(t[n]){let s=zn(r[n],t[n],n);if(s.length){e&&i.push(e),i.push(...s);break}}else{i.push(n);break}return i}async function Nt(r,t,e,i,n,s){let o=n[r],a,l;if(o){if(!s||s&&o.status==-1)return o.model;if(a=await m.stat(i[0]+o.path,"mtimeMs",!0,0),a){if(l=await Mr(o.dependencies,i),Fr(o.dependencies,l))return o.model}else if(o.status==0)return o.model}let c=r,u=!1;if(o?(r=o.path,u=o.static):r[0]=="."?r=Hn.join(Hn.relative(i[0],e),r):r[0]!="/"?u=!0:r=r.substring(1),u)n[c]={model:await Et(c),status:-1,static:!0,path:r};else{r=It(r);let g=i[0]+r;if(a=a??await m.stat(g,"mtimeMs",!0,0),a){let h=Vn[r];h&&Fr(h.dependencies,l=l??await Mr(h.dependencies,i))?n[c]=h:(l=l??{},n[c]={model:await Se(t,r,i,s,l,h&&zn(h.dependencies,l)),dependencies:l,path:r})}else{n[c]={model:{},status:0,path:r};let[h,y]=_({type:"warn",errorName:"import-not-exists",text:`Import '${r}' does not exists from '${t}'`});b[h](y)}}let p=n[c];return Vn[p.path]=p,p.model}var Y={PageLoadRam:{},PageRam:!0};async function La(r,t,e,i,n,s){let o=n[r],a=()=>o.model(s),l;if(o&&(!s.isDebug||o.date==-1&&(l=await m.existsFile(o.path),!l)))return a();let c=r,u=Wt.extname(r).substring(1);u||(u=S.pageTypes.page,r+="."+u);let p;if(r[0]=="."?p=Wt.join(e,r):p=Wt.join(i[0],r),![S.pageTypes.page,S.pageTypes.component].includes(u)){let k=await m.readFile(p);return s.write(k),k}if(l=l??await m.existsFile(p),!l){let[k,x]=_({type:"warn",errorName:"import-not-exists",text:`Import '${c}' does not exists from '${t}'`});return b[k](x),n[c]={model:()=>{},date:-1,path:p},n[c].model}let g=Wt.relative(i[0],p),h=i[2]+"/"+g,y=s.isDebug&&(!await m.existsFile(i[1]+"/"+g+".cjs")||await it(h));if(y&&await ve(g,i,u!=S.pageTypes.page),Y.PageLoadRam[h]&&!y)return n[c]={model:Y.PageLoadRam[h][0]},await n[c].model(s);let T=await qt(h,s.isDebug);return Y.PageRam&&(Y.PageLoadRam[h]||(Y.PageLoadRam[h]=[]),Y.PageLoadRam[h][0]=T),n[c]={model:T},await T(s)}var Ea={};function $r(r){let t=O("/",r);return d[t[0]][1]+t[1]+".cjs"}async function qt(r,t){let e=O("/",r),i=d[e[0]],n={};function s(u,p,g,h){return Nt(h,u,p,i,n,g.isDebug)}function o(u,p,g,h,y={}){return La(h,u,p,i,n,B(B({},y),g))}function a(u,p,g,h,y,T){if(T.out_run_script.text="",!p){let k=T.Request.body?{}:null;T=I(B({},T),{Request:I(B({},T.Request),{files:{},query:{},body:k}),Post:k,Query:{},Files:{}})}return o(h,y,T,u,g)}let l=Wt.join(i[1],e[1]+".cjs"),c={};try{return(await st(l))(s,o,a,c,sn)}catch(u){let p;return t?(b.error("Error path -> ",On(r),"->",u.message),b.error(u.stack),p=P.printError(`Error path: ${r}<br/>Error message: ${u.message}`)):p=P.printError(`Error code: ${u.code}`),g=>{g.Request.error=u,g.out_run_script.text+=p}}}function Ce(r,t){let e={};return async function(i,n,s,o,a,l,c,u){let p={text:""};function g(A){let v=A?.toString?.();return v==null||v.startsWith("[object Object]")?JSON.stringify(A,null,2):v}function h(A){p.text=g(A)}function y(A=""){p.text+=g(A)}function T(A=""){A=g(A);for(let v of A)p.text+="&#"+v.charCodeAt(0)+";"}function k(A,...v){for(let H in v)p.text+=A[H],T(v[H]);p.text+=A.at(-1)}let x=!1;i.redirect=(A,v)=>(x=String(A),v!=null&&i.status(v),i),i.reload=()=>{i.redirect(n.url)};function C(A,v=!1){x={file:A,deleteAfter:v}}return await r({sendFile:C,writeSafe:T,write:y,echo:k,setResponse:h,out_run_script:p,run_script_name:t,Response:i,Request:n,Post:s,Query:o,Session:l,Files:c,Cookies:a,isDebug:u,PageVar:e,GlobalVar:Ea,codebase:""}),{out_run_script:p.text,redirectPath:x}}}import Ia from"path";import Ra from"http";var Lr={};function Oa(r,t){let e=Object.keys(Lr);for(let i of e){let n=Lr[i];if(r.startsWith(i)&&n.pathSplit==t)return{staticPath:i,dataInfo:n}}return{}}async function ja(r){for(;r.length;){let t=Ia.join(d.Static[0],r+".api"),e=async n=>await m.existsFile(t+"."+n)&&n,i=(await Promise.all([e("ts"),e("js")])).filter(n=>n).shift();if(i)return r+".api."+i;r=Gt("/",r)}return r}async function Xn(r,t,e,i,n){let s=e.split("/").length,{staticPath:o,dataInfo:a}=Oa(e,s);if(a||(o=await ja(e),o&&(a={pathSplit:s,depsMap:{}},Lr[o]=a)),a)return await Wa(await Nt("/"+o,"api-call","",d.Static,a.depsMap,i),r,t,e.substring(o.length-6),i,n)}var Na=["validateURL","validateFunc","func","define",...Ra.METHODS];function Gn(r,t){let e=0,i="";for(let n in r){let s=n.length;e<s&&t.startsWith(n)&&!Na.includes(n)&&(e=s,i=n)}return i}async function Zn(r,t,e,i,n){let s=t,o=!0,a;switch(r){case Number:case parseFloat:case parseInt:s=r(t),o=!isNaN(s);break;case Boolean:s=t!="false",t=t.toLowerCase(),o=t=="true"||t=="false";break;case"any":break;default:if(Array.isArray(r)&&(o=r.includes(t)),typeof r=="function")try{let l=await r(t,e,i);l&&typeof l=="object"?(o=l.valid,s=l.parse??t):o=l}catch(l){a="Error on function validator, field - "+n(l)}r instanceof RegExp&&(o=r.test(t))}return o||(a='Error validate field, value is "'+t+'"'),[a,s]}async function Qn(r,t,e,i,n,s){if(!r.define)return t;let o=r.define.validateFunc;r.define.validateFunc=null,delete r.define.validateFunc;for(let a in r.define){let[l,c]=O("/",t);t=c;let[u,p]=await Zn(r.define[a],l,i,n,s);if(u)return{error:u};e[a]=p}if(o){let a;try{a=await o(e,i,n)}catch(l){a="Error on function validator"+s(l)}return{error:typeof a=="string"?a:"Error validating URL"}}return t||""}async function Wa(r,t,e,i,n,s){let o=!F("SafeDebug")&&n,a=v=>(n?b.error(v):null)+(o?`, message: ${v.message}`:""),l=t.method,c=r[l]||r.default[l],u=!0;c||(u=!1,c=r.default||r);let p=c,g={},h=await Qn(c,i,g,t,e,a);if(h.error)return e.json(h);i=h;let y=Gn(c,i);for(let v=0;v<2;v++){for(;y=Gn(c,i);){let H=await Qn(c,i,g,t,e,a);if(H.error)return e.json(H);i=H,i=ii("/",i.substring(y.length)),c=c[y]}u||(u=!0,c=c[l])}if(c=c?.func&&c||p,!c?.func)return!1;let T=i.split("/"),k=[],x;if(c.validateURL)for(let[v,H]of Object.entries(c.validateURL)){let[Hr,xs]=await Zn(H,T[v],t,e,a);if(Hr){x=Hr;break}k.push(xs)}else k.push(...T);if(!x&&c.validateFunc){let v;try{v=await c.validateFunc(T,t,e,k)}catch(H){v="Error on function validator"+a(H)}typeof v=="string"?x=v:v||(x="Error validating URL")}if(x)return e.json({error:x});let C=await s(),$,A;try{$=await c.func(t,e,k,g,T)}catch(v){o?A={error:v.message}:A={error:"500 - Internal Server Error"}}return typeof $=="string"?A={text:$}:A=$||A,C(),A!=null&&e.json(A),!0}var{Export:N}=Dr,M={CacheDays:1,DevMode:!0,ErrorPages:{}};async function qa(r,t){await m.existsFile($r(r))&&(N.PageLoadRam[r]=[],N.PageLoadRam[r][0]=await qt(r,t),N.PageLoadRam[r][1]=Ce(N.PageLoadRam[r][0],r))}async function Yn(r){for(let t in G.store)Ua(t,S.ReqFileTypesArray)||await qa(t,r)}function ts(){for(let r in N.PageLoadRam)N.PageLoadRam[r]=void 0,delete N.PageLoadRam[r]}function Ua(r,...t){r=r.toLowerCase();for(let e of t)for(let i of e)if(r.substring(r.length-i.length-1)=="."+i)return!0;return!1}function Ae(r,t){let e,i;return M.ErrorPages[t]?(e=d.Static,i=M.ErrorPages[t].path,r=M.ErrorPages[t].code??r):(e=d.Logs,i="e"+r),{url:i,arrayType:e,code:r}}async function Ja(r,t,e){if(r.method=="POST"?(!r.body||!Object.keys(r.body).length)&&(r.body=r.fields||{}):r.body=!1,r.closed)return;await new Promise(n=>M.Cookies(r,t,n)),await new Promise(n=>M.CookieEncrypter(r,t,n)),await new Promise(n=>M.SessionStore(r,t,n)),r.signedCookies=r.signedCookies||{},r.files=r.files||{};let i=JSON.parse(JSON.stringify(r.signedCookies));return t.statusCode=201,()=>{t.statusCode===201&&(t.statusCode=e);for(let n in r.signedCookies)(typeof r.signedCookies[n]!="object"&&r.signedCookies[n]!=i[n]||JSON.stringify(r.signedCookies[n])!=JSON.stringify(i[n]))&&t.cookie(n,r.signedCookies[n],M.CookieSettings);for(let n in i)r.signedCookies[n]===void 0&&t.clearCookie(n)}}function Ha(r){if(!r.files)return[];let t=[];for(let e in r.files){let i=r.files[e];if(Array.isArray(i))for(let n in i)t.push(i[n].filepath);else t.push(i.filepath)}return t}async function Kn(r){for(let t in r)await m.unlinkIfExists(t)}async function Va(r,t,e){if(e==200){let i=d.Static[0]+t;if(await Pr(r,M.DevMode,t)||await m.existsFile(i))return i}}async function Er(r,t){let e=[t??await qt(r,M.DevMode)];return e[1]=Ce(e[0],r),N.PageRam&&(N.PageLoadRam[r]=e),e[1]}async function es(r,t,e){let i=t+"."+S.pageTypes.page,n=r[2]+"/"+i,s=S.fullWebSitePath+n,o;if(M.DevMode&&await m.existsFile(s))!await m.existsFile(r[1]+i+".cjs")||await it(n)?(await ve(t+"."+S.pageTypes.page,r),o=await Er(n)):N.PageLoadRam[n]?.[1]?o=N.PageLoadRam[n][1]:o=await Er(n,N.PageLoadRam[n]?.[0]);else if(N.PageLoadRam[n]?.[1])o=N.PageLoadRam[n][1];else if(!N.PageRam&&await m.existsFile(s))o=await Er(n,N.PageLoadRam[n]?.[0]);else if(r!=d.Logs){let{arrayType:a,code:l,url:c}=Ae(404,"notFound");return es(a,c,l)}else s=null;return{DynamicFunc:o,code:e,fullPageUrl:s}}async function za(r,t){if(r.redirectPath?.file)t.sendFile(r.redirectPath.file),await new Promise(e=>t.on("finish",e));else if(r.redirectPath)t.writeHead(302,{Location:r.redirectPath}),t.end();else{let e=r.out_run_script.trim();e?t.send(e):t.end()}r.redirectPath.deleteAfter&&await m.unlinkIfExists(t.redirectPath.file)}async function Ga(r,t,e,i,n,s){let{DynamicFunc:o,fullPageUrl:a,code:l}=await es(e,i,n);if(!a||!o&&n==500)return t.sendStatus(l);try{let c=await s(),u=await o(t,r,r.body,r.query,r.cookies,r.session,r.files,M.DevMode);c(),await za(u,t)}catch(c){b.error(c),r.error=c;let u=Ae(500,"serverError");return _e(r,t,u.url,u.arrayType,u.code),!1}return!0}async function _e(r,t,e,i=d.Static,n=200){let s=await Va(r,e,n),o=Ha(r);if(s){M.CacheDays&&t.setHeader("Cache-Control","max-age="+M.CacheDays*24*60*60),await En(e,M.DevMode,r,t),Kn(o);return}let a=()=>Ja(r,t,n);!await Xn(r,t,e,M.DevMode,a)&&!await Ga(r,t,i,e,n,a)||Kn(o)}function rs(r){return r=="/"&&(r="/index"),decodeURIComponent(r)}import{v4 as ns}from"uuid";import{cookieParser as Qa}from"@tinyhttp/cookie-parser";import Xa from"cookie-encrypter";import ss from"express-session";import Za from"body-parser";import Ka from"memorystore";var jr=ns().substring(0,32),os=ns(),Ya=Ka(ss),as=Qa(jr),ls=Xa(jr,{}),Ir={httpOnly:!0,signed:!0,maxAge:864e5*30};M.Cookies=as;M.CookieEncrypter=ls;M.CookieSettings=Ir;var Ut=!0,Rr,Or,cs,us,E={sessionTotalRamMB:150,sessionTimeMinutes:40,sessionCheckPeriodMinutes:30,fileLimitMB:10,requestLimitMB:4},Nr;function ps(){return Nr}var ms=[...S.ReqFileTypesArray,...S.pageTypesArray,...S.pageCodeFileArray],fs=[r=>r.split(".").at(-2)!="serv"],w={get settingsPath(){return R+S.WebSiteFolder+"/Settings"},set development(r){Ut!=r&&(Ut=r,r||(Rr=Jn(w),process.env.NODE_ENV="production"),M.DevMode=r,Xr(r))},get development(){return Ut},middleware:{get cookies(){return as},get cookieEncrypter(){return ls},get session(){return Or},get formidable(){return cs},get bodyParser(){return us}},secret:{get cookies(){return jr},get session(){return os}},general:{importOnLoad:[],set pageInRam(r){Y.PageRam=r,Nr=async()=>{await(await Rr)?.(),r?await Yn(w.development):ts()}},get pageInRam(){return Y.PageRam}},compile:{set compileSyntax(r){J.AddCompileSyntax=r},get compileSyntax(){return J.AddCompileSyntax},set ignoreError(r){ie.PreventErrors=r},get ignoreError(){return ie.PreventErrors},set plugins(r){J.plugins.length=0,J.plugins.push(...r)},get plugins(){return J.plugins},get define(){return be.define},set define(r){be.define=r}},routing:{rules:{},urlStop:[],validPath:fs,ignoreTypes:ms,ignorePaths:[],sitemap:!0,get errorPages(){return M.ErrorPages},set errorPages(r){M.ErrorPages=r}},serveLimits:{get cacheDays(){return M.CacheDays},set cacheDays(r){M.CacheDays=r},get cookiesExpiresDays(){return Ir.maxAge/864e5},set cookiesExpiresDays(r){Ir.maxAge=r*864e5},set sessionTotalRamMB(r){E.sessionTotalRamMB!=r&&(E.sessionTotalRamMB=r,Jt())},get sessionTotalRamMB(){return E.sessionTotalRamMB},set sessionTimeMinutes(r){E.sessionTimeMinutes!=r&&(E.sessionTimeMinutes=r,Jt())},get sessionTimeMinutes(){return E.sessionTimeMinutes},set sessionCheckPeriodMinutes(r){E.sessionCheckPeriodMinutes!=r&&(E.sessionCheckPeriodMinutes=r,Jt())},get sessionCheckPeriodMinutes(){return E.sessionCheckPeriodMinutes},set fileLimitMB(r){E.fileLimitMB!=r&&(E.fileLimitMB=r,Be())},get fileLimitMB(){return E.fileLimitMB},set requestLimitMB(r){E.requestLimitMB!=r&&(E.requestLimitMB=r,Be(),Wr())},get requestLimitMB(){return E.requestLimitMB}},serve:{port:8080,http2:!1,greenLock:{staging:null,cluster:null,email:null,agent:null,agreeToTerms:!1,sites:[]}}};function Be(){cs={maxFileSize:w.serveLimits.fileLimitMB*1048576,uploadDir:D+"/UploadFiles/",multiples:!0,maxFieldsSize:w.serveLimits.requestLimitMB*1048576}}function Wr(){us=Za.json({limit:w.serveLimits.requestLimitMB+"mb"})}function Jt(){if(!w.serveLimits.sessionTimeMinutes||!w.serveLimits.sessionTotalRamMB){Or=(r,t,e)=>e();return}Or=ss({cookie:{maxAge:w.serveLimits.sessionTimeMinutes*60*1e3,sameSite:!0},secret:os,resave:!1,saveUninitialized:!1,store:new Ya({checkPeriod:w.serveLimits.sessionCheckPeriodMinutes*60*1e3,max:w.serveLimits.sessionTotalRamMB*1048576})})}function at(r,t,e=[],i="ignore"){if(!t)return!1;let n=!1;for(let s in t){let o=e.includes(s);(i=="only"&&o||i=="ignore"&&!o)&&(n=!0,r[s]=t[s])}return n}async function qr(){let r=await Rn(w.settingsPath,Ut);if(r==null)return;r.development?Object.assign(r,r.implDev):Object.assign(r,r.implProd),at(w.compile,r.compile),at(w.routing,r.routing,["ignoreTypes","validPath"]);let t=(e,i)=>r.routing?.[e]&&(w.routing[e]=r.routing[e].concat(i));t("ignoreTypes",ms),t("validPath",fs),at(w.serveLimits,r.serveLimits,["cacheDays","cookiesExpiresDays"],"only"),at(E,r.serveLimits,["sessionTotalRamMB","sessionTimeMinutes","sessionCheckPeriodMinutes"],"only")&&Jt(),at(E,r.serveLimits,["fileLimitMB","requestLimitMB"],"only")&&Be(),at(E,r.serveLimits,["requestLimitMB"],"only")&&Wr(),at(w.serve,r.serve),w.development=r.development,r.general?.importOnLoad&&(w.general.importOnLoad=await In(r.general.importOnLoad,Ut)),!at(w.general,r.general,["pageInRam"],"only")&&r.development&&(Nr=await Rr),w.development&&w.routing.sitemap&&jn(w)}function gs(){Jt(),Be(),Wr()}import al from"formidable";import tl from"http";import el from"http2";import*as ds from"selfsigned";import*as hs from"greenlock-express";async function rl(r,t){let e=R+"/SystemSave/";if(await m.mkdirIfNotExists(e),e+=r,await m.mkdirIfNotExists(e),t){e+="/";let i=e+t.name;await m.existsFile(i)?t.exits&&await m.writeFile(i,await t.exits(await m.readFile(i,"utf8"),i,e)):await m.writeFile(i,t.value)}}async function il(){let r,t=D+"/Certificate.json";return await m.existsFile(t)?r=m.readJsonFile(t):(r=await new Promise(e=>{ds.generate(null,{days:36500},(i,n)=>{if(i)throw i;e({key:n.private,cert:n.cert})})}),m.writeJsonFile(t,r)),r}function nl(r){let t=tl.createServer(r.attach);return{server:t,listen(e){return new Promise(i=>{t.listen(e,i)})},close(){t.close()}}}async function Ss(r){if(!(w.serve.http2||w.serve.greenLock?.agreeToTerms))return await nl(r);if(!w.serve.greenLock.agreeToTerms){let n=el.createSecureServer(I(B({},await il()),{allowHTTP1:!0}),r.attach);return{server:n,listen(s){n.listen(s)},stop(){n.close()}}}await rl("greenlock",{name:"config.json",value:JSON.stringify({sites:w.serve.greenLock.sites}),async exits(n,s,o){n=JSON.parse(n);for(let l in n.sites){let c=n.sites[l],u;for(let p of w.serve.greenLock.sites)if(p.subject==c.subject){u=!0,(p.altnames.length!=c.altnames.length||p.altnames.some(g=>c.altnames.includes(g)))&&(c.altnames=p.altnames,delete c.renewAt);break}if(!u){n.sites.splice(l,l);let p=o+"live/"+c.subject;await m.exists(p)&&(await kt(p),await m.rmdir(p))}}let a=w.serve.greenLock.sites.filter(l=>!n.sites.find(c=>c.subject==l.subject));return n.sites.push(...a),JSON.stringify(n)}});let t=await m.readJsonFile(R+"package.json"),e=await new Promise(n=>hs.init({packageRoot:R,configDir:"SystemSave/greenlock",packageAgent:w.serve.greenLock.agent||t.name+"/"+t.version,maintainerEmail:w.serve.greenLock.email,cluster:w.serve.greenLock.cluster,staging:w.serve.greenLock.staging}).ready(n));function i(n,s,o){let a=()=>{},l=e[n](o,s);return{server:l,listen:p=>{let g=e.httpServer();return a=()=>g.close(),Promise.all([new Promise(h=>l.listen(443,"0.0.0.0",h)),new Promise(h=>g.listen(p,"0.0.0.0",h))])},close:()=>{l.close(),a()}}}return w.serve.http2?i("http2Server",r.attach,{allowHTTP1:!0}):i("httpsServer",r.attach)}async function Ur(r,t){return w.development&&await qr(),await ll(r,t)}async function ll(r,t){let e=rs(r.path);for(let n of w.routing.urlStop)if(e.startsWith(n))return n.endsWith("/")&&(n=n.substring(0,n.length-1)),await ys(r,t,n);let i=Object.keys(w.routing.rules).find(n=>e.startsWith(n));i&&(e=await w.routing.rules[i](e,r,t)),await ys(r,t,e)}async function ys(r,t,e){let i=w.routing.ignorePaths.find(n=>e.startsWith(n))||w.routing.ignoreTypes.find(n=>e.endsWith("."+n));if(!i){for(let n of w.routing.validPath)if(!await n(e,r,t)){i=!0;break}}if(i){let n=Ae(404,"notFound");return await _e(r,t,n.url,n.arrayType,n.code)}await _e(r,t,e.substring(1))}var Ht;async function cl(r){let t=new sl;w.serve.http2||t.use(ol()),M.SessionStore=async(i,n,s)=>w.middleware.session(i,n,s);let e=await pl(t,r);for(let i of w.general.importOnLoad)await i(t,Ht.server,w);await ps()?.(),t.all("*",ul),await e(w.serve.port),console.log("App listing at port: "+w.serve.port)}async function ul(r,t){r.method=="POST"?r.headers["content-type"]?.startsWith?.("application/json")?w.middleware.bodyParser(r,t,()=>Ur(r,t)):new al.IncomingForm(w.middleware.formidable).parse(r,(e,i,n)=>{e&&b.error(e),r.fields=i,r.files=n,Ur(r,t)}):Ur(r,t)}async function pl(r,t){Ht&&Ht.close&&await Ht.close();let{server:e,listen:i,close:n}=await t(r);return Ht={server:e,close:n},i}async function Jr({SitePath:r="./",HttpServer:t=Ss}={}){S.WebSiteFolder=r,gs(),await qr(),cl(t)}var LS=(r,t="async import")=>X(t,r,d.Static,{isDebug:w.development});var ES=Jr;export{LS as AsyncImport,Lt as SearchRecord,w as Settings,ES as default};
