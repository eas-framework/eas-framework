var ei=Object.freeze,Ne=Object.defineProperty,Ms=Object.defineProperties;var Bs=Object.getOwnPropertyDescriptors;var ri=Object.getOwnPropertySymbols;var Fs=Object.prototype.hasOwnProperty,$s=Object.prototype.propertyIsEnumerable;var ii=(r,t,e)=>t in r?Ne(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,P=(r,t)=>{for(var e in t||(t={}))Fs.call(t,e)&&ii(r,e,t[e]);if(ri)for(var e of ri(t))$s.call(t,e)&&ii(r,e,t[e]);return r},R=(r,t)=>Ms(r,Bs(t));var Ds=(r,t)=>{for(var e in t)Ne(r,e,{get:t[e],enumerable:!0})};var Zt=(r,t)=>ei(Ne(r,"raw",{value:ei(t||r.slice())}));import{App as dl}from"@tinyhttp/app";import hl from"compression";import tt,{Dirent as Cl}from"fs";var ni=!0;function si(r){ni=r}var w=new Proxy(console,{get(r,t,e){return t=="important"?r.error:ni&&t!="do-nothing"?r[t]:()=>{}}});import Ls from"path";function Kt(r){return new Promise(t=>{tt.stat(r,(e,i)=>{t(Boolean(i))})})}function oi(r,t,e,i={}){return new Promise(n=>{tt.stat(r,(s,o)=>{s&&!e&&w.error(s),n(t&&o?o[t]:o||i)})})}async function Es(r,t=!0){return(await oi(r,void 0,!0)).isFile?.()&&t}function ai(r){return new Promise(t=>{tt.mkdir(r,e=>{e&&w.error(e),t(!e)})})}function Is(r){return new Promise(t=>{tt.rmdir(r,e=>{e&&w.error(e),t(!e)})})}function li(r){return new Promise(t=>{tt.unlink(r,e=>{e&&w.error(e),t(!e)})})}async function Rs(r){return await Kt(r)?await li(r):!1}function Os(r,t={}){return new Promise(e=>{tt.readdir(r,t,(i,n)=>{i&&w.error(i),e(n||[])})})}async function ci(r){return await Kt(r)?!1:await ai(r)}function ui(r,t){return new Promise(e=>{tt.writeFile(r,t,i=>{i&&w.error(i),e(!i)})})}async function js(r,t){try{return await ui(r,JSON.stringify(t))}catch(e){w.error(e)}return!1}function pi(r,t="utf8"){return new Promise(e=>{tt.readFile(r,t,(i,n)=>{i&&w.error(i),e(n||"")})})}async function Ns(r,t){try{return JSON.parse(await pi(r,t))}catch(e){w.error(e)}return{}}async function Ws(r,t=""){if(r=Ls.dirname(r),!await Kt(t+r)){let e=r.split(/\\|\//),i="";for(let n of e)i.length&&(i+="/"),i+=n,await ci(t+i)}}var m=R(P({},tt.promises),{exists:Kt,existsFile:Es,stat:oi,mkdir:ai,mkdirIfNotExists:ci,writeFile:ui,writeJsonFile:js,readFile:pi,readJsonFile:Ns,rmdir:Is,unlink:li,unlinkIfExists:Rs,readdir:Os,makePathReal:Ws});import{cwd as qs}from"process";import re from"path";import{fileURLToPath as Us}from"url";function j(r,t){let e=t.indexOf(r);return e==-1?[t]:[t.substring(0,e),t.substring(e+r.length)]}function Yt(r,t){return t.substring(0,t.lastIndexOf(r))}function mi(r,t){for(;t.startsWith(r);)t=t.substring(r.length);for(;t.endsWith(r);)t=t.substring(0,t.length-r.length);return t}function Js(r){return re.dirname(Us(r))}var D=re.join(Js(import.meta.url),"/SystemData"),We="WebSite",At="WWW",ee="Logs",fi="node_modules",Hs=D+`/${At}Compile/`,Vs=D+`/${ee}Compile/`,zs=D+`/${fi}Compile/`,O=qs()+"/";function qe(){return re.join(O,We,"/")}var te=qe();function _t(r){return qe()+r+"/"}var S={Static:[_t(At),Hs,At],Logs:[_t(ee),Vs,ee],node_modules:[_t("node_modules"),zs,fi],get[At](){return S.Static}},ut={page:"page",model:"mode",component:"inte"},h={pageTypes:ut,pageTypesArray:[],pageCodeFile:{page:[ut.page+".js",ut.page+".ts"],model:[ut.model+".js",ut.model+".ts"],component:[ut.component+".js",ut.component+".ts"]},pageCodeFileArray:[],partExtensions:["serv","api"],ReqFileTypes:{js:"serv.js",ts:"serv.ts","api-ts":"api.js","api-js":"api.ts"},ReqFileTypesArray:[],get WebSiteFolder(){return We},get fullWebSitePath(){return te},set WebSiteFolder(r){We=r,te=qe(),S.Static[0]=_t(At),S.Logs[0]=_t(ee)},get tsConfig(){return te+"tsconfig.json"},async tsConfigFile(){if(await m.existsFile(this.tsConfig))return await m.readFile(this.tsConfig)},relative(r){return re.relative(te,r)}};h.pageTypesArray=Object.values(h.pageTypes);h.pageCodeFileArray=Object.values(h.pageCodeFile).flat();h.ReqFileTypesArray=Object.values(h.ReqFileTypes);async function Mt(r){let t=await m.readdir(r,{withFileTypes:!0});for(let e of t){let i=e.name;if(e.isDirectory()){let n=r+i+"/";await Mt(n),await m.rmdir(n)}else await m.unlink(r+i)}}function pt(r){return Yt(".",j("/",r).pop())}import _i from"path";import{SourceMapGenerator as Qs,SourceMapConsumer as Xs}from"source-map";import ie from"path";import{fileURLToPath as Zs}from"url";import{SourceMapConsumer as gi,SourceMapGenerator as Gs}from"source-map";function mt(r,t){let e=`sourceMappingURL=data:application/json;charset=utf-8;base64,${Buffer.from(r.toString()).toString("base64")}`;return t?e=`/*# ${e}*/`:e="//# "+e,`\r
`+e}async function di(r,t){let e=await new gi(t),i=new Gs;return(await new gi(r)).eachMapping(n=>{let s=e.originalPositionFor({line:n.originalLine,column:n.originalColumn});!s.source||i.addMapping({generated:{column:n.generatedColumn,line:n.generatedLine},original:{column:s.column,line:s.line},source:s.source})}),i}var Bt=class{constructor(t,e=!0,i=!1,n=!1){this.filePath=t;this.httpSource=e;this.relative=i;this.isCss=n;this.lineCount=0;this.map=new Qs({file:t.split(/\/|\\/).pop()}),e||(this.fileDirName=ie.dirname(this.filePath))}getSource(t){return t=t.split("<line>").pop().trim(),this.httpSource?(h.pageTypesArray.includes(ie.extname(t).substring(1))?t+=".source":t=j("/",t).pop()+"?source=true",ie.normalize((this.relative?"":"/")+t.replace(/\\/gi,"/"))):ie.relative(this.fileDirName,h.fullWebSitePath+t)}getRowSourceMap(){return this.map.toJSON()}mapAsURLComment(){return mt(this.map,this.isCss)}},et=class extends Bt{constructor(e,i=!0,n=!1,s=!0){super(e,s,!1,n);this.debug=i;this.storeString="";this.actionLoad=[]}notEmpty(){return this.actionLoad.length>0}addStringTracker(e,{text:i=e.eq}={}){this.actionLoad.push({name:"addStringTracker",data:[e,{text:i}]})}_addStringTracker(e,{text:i=e.eq}={}){if(!this.debug)return this._addText(i);let n=e.getDataArray(),s=n.length,o=!1;for(let a=0;a<s;a++){let{text:l,line:c,info:p}=n[a];if(l==`
`){this.lineCount++,o=!1;continue}!o&&c&&p&&(o=!0,this.map.addMapping({original:{line:c,column:0},generated:{line:this.lineCount,column:0},source:this.getSource(p)}))}this.storeString+=i}addText(e){this.actionLoad.push({name:"addText",data:[e]})}_addText(e){this.debug&&(this.lineCount+=e.split(`
`).length-1),this.storeString+=e}static fixURLSourceMap(e){for(let i=0;i<e.sources.length;i++)e.sources[i]=h.relative(Zs(e.sources[i]));return e}addSourceMapWithStringTracker(e,i,n){this.actionLoad.push({name:"addSourceMapWithStringTracker",data:[e,i,n]})}async _addSourceMapWithStringTracker(e,i,n){if(!this.debug)return this._addText(n);(await new Xs(e)).eachMapping(s=>{let o=i.getLine(s.originalLine).getDataArray()[0];s.source==this.filePath?this.map.addMapping({source:this.getSource(s.source),original:{line:o.line,column:s.originalColumn},generated:{line:s.generatedLine+this.lineCount,column:s.generatedColumn}}):this.map.addMapping({source:this.getSource(s.source),original:{line:s.originalLine,column:s.originalColumn},generated:{line:s.generatedLine,column:s.generatedColumn}})}),this._addText(n)}async buildAll(){for(let{name:e,data:i}of this.actionLoad)switch(e){case"addStringTracker":this._addStringTracker(...i);break;case"addText":this._addText(...i);break;case"addSourceMapWithStringTracker":await this._addSourceMapWithStringTracker(...i);break}}mapAsURLComment(){return this.buildAll(),super.mapAsURLComment()}async createDataWithMap(){return await this.buildAll(),this.debug?this.storeString+super.mapAsURLComment():this.storeString}clone(){let e=new et(this.filePath,this.debug,this.isCss,this.httpSource);return e.actionLoad.push(...this.actionLoad),e}};var ne=class extends Bt{constructor(t,e=!1,i=!1){super(t,e,i),this.lineCount=1}addMappingFromTrack(t){let e=t.getDataArray(),i=e.length,n=!0;for(let s=0;s<i;s++){let{text:o,line:a,info:l}=e[s];if(o==`
`){this.lineCount++,n=!1;continue}!n&&a&&l&&(n=!0,this.map.addMapping({original:{line:a,column:0},generated:{line:this.lineCount,column:0},source:this.getSource(l)}))}}};function hi(r,t,e,i){let n=new ne(t,e,i);return n.addMappingFromTrack(r),n.getRowSourceMap()}function Si(r,t){let e=new ne(t);return e.addMappingFromTrack(r),r.eq+e.mapAsURLComment()}var f=class{constructor(t,e){this.DataArray=[];this.InfoText=null;this.OnLine=1;this.OnChar=1;typeof t=="string"?this.InfoText=t:t&&this.setDefault(t),e&&this.AddFileText(e,this.DefaultInfoText.info)}static get emptyInfo(){return{info:"",line:0,char:0}}setDefault(t=this.DefaultInfoText){this.InfoText=t.info,this.OnLine=t.line,this.OnChar=t.char}getDataArray(){return this.DataArray}get DefaultInfoText(){return!this.DataArray.find(t=>t.info)&&this.InfoText!=null?{info:this.InfoText,line:this.OnLine,char:this.OnChar}:this.DataArray[this.DataArray.length-1]??f.emptyInfo}get StartInfo(){return this.DataArray[0]??this.DefaultInfoText}get OneString(){let t="";for(let e of this.DataArray)t+=e.text;return t}get eq(){return this.OneString}get lineInfo(){let t=this.DefaultInfoText,e=t.info.split("<line>");return e.push(h.fullWebSitePath+e.pop()),`${e.join("<line>")}:${t.line}:${t.char}`}get length(){return this.DataArray.length}Clone(){let t=new f(this.StartInfo);for(let e of this.DataArray)t.AddTextAfter(e.text,e.info,e.line,e.char);return t}AddClone(t){this.DataArray=this.DataArray.concat(t.DataArray),this.setDefault({info:t.InfoText,line:t.OnLine,char:t.OnChar})}static concat(...t){let e=new f;for(let i of t)i instanceof f?e.AddClone(i):e.AddTextAfter(String(i));return e}ClonePlus(...t){return f.concat(this.Clone(),...t)}Plus(...t){let e=this.DefaultInfoText;for(let i of t)i instanceof f?(e=i.DefaultInfoText,this.AddClone(i)):this.AddTextAfter(String(i),e.info,e.line,e.char);return this}Plus$(t,...e){let i=this.DefaultInfoText;for(let n in e){let s=t[n],o=e[n];this.AddTextAfter(s,i?.info,i?.line,i?.char),o instanceof f?(this.AddClone(o),i=o.DefaultInfoText):o!=null&&this.AddTextAfter(String(o),i?.info,i?.line,i?.char)}return this.AddTextAfter(t[t.length-1],i?.info,i?.line,i?.char),this}AddTextAction(t,e,i=this.DefaultInfoText.info,n=0,s=1){let o=[];for(let a of[...t])o.push({text:a,info:i,line:n,char:s}),s++,a==`
`&&(n++,s=1);this.DataArray[e](...o)}AddTextAfter(t,e,i,n){return this.AddTextAction(t,"push",e,i,n),this}AddTextAfterNoTrack(t,e=""){for(let i of t)this.DataArray.push({text:i,info:e,line:0,char:0});return this}AddTextBefore(t,e,i,n){return this.AddTextAction(t,"unshift",e,i,n),this}AddTextBeforeNoTrack(t,e=""){let i=[];for(let n of t)i.push({text:n,info:e,line:0,char:0});return this.DataArray.unshift(...i),this}AddFileText(t,e=this.DefaultInfoText.info){let i=1,n=1;for(let s of[...t])this.DataArray.push({text:s,info:e,line:i,char:n}),n++,s==`
`&&(i++,n=1)}CutString(t=0,e=this.length){let i=new f(this.StartInfo);return i.DataArray=i.DataArray.concat(this.DataArray.slice(t,e)),i}substring(t,e){return isNaN(e)?e=void 0:e=Math.abs(e),isNaN(t)?t=void 0:t=Math.abs(t),this.CutString(t,e)}substr(t,e){return t<0&&(t=this.length-t),this.substring(t,e!=null?e+t:e)}slice(t,e){return t<0&&(t=this.length-t),e<0&&(t=this.length-t),this.substring(t,e)}charAt(t){return t||(t=0),this.CutString(t,t+1)}at(t){return this.charAt(t)}charCodeAt(t){return this.charAt(t).OneString.charCodeAt(0)}codePointAt(t){return this.charAt(t).OneString.codePointAt(0)}*[Symbol.iterator](){for(let t of this.DataArray){let e=new f;e.DataArray.push(t),yield e}}getLine(t,e=!0){return this.split(`
`)[t-+e]}charLength(t){if(t<=0)return t;let e=0;for(let i of this.DataArray)if(e++,t-=i.text.length,t<=0)return e;return e}indexOf(t){return this.charLength(this.OneString.indexOf(t))}lastIndexOf(t){return this.charLength(this.OneString.lastIndexOf(t))}unicodeMe(t){let e="";for(let i of t)e+="\\u"+("000"+i.charCodeAt(0).toString(16)).slice(-4);return e}get unicode(){let t=new f;for(let e of this.DataArray)t.AddTextAfter(this.unicodeMe(e.text),e.info,e.line,e.char);return t}search(t){return this.charLength(this.OneString.search(t))}startsWith(t,e){return this.OneString.startsWith(t,e)}endsWith(t,e){return this.OneString.endsWith(t,e)}includes(t,e){return this.OneString.includes(t,e)}trimStart(){let t=this.Clone();t.setDefault();for(let e=0;e<t.DataArray.length;e++){let i=t.DataArray[e];if(i.text.trim()=="")t.DataArray.shift(),e--;else{i.text=i.text.trimStart();break}}return t}trimLeft(){return this.trimStart()}trimEnd(){let t=this.Clone();t.setDefault();for(let e=t.DataArray.length-1;e>=0;e--){let i=t.DataArray[e];if(i.text.trim()=="")t.DataArray.pop();else{i.text=i.text.trimEnd();break}}return t}trimRight(){return this.trimEnd()}trim(){return this.trimStart().trimEnd()}SpaceOne(t){let e=this.at(0),i=this.at(this.length-1),n=this.Clone().trim();return e.eq&&n.AddTextBefore(t||e.eq,e.DefaultInfoText.info,e.DefaultInfoText.line,e.DefaultInfoText.char),i.eq&&n.AddTextAfter(t||i.eq,i.DefaultInfoText.info,i.DefaultInfoText.line,i.DefaultInfoText.char),n}ActionString(t){let e=this.Clone();for(let i of e.DataArray)i.text=t(i.text);return e}toLocaleLowerCase(t){return this.ActionString(e=>e.toLocaleLowerCase(t))}toLocaleUpperCase(t){return this.ActionString(e=>e.toLocaleUpperCase(t))}toUpperCase(){return this.ActionString(t=>t.toUpperCase())}toLowerCase(){return this.ActionString(t=>t.toLowerCase())}normalize(){return this.ActionString(t=>t.normalize())}StringIndexer(t,e){t instanceof RegExp&&(t=new RegExp(t,t.flags.replace("g","")));let i=[],n=this.OneString,s=n.match(t),o=0,a=0,l=this.Clone();for(;(e==null||a<e)&&s?.[0]?.length;){let c=[...s[0]].length,p=l.charLength(s.index);i.push({index:p+o,length:c}),n=n.slice(s.index+s[0].length),l=l.CutString(p+c),o+=p+c,s=n.match(t),a++}return i}RegexInString(t){return t instanceof RegExp?t:new f("n",t).unicode.eq}split(t,e){let i=this.StringIndexer(this.RegexInString(t),e),n=[],s=0;for(let o of i)n.push(this.CutString(s,o.index)),s=o.index+o.length;return n.push(this.CutString(s)),n}repeat(t){let e=this.Clone();for(let i=0;i<t;i++)e.AddClone(this.Clone());return e}static join(t){let e=new f;for(let i of t)e.AddClone(i);return e}replaceWithTimes(t,e,i){let n=this.StringIndexer(t,i),s=new f,o=0;for(let a of n)s=s.ClonePlus(this.CutString(o,a.index),e),o=a.index+a.length;return s.AddClone(this.CutString(o)),s}replace(t,e){return this.replaceWithTimes(this.RegexInString(t),e,t instanceof RegExp?void 0:1)}replacer(t,e){let i=this.Clone(),n;function s(){n=i.match(t)}s();let o=new f(i.StartInfo);for(;n;)o.Plus(i.substring(0,n.index)),o.Plus(e(n)),i=i.substring(n.index+n[0].length),s();return o.Plus(i),o}async replacerAsync(t,e){let i=this.Clone(),n;function s(){n=i.match(t)}s();let o=new f(i.StartInfo);for(;n;)o.Plus(i.substring(0,n.index)),o.Plus(await e(n)),i=i.substring(n.index+n[0].length),s();return o.Plus(i),o}replaceAll(t,e){return this.replaceWithTimes(this.RegexInString(t),e)}matchAll(t){let e=this.StringIndexer(t),i=[];for(let n of e)i.push(this.substr(n.index,n.length));return i}match(t){if(t instanceof RegExp&&t.global)return this.matchAll(t);let e=this.OneString.match(t);if(e==null)return null;let i=[];i[0]=this.substr(e.index,e.shift().length),i.index=e.index,i.input=this.Clone();let n=i[0].Clone();for(let s in e){if(isNaN(Number(s)))break;let o=e[s];if(o==null){i.push(o);continue}let a=n.indexOf(o);i.push(n.substr(a,o.length)),n=n.substring(a)}return i}toString(){return this.OneString}extractInfo(t="<line>"){return this.DefaultInfoText.info.split(t).pop().trim()}originalPositionFor(t,e){let i=this.getLine(t);return i.startsWith("//")&&(i=this.getLine(t-1),e=0),R(P({},i.at(e-1).DefaultInfoText),{searchLine:i})}debugLine({message:t,text:e,location:i,line:n,col:s}){let o=this.originalPositionFor(n??i?.line??1,s??i?.column??0);return`${e||t}, on file -><color>${h.fullWebSitePath+o.searchLine.extractInfo()}:${o.line}:${o.char}${i?.lineText?`
Line: "`+i.lineText.trim()+'"':""}`}StringWithTack(t){return Si(this,t)}StringTack(t,e,i){return hi(this,t,e,i)}};import se from"chalk";var oe={PreventErrors:[]},Ue=[],Je=()=>Ue.length=0;function M({id:r,text:t,type:e="warn",errorName:i}){if(!Ue.includes(r??t)&&!oe.PreventErrors.includes(i)){Ue.push(r??t);let n=e=="error"?"important":e,s=t.split("<color>"),o=se.magenta(s.pop().replace(/<line>/gi," -> ")),a="-".repeat(10)+(e=="error"?se.bold(e):e)+"-".repeat(10);return[n,a+`
`+se.blue(s.shift()||"")+`
`+o+`
`+se.red(`Error-Code: ${i}`)+`
`+"-".repeat(e.length+20)+`
`]}return["do-nothing"]}function yi(r){return r.replace(/\n|<line>|<color>/,"<br/>")}import{promises as Ks}from"fs";import{fileURLToPath as Ys}from"url";var to="/../static/wasm/component/",eo=new WebAssembly.Module(await Ks.readFile(Ys(import.meta.url+to+"build.wasm"))),ro=new WebAssembly.Instance(eo,{}),W=ro.exports,ft=0,ae=null;function He(){return(ae===null||ae.buffer!==W.memory.buffer)&&(ae=new Uint8Array(W.memory.buffer)),ae}var io=typeof TextEncoder>"u"?(0,module.require)("util").TextEncoder:TextEncoder,le=new io("utf-8"),no=typeof le.encodeInto=="function"?function(r,t){return le.encodeInto(r,t)}:function(r,t){let e=le.encode(r);return t.set(e),{read:r.length,written:e.length}};function Ft(r,t,e){if(e===void 0){let a=le.encode(r),l=t(a.length);return He().subarray(l,l+a.length).set(a),ft=a.length,l}let i=r.length,n=t(i),s=He(),o=0;for(;o<i;o++){let a=r.charCodeAt(o);if(a>127)break;s[n+o]=a}if(o!==i){o!==0&&(r=r.slice(o)),n=e(n,i,i=o+r.length*3);let a=He().subarray(n+o,n+i);o+=no(r,a).written}return ft=o,n}var so=typeof TextDecoder>"u"?(0,module.require)("util").TextDecoder:TextDecoder,oo=new so("utf-8",{ignoreBOM:!0,fatal:!0});oo.decode();function xi(r,t){var e=Ft(r,W.__wbindgen_malloc,W.__wbindgen_realloc),i=ft,n=Ft(t,W.__wbindgen_malloc,W.__wbindgen_realloc),s=ft,o=W.find_end_block(e,i,n,s);return o}function bi(r,t){var e=Ft(r,W.__wbindgen_malloc,W.__wbindgen_realloc),i=ft,n=Ft(t,W.__wbindgen_malloc,W.__wbindgen_realloc),s=ft,o=W.find_end_of_def(e,i,n,s);return o}function wi(r,t){var e=Ft(r,W.__wbindgen_malloc,W.__wbindgen_realloc),i=ft,n=W.find_end_of_q(e,i,t.codePointAt(0));return n>>>0}var Ti=["textarea","script","style"],ki=[["%","%"],["#{debug}","{debug}#"]];import lo from"workerpool";import{cpus as co}from"os";var rt=lo.pool(D+"/../static/wasm/component/workerInsertComponent.js",{maxWorkers:co().length}),st=class{static findEntOfQ(t,e){return wi(t,e)}static findEndOfDef(t,e){return Array.isArray(e)||(e=[e]),bi(t,JSON.stringify(e))}static FindEndOfBlock(t,e,i){return xi(t,e+i)}},ce=class{constructor(t){this.printNew=t;this.SimpleSkip=Ti;this.SkipSpecialTag=ki}printErrors(t,e){if(!!this.printNew)for(let i of JSON.parse(e).reverse())this.printNew({text:`
Warning, you didn't write right this tag: "${i.type_name}", used in: ${t.at(Number(i.index)).lineInfo}
(the system will auto close it)`,errorName:"close-tag"})}async FindCloseChar(t,e){let[i,n]=await rt.exec("FindCloseChar",[t.eq,e]);return this.printErrors(t,n),i}async FindCloseCharHTML(t,e){let[i,n]=await rt.exec("FindCloseCharHTML",[t.eq,e]);return this.printErrors(t,n),i}};async function vi(r){return JSON.parse(await rt.exec("RazorToEJS",[r]))}async function Ci(r,t){return JSON.parse(await rt.exec("RazorToEJSMini",[r,t]))}async function Pi(r,t,e){return JSON.parse(await rt.exec("EJSParser",[r,t,e]))}import uo from"workerpool";import{cpus as po}from"os";var Ge=uo.pool(D+"/../static/wasm/reader/worker.js",{maxWorkers:po().length});async function ue(r){return JSON.parse(await Ge.exec("build_stream",[r]))}async function Qe(r,t){return await Ge.exec("find_end_of_def_skip_block",[r,JSON.stringify(t)])}async function Ai(r,t){return await Ge.exec("end_of_block",[r,t.join("")])}var Ve=class{ReplaceAll(t,e,i){let n="";for(let s of t.split(e))n+=i+s;return n.substring(i.length)}},ze=class extends Ve{constructor(e){super();this.ParseArray=e}BuildCode(){let e="";for(let i of this.ParseArray)e+=i.text;return this.ReplaceAll(e,"<|-|>","<||>")}},yt=class extends ze{constructor(e){super(e);this.DataCode={text:"",inputs:[]},this.CreateDataCode()}get CodeBuildText(){return this.DataCode.text}set CodeBuildText(e){this.DataCode.text=e}get AllInputs(){return this.DataCode.inputs}CreateDataCode(){for(let e of this.ParseArray)e.is_skip?(this.DataCode.text+=`<|${this.DataCode.inputs.length}|${e.type_name??""}|>`,this.DataCode.inputs.push(e.text)):this.DataCode.text+=e.text}BuildCode(){let e=this.DataCode.text.replace(/<\|([0-9]+)\|[\w]*\|>/gi,(i,n)=>this.DataCode.inputs[n]);return super.ReplaceAll(e,"<|-|>","<||>")}};var v=class{constructor(t,e,i="<%",n="%>",s="script"){this.start=i,this.text=t,this.end=n,this.type=s,this.path=e}ReplaceValues(t,e){this.text=this.text.replaceAll(t,e)}findEndOfDefGlobal(t){let e=t.eq,i=st.findEndOfDef(e,[";",`
`,this.end]);return i!=-1?i+1:e.length}ScriptWithInfo(t){let e=new f(t.StartInfo),i=t.split(`
`),n=i.length;e.Plus(`
`);let s=1;for(let o of i)o.eq.trim().length&&e.Plus(new f(null,`//!${o.lineInfo}
`),o),s!=n&&(e.Plus(`
`),s++);return e}async findScripts(){let t=await Pi(this.text.eq,this.start,this.end);this.values=[];for(let e of t){let i=this.text.substring(e.start,e.end),n=e.name;switch(e.name){case"print":i=new f().Plus$`write(${i})`,n="script";break;case"escape":i=new f().Plus$`writeSafe(${i})`,n="script";break;case"debug":i=new f().Plus$`\nrun_script_name = \`${v.fixText(i)}\``,n="no-track";break}n!="text"&&!i.endsWith(";")&&i.AddTextAfterNoTrack(";"),this.values.push({text:i,type:n})}}static fixText(t){return t.replace(/\\/gi,"\\\\").replace(/`/gi,"\\`").replace(/\u0024/gi,"\\u0024")}static fixTextSimpleQuotes(t){return t.replace(/\\/gi,"\\\\").replace(/"/gi,'\\"')}ReBuildText(){let t=new f(this.values[0]?.text?.StartInfo);for(let e of this.values)e.type=="text"?e.text.eq!=""&&t.Plus(e.text):e.type=="no-track"?t.Plus(this.start,"!",e.text,this.end):t.Plus(this.start,e.text,this.end);return t}BuildAll(t){let e=new f(this.values[0]?.text?.StartInfo);if(!this.values.length)return e;for(let i of this.values)i.type=="text"?i.text.eq!=""&&e.Plus$`\nout_run_script.text+=\`${v.fixText(i.text)}\`;`:t&&i.type=="script"?e.Plus(new f(null,`
run_script_code=\`${v.fixText(i.text)}\`;`),this.ScriptWithInfo(i.text)):e.Plus(i.text);return e}static printError(t){return`<div style="color:red;text-align:left;font-size:16px;">${v.fixText(yi(t))}</div>`}static async RunAndExport(t,e,i){let n=new v(t,e);return await n.findScripts(),n.BuildAll(i)}static split2FromEnd(t,e,i=1){for(let n=t.length-1;n>=0;n--)if(t[n]==e&&i--,i==0)return[t.substring(0,n),t.substring(n+1)];return[t]}},xt=class{constructor(t=""){this.addText=t;this.savedBuildData=[];this.replacer=RegExp(`${t}\\/\\*!system--<\\|ejs\\|([0-9])\\|>\\*\\/|system--<\\|ejs\\|([0-9])\\|>`)}async load(t,e){this.buildCode=new yt(await ue(await this.ExtractAndSaveCode(t))),this.path=e}async ExtractAndSaveCode(t){let e=new v(t,this.path);await e.findScripts();let i="",n=0;for(let s of e.values)s.type=="text"?i+=s.text:(this.savedBuildData.push({type:s.type,text:s.text}),i+=`system--<|ejs|${n++}|>`);return i}ParseOutsideOfComment(t){return t.replacer(/system--<\|ejs\|([0-9])\|>/,e=>{let i=e[1];return new f(i.StartInfo).Plus$`${this.addText}/*!system--<|ejs|${i}|>*/`})}async StartBuild(){let t=new v(new f(null,this.buildCode.CodeBuildText),this.path,"/*","*/");await t.findScripts();for(let e of t.values)e.type=="text"&&(e.text=this.ParseOutsideOfComment(e.text));return this.buildCode.CodeBuildText=t.ReBuildText().eq,this.buildCode.BuildCode()}RestoreAsCode(t){return new f(t.text.StartInfo).Plus$`<%${t.type=="no-track"?"!":""}${t.text}%>`}RestoreCode(t){return t.replacer(this.replacer,e=>{let i=Number(e[1]??e[2]);return this.RestoreAsCode(this.savedBuildData[i])})}};async function mo(r,t){let e=new v(r,t,"<#{debug}","{debug}#>","debug info");await e.findScripts();let i=new f(r.DefaultInfoText);for(let n of e.values)n.type=="text"?i.Plus(n.text):i.Plus$`<%{?debug_file?}${n.text}%>`;return i}async function Bi(r,t){let e=new v(r,t,"<#{debug}","{debug}#>","debug info");await e.findScripts();let i=new f(r.DefaultInfoText);for(let n of e.values)n.type=="text"?i.Plus(n.text):i.Plus$`run_script_name=\`${v.fixText(n.text)}\`;`;return i}async function Fi(r,t){let e=new v(r,t);await e.findScripts();for(let i of e.values)i.type=="text"?i.text=await mo(i.text,t):i.text=await Bi(i.text,t);return e.start="<%",e.end="%>",e.ReBuildText()}async function $i(r,t){return await Bi(r,t)}async function bt(r,t,e,i,n={}){return n.value||(n.value=await m.readFile(e,"utf8")),{allData:new f(`${t}<line>${i}`,r?`<%{%>${n.value}<%}%>`:n.value),stringInfo:`<%!
run_script_name=\`${v.fixText(t+" -> "+i)}\`;%>`}}function Mi(r,t,e,i,n=0){if(i&&!t.endsWith("."+i)&&(t=`${t}.${i}`),t[0]=="^"){let[s,o]=j("/",t.substring(1));return(n==0?O:"")+`node_modules/${s}/${e}/${o}`}return t[0]=="."?(t[1]=="/"&&(t=t.substring(2)),t=`${_i.dirname(r)}/${t}`):t[0]=="/"?t=`${S.Static[n]}${t}`:t=`${n==0?O+h.WebSiteFolder+"/":""}${e}/${t}`,_i.normalize(t)}function wt(r,t,e,i,n){return{SmallPath:Mi(t,e,i,n,2),FullPath:Mi(r,e,i,n)}}import{minify as go}from"@swc/core";import{SourceMapConsumer as fo}from"source-map";function Xe(r,t=(e,i,n)=>({line:e,char:i,info:n})){let e=r.stack.trim().split(`
`),i=e.reverse().findIndex(l=>l.includes("//!"));if(i==-1){let l=r.message.replace(/(;[0-9]m)(.*?)\[0m:([0-9]+):([0-9]+)\]/,(c,p,u,g,d)=>{let{line:y,char:b,info:k}=t(Number(g),Number(d),u);return`${p}${k}:${y}:${b}]`});return{errorCode:r.code,errorLines:e[0],errorFile:e[0],simpleMessage:l,fullMessage:l}}let n=e[i].split("//!").pop(),s=e.slice(e.length-i,-3).map(l=>l.substring(l.indexOf("\u2502")+1)).join(`
`),o=e.at(-2);o=o.substring(o.indexOf("`")).split("[0m").shift().trim();let a={get simpleMessage(){return`${a.errorCode}, on file -><color>
${a.errorFile}`},get fullMessage(){return`${a.simpleMessage}
Lines: ${a.errorLines}`},errorFile:n,errorLines:s,errorCode:o};return a}function pe(r){let t=Xe(r),[e,i]=M({type:"error",errorName:"compilation-error",text:t.fullMessage});return w[e](i),t}async function Di(r,t,e){let i=await new fo(t),n=Xe(r,(a,l)=>{let c=i.originalPositionFor({line:a,column:l});return{line:c.line,char:c.column,info:e??c.source}}),[s,o]=M({type:"error",errorName:"compilation-error",text:n.fullMessage});return w[s](o),n}function Q(r,t){let e=Xe(t,(s,o,a)=>{let l=r.originalPositionFor(s,o);return R(P({},l),{info:l.searchLine.extractInfo()})}),[i,n]=M({type:"error",errorName:"compilation-error",text:e.fullMessage});return w[i](n),e}async function Li(r,t){try{return(await go(r)).code}catch(e){Q(t,e)}return r}var ho="/serv/temp.js";async function So(r,t,e,i,n,s,o){let a=await v.RunAndExport(n,s,o);return new f().Plus$`function ${t}({${e}}, selector${i?` = "${i}"`:""}, out_run_script = {text: ''}){
        const {write, writeSafe, setResponse, sendToSelector} = new buildTemplate(out_run_script);
        ${await r(a)}
        var exports = ${t}.exports;
        return sendToSelector(selector, out_run_script.text);
    }\n${t}.exports = {};`}async function Ze(r,t,e,i,n,s){i=await n.StartReplace(i,r,s),s.script(ho,{async:null});let o=await So(s.BuildScriptWithPrams,e.popAnyTracker("name","connect"),e.popAnyTracker("params",""),e.popAnyDefault("selector",""),i,r,s.debug&&!n.SomePlugins("SafeDebug")),a=s.addScriptStylePage("script",e,t);return n.SomePlugins("MinJS")||n.SomePlugins("MinAll")?a.addText(await Li(o.eq,i)):a.addStringTracker(o),{compiledString:new f}}import{SourceMapConsumer as yo}from"source-map";import{fileURLToPath as xo}from"url";async function $t(r,t){let e=typeof t=="string"?JSON.parse(t):t,i=new f(null,r),n=i.split(`
`);return(await new yo(e)).eachMapping(s=>{let o=n[s.generatedLine-1];if(!o)return;let a=1;for(let l of o.substring(s.generatedColumn?s.generatedColumn-1:0).getDataArray())l.info=s.source,l.line=s.originalLine,l.char=a++}),i}function bo(r,t){let e=r.split(`
`);for(let i of t.getDataArray()){let{line:n,char:s,info:o}=e[i.line-1]?.DefaultInfoText??f.emptyInfo;i.line=n,i.info=o,i.char=s}}async function Tt(r,t,e){let i=await $t(t,e);return bo(r,i),i}function wo(r,t,e){let i=r.split(`
`);for(let n of t.getDataArray())if(n.info==e){let{line:s,char:o,info:a}=i[n.line-1].at(n.char-1)?.DefaultInfoText??f.emptyInfo;n.line=s,n.info=a,n.char=o}else n.info&&(n.info=h.relative(xo(n.info)))}async function Ei(r,t,e,i){let n=await $t(t,e);return wo(r,n,i),n}import{transform as To}from"@swc/core";var Ke="es2022";function me(r){return r.transform={legacyDecorator:!0,decoratorMetadata:!0},r.parser.decorators=!0,r}function X(r){return me(P({target:Ke},r))}function kt(r){return r.module={type:"commonjs",strict:!1,strictMode:!1},r}async function fe(r,t,e,i=r.eq,n){let s="",o,a=kt(P({filename:r.extractInfo(),minify:q("Min"+t.toUpperCase())||q("MinAll"),sourceMaps:e,jsc:P({target:Ke},n)},$("transformOptions")));try{switch(t){case"ts":me(a.jsc).parser=P({syntax:"typescript"},$("TSOptions"));break;case"jsx":a.jsc.parser=P({syntax:"ecmascript",jsx:!0},$("JSXOptions"));break;case"tsx":me(a.jsc).parser=P({syntax:"ecmascript",jsx:!0},$("TSXOptions"));break}let{map:l,code:c}=await To(i,a);s=c,o=l}catch(l){Q(r,l)}return{resultCode:s,resultMap:o}}var Ii;async function Ye(r,t,e,i,n){let s=n,o=new xt("serv");await o.load(n,t);let a=await o.StartBuild(),{resultCode:l,resultMap:c}=await fe(n,r,!1,a,{preserveAllComments:!0});return s=o.RestoreCode(await $t(l,c)),{compiledString:new f(e.DefaultInfoText).Plus$(Ii||(Ii=Zt(["<script",">","<\/script>"])),i.rebuildSpace(),s)}}async function tr(r,t,e,i){let n=e.eq,s=n.trim(),o=t.popString("type")=="module",a=o?"scriptModule":"script";if(i.cache[a].includes(s))return{compiledString:new f};i.cache[a].push(s);let{resultCode:l,resultMap:c}=await fe(e,r,i.debug),p=i.addScriptStylePage(o?"module":"script",t,e);return c?p.addSourceMapWithStringTracker(JSON.parse(c),e,l):p.addText(l),{compiledString:new f}}var Ri;async function er(r,t,e,i,n){if(e.exists("src"))return{compiledString:new f(t.DefaultInfoText).Plus$(Ri||(Ri=Zt(["<script",">","<\/script>"])),e.rebuildSpace(),i)};let s=e.popAnyDefault("lang","js");return e.popBoolean("server")?Ye(s,r,t,e,i):tr(s,e,i,n)}import{fileURLToPath as rr,pathToFileURL as ir}from"url";import Oi from"sass";function Dt(r){return{findFileUrl(t){return t[0]=="/"||t[0]=="~"?new URL(t.substring(1),ir(t[0]=="/"?S.Static[0]:S.node_modules[0])):new URL(t,ir(r))}}}function ji(r){return["scss","sass"].includes(r)?q("MinAll","MinSass"):q("MinCss","MinAll")}function ge(r){return ji(r)?"compressed":"expanded"}function Lt(r){return r=="sass"?"indented":r}function nr(r,t){if(!!r)for(let e in r.sources)r.sources[e].startsWith("data:")&&(r.sources[e]=t)}function Ni({sassStack:r}){let t=r.match(/[0-9]+:[0-9]+/)[0].split(":").map(e=>Number(e));return{line:t[0],column:t[1]}}function sr(r,{line:t,column:e}=Ni(r)){let[i,n]=M({text:`${r.message},
on file -><color>${rr(r.span.url)}:${t??0}:${e??0}`,errorName:r?.status==5?"sass-warning":"sass-error",type:r?.status==5?"warn":"error"});w[i](n)}function or(r,t){if(r.span.url)return sr(r);r.location=Ni(r);let[e,i]=M({text:t.debugLine(r),errorName:r?.status==5?"sass-warning":"sass-error",type:r?.status==5?"warn":"error"});w[e](i)}async function de(r,t,e,i=t.eq){let n=h.fullWebSitePath+t.extractInfo(),s=ir(n),o=ji(r),a;try{a=await Oi.compileStringAsync(i,{sourceMap:e.debug,syntax:Lt(r),style:o?"compressed":"expanded",importer:Dt(n),logger:Oi.Logger.silent}),i=a?.css??i}catch(l){if(l.span.url){let c=rr(l.span.url);await e.dependence(h.relative(c),c)}return or(l,t),{outStyle:"Sass Error (see console)"}}if(a?.loadedUrls)for(let l of a.loadedUrls){let c=rr(l);await e.dependence(h.relative(c),c)}return a?.sourceMap&&nr(a.sourceMap,s.href),{result:a,outStyle:i,compressed:o}}async function ar(r,t,e,i,n,s){let o=new xt;await o.load(n.trimStart(),t);let{outStyle:a,compressed:l}=await de(r,n,s,await o.StartBuild());l||(a=`
${a}
`);let c=o.RestoreCode(new f(n.StartInfo,a));return{compiledString:new f(e.DefaultInfoText).Plus$`<style${i.rebuildSpace()}>${c}</style>`}}async function lr(r,t,e,i){let n=e.eq.trim();if(i.cache.style.includes(n))return{compiledString:new f};i.cache.style.push(n);let{result:s,outStyle:o}=await de(r,e,i),a=i.addScriptStylePage("style",t,e);return s?.sourceMap?a.addSourceMapWithStringTracker(et.fixURLSourceMap(s.sourceMap),e,o):a.addStringTracker(e,{text:o}),{compiledString:new f}}async function cr(r,t,e,i,n){let s=e.popAnyDefault("lang","css");return e.popBoolean("server")?ar(s,r,t,e,i,n):lr(s,e,i,n)}import Wi from"path";var J=class{constructor(t,e=!0){this.store={};this.savePath=`${D}/${t}.json`,e&&this.loadFile(),process.on("SIGINT",async()=>{await this.save(),setTimeout(()=>process.exit())})}async loadFile(){await m.existsFile(this.savePath)&&(this.store=JSON.parse(await m.readFile(this.savePath)||"{}"))}update(t,e){this.store[t]=e}have(t,e){let i=this.store[t];return i||!e||(i=e(),this.update(t,i)),i}clear(){for(let t in this.store)this.store[t]=void 0,delete this.store[t]}save(){return m.writeJsonFile(this.savePath,this.store)}};var H=new J("PagesInfo");async function ot(r,t=H.store[r]){for(let e in t){let i=h.fullWebSitePath+(e=="thisPage"?r:e);if(await m.stat(i,"mtimeMs",!0)!=t[e])return!0}return!t}function ko(r,t){return r[0]=="."&&(r=Wi.join(t,"/../",r)),Wi.extname(r)||(r+="."+h.pageTypes.page),r}var ur={};async function pr(r,t,e,i,n,s){let o=e.popHaveDefault("from"),a=ko(o,pt(t.extractInfo())),l=S.Static[0]+a,c=S.Static[2]+"/"+a;if(!(await m.stat(l,null,!0)).isFile?.()){let[g,d]=M({text:`
Page not found: <color>${t.at(0).lineInfo} -> ${l}`,errorName:"page-not-found",type:"error"});return w[g](d),{compiledString:new f(t.DefaultInfoText,v.printError(`Page not found: ${h.relative(t.lineInfo)} -> ${c}`))}}let p,u=ur[a];if(!u||await ot(null,u.newSession.dependencies)){let{CompiledData:g,sessionInfo:d}=await mr(a,S.Static,{nestedPage:r,nestedPageData:e.popHaveDefault("object")});d.dependencies[c]=d.dependencies.thisPage,delete d.dependencies.thisPage,s.extends(d),ur[a]={CompiledData:g,newSession:d},p=g}else{let{CompiledData:g,newSession:d}=ur[a];Object.assign(s.dependencies,d.dependencies),s.extends(d),p=g}return{compiledString:p}}async function fr(r){let t=new f(r.StartInfo);return t.Plus$`<%{%>${r}<%}%>`,{compiledString:t,checkComponents:!0}}import{relative as Ro}from"path";function Et(r,t=10){return Buffer.from(r).toString("base64").substring(0,t).replace(/\+/,"_").replace(/\//,"_")}import Qi from"path";import{transform as Ao}from"@swc/core";import{extname as _o}from"path";import Hi from"sass";import{v4 as Mo}from"uuid";import Bo from"path";import{fileURLToPath as Fo}from"url";import{transform as Co}from"@swc/core";function qi(r){return m.readJsonFile(r)}import{promises as vo}from"fs";async function Ui(r){let t=new WebAssembly.Module(await vo.readFile(r));return new WebAssembly.Instance(t,{}).exports}var he=["json","wasm"];async function gr(r,t){switch(t){case"json":return qi(r);case"wasm":return Ui(r);default:return import(r)}}var it=class{async load(t){let e=await ue(t);this.Build=new yt(e),this.actionStringExport=this.actionStringExport.bind(this),this.actionStringExportAll=this.actionStringExportAll.bind(this)}actionStringImport(t,e,i){return`const ${e} = await ${t}(<|${i}||>)`}actionStringExport(t,e,i){return`${this.actionStringImport(t,e,i)};Object.assign(exports, ${e})`}actionStringImportAll(t,e){return`await ${t}(<|${e}||>)`}actionStringExportAll(t,e){return`Object.assign(exports, ${this.actionStringImportAll(t,e)})`}BuildImportType(t,e=t,i=this.actionStringImport){let n="",s=this.Build.CodeBuildText,o;function a(){o=s.match(new RegExp(`${t}[ \\n]+([\\*]{0,1}[\\p{L}0-9_,\\{\\} \\n]+)[ \\n]+from[ \\n]+<\\|([0-9]+)\\|\\|>`,"u"))}for(a();o;){let l=o[1].trim();n+=s.substring(0,o.index),s=s.substring(o.index+o[0].length);let c;if(l[0]=="*")c=l.substring(1).replace(" as ","").trimStart();else{let p=[];if(l[0]=="{"?(p=l.split("}",2),p[0]+="}",p[1]&&(p[1]=p[1].split(",").pop())):p=l.split(",",1).reverse(),p=p.map(u=>u.trim()).filter(u=>u.length),p.length==1)if(p[0][0]=="{")c=p[0];else{let u=this.Build.AllInputs[o[2]];u=u.substring(u.lastIndexOf(".")+1,u.length-1),he.includes(u)?c=p[0]:c=`{default:${p[0]}}`}else c=p[0],c=`${c.substring(0,c.length-1)},default:${p[1]}}`;c=c.replace(/ as /,":")}n+=i(e,c,o[2]),a()}n+=s,this.Build.CodeBuildText=n}BuildInOneWord(t,e=t,i=this.actionStringImportAll){let n="",s=this.Build.CodeBuildText,o;function a(){o=s.match(new RegExp(t+"[ \\n]+<\\|([0-9]+)\\|\\|>"))}for(a();o;)n+=s.substring(0,o.index),s=s.substring(o.index+o[0].length),n+=i(e,o[1]),a();n+=s,this.Build.CodeBuildText=n}replaceWithSpace(t){this.Build.CodeBuildText=t(" "+this.Build.CodeBuildText).substring(1)}Define(t){for(let[e,i]of Object.entries(t))this.replaceWithSpace(n=>n.replace(new RegExp(`([^\\p{L}])${e}([^\\p{L}])`,"gui"),(...s)=>s[1]+i+s[2]))}BuildInAsFunction(t,e){this.replaceWithSpace(i=>i.replace(new RegExp(`([^\\p{L}])${t}([ \\n]*\\()`,"gui"),(...n)=>n[1]+e+n[2]))}async exportVariable(){let t=this.Build.CodeBuildText,e;function i(){e=t.match(/(export[ \n]+)(var|let|const)[ \n]+([\p{L}\$_][\p{L}0-9\$_]*)/u)}for(i();e;){let n=t.substring(0,e.index),s=e[0].substring(e[1].length),o=t.substring(e.index+e[0].length),a=await Qe(o,[";",`
`]);a==-1&&(a=o.length);let l=o.substring(0,a),c=o.substring(a);t=`${n+s+l};exports.${e[3]}=${e[3]}${c}`,i()}this.Build.CodeBuildText=t}async exportBlock(){let t=this.Build.CodeBuildText,e;function i(){e=t.match(/(export[ \n]+)(default[ \n]+)?([^ \n])/u)}for(i();e;){let n=t.substring(0,e.index),s=e[0].substring(e[1].length+(e[2]||"").length),o=e[3][0],a=Boolean(e[2]);if(o=="{"){let l=t.substring(e.index+e[0].length);if(a)t=n+"exports.default="+s+l;else{let c=await Ai(l,["{","}"]);n+=`Object.assign(exports, ${s+l.substring(0,c+1)})`,t=n+l.substring(c+1)}}else{let l=t.substring(e.index+e[0].length-1);s=s.slice(0,-1);let c=await Qe(l,[";",`
`]);c==-1&&(c=l.trimEnd().length);let p=l.substring(0,c),u=p.match(/(function|class)[ |\n]+([\p{L}\$_][\p{L}0-9\$_]*)?/u);if(u?.[2]){let g=l.substring(c);t=`${n+s+p}exports.${a?"default":u[2]}=${u[2]}${g}`}else a?t=n+"exports.default="+s+l:t=`${n}exports.${p.split(/ |\n/,1).pop()}=${s+l}`}i()}this.Build.CodeBuildText=t}async BuildImports(t){this.BuildImportType("import","require"),this.BuildImportType("export","require",this.actionStringExport),this.BuildImportType("include"),this.BuildInOneWord("import","require"),this.BuildInOneWord("export","require",this.actionStringExportAll),this.BuildInOneWord("include"),this.BuildInAsFunction("import","require"),await this.exportVariable(),await this.exportBlock(),t&&this.Define(t)}BuiltString(){return this.Build.BuildCode()}static async BuildAndExportImports(t,e){let i=new it;return await i.load(` ${t} `),await i.BuildImports(e),t=i.BuiltString(),t.substring(1,t.length-1)}};function Po(r){return`module.exports = () => (DataObject) => DataObject.out_run_script.text += \`${v.printError(`Syntax Error: ${r}}`)}\``}async function dr(r,t,e){r=r.trim();let i=kt({jsc:X({parser:P({syntax:t?"typescript":"ecmascript"},$((t?"TS":"JS")+"Options"))}),filename:e.smallPath,sourceMaps:!0}),n,s=await it.BuildAndExportImports(r.eq,{debug:""+e.debug});try{let{code:o,map:a}=await Co(s,i);n=a?await Tt(r,o,a):new f(null,o)}catch(o){let a=Q(r,o);e.debug&&(a.errorFile=h.relative(a.errorFile),n=new f(null,Po(a.simpleMessage)))}return n}var Ji=new J("ShortScriptNames"),at=class{constructor(t,e,i,n,s){this.smallPath=t;this.fullPath=e;this.typeName=i;this.debug=n;this._safeDebug=s;this.connectorArray=[];this.scriptURLSet=[];this.styleURLSet=[];this.inScriptStyle=[];this.headHTML="";this.cache={style:[],script:[],scriptModule:[]};this.cacheCompileScript={};this.cacheComponent={};this.compileRunTimeStore={};this.dependencies={};this.recordNames=[];this.BuildScriptWithPrams=this.BuildScriptWithPrams.bind(this)}get safeDebug(){return this.debug&&this._safeDebug}style(t,e){this.styleURLSet.find(i=>i.url==t&&JSON.stringify(i.attributes)==JSON.stringify(e))||this.styleURLSet.push({url:t,attributes:e})}script(t,e){this.scriptURLSet.find(i=>i.url==t&&JSON.stringify(i.attributes)==JSON.stringify(e))||this.scriptURLSet.push({url:t,attributes:e})}record(t){this.recordNames.includes(t)||this.recordNames.push(t)}async dependence(t,e=h.fullWebSitePath+t){if(this.dependencies[t])return;let i=await m.stat(e,"mtimeMs",!0,null);if(i)return this.dependencies[t]=i,!0}addScriptStyle(t,e=this.smallPath){let i=this.inScriptStyle.find(n=>n.type==t&&n.path==e);return i||(i={type:t,path:e,value:new et(e,this.safeDebug,t=="style",!0)},this.inScriptStyle.push(i)),i.value}addScriptStylePage(t,e,i){return this.addScriptStyle(t,e.popString("page")?this.smallPath:i.extractInfo())}static createName(t){let e=0,i,n=Object.values(Ji.store);for(;i==null||n.includes(i);)i=Et(t,5+e).substring(e),e++;return i}async addHeadTags(){let t=this.typeName==S.Logs[2];for(let e of this.inScriptStyle){let i=t&&e.path==this.smallPath,n=i?S.Logs[1]:S.Static[1],s=i?"?t=l":"",o=Ji.have(e.path,()=>at.createName(e.path))+".pub";switch(e.type){case"script":o+=".js",this.script("/"+o+s,{defer:null});break;case"module":o+=".mjs",this.script("/"+o+s,{type:"module"});break;case"style":o+=".css",this.style("/"+o+s);break}m.writeFile(n+o,await e.value.createDataWithMap())}}async buildHead(){await this.addHeadTags();let t=i=>i.attributes?" "+Object.keys(i.attributes).map(n=>i.attributes[n]?n+`="${i.attributes[n]}"`:n).join(" "):"",e="";for(let i of this.styleURLSet)e+=`<link rel="stylesheet" href="${i.url}"${t(i)}/>`;for(let i of this.scriptURLSet)e+=`<script src="${i.url}"${t(i)}><\/script>`;return e+this.headHTML}extends(t){this.connectorArray.push(...t.connectorArray),this.scriptURLSet.push(...t.scriptURLSet),this.styleURLSet.push(...t.styleURLSet);for(let i of t.inScriptStyle)this.inScriptStyle.push(R(P({},i),{value:i.value.clone()}));let e=["cacheCompileScript","cacheComponent","dependencies"];for(let i of e)Object.assign(this[i],t[i]);this.recordNames.push(...t.recordNames.filter(i=>!this.recordNames.includes(i))),this.headHTML+=t.headHTML,this.cache.style.push(...t.cache.style),this.cache.script.push(...t.cache.script),this.cache.scriptModule.push(...t.cache.scriptModule)}BuildScriptWithPrams(t){return dr(t,gt(),this)}};async function $o(r,t,e){try{let{css:i,sourceMap:n,loadedUrls:s}=await Hi.compileStringAsync(r.eq,{syntax:Lt(t),style:ge(t),importer:Dt(e),logger:Hi.Logger.silent,sourceMap:!0});return{code:await Ei(r,i,n,n.sources.find(o=>o.startsWith("data:"))),dependencies:s.map(o=>Fo(o))}}catch(i){or(i,r)}return{code:new f}}async function Do(r,t,e,i=""){let n={};if(r=r.replacer(/((import({|[ ]*\(?)|((import[ ]*type|import|export)({|[ ]+)[\W\w]+?(}|[ ]+)from))(}|[ ]*))(["|'|`])([\W\w]+?)\9([ ]*\))?/m,s=>{if(t=="ts"&&s[5].endsWith(" type"))return s[0];let o=_o(s[10].eq);o==""&&(t=="ts"?s[10].AddTextAfterNoTrack(".ts"):s[10].AddTextAfterNoTrack(".js"));let a=s[1].Plus(s[9],s[10],o==".svelte"?i:"",s[9],s[11]??"");if(o==".svelte")e.push(s[10].eq);else if(t!=="ts"||!s[4])return a;let l=Mo();return n[l]=a,new f(null,`___toKen\`${l}\``)}),t!=="ts")return r;try{let{code:s,map:o}=await Ao(r.eq,P({jsc:X({parser:{syntax:"typescript"}}),sourceMaps:!0},$("transformOptions")));r=await Tt(r,s,o)}catch(s){return Q(r,s),new f}return r=r.replacer(/___toKen`([\w\W]+?)`/mi,s=>n[s[1].eq]??new f),r}async function Se(r,t,e=t,i=!0,n=""){let s=new f(t,await m.readFile(r)),o="js",a="css",l=[],c=[];s=await s.replacerAsync(/(<script)[ ]*( lang=('|")?([A-Za-z]+)('|")?)?[ ]*(>\n?)(.*?)(\n?<\/script>)/s,async y=>(o=y[4]?.eq??"js",y[1].Plus(y[6],await Do(y[7],o,l,n),y[8])));let p=l.map(y=>`@import "${y}.css";`).join(""),u=!1;s=await s.replacerAsync(/(<style)[ ]*( lang=('|")?([A-Za-z]+)('|")?)?[ ]*(>\n?)(.*?)(\n?<\/style>)/s,async y=>{if(a=y[4]?.eq??"css",a=="css")return y[0];let{code:b,dependencies:k}=await $o(y[7],a,r);return k&&c.push(...k),u=!0,p&&b.AddTextBeforeNoTrack(p),y[1].Plus(y[6],b,y[8])}),!u&&p&&s.AddTextAfterNoTrack(`<style>${p}</style>`);let g=new at(t,r),d=[g.dependence(t,r)];for(let y of c)d.push(g.dependence(h.relative(y),y));return{scriptLang:o,styleLang:a,code:s.eq,map:s.StringTack(e,i),dependencies:g.dependencies,svelteFiles:l.map(y=>y[0]=="/"?S.Static[0]+y:Bo.normalize(r+"/../"+y))}}function ye(r){return r[0].toUpperCase()+r.slice(1)}import*as Xi from"svelte/compiler";import{createRequire as Lo}from"module";import hr from"clear-module";import Eo from"path";var Vi=Lo(import.meta.url),zi=r=>Vi.resolve(r);function lt(r){r=Eo.normalize(r);let t=Vi(r);return hr(r),t}import{SourceMapConsumer as Io}from"source-map";var xe=class{constructor(t){this.map=new Io(t)}async getLocation(t){let{line:e,column:i}=(await this.map).originalPositionFor(t);return`${e}:${i}`}};async function Gi({message:r,code:t,start:e,frame:i},n,s){let o=new xe(s),[a,l]=M({errorName:"svelte-"+t,type:"error",text:`${r}
${i}<color>${n}:${await o.getLocation(e)}`});w[a](l)}async function be(r,t,e){let i=new xe(e);for(let{message:n,code:s,start:o,frame:a}of r){let[l,c]=M({errorName:"svelte-"+s,type:"warn",text:`${n}
${a}<color>${t}:${await i.getLocation(o)}`});w[l](c)}}async function we(r,t,e){let i=Qi.parse(r).name.replace(/^\d/,"_$&").replace(/[^a-zA-Z0-9_$]/g,""),n={filename:r,name:ye(i),generate:"ssr",format:"cjs",dev:e.debug,errorMode:"warn"},s=Qi.relative(S.Static[2],t),o=S.Static[1]+s,a=o+".ssr.cjs",{svelteFiles:l,code:c,map:p,dependencies:u}=await Se(r,t,a,!1,".ssr.cjs");Object.assign(e.dependencies,u),n.sourcemap=p;let g=[];for(let k of l)hr(zi(k)),g.push(we(k,h.relative(k),e));await Promise.all(g);let{js:d,css:y,warnings:b}=Xi.compile(c,n);return be(b,r,p),await m.writeFile(a,d.code),y.code&&(y.map.sources[0]="/"+s.split(/\/|\//).pop()+"?source=true",y.code+=mt(y.map,!0)),await m.writeFile(o+".css",y.code??""),a}import Oo from"json5";async function jo(r,t,e,i){let n=c=>{let p=g=>r.popAnyDefault(g,"").trim(),u=p("ssr"+ye(c))||p(c);return u?Oo.parse(`{${u}}`):{}},s=await we(t,e,i),o=await lt(s),{html:a,head:l}=o.default.render(n("props"),n("options"));return i.headHTML+=l,a}async function Sr(r,t,e){let i=r.extractInfo(),n=h.fullWebSitePath+i,{SmallPath:s,FullPath:o}=wt(n,i,t.popHaveDefault("from"),S.Static[2],"svelte"),a=Ro(S.Static[2],s).replace(/\\/gi,"/");e.style("/"+a+".css");let l=t.popAnyDefault("id",Et(a)),c=g=>{let d=t.popAnyDefault(g,"").trim();return d?`,${g}:{${d}}`:""},p=t.popHaveDefault("selector"),u=!p&&t.popBoolean("ssr")?await jo(t,o,s,e):"";return e.addScriptStylePage("module",t,r).addText(`import App${l} from '/${a}';
const target${l} = document.querySelector("${p||"#"+l}");
target${l} && new App${l}({
    target: target${l}
    ${c("props")+c("options")}${u?", hydrate: true":""}
});`),{compiledString:new f(null,p?"":`<div id="${l}">${u}</div>`),checkComponents:!0}}import No from"markdown-it";import Zi from"highlight.js";import It from"path";import Ki from"markdown-it-anchor";import Wo from"@sindresorhus/slugify";import qo from"markdown-it-attrs";import Uo from"markdown-it-abbr";function Jo(r,t){function e(i){return(...n)=>{let s=i(...n);return`<div class="code-copy">
                <div>
                    <a href="#copy-clipboard" onclick="markdownCopy(this)">${t}</a>
                </div>
                ${s}
            </div>`}}r.renderer.rules.code_block=e(r.renderer.rules.code_block),r.renderer.rules.fence=e(r.renderer.rules.fence)}async function yr(r,t,e,i,n){let s=i.GetPlugin("markdown"),o=t.popBoolean("hljs-class",s?.hljsClass??!0)?' class="hljs"':"",a=!1,l=No({html:!0,xhtmlOut:!0,linkify:t.popBoolean("linkify",s?.linkify),breaks:t.popBoolean("breaks",s?.breaks??!0),typographer:t.popBoolean("typographer",s?.typographer??!0),highlight:function(x,A){if(A&&Zi.getLanguage(A)){a=!0;try{return`<pre${o}><code>${Zi.highlight(x,{language:A,ignoreIllegals:!0}).value}</code></pre>`}catch(B){let[_,C]=M({text:B,type:"error",errorName:"markdown-parser"});w[_](C)}}return`<pre${o}><code>${l.utils.escapeHtml(x)}</code></pre>`}}),c=t.popAnyDefault("copy-code",s?.copyCode??"\u{1F4CB}");c&&l.use(x=>Jo(x,c)),t.popBoolean("header-link",s?.headerLink??!0)&&l.use(Ki,{slugify:x=>Wo(x),permalink:Ki.permalink.headerLink()}),t.popBoolean("attrs",s?.attrs??!0)&&l.use(qo),t.popBoolean("abbr",s?.abbr??!0)&&l.use(Uo);let p=e?.eq||"",u=t.popAnyDefault("file","./markdown");if(!p?.trim?.()&&u){let x=u[0]=="/"?It.join(S.Static[2],u):It.join(It.dirname(r.extractInfo("<line>")),u);It.extname(x)||(x+=".serv.md");let A=It.join(h.fullWebSitePath,x);p=await m.readFile(A),await n.dependence(x,A)}let g=l.render(p),d=new f(r.DefaultInfoText),y=await Vo(t.popString("code-theme")||s?.codeTheme||"atom-one");if(a){if(y!="none"){let x="/serv/md/code-theme/"+y+".css";n.style(x)}c&&n.script("/serv/md.js")}t.addClass("markdown-body");let b=t.popAnyDefault("theme",s?.theme??"auto"),k="/serv/md/theme/"+b+".css";return b!="none"&&n.style(k),d.Plus$`<div${t.rebuildSpace()}>${g}</div>`,{compiledString:d,checkComponents:!1}}var $m=O+"node_modules/github-markdown-css/github-markdown";function Ho(r,t){let[e,i,n]=r.split(/(}|\*\/).hljs{/),s=r[e.length]=="}"?"}":"*/";return[e+s,".hljs{"+(n??i),".hljs{"+t.split(/(}|\*\/).hljs{/).pop()]}var Te=O+"node_modules/highlight.js/styles/";async function Vo(r){let t=r.split("|");if(t.length==1)return r;let e=t[2]||t.slice(0,2).join("~").replace("/","-");if(await m.existsFile(Te+e+".css"))return e;let i=await m.readFile(Te+t[0]+".css"),n=await m.readFile(Te+t[1]+".css"),[s,o,a]=Ho(n,i),l=`${s}@media(prefers-color-scheme:dark){${o}}@media(prefers-color-scheme:light){${a}}`;return await m.writeFile(Te+e+".css",l),e}async function xr(r,t,e,i,n,s){return{compiledString:new f(t.DefaultInfoText).Plus$`<head${e.rebuildSpace()}>${await n.StartReplace(i,r,s)}@DefaultInsertBundle</head>`,checkComponents:!1}}async function Yi(r,t,e){let i=await t.buildHead(),n=[/@InsertBundle(;?)/,/@DefaultInsertBundle(;?)/],s=()=>(n.forEach(l=>r=r.replace(l,"")),r);if(!i)return s();let o=new f(null,i),a=!1;for(let l=0;l<n.length&&!a;l++)r=r.replacer(n[l],()=>(a=!0)&&o);return a?s():r.Plus$`\nout_run_script.text+='${o}';`}var tn=["number","num","integer","int"],en=["boolean","bool"],zo=["email","string","text",...tn,...en],Go=/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/,ke={"string-length-range":[/^[0-9]+-[0-9]+$/,r=>r.split("-").map(t=>Number(t)),([r,t],e)=>e.length>=r&&e.length<=t,"string"],"number-range-integer":[/^[0-9]+..[0-9]+$/,r=>r.split("..").map(t=>Number(t)),([r,t],e)=>Number.isInteger(e)&&e>=r&&e<=t,"number"],"number-range-float":[/^[0-9]+\.[0-9]+..[0-9]+\.[0-9]+$/,r=>r.split("..").map(t=>Number(t)),([r,t],e)=>e>=r&&e<=t,"number"],"multiple-choice-string":[/^string|text+[ ]*=>[ ]*(\|?[^|]+)+$/,r=>r.split("=>").pop().split("|").map(t=>`"${t.trim().replace(/"/gi,'\\"')}"`),(r,t)=>r.includes(t),"string"],"multiple-choice-number":[/^number|num|integer|int+[ ]*=>[ ]*(\|?[^|]+)+$/,r=>r.split("=>").pop().split("|").map(t=>parseFloat(t)),(r,t)=>r.includes(t),"number"]},br=[...tn];for(let r in ke){let t=ke[r][3];br.includes(t)&&br.push(r)}function ve(r){if(r=r.toLowerCase().trim(),zo.includes(r))return`["${r}"]`;for(let[t,[e,i]]of Object.entries(ke))if(e.test(r))return`["${t}", ${i(r)}]`;return`[${r}]`}async function Ce(r,t){for(let e in t){let[i,...n]=t[e],s=r[e],o=!1,a=!1;switch(i){case"number":case"num":o=typeof s!="number";break;case"boolean":case"bool":o=typeof s!="boolean";break;case"integer":case"int":o=!Number.isInteger(s);break;case"string":case"text":o=typeof s!="string";break;case"email":o=!Go.test(s);break;default:{let l=ke[i];if(l){o=s==null||!l[2](n,s);break}a=!0,i instanceof RegExp?o=!i.test(s)&&"regex - "+s:typeof i=="function"&&(o=!await i(s)&&"function - "+(i.name||"anonymous"))}}if(o){let l=`Validation failed at filed ${Number(e)+1} - ${a?o:"expected "+i}`;return n.length&&(l+=`, arguments: ${JSON.stringify(n)}`),l+=`, input: ${JSON.stringify(s)}`,[l,i,n,s]}}return!0}function rn(r,t){let e=[];for(let i in t){let[n]=t[i],s=r[i];br.includes(n)?e.push(parseFloat(s)):en.includes(n)?e.push(s==="true"):e.push(s)}return e}function Pe(r,t,e,i,n,s,{returnData:o}={}){if(!n.connectorArray.find(a=>a.type==e))return i;for(let a of n.connectorArray){if(a.type!=e)continue;let l=new f(null,a.name).unicode.eq,c=new RegExp(`@${r}\\([ ]*${l}[ ]*\\)(;?)`),p=new RegExp(`@\\?${r}\\([ ]*${l}[ ]*\\)`),u=!1,g=()=>(u=!0,new f(null,`if(Post?.${t} == "${a.name}"){
                ${o?"return ":""}await handelConnector("${e}", page, 
                    ${s(a)}
                );
            }`));i=i.replacer(c,g),u?i=i.replace(p,""):i=i.replacer(p,g)}return i}var Qo="/serv/connect.js";function Xo(r){return`function ${r}(...args){return connector("${r}", args)}`}async function wr(r,t,e,{SomePlugins:i},n){let s=t.popHaveDefault("name"),o=t.popHaveDefault("sendTo"),a=t.popHaveDefault("validate"),l=t.popHaveDefault("notValid"),c=t.popAnyDefault("message",n.debug&&!i("SafeDebug"));n.script(Qo,{async:null}),n.addScriptStylePage("script",t,r).addText(Xo(s)),n.connectorArray.push({type:"connect",name:s,sendTo:o,message:c,notValid:l,validator:a&&a.split(",").map(u=>u.trim())});let p=e||new f;return p.AddTextBeforeNoTrack(`<%!@@?ConnectHere(${s})%>`),{compiledString:p,checkComponents:!0}}function nn(r,t){return Pe("ConnectHere","connectorCall?.name","connect",r,t,e=>`
        {
            name:"${e.name}",
            sendTo:${e.sendTo},
            notValid: ${e.notValid||"null"},
            message:${typeof e.message=="string"?`"${e.message}"`:e.message},
            validator:[${e.validator&&e.validator.map(ve).join(",")||""}]
        }`,{returnData:!0})}async function sn(r,t){let e=r.Post.connectorCall.values,i=t.validator.length&&await Ce(e,t.validator);r.setResponse("");let n=s=>{r.Response.setHeader("Content-Type","application/json"),r.Response.end(JSON.stringify(s))};return!t.validator.length||i===!0?n(await t.sendTo(...e)):t.notValid?n(await t.notValid(...i)):t.message?n({error:typeof t.message=="string"?t.message:i.shift()}):r.Response.status(400),!0}import{v4 as Zo}from"uuid";async function Tr(r,t,e,i,n,s){let o=e.popAnyDefault("sendTo","").trim();if(!o)return{compiledString:new f(t.DefaultInfoText).Plus$`<form${e.rebuildSpace()}>${await n.StartReplace(i,r,s)}</form>`,checkComponents:!1};let a=e.popAnyDefault("name",Zo()).trim(),l=e.popHaveDefault("validate"),c=e.popHaveDefault("order"),p=e.popHaveDefault("notValid"),u=e.popBoolean("safe"),g=e.popAnyDefault("message",s.debug&&!n.SomePlugins("SafeDebug")),d=[],y=l&&l.split(",").map(k=>{let x=j(":",k.trim());return x.length>1&&d.push(x.shift()),x.pop()});return c&&(d=c.split(",").map(k=>k.trim())),s.connectorArray.push({type:"form",name:a,sendTo:o,validator:y,order:d.length&&d,notValid:p,message:g,responseSafe:u}),e.pushValue("method","post"),{compiledString:new f(t.DefaultInfoText).Plus$`<%!
@?ConnectHereForm(${a})
%><form${e.rebuildSpace()}>
    <input type="hidden" name="connectorFormCall" value="${a}"/>${await n.StartReplace(i,r,s)}</form>`,checkComponents:!1}}function on(r,t){return Pe("ConnectHereForm","connectorFormCall","form",r,t,e=>`
        {
            sendTo:${e.sendTo},
            notValid: ${e.notValid||"null"},
            validator:[${e.validator?.map?.(ve)?.join(",")??""}],
            order: [${e.order?.map?.(i=>`"${i}"`)?.join(",")??""}],
            message:${typeof e.message=="string"?`"${e.message}"`:e.message},
            safe:${e.responseSafe}
        }`)}async function an(r,t){delete r.Post.connectorFormCall;let e=[];if(t.order.length)for(let s of t.order)e.push(r.Post[s]);else e.push(...Object.values(r.Post));let i=!0;t.validator.length&&(e=rn(e,t.validator),i=await Ce(e,t.validator));let n;i===!0?n=await t.sendTo(...e):t.notValid&&(n=await t.notValid(...i)),i&&!n&&(t.message===!0?r.writeSafe(i[0]):n=t.message),n&&(t.safe?r.writeSafe(n):r.write(n))}var Z=new J("Records");function Ko(r,t){return r.popAnyDefault("link",pt(t.smallPath))}function kr(r,t,e){let i=Ko(t,e),n=t.popAnyDefault("name",r);return Z.store[n]??={},Z.store[n][i]??="",e.record(n),{store:Z.store[n],current:Z.store[n][i],link:i}}async function vr(r,t,e,i,n){if(e=await i.StartReplace(e,r,n),!n.smallPath.endsWith("."+h.pageTypes.page))return{compiledString:e};let s=new v(e,e.extractInfo());await s.findScripts();let o="";for(let c of s.values)c.type=="text"&&(o+=c.text.eq);o=o.trim();let{store:a,link:l}=kr("records/record.serv",t,n);return a[l].includes(o)||(a[l]+=o),{compiledString:e}}function ln(r){let t=pt(r);for(let e in Z.store){let i=Z.store[e];i[t]&&(i[t]=void 0,delete i[t])}}async function cn(r){if(!!r.debug)for(let t of r.recordNames){let e=S.Static[0]+t+".json";await m.makePathReal(t,S.Static[0]),m.writeJsonFile(e,Z.store[t])}}function un(){Z.clear()}async function pn(){for(let r in Z.store){let t=S.Static[0]+r+".json";await m.makePathReal(r,S.Static[0]),m.writeJsonFile(t,Z.store[r])}}import{parse as Yo}from"node-html-parser";async function Cr(r,t,e,i,n){if(e=await i.StartReplace(e,r,n),!n.smallPath.endsWith("."+h.pageTypes.page))return{compiledString:e};let s=new v(e,e.extractInfo());await s.findScripts();let o="";for(let u of s.values)u.type=="text"&&(o+=u.text.eq);let{store:a,link:l,current:c}=kr("records/search.serv",t,n),p=ta(o,t.popAnyDefault("match","h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]"));return c?(Object.assign(c.titles,p.titles),c.text.includes(p.text)||(c.text+=p.text)):a[l]=p,{compiledString:e}}function ta(r,t){let e=Yo(r,{blockTextElements:{script:!1,style:!1,noscript:!1}}),i={};for(let n of e.querySelectorAll(t)){let s=n.attributes.id;i[s]=n.innerText.trim(),n.remove()}return{titles:i,text:e.innerText.trim().replace(/[ \n]{2,}/g," ").replace(/[\n]/g," ")}}var Pr=["client","script","style","page","connect","isolate","form","head","svelte","markdown","record","search"];function mn(r,t,e,i,n,s){let o;switch(t.eq.toLowerCase()){case"client":o=Ze(r,t,e,i,n,s);break;case"record":o=vr(r,e,i,n,s);break;case"search":o=Cr(r,e,i,n,s);break;case"script":o=er(r,t,e,i,s);break;case"style":o=cr(r,t,e,i,s);break;case"page":o=pr(r,t,e,i,n,s);break;case"connect":o=wr(t,e,i,n,s);break;case"form":o=Tr(r,t,e,i,n,s);break;case"isolate":o=fr(i);break;case"head":o=xr(r,t,e,i,n,s);break;case"svelte":o=Sr(t,e,s);break;case"markdown":o=yr(t,e,i,n,s);break;default:console.error("Component is not build yet")}return o}function fn(r){return Pr.includes(r.toLowerCase())}async function gn(r,t,e){return cn(t),r=nn(r,t),r=on(r,t),r=r.replace(/@ConnectHere(;?)/gi,"").replace(/@ConnectHereForm(;?)/gi,""),r=await Yi(r,t,e),r}function dn(r,t,e){return r=="connect"?sn(t,e):an(t,e)}async function hn(){un()}async function Sn(){pn()}async function yn(r,t){r.debug&&ln(r.smallPath)}async function xn(r,t){}import da from"path";function ea(r){let t="";for(let e of r)t+="\\u"+("000"+e.charCodeAt(0).toString(16)).substr(-4);return t}function Rt(r,t,e,i,n){let s="";for(let o of t)s+=ea(e)+o+"|";return s=s.substring(0,s.length-1),s=`<(${s})${n?"([\\p{L}0-9_\\-\\.]+)":""}(\\u0020)*\\u002F?>`,wn(r,new RegExp(s,"u"),e,i)}function ra(r){let t=r.indexOf(">");for(r=r.substring(0,t);r.endsWith(" ")||r.endsWith("/");)r=r.substring(0,r.length-1);return r}function wn(r,t,e,i=!0,n=new f,s=[]){let o=r,a=r.search(t);if(a==-1)return{data:n.Plus(r),found:s};n.Plus(r.substring(0,a)),r=r.substring(a+1);let l=ra(r.eq);r=r.substring(bn(">",r));let c;if(i){let p=Ar(["<"+l,"</"+l],r);if(p!=-1)c=r.substring(0,p),r=r.substring(p),r=r.substring(bn(">",r));else{let u=r.search(t);u==-1?(c=r,r=new f):(c=r.substring(0,u),r=r.substring(u))}}return s.push({tag:l,data:c,loc:a}),o==r?{error:!0}:wn(r,t,e,i,n,s)}function bn(r,t){return t.indexOf(r)+r.length}function Ar(r,t){let e=t.indexOf(r[0]),i=t.indexOf(r[1]);if(i==-1)return-1;if(e<i&&e!=-1){e++;let n=e+Ar(r,t.substring(e))+r[0].length;return n+Ar(r,t.substring(n))}else return i}import Me from"path";import pa from"path";import{transform as sa}from"@swc/core";import L from"path";import{v4 as oa}from"uuid";import na from"minisearch";var vt=class{constructor(t){this.fullPath=S.Static[0]+t+".json"}async load(){this.indexData=await m.readJsonFile(this.fullPath);let t=[],e=0;for(let i in this.indexData){let n=this.indexData[i];for(let s in n.titles)t.push({id:e++,text:n.titles[s],url:`/${i}#${s}`});t.push({id:e++,text:n.text,url:`/${i}`})}this.miniSearch=new na({fields:["text"],storeFields:["id","text","url"]}),await this.miniSearch.addAllAsync(t)}search(t,e={fuzzy:!0,length:200,addAfterMaxLength:"..."},i="b"){let n=this.miniSearch.search(t,e);if(!i)return n;for(let s of n)for(let o of s.terms){if(e.length&&s.text.length>e.length){let u=s.text.substring(0,e.length);s.text[e.length].trim()!=""?s.text=u.substring(0,u.lastIndexOf(" "))+(e.addAfterMaxLength??""):s.text=u,s.text=s.text.trim()}let a=s.text.toLowerCase(),l="",c=a.indexOf(o),p=0;for(;c!=-1;)l+=s.text.substring(p,p+c)+`<${i}>${s.text.substring(c+p,c+o.length+p)}</${i}>`,a=a.substring(c+o.length),p+=c+o.length,c=a.indexOf(o);s.text=l+s.text.substring(p)}return n}suggest(t,e){return this.miniSearch.autoSuggest(t,e)}};function Tn(){return{Settings:T,SearchRecord:vt}}var kn=["@eas-framework/server"];function Ae(r){switch(r){case"@eas-framework/server":return Tn();default:return!1}}function Ot(r){let t=Ae(r);return t||import(r)}function vn(r,t){return he.includes(t)||kn.includes(r)}async function _r(r,t,e,i){let n=await Ae(r);return n||gr(t,e)}async function aa(r,t){return r=await it.BuildAndExportImports(r,t),r}function la(r,t,e,i,n){return`${t?"require('source-map-support').install();":""}var __dirname="${v.fixTextSimpleQuotes(e)}",__filename="${v.fixTextSimpleQuotes(i)}";module.exports = (async (require${n?","+n:""})=>{var module={exports:{}},exports=module.exports;${r}
return module.exports;});`}async function Br(r,t,e,i,{params:n,templatePath:s=r,codeMinify:o=!i,mergeTrack:a}={}){let l=kt({jsc:X({parser:P({syntax:e?"typescript":"ecmascript"},$((e?"TS":"JS")+"Options"))}),minify:o,filename:r,sourceMaps:i?a?!0:"inline":!1,outputPath:t&&L.relative(L.dirname(t),r)}),c=await aa(a?.eq||await m.readFile(r),{debug:""+i});c=la(c,i,L.dirname(s),s,n);try{let{code:p,map:u}=await sa(c,l);c=a&&u&&(await Tt(a,p,u)).StringWithTack(t)||p}catch(p){a?Q(a,p):pe(p)}return t&&(await m.makePathReal(L.dirname(t)),await m.writeFile(t,c)),c}function Cn(r){return r.endsWith(".ts")}async function ca(r,t,e=!1){return await m.makePathReal(r,t[1]),await Br(t[0]+r,t[1]+r+".cjs",Cn(r),e)}function jt(r){let t=L.extname(r);return h.partExtensions.includes(t.substring(1))?r+="."+(gt()?"ts":"js"):t==""&&(r+="."+h.ReqFileTypes[gt()?"ts":"js"]),r}var U={},Mr={};async function K(r,t,e,{isDebug:i=!1,useDeps:n,withoutCache:s=[],onlyPrepare:o}){let a,l=L.normalize(t.toLowerCase());t=jt(t);let c=L.extname(t).substring(1),p=vn(l,c)||!["js","ts"].includes(c),u=L.join(e[2],t),g=L.join(e[0],t);if(r.includes(u)){let[A,B]=M({type:"error",errorName:"circle-import",text:`Import '${u}' creates a circular dependency <color>${r.slice(r.indexOf(u)).concat(g).join(` ->
`)}`});return w[A](B),U[u]=null,n[t]={thisFile:-1},null}let d;o||(U[u]?U[u]instanceof Promise&&await U[u]:U[u]=new Promise(A=>d=A));let y=!H.store[u]||H.store[u]!=(a=await m.stat(g,"mtimeMs",!0,null));if(y){if(a=a??await m.stat(g,"mtimeMs",!0,null),a==null){let[A,B]=M({type:"warn",errorName:"import-not-exists",text:`Import '${t}' does not exists from <color>'${h.fullWebSitePath}/${r.at(-1)}'`});return w[A](B),U[u]=null,null}p||await ca(t,e,i),H.update(u,a)}n&&(n[t]={thisFile:a},n=n[t]);let b=s[0]==t;if(b)s.shift();else if(!y&&U[u]&&!(U[u]instanceof Promise))return U[u];function k(A){if(L.isAbsolute(A))A=L.relative(A,e[0]);else if(A[0]==".")A=L.join(L.dirname(t),A);else if(A[0]!="/")return Ot(A);return K([...r,u],A,e,{isDebug:i,useDeps:n,withoutCache:b?s:[]})}let x;if(p)x=await _r(l,g,c,k);else{let A=L.join(e[1],t+".cjs");if(x=lt(A),o){Mr[u]=()=>x(k);return}try{x=await x(k)}catch(B){let[_,C]=M({type:"error",errorName:"import-error",text:`${B.message}<color>${r.concat(g).reverse().join(` ->
`)}`});w[_](C)}}return U[u]=x,d?.(),x}async function _e(r,t,e,i=!1,n,s){if(!i){let o=L.join(e[2],t.toLowerCase()),a=U[o];if(a!=null)return a;if(Mr[o]){let l=await Mr[o]();return U[o]=l,l}}return K([r],t,e,{isDebug:i,useDeps:n,withoutCache:s})}async function Pn(r,t){let e=L.join(D,`temp-${oa()}.cjs`);await Br(r,e,Cn(r),t);let i=await lt(e);return m.unlink(e),await i(n=>import(n))}async function An(r,t,e,i,n,s,o){await m.makePathReal(e,i[1]);let a=t+".cjs",l=i[0]+e;await Br(t,a,n,s,{params:r,mergeTrack:o,templatePath:l,codeMinify:!1});function c(u){if(L.isAbsolute(u))u=L.relative(u,i[0]);else if(u[0]==".")u=L.join(e,u);else if(u[0]!="/")return Ot(u);return K([l],u,i,{isDebug:s})}let p=await lt(a);return async(...u)=>await p(c,...u)}var ua={include:"await ",import:"await ",transfer:"return await "};async function Fr(r,t){let e=await vi(r.eq),i=new f;for(let n of e){let s=r.substring(n.start,n.end);switch(n.name){case"text":i.Plus(s);break;case"script":i.Plus$`<%${s}%>`;break;case"print":i.Plus$`<%=${s}%>`;break;case"escape":i.Plus$`<%:${s}%>`;break;default:i.Plus$`<%${ua[n.name]}${s}%>`}}return i}async function _n(r,t,e){let i=await Ci(r.eq,t),n=new f;for(let s=0;s<i.length;s+=4){i[s]!=i[s+1]&&n.Plus(r.substring(i[s],i[s+1]));let o=r.substring(i[s+2],i[s+3]);n.Plus$`<%${e}${o}%>`}return n.Plus(r.substring((i.at(-1)??-1)+1)),n}var Nt=class{constructor(t,e,i,n){this.script=t;this.sessionInfo=e;this.smallPath=i;this.isTs=n;this.define={}}templateScript(t){let e=new f;e.AddTextAfterNoTrack(`const __writeArray = []
        var __write;

        function write(text){
            __write.text += text;
        }`);for(let i of t)e.AddTextAfterNoTrack(`
__write = {text: ''};__writeArray.unshift(__write);`),e.Plus(i);return e.AddTextAfterNoTrack(`
return __writeArray`),e}methods(t){let e="/"+pt(this.sessionInfo.smallPath);return{string:"script,style,define,store,page__filename,page__dirname,__localpath,attributes",funcs:[this.sessionInfo.script.bind(this.sessionInfo),this.sessionInfo.style.bind(this.sessionInfo),(i,n)=>this.define[String(i)]=n,this.sessionInfo.compileRunTimeStore,this.sessionInfo.fullPath,pa.dirname(this.sessionInfo.fullPath),e,t||{}]}}rebuildCode(t,e){let i=new f;for(let n of t.values){if(n.type=="text"){i.Plus(n.text);continue}i.AddTextAfterNoTrack(e.pop().text,n.text.DefaultInfoText.info)}return i}async compile(t){let e=this.sessionInfo.cacheCompileScript[this.smallPath];if(e)return(await e)(this.methods(t).funcs);let i;this.sessionInfo.cacheCompileScript[this.smallPath]=new Promise(b=>i=b),this.script=await _n(this.script,"@compile","*");let n=new v(this.script,this.smallPath,"<%*","%>");if(await n.findScripts(),n.values.length==1&&n.values[0].type==="text"){let b=()=>this.script;return i(b),this.sessionInfo.cacheCompileScript[this.smallPath]=b,this.script}let[s,o]=j("/",this.smallPath),a=S[s]??S.Static,l=a[1]+o+".comp.js";await m.makePathReal(o,a[1]);let c=this.templateScript(n.values.filter(b=>b.type!="text").map(b=>b.text)),{funcs:p,string:u}=this.methods(t),g=await An(u,l,o,a,this.isTs,this.sessionInfo.debug,c),d=async b=>{try{return this.rebuildCode(n,await g(...b))}catch(k){let[x,A]=M({errorName:k,text:k.message,type:"error"});w[x](A)}};this.sessionInfo.cacheCompileScript[this.smallPath]=d;let y=await d(p);return i(d),y}};var ma=["codefile"],Be={define:{}};async function fa(r){let t=await rt.exec("PageBaseParser",[r]);return JSON.parse(t)}var V=class{constructor(t,e,i){this.sessionInfo=t;this.code=e;this.isTs=i;this.scriptFile=new f;this.valueArray=[]}nonDynamic(t){if(!(!t||this.popAny("dynamic")!=null)){if(this.sessionInfo.debug){let i=new V;i.clearData=this.clearData,i.valueArray=[...this.valueArray,{key:"dynamic",value:!0}],i.rebuild(),m.writeFile(this.sessionInfo.fullPath,i.clearData.eq);let[n,s]=M({type:"warn",errorName:"dynamic-ssr-import",text:"Adding 'dynamic' attribute to file <color>"+this.sessionInfo.smallPath});w[n](s)}return!0}}async loadSettings(t,e,i,{attributes:n,dynamicCheck:s}){let o=new Nt(this.code,this.sessionInfo,e,this.isTs);return this.code=await o.compile(n),await this.parseBase(this.code),this.nonDynamic(s)?!1:(await this.loadCodeFile(t,e,this.isTs,i),this.loadDefine(P(P({},Be.define),o.define)),!0)}async parseBase(t){let e=await fa(t.eq);if(e.start==e.end){this.clearData=t;return}for(let{char:i,end:n,key:s,start:o}of e.values)this.valueArray.push({key:s,value:o===n?!0:t.substring(o,n),char:i});this.clearData=t.substring(0,e.start).Plus(t.substring(e.end)).trimStart()}rebuild(){if(!this.valueArray.length)return this.clearData;let t=new f(null,"@[");for(let{key:e,value:i,char:n}of this.valueArray)i!==!0?t.Plus$`${e}=${n}${i}${n} `:t.Plus$`${e} `;this.clearData=t.substring(0,t.length-1).Plus(`]
`).Plus(this.clearData)}static async rebuildBaseInheritance(t){let e=new V,i=new f;await e.parseBase(t);for(let n of e.byValue("inherit"))ma.includes(n.toLowerCase())||(e.pop(n),i.AddTextAfterNoTrack(`<@${n}><:${n}/></@${n}>`));return e.rebuild(),e.clearData.Plus(i)}get(t){return this.valueArray.find(e=>e.key===t)?.value}pop(t){return this.valueArray.splice(this.valueArray.findIndex(e=>e.key===t),1)[0]?.value}popAny(t){let e=this.valueArray.findIndex(n=>n.key.toLowerCase()==t);if(e!=-1)return this.valueArray.splice(e,1)[0].value;let i=Rt(this.clearData,[t],"@");if(!!i.found[0])return this.clearData=i.data,i.found[0].data.trim()}byValue(t){return this.valueArray.filter(e=>e.value!==!0&&e.value.eq===t).map(e=>e.key)}replaceValue(t,e){let i=this.valueArray.find(n=>n.key===t);i&&(i.value=e)}defaultValuePopAny(t,e){let i=this.popAny(t);return i===!0?e:i?.eq}async loadCodeFile(t,e,i,n){let s=this.defaultValuePopAny("codefile","inherit");if(!s)return;let o=this.defaultValuePopAny("lang","js"),a=s.toLowerCase();a=="inherit"&&(s=t);let l=Me.extname(s).substring(1);["js","ts"].includes(l)||(/(\\|\/)$/.test(s)?s+=t.split("/").pop():h.pageTypesArray.includes(l)||(s+=Me.extname(t)),s+="."+(o||(i?"ts":"js"))),s[0]=="."&&(s=Me.join(Me.dirname(t),s));let c=h.relative(s);if(await this.sessionInfo.dependence(c,s)){let p=await bt(!1,n,s,c);this.scriptFile=p.allData.replaceAll("@","@@"),this.scriptFile.AddTextBeforeNoTrack("<%"),this.scriptFile.AddTextAfterNoTrack("%>"),this.sessionInfo.debug&&this.scriptFile.AddTextBeforeNoTrack(p.stringInfo)}else if(a=="inherit"&&this.sessionInfo.debug){m.writeFile(s,"");let[p,u]=M({id:c,type:"warn",errorName:"create-code-file",text:`
Code file created: <color>${t}<line>${c}`});w[p](u)}else{let[p,u]=M({id:c,type:"error",errorName:"code-file-not-found",text:`
Code file not found: <color>${t}<line>${c}`});w[p](u),this.scriptFile=new f(n,v.printError(`Code File Not Found: '${e}' -> '${c}'`))}}loadSetting(t="define",e=2){let i=this.clearData.indexOf(`@${t}(`);if(i==-1)return!1;let n=[],s=this.clearData.substring(0,i),o=this.clearData.substring(i+8).trimStart();for(let a=0;a<e;a++){let l=o.at(0).eq,c=st.findEntOfQ(o.eq.substring(1),l);n.push(o.substring(1,c));let p=o.substring(c+1).trimStart();if(p.at(0).eq!=","){o=p;break}o=p.substring(1).trimStart()}return o=o.substring(o.indexOf(")")+1),this.clearData=s.trimEnd().Plus(o.trimStart()),n}loadDefine(t){let e=this.loadSetting(),i=[];for(;e;)i.unshift(e),e=this.loadSetting();i.unshift(...Object.entries(t));for(let[n,s]of i)this.clearData=this.clearData.replaceAll(`:${n}:`,s)}};import ha from"path";async function ga(r){let t=await rt.exec("HTMLAttrParser",[r]);return JSON.parse(t)}var Wt=class{constructor(t){this.text=t;this.valueArray=[]}async parser(){let t=await ga(this.text.eq);for(let{char:e,ek:i,ev:n,sk:s,space:o,sv:a}of t)this.valueArray.push({char:e,space:o,key:this.text.substring(s,i),value:a==n?!0:this.text.substring(a,n)})}popItem(t){t=t.toLowerCase();let e=this.valueArray.findIndex(i=>i.key.eq.toLowerCase()==t);return e==-1?null:this.valueArray.splice(e,1).shift()}popTracker(t){return this.popItem(t)?.value}popHaveDefaultTracker(t,e=""){let i=this.popTracker(t);return typeof i=="boolean"?e:i}popAnyTracker(t,e=""){let i=this.popTracker(t);return i instanceof f?i.eq:e}popString(t){let e=this.popItem(t)?.value;return e instanceof f?e.eq:e}popBoolean(t,e){return Boolean(this.popString(t)??e)}exists(t){return this.valueArray.find(e=>e.key.eq.toLowerCase()==t)!=null}popHaveDefault(t,e=""){let i=this.popString(t);return typeof i=="boolean"?e:i}popAnyDefault(t,e=""){let i=this.popString(t);return typeof i=="string"?i:e}addClass(t){let e=this.valueArray.find(i=>i.key.eq.toLowerCase()=="class");e?.value instanceof f?e.value.AddTextAfterNoTrack(" "+t).trimStart():e?.value===!0?e.value=new f(null,t):this.pushValue("class",t)}rebuildSpace(){let t=new f;for(let{value:e,char:i,key:n,space:s}of this.valueArray)s&&t.AddTextAfterNoTrack(" "),e===!0?t.Plus(n):t.Plus$`${n}=${i}${e}${i}`;return t}pushValue(t,e){let i=this.valueArray.find(n=>n.key.eq.toLowerCase()==t);if(i)return i.value=new f(null,e);this.valueArray.push({key:new f(null,t),value:new f(null,e),char:'"',space:!0})}map(){let t={};for(let{key:e,value:i}of this.valueArray)e&&(t[e.eq]=i===!0?!0:i.eq);return t}};var Sa=new RegExp(`<([\\p{Lu}_\\-:0-9]|${Pr.join("|")})`,"u"),ya=/<[\p{L}_\-:0-9]/u,dt=class extends ce{constructor(e){super();this.dirFolder="Components",this.PluginBuild=e}get regexSearch(){return this.SomePlugins("MinHTML","MinAll")?ya:Sa}FindSpecialTagByStart(e){for(let i of this.SkipSpecialTag)if(e.substring(0,i[0].length)==i[0])return i}findIndexSearchTag(e,i){let n=e.split("."),s=0;for(let o of n){let a=i.indexOf(o);if(a==-1){let[l,c]=M({text:`Waring, can't find all query in tag -><color>${i.eq}
${i.lineInfo}`,errorName:"query-not-found"});w[l](c);break}s+=a+o.length,i=i.substring(a+o.length)}return s+i.search(/\ |\>/)}CheckMinHTML(e){return this.SomePlugins("MinHTML","MinAll")&&(e=e.SpaceOne(" ")),e}CheckMinHTMLText(e){if(!this.SomePlugins("MinHTML","MinAll"))return e;for(;/[ \n]{2,}/.test(e.eq);)e=e.replace(/[ \n]{2,}/gi," ");return e}async ReBuildTag(e,i,n,s,o){this.SomePlugins("MinHTML","MinAll")&&(s&&(s=s.SpaceOne(" ")),i=n.rebuildSpace());let a=new f(e.DefaultInfoText).Plus("<",e,i);return s?a.Plus$`>${await o(s)}</${e}>`:a.Plus("/>"),a}exportDefaultValues(e,i=[]){let n=e.match(/@default[ ]*\(([A-Za-z0-9{}()\[\]_\-$"'`%*&|\/\@ \n]*)\)[ ]*\[([A-Za-z0-9_\-,$ \n]+)\]/);if(n==null)return{fileData:e,foundSetters:i};let s=e.substring(0,n.index).Plus(e.substring(n.index+n[0].length)),o=n[2].eq.split(",").map(a=>a.trim());return i.push({value:n[1],elements:o}),this.exportDefaultValues(s,i)}addDefaultValues(e,i){for(let n of e)for(let s of n.elements)i=i.replaceAll("#"+s,n.value);return i}parseComponentProps(e,i){let{fileData:n,foundSetters:s}=this.exportDefaultValues(i);for(let{key:o,value:a}of e.valueArray){let l=new RegExp("\\~"+o,"gi");n=n.replace(l,a)}return this.addDefaultValues(s,n)}async buildTagBasic(e,i,n,s,o,a,l){return e=await this.PluginBuild.BuildComponent(e,n,o,a),e=this.parseComponentProps(i,e),e=e.replace(/<\:reader( )*\/>/gi,l??""),o=o+" -> "+s,e=await this.StartReplace(e,o,a),e=await $i(e,`${o} ->
${s}`),e}static addSpacialAttributes(e,i,n){let s="/"+i.extractInfo();e.pushValue("importSource",s),e.pushValue("importSourceDirectory",ha.dirname(s));let o=e.map();return o.reader=n?.eq,o}async insertTagData(e,i,n,{BetweenTagData:s,sessionInfo:o}){let a=new Wt(n),l=fn(i.eq);await a.parser();let c,p=!0,u={},g;if(l){let{compiledString:d,checkComponents:y}=await mn(e,i,a,s??new f,this,o);c=d,p=y}else{let d=()=>this.ReBuildTag(i,n,a,s,St=>this.StartReplace(St,e,o)),y=i.at(0).eq;if(y!=y.toUpperCase())return d();let b=a.popHaveDefault("folder","."),k=(b?b+"/":"")+i.replace(/:/gi,"/").eq,x=i.extractInfo(),A=da.join(h.fullWebSitePath,x);if(u=wt(A,x,k,this.dirFolder,h.pageTypes.component),o.cacheComponent[u.SmallPath]===null||o.cacheComponent[u.SmallPath]===void 0&&!await m.existsFile(u.FullPath)){if(o.cacheComponent[u.SmallPath]=null,b){let[St,je]=M({text:`Component ${i.eq} not found! -><color>${e}
-> ${i.lineInfo}
${u.SmallPath}`,errorName:"component-not-found",type:"error"});w[St](je)}return d()}o.cacheComponent[u.SmallPath]?.mtimeMs||(o.cacheComponent[u.SmallPath]={mtimeMs:await m.stat(u.FullPath,"mtimeMs")}),o.dependencies[u.SmallPath]=o.cacheComponent[u.SmallPath].mtimeMs;let{allData:B,stringInfo:_}=await bt(!0,e,u.FullPath,u.SmallPath,o.cacheComponent[u.SmallPath]),C=new V(o,B,this.isTs()),I=dt.addSpacialAttributes(a,i,s);await C.loadSettings(u.FullPath,u.SmallPath,e+" -> "+u.SmallPath,{attributes:I}),c=C.scriptFile.Plus(C.clearData),g=o.debug&&_}if(p&&(c.length>0||s)){let{SmallPath:d,FullPath:y}=u;c=await this.buildTagBasic(c,a,l?i.eq:y,l?i.eq:d,e,o,s),g&&c.AddTextBeforeNoTrack(g)}return c}CheckDoubleSpace(...e){let i=this.SomePlugins("MinHTML","MinAll"),n=e.shift();i&&(n=n.SpaceOne(" "));for(let s of e)i&&n.endsWith(" ")&&s.startsWith(" ")&&(s=s.trimStart()),n.Plus(s);return i&&(n=n.SpaceOne(" ")),n}async StartReplace(e,i,n){let s,o=[];for(;(s=e.search(this.regexSearch))!=-1;){let l=e.eq,c=this.FindSpecialTagByStart(l.trim());if(c){let C=l.indexOf(c[0])+c[0].length,I=l.substring(C).indexOf(c[1])+C+c[1].length;o.push(e.substring(0,I)),e=e.substring(I);continue}let p=e.substring(0,s),u=e.substring(s),g=u.search(" |/|>|(<%)"),d=u.substring(1,g),y=await this.FindCloseChar(u.substring(1),">")+1,b=u.substring(g,y);b.at(b.length-1).eq=="/"&&(b=b.substring(0,b.length-1));let k=u.substring(y+1);if(u.at(y-1).eq=="/"){o.push(this.CheckMinHTML(this.CheckMinHTMLText(p)),this.insertTagData(i,d,b,{sessionInfo:n})),e=k;continue}let x;if(this.SimpleSkip.includes(d.eq))x=k.indexOf("</"+d);else if(x=await this.FindCloseCharHTML(k,d.eq),x==-1){let[C,I]=M({text:`
Warning, you didn't write right this tag: "${d}", used in: ${d.at(0).lineInfo}
(the system will auto close it)`,errorName:"close-tag"});w[C](I),x=null}let A=x!=null&&k.substring(0,x),B=k.substring(x),_=x!=null?B.substring(st.findEndOfDef(B.eq,">")+1):B;o.push(this.CheckMinHTML(p),this.insertTagData(i,d,b,{BetweenTagData:A,sessionInfo:n})),e=_}let a=new f(e.DefaultInfoText);for(let l of o)a=this.CheckDoubleSpace(a,await l);return o.length===0&&!this.FindSpecialTagByStart(e.eq.trim())&&(e=this.CheckMinHTMLText(e)),this.CheckMinHTML(this.CheckDoubleSpace(a,e))}RemoveUnnecessarySpace(e){return e=e.trim(),e=e.replaceAll(/%>[ ]+<%(?![=:])/,"%><%"),e}async Insert(e,i,n){return e=e.replace(/<!--[\w\W]+?-->/,""),e=await this.StartReplace(e,i,n),e=e.replace(/<\:reader+( )*\/>/gi,'<%typeof page.codebase == "function" ? page.codebase(): write(page.codebase)%>'),this.RemoveUnnecessarySpace(e)}};import Mn from"path";var z=class extends v{static async AddPageTemplate(t,e){return e.debug&&t.AddTextBeforeNoTrack(`try {
`),t.AddTextBeforeNoTrack(`
        module.exports = (_require, _include, _transfer, private_var, handelConnector) => {
            return (async function (page) {
                const __filename = "${v.fixTextSimpleQuotes(e.fullPath)}", __dirname = "${v.fixTextSimpleQuotes(Mn.dirname(e.fullPath))}";
                const require = (p) => _require(__filename, __dirname, page, p);
                const include = (p, withObject) => _include(__filename, __dirname, page, p, withObject);
        
                var module = { exports: {} },
                    exports = module.exports,
                    { sendFile, writeSafe, write, echo, setResponse, out_run_script, run_script_name, Response, Request, Post, Query, Session, Files, Cookies, PageVar, GlobalVar} = page,

                    run_script_code = run_script_name;

                    const transfer = (p, preserveForm, withObject) => (out_run_script = {text: ''}, _transfer(p, preserveForm, withObject, __filename, __dirname, page));
                {`),e.debug&&t.AddTextAfterNoTrack(`
}
                catch(e){
                    const last_file = run_script_name.split(/->|<line>/).pop();
                    run_script_name += ' -> <line>' + e.stack.split(/\\n( )*at /)[2];
                    out_run_script.text += '${z.printError("<p>Error path: ' + run_script_name.replace(/<(line|color)>/gi, '<br/>') + '</p><p>Error message: ' + e.message + '</p>")}';
        
                    console.error("Error path: " + run_script_name.slice(0, -last_file.length).replace(/<line>/gi, '\\n'));
                    console.error("${v.fixTextSimpleQuotes(h.fullWebSitePath)}" + last_file.trim());
                    console.error("Error message: " + e.message);
                    console.error("Error running this code: \\"" + run_script_code + '"');
                    console.error("Error stack: " + e.stack);
                }`),t.AddTextAfterNoTrack("}});}"),t}static async BuildPage(t,e){let i=await z.RunAndExport(t,e.fullPath,e.debug);return z.AddPageTemplate(i,e)}static AddAfterBuild(t,e){return e&&t.AddTextBeforeNoTrack("require('source-map-support').install();"),t}static InPageTemplate(t,e,i){return t.AddTextBeforeNoTrack(`<%!{
            const _page = page;
            {
            const page = {..._page${e?","+e:""}};
            const __filename = "${v.fixTextSimpleQuotes(i)}", __dirname = "${v.fixTextSimpleQuotes(Mn.dirname(i))}";
            const require = (p) => _require(__filename, __dirname, page, p);
            const include = (p, withObject) => _include(__filename, __dirname, page, p, withObject);
            const transfer = (p, preserveForm, withObject) => (out_run_script = {text: ''}, _transfer(p, preserveForm, withObject, __filename, __dirname, page));
                {%>`),t.AddTextAfterNoTrack("<%!}}}%>"),t}};function $r(r){let t;switch(r.name||r){case"Razor":t=Fr;break}return t}var qt=class{constructor(t){this.SettingsObject=t}get defaultSyntax(){return this.SettingsObject.BasicCompilationSyntax.concat(this.SettingsObject.AddCompileSyntax)}async BuildBasic(t,e,i,n,s){if(!e)return t;Array.isArray(e)||(e=[e]);for(let o of e){let a=await $r(o);a&&(t=await a(t,o,i,n,s))}return t}async BuildPage(t,e,i,n){return t=await this.BuildBasic(t,this.defaultSyntax,e,i,n),t}async BuildComponent(t,e,i,n){return t=await this.BuildBasic(t,this.defaultSyntax,e,i,n),t}};var Bn={plugins:[]};var G={AddCompileSyntax:[],plugins:[],BasicCompilationSyntax:["Razor"]},Fn=new qt(G),Ut=new dt(Fn);function $(r){return G.plugins.find(t=>t==r||t?.name==r)}function q(...r){return r.some(t=>$(t))}function gt(){return G.AddCompileSyntax.includes("TypeScript")}Ut.MicroPlugins=G.plugins;Ut.GetPlugin=$;Ut.SomePlugins=q;Ut.isTs=gt;Bn.plugins=G.plugins;async function $n(r,t,e,i,n,s,o){let a=new V(s,r,gt());if(!await a.loadSettings(e,n,i,{dynamicCheck:o}))return;let l=a.defaultValuePopAny("model","website");if(!l)return t.Plus(a.scriptFile,a.clearData);r=a.clearData;let{SmallPath:c,FullPath:p}=wt(e,n,l,"Models",h.pageTypes.model);if(!await m.existsFile(p)){let x=`Error model not found -> ${l} at page ${i}`;return w.error(x),new f(r.DefaultInfoText,z.printError(x))}await s.dependence(c,p);let u=await bt(!1,i,p,c),g=await V.rebuildBaseInheritance(u.allData);s.debug&&g.AddTextBeforeNoTrack(u.stringInfo),i+=" -> "+c;let d=Rt(g,[""],":",!1,!0);if(d.error)return w.error("Error within model ->",l,"at page: ",i),r;g=d.data;let y=d.found.map(x=>x.tag.substring(1)),b=Rt(r,y,"@");if(b.error)return w.error("Error With model ->",l,"at page: ",i),r;let k=new f;for(let x of d.found){x.tag=x.tag.substring(1);let A=b.found.find(B=>B.tag=="@"+x.tag);if(k.Plus(g.substring(0,x.loc)),g=g.substring(x.loc),A)k.Plus(A.data);else{let B=a.get(x.tag);B&&B!==!0&&B.eq.toLowerCase()!="inherit"&&k.Plus(B)}}return k.Plus(g),await $n(k,t.Plus(a.scriptFile),p,i,c,s)}async function Dn(r,t,e,i,n,s){let o=new f(n.smallPath,r);if(o=await $n(o,new f(o.DefaultInfoText),n.fullPath,n.smallPath,n.smallPath,n,s),o!=null)return o=await Fn.BuildPage(o,n.fullPath,n.smallPath,n),o=await Ut.Insert(o,n.smallPath,n),o=await Fi(o,n.smallPath),e?z.InPageTemplate(o,i,n.fullPath):(o=await gn(o,n,t),o=await z.BuildPage(o,n),o=await n.BuildScriptWithPrams(o),o=z.AddAfterBuild(o,n.debug),o)}import ht from"path";import{transform as xa}from"@swc/core";async function Fe(r,t,e,i,n){let s=S.Static[0]+r,o=S.Static[1]+r,a={filename:s,sourceFileName:r+"?source=true",jsc:X({parser:P(P(P({},i),$("transformOptions")),$(n))}),minify:q("Min"+t.toUpperCase())||q("MinAll"),sourceMaps:e?"inline":!1},l=await m.readFile(s);try{l=(await xa(l,a)).code}catch(c){pe(c)}return await m.makePathReal(r,S.Static[1]),await m.writeFile(o,l),{thisFile:await m.stat(s,"mtimeMs")}}function Ln(r,t){return Fe(r,"js",t)}function En(r,t){return Fe(r,"ts",t,{syntax:"typescript",decorators:!0})}function In(r,t){return Fe(r,"jsx",t,{syntax:"ecmascript",jsx:!0},"JSXOptions")}function Rn(r,t){return Fe(r,"tsx",t,{syntax:"typescript",tsx:!0,decorators:!0},"TSXOptions")}import*as On from"svelte/compiler";import{transform as ba}from"@swc/core";async function Dr(r,t){let e=S.Static[0]+r,i=S.Static[1]+r,{code:n,dependencies:s,map:o,scriptLang:a}=await Se(e,S.Static[2]+"/"+r),l=e.split(/\/|\//).pop(),c,p;try{let g=On.compile(n,{filename:l,dev:t,sourcemap:o,css:!1,hydratable:!0,sveltePath:"/serv/svelte"});be(g.warnings,e,o),c=g.js,p=g.css}catch(g){return Gi(g,e,o),{thisFile:0}}let u=c.map.sources[0].substring(1);if(t&&(c.map.sources[0]=u),q("MinJS")||q("MinAll"))try{let{code:g,map:d}=await ba(c.code,{jsc:X({parser:P({syntax:a=="js"?"ecmascript":"typescript"},$(a.toUpperCase()+"Options"))}),minify:!0,sourceMaps:t});c.code=g,d&&(c.map=await di(JSON.parse(d),c.map))}catch(g){await Di(g,c.map,e)}return t&&(c.code+=mt(c.map),p.code&&(p.map.sources[0]=u,p.code+=mt(p.map,!0))),await m.makePathReal(r,S.Static[1]),await m.writeFile(i+".js",c.code),await m.writeFile(i+".css",p.code??""),R(P({},s),{thisFile:await m.stat(e,"mtimeMs")})}import jn from"sass";import Nn from"path";import{fileURLToPath as Wn,pathToFileURL as wa}from"url";async function qn(r,t,e){let i=S.Static[0]+r,n=S.Static[1]+r,s={thisFile:await m.stat(i,"mtimeMs")},o=await m.readFile(i),a=Nn.dirname(i);try{let l=await jn.compileStringAsync(o,{sourceMap:e,syntax:Lt(t),style:ge(t),logger:jn.Logger.silent,importer:Dt(i)});if(l?.loadedUrls)for(let p of l.loadedUrls){let u=Wn(p);s[h.relative(u)]=await m.stat(i,"mtimeMs",!0,null)}let c=l.css;e&&l.sourceMap&&(nr(l.sourceMap,wa(o).href),l.sourceMap.sources=l.sourceMap.sources.map(p=>Nn.relative(a,Wn(p))+"?source=true"),c+=`\r
/*# sourceMappingURL=data:application/json;charset=utf-8;base64,${Buffer.from(JSON.stringify(l.sourceMap)).toString("base64")}*/`),await m.makePathReal(r,S.Static[1]),await m.writeFile(n,c)}catch(l){return sr(l),{}}return s}import Ta from"fs";import ka from"promptly";import{argv as va}from"process";var Ca=["js","svelte","ts","jsx","tsx","css","sass","scss"],Un=new J("StaticFiles");async function Pa(r){let t=Un.store[r];for(let e in t){let i=e;e=="thisFile"&&(i=S.Static[2]+"/"+r);let n=h.fullWebSitePath+i;if(await m.stat(n,"mtimeMs",!0)!=t[e])return!0}return!t}async function Ht(r,t,e){let i=ht.extname(r).substring(1).toLowerCase(),n;switch(i){case"js":n=await Ln(r,t);break;case"ts":n=await En(r,t);break;case"jsx":n=await In(r,t);break;case"tsx":n=await Rn(r,t);break;case"css":case"sass":case"scss":n=await qn(r,i,t);break;case"svelte":n=await Dr(r,t),e+=".js"}if(t&&await m.existsFile(e))return Un.update(r,n),!0;if(!t)return!0}var Lr=D+"/../static/client/",Aa=[{path:"serv/temp.js",type:"js",inServer:Lr+"buildTemplate.js"},{path:"serv/connect.js",type:"js",inServer:Lr+"makeConnection.js"},{path:"serv/md.js",type:"js",inServer:Lr+"markdownCopy.js"}],_a=[{ext:".pub.js",type:"js"},{ext:".pub.mjs",type:"js"},{ext:".pub.css",type:"css"}];async function Ma(r,t,e){let i=_a.find(o=>t.endsWith(o.ext));if(!i)return;let n=r.query.t=="l"?S.Logs[1]:S.Static[1],s=ht.join(n,t);if(e||await m.existsFile(s))return R(P({},i),{inServer:s})}var Jt=null;va.includes("allowSourceDebug")&&(Jt=!0);async function Ba(){if(typeof Jt=="boolean")return Jt;try{Jt=(await ka.prompt("Allow debugging JavaScript/CSS in source page? - exposing your source code (no)",{validator(r){if(["yes","no"].includes(r.trim().toLowerCase()))return r;throw new Error("yes or no")},timeout:1e3*30})).trim().toLowerCase()=="yes"}catch{}return Jt}var Fa=[S.Static[2],S.Logs[2],"Models","Components"];async function $a(r,t,e){if(!r||$("SafeDebug")||ht.extname(t)!=".source"||!Fa.includes(t.split(/\/|\\/).shift())||!await Ba())return;let i=ht.join(h.fullWebSitePath,t.substring(0,t.length-7));if(e||await m.existsFile(i))return{type:"html",inServer:i}}async function Jn(r,t,e){let i=r.substring(0,r.length-4),n=S.Static[1]+r,s;if(ht.extname(i)==".svelte"&&(t||(s=await m.existsFile(n))))return{type:"css",inServer:n};if(e&&!s)return await Ht(i,e,S.Static[1]+i),Jn(r,t,!1)}async function Da(r,t){if(!r.startsWith("serv/svelte/"))return;let e=O+"node_modules"+r.substring(4)+(ht.extname(r)?"":"/index.mjs");if(t||await m.existsFile(e))return{type:"js",inServer:e}}async function La(r,t){if(!r.startsWith("serv/md/code-theme/"))return;let e=O+"node_modules/highlight.js/styles"+r.substring(18);if(t||await m.existsFile(e))return{type:"css",inServer:e}}async function Ea(r,t){if(!r.startsWith("serv/md/theme/"))return;let e=r.substring(14);e.startsWith("auto.")?e=e.substring(4):e="-"+e;let i=O+"node_modules/github-markdown-css/github-markdown"+e.replace(".css",".min.css");if(t||await m.existsFile(i))return{type:"css",inServer:i}}async function Er(r,t,e,i=!1){return await Da(e,i)||await Jn(e,i,t)||await $a(t,e,i)||await Ma(r,e,i)||await Ea(e,i)||await La(e,i)||Aa.find(n=>n.path==e)}async function Hn(r,t,e,i){let n=await Er(e,t,r,!0);if(n){i.type(n.type),i.end(await m.readFile(n.inServer));return}let s=S.Static[1]+r,o=S.Static[0]+r,a=ht.extname(r).substring(1).toLowerCase();if(!Ca.includes(a)){i.sendFile(o);return}["sass","scss","css"].includes(a)?i.type("css"):i.type("js");let l=s;t&&(e.query.source=="true"||await Pa(r)&&!await Ht(r,t,s))?l=o:a=="svelte"&&(l+=".js"),i.end(await Ta.promises.readFile(l,"utf8"))}import ja from"path";import Ia from"path";async function Vn(r,t){let e=[];for(let i of r){i=jt(i);let n=await K(["root folder (WWW)"],i,S.Static,{isDebug:t});n&&typeof n.StartServer=="function"?e.push(n.StartServer):w.log(`Can't find StartServer function at module - ${i}
`)}return e}var Ir;async function zn(r,t){await m.existsFile(r+".ts")?r+=".ts":r+=".js";let e=await m.stat(r,"mtimeMs",!0,null);return e==Ir||!e?null:(Ir=e,(await Pn(r,t)).default)}function Rr(){return Ir}var $e=class{constructor(){this.state={update:0,pageArray:[],importArray:[],fileArray:[]};this.state.update=Rr()}get scripts(){return this.state.importArray}get pages(){return this.state.pageArray}get files(){return this.state.fileArray}addPage(t,e){this.state.pageArray.find(i=>i[0]==t&&i[1]==e)||this.state.pageArray.push([t,e])}addImport(t){this.state.importArray.includes(t)||this.state.importArray.push(t)}addFile(t){this.state.fileArray.includes(t)||this.state.fileArray.push(t)}export(){return m.writeJsonFile($e.filePath,this.state)}static async checkLoad(){if(!await m.existsFile(this.filePath))return;let t=new $e;if(t.state=await m.readJsonFile(this.filePath),t.state.update==Rr())return t}},nt=$e;nt.filePath=Ia.join(D,"CompileState.json");import{argv as Na}from"process";import Ra from"path";function Or(r,t){return r.endsWith("."+t)}function Ct(r,t){t=t.toLowerCase();for(let e of r)if(Or(t,e))return!0;return!1}function Gn(r){return r.substring(0,r.lastIndexOf("."))}async function jr(r,t,e){let i=await m.readdir(r[0]+t,{withFileTypes:!0}),n=[];for(let s of i){let o=s.name,a=t+o;s.isDirectory()?n.push(jr(r,a+"/",e)):Ct(h.pageTypesArray,o)?e.addPage(a,r[2]):r==S.Static&&Ct(h.ReqFileTypesArray,o)?e.addImport(a):e.addFile(a)}return Promise.all(n)}async function Oa(){let r=new nt;return await Promise.all([jr(S.Static,"",r),jr(S.Logs,"",r)]),r}async function Qn(r){return Nr(r,await Oa())}async function Nr(r,t){let{routing:e,development:i}=r;if(!e.sitemap)return;let n=e.sitemap===!0?{}:e.sitemap;Object.assign(n,{rules:!0,urlStop:!1,errorPages:!1,validPath:!0});let s=[];t:for(let[a,l]of t.pages)if(!(l!=S.Static[2]||!a.endsWith("."+h.pageTypes.page))&&(a="/"+a.substring(0,a.length-h.pageTypes.page.length-1),Ra.extname(a)!=".serv")){if(n.urlStop)for(let c in e.urlStop){a.startsWith(c)&&(a=c);break}if(n.rules){for(let c in e.rules)if(a.startsWith(c)){a=await e.rules[c](a);break}}if(!(e.ignoreTypes.find(c=>a.endsWith("."+c))||e.ignorePaths.find(c=>a.startsWith(c)))){if(n.validPath){for(let c of e.validPath)if(!await c(a))continue t}if(!n.errorPages)for(let c in e.errorPages){let p="/"+e.errorPages[c].path;if(a.startsWith(p))continue t}s.push(a)}}let o=!0;if(n.file){let a=await _e("Sitemap Import",n.file,S.Static,i);a?.Sitemap?o=await a.Sitemap(s,t,r):dump.warn("'Sitemap' function not found on file -> "+n.file)}if(o&&s.length){let a=o===!0?"sitemap.txt":o;t.addFile(a),await m.writeFile(S.Static[0]+a,s.join(`
`))}}async function Zn(r,t,{isDebug:e,hasSessionInfo:i,nestedPage:n,nestedPageData:s,dynamicCheck:o}={}){let a=ja.join(t[0],r),l=t[1]+r+".cjs",c=await m.readFile(a,"utf8"),p=(n?n+"<line>":"")+t[2]+"/"+r,u=i??new at(t[2]+"/"+r,a,t[2],e,$("SafeDebug"));await u.dependence("thisPage",a),await yn(u,l);let g=await Dn(c,l,Boolean(n),s,u,o)??new f;return await xn(u,l),!n&&g.length&&(await m.writeFile(l,g.StringWithTack(l)),H.update(p,u.dependencies)),{CompiledData:g,sessionInfo:u}}function Kn(r){return K(["Production Loader"],r,S.Static,{isDebug:!1,onlyPrepare:!0})}async function Yn(r,t,e){let i=await m.readdir(r[0]+t,{withFileTypes:!0});for(let n of i){let s=n.name,o=t+s;n.isDirectory()?(await m.mkdir(r[1]+o),await Yn(r,o+"/",e)):Ct(h.pageTypesArray,s)?(e.addPage(o,r[2]),await ot(r[2]+"/"+o)&&await Zn(o,r,{dynamicCheck:!Or(s,h.pageTypes.page)})):r==S.Static&&Ct(h.ReqFileTypesArray,s)?(e.addImport(o),await Kn(o)):(e.addFile(o),await Ht(o,!1))}}async function Wa(r){for(let t of r)await Kn(t)}async function Xn(r,t){let e=S[r];return await Mt(e[1]),()=>Yn(e,"",t)}async function mr(r,t,{hasSessionInfo:e,nestedPage:i,nestedPageData:n,dynamicCheck:s}={}){return await m.makePathReal(r,t[1]),await Zn(r,t,{isDebug:!0,hasSessionInfo:e,nestedPage:i,nestedPageData:n,dynamicCheck:s})}async function De(r,t,e){await mr(r,t,{dynamicCheck:e}),Je()}async function ts(r){let t=!Na.includes("rebuild")&&await nt.checkLoad();if(t)return()=>Wa(t.scripts);H.clear(),t=new nt,hn();let e=[await Xn(S.Static[2],t),await Xn(S.Logs[2],t),Je];return async()=>{for(let i of e)await i();await Nr(r,t),t.export(),H.save(),Sn()}}var Jr={};Ds(Jr,{BuildPage:()=>Le,Export:()=>Y,LoadPage:()=>Gt,SplitFirst:()=>j,getFullPathCompile:()=>Ur});import zt from"path";import es from"path";var rs={};async function Wr(r,t,e="",i={}){let n={},s=[];for(let[o,a]of Object.entries(r))s.push((async()=>{o=="thisFile"?(i[e]||(i[e]=await m.stat(t[0]+e,"mtimeMs",!0)),n.thisFile=i[e]):n[o]=await Wr(a,t,o,i)})());return await Promise.all(s),n}function qr(r,t){for(let e in r)if(e=="thisFile"){if(t[e]!=r[e])return!1}else if(!qr(r[e],t[e]))return!1;return!0}function is(r,t,e=""){let i=[];for(let n in r)if(n=="thisFile"){if(t[n]!=r[n]){i.push(e);break}}else if(t[n]){let s=is(r[n],t[n],n);if(s.length){e&&i.push(e),i.push(...s);break}}else{i.push(n);break}return i}async function Vt(r,t,e,i,n,s){let o=n[r],a,l;if(o){if(!s||s&&o.status==-1)return o.model;if(a=await m.stat(i[0]+o.path,"mtimeMs",!0,0),a){if(l=await Wr(o.dependencies,i),qr(o.dependencies,l))return o.model}else if(o.status==0)return o.model}let c=r,p=!1;if(o?(r=o.path,p=o.static):r[0]=="."?r=es.join(es.relative(i[0],e),r):r[0]!="/"?p=!0:r=r.substring(1),p)n[c]={model:await Ot(c),status:-1,static:!0,path:r};else{r=jt(r);let g=i[0]+r;if(a=a??await m.stat(g,"mtimeMs",!0,0),a){let d=rs[r];d&&qr(d.dependencies,l=l??await Wr(d.dependencies,i))?n[c]=d:(l=l??{},n[c]={model:await _e(h.relative(t),r,i,s,l,d&&is(d.dependencies,l)),dependencies:l,path:r})}else{n[c]={model:{},status:0,path:r};let[d,y]=M({type:"warn",errorName:"import-not-exists",text:`Import '${r}' does not exists from <color>'${t}'`});w[d](y)}}let u=n[c];return rs[u.path]=u,u.model}var Y={PageLoadRam:{},PageRam:!0};async function Ua(r,t,e,i,n,s){let o=n[r],a=()=>o.model(s),l;if(o&&(!s.isDebug||o.date==-1&&(l=await m.existsFile(o.path),!l)))return a();let c=r,p=zt.extname(r).substring(1);p||(p=h.pageTypes.page,r+="."+p);let u;if(r[0]=="."?u=zt.join(e,r):u=zt.join(i[0],r),![h.pageTypes.page,h.pageTypes.component].includes(p)){let k=await m.readFile(u);return s.write(k),k}if(l=l??await m.existsFile(u),!l){let[k,x]=M({type:"warn",errorName:"import-not-exists",text:`Import '${c}' does not exists from <color>'${t}'`});return w[k](x),n[c]={model:()=>{},date:-1,path:u},n[c].model}let g=zt.relative(i[0],u),d=i[2]+"/"+g,y=s.isDebug&&(!await m.existsFile(i[1]+"/"+g+".cjs")||await ot(d));if(y&&await De(g,i,p!=h.pageTypes.page),Y.PageLoadRam[d]&&!y)return n[c]={model:Y.PageLoadRam[d][0]},await n[c].model(s);let b=await Gt(d,s.isDebug);return Y.PageRam&&(Y.PageLoadRam[d]||(Y.PageLoadRam[d]=[]),Y.PageLoadRam[d][0]=b),n[c]={model:b},await b(s)}var Ja={};function Ur(r){let t=j("/",r);return S[t[0]][1]+t[1]+".cjs"}async function Gt(r,t){let e=j("/",r),i=S[e[0]],n={};function s(p,u,g,d){return Vt(d,p,u,i,n,g.isDebug)}function o(p,u,g,d,y={}){return Ua(d,p,u,i,n,P(P({},y),g))}function a(p,u,g,d,y,b){if(b.out_run_script.text="",!u){let k=b.Request.body?{}:null;b=R(P({},b),{Request:R(P({},b.Request),{files:{},query:{},body:k}),Post:k,Query:{},Files:{}})}return o(d,y,b,p,g)}let l=zt.join(i[1],e[1]+".cjs"),c={};try{return(await lt(l))(s,o,a,c,dn)}catch(p){let u;return t?(w.error("Error path -> ",Gn(r),"->",p.message),w.error(p.stack),u=v.printError(`Error path: ${r}<br/>Error message: ${p.message}`)):u=v.printError(`Error code: ${p.code}`),g=>{g.Request.error=p,g.out_run_script.text+=u}}}function Le(r,t){let e={};return async function(i,n,s,o,a,l,c,p){let u={text:""};function g(_){let C=_?.toString?.();return C==null||C.startsWith("[object Object]")?JSON.stringify(_,null,2):C}function d(_){u.text=g(_)}function y(_=""){u.text+=g(_)}function b(_=""){_=g(_);for(let C of _)u.text+="&#"+C.charCodeAt(0)+";"}function k(_,...C){for(let I in C)u.text+=_[I],b(C[I]);u.text+=_.at(-1)}let x=!1;i.redirect=(_,C)=>(x=String(_),C!=null&&i.status(C),i),i.reload=()=>{i.redirect(n.url)};function A(_,C=!1){x={file:_,deleteAfter:C}}return await r({sendFile:A,writeSafe:b,write:y,echo:k,setResponse:d,out_run_script:u,run_script_name:t,Response:i,Request:n,Post:s,Query:o,Session:l,Files:c,Cookies:a,isDebug:p,PageVar:e,GlobalVar:Ja,codebase:""}),{out_run_script:u.text,redirectPath:x}}}import Ha from"path";import Va from"http";var Hr={};function za(r,t){let e=Object.keys(Hr);for(let i of e){let n=Hr[i];if(r.startsWith(i)&&n.pathSplit==t)return{staticPath:i,dataInfo:n}}return{}}async function Ga(r){for(;r.length;){let t=Ha.join(S.Static[0],r+".api"),e=async n=>await m.existsFile(t+"."+n)&&n,i=(await Promise.all([e("ts"),e("js")])).filter(n=>n).shift();if(i)return r+".api."+i;r=Yt("/",r)}return r}async function os(r,t,e,i,n){let s=e.split("/").length,{staticPath:o,dataInfo:a}=za(e,s);if(a||(o=await Ga(e),o&&(a={pathSplit:s,depsMap:{}},Hr[o]=a)),a)return await Xa(await Vt("/"+o,"api-call","",S.Static,a.depsMap,i),r,t,e.substring(o.length-6),i,n)}var Qa=["validateURL","validateFunc","func","define",...Va.METHODS];function ns(r,t){let e=0,i="";for(let n in r){let s=n.length;e<s&&t.startsWith(n)&&!Qa.includes(n)&&(e=s,i=n)}return i}async function as(r,t,e,i,n){let s=t,o=!0,a;switch(r){case Number:case parseFloat:case parseInt:s=r(t),o=!isNaN(s);break;case Boolean:s=t!="false",t=t.toLowerCase(),o=t=="true"||t=="false";break;case"any":break;default:if(Array.isArray(r)&&(o=r.includes(t)),typeof r=="function")try{let l=await r(t,e,i);l&&typeof l=="object"?(o=l.valid,s=l.parse??t):o=l}catch(l){a="Error on function validator, field - "+n(l)}r instanceof RegExp&&(o=r.test(t))}return o||(a='Validation error with value "'+t+'"'),[a,s]}async function ss(r,t,e,i,n,s){if(!r.define)return t;let o=r.define.validateFunc;r.define.validateFunc=null,delete r.define.validateFunc;for(let a in r.define){let[l,c]=j("/",t);t=c;let[p,u]=await as(r.define[a],l,i,n,s);if(p)return{error:p};e[a]=u}if(o){let a;try{a=await o(e,i,n)}catch(l){a="Error on function validator"+s(l)}return{error:typeof a=="string"?a:"Error validating URL"}}return t||""}async function Xa(r,t,e,i,n,s){let o=!$("SafeDebug")&&n,a=C=>(n?w.error(C):null)+(o?`, message: ${C.message}`:""),l=t.method,c=r[l]||r.default[l],p=!0;c||(p=!1,c=r.default||r);let u=c,g={},d=await ss(c,i,g,t,e,a);if(d.error)return e.json(d);i=d;let y=ns(c,i);for(let C=0;C<2;C++){for(;y=ns(c,i);){let I=await ss(c,i,g,t,e,a);if(I.error)return e.json(I);i=I,i=mi("/",i.substring(y.length)),c=c[y]}p||(p=!0,c=c[l])}if(c=c?.func&&c||u,!c?.func)return!1;let b=i.split("/"),k=[],x;if(c.validateURL)for(let[C,I]of Object.entries(c.validateURL)){let[St,je]=await as(I,b[C],t,e,a);if(St){x=St;break}k.push(je)}else k.push(...b);if(!x&&c.validateFunc){let C;try{C=await c.validateFunc(b,t,e,k)}catch(I){C="Error on function validator"+a(I)}typeof C=="string"?x=C:C||(x="Error validating URL")}if(x)return e.json({error:x});let A=await s(),B,_;try{B=await c.func(t,e,k,g,b)}catch(C){o?_={error:C.message}:_={error:"500 - Internal Server Error"}}return typeof B=="string"?_={text:B}:_=B||_,A(),_!=null&&e.json(_),!0}var{Export:N}=Jr,F={CacheDays:1,DevMode:!0,ErrorPages:{}};async function Za(r,t){await m.existsFile(Ur(r))&&(N.PageLoadRam[r]=[],N.PageLoadRam[r][0]=await Gt(r,t),N.PageLoadRam[r][1]=Le(N.PageLoadRam[r][0],r))}async function cs(r){for(let t in H.store)Ka(t,h.ReqFileTypesArray)||await Za(t,r)}function us(){for(let r in N.PageLoadRam)N.PageLoadRam[r]=void 0,delete N.PageLoadRam[r]}function Ka(r,...t){r=r.toLowerCase();for(let e of t)for(let i of e)if(r.substring(r.length-i.length-1)=="."+i)return!0;return!1}function Ee(r,t){let e,i;return F.ErrorPages[t]?(e=S.Static,i=F.ErrorPages[t].path,r=F.ErrorPages[t].code??r):(e=S.Logs,i="e"+r),{url:i,arrayType:e,code:r}}async function Ya(r,t,e){if(r.method=="POST"?(!r.body||!Object.keys(r.body).length)&&(r.body=r.fields||{}):r.body=!1,r.closed)return;await new Promise(n=>F.Cookies(r,t,n)),await new Promise(n=>F.CookieEncrypter(r,t,n)),await new Promise(n=>F.SessionStore(r,t,n)),r.signedCookies=r.signedCookies||{},r.files=r.files||{};let i=JSON.parse(JSON.stringify(r.signedCookies));return t.statusCode=201,()=>{t.statusCode===201&&(t.statusCode=e);for(let n in r.signedCookies)(typeof r.signedCookies[n]!="object"&&r.signedCookies[n]!=i[n]||JSON.stringify(r.signedCookies[n])!=JSON.stringify(i[n]))&&t.cookie(n,r.signedCookies[n],F.CookieSettings);for(let n in i)r.signedCookies[n]===void 0&&t.clearCookie(n)}}function tl(r){if(!r.files)return[];let t=[];for(let e in r.files){let i=r.files[e];if(Array.isArray(i))for(let n in i)t.push(i[n].filepath);else t.push(i.filepath)}return t}async function ls(r){for(let t in r)await m.unlinkIfExists(t)}async function el(r,t,e){if(e==200){let i=S.Static[0]+t;if(await Er(r,F.DevMode,t)||await m.existsFile(i))return i}}async function Vr(r,t){let e=[t??await Gt(r,F.DevMode)];return e[1]=Le(e[0],r),N.PageRam&&(N.PageLoadRam[r]=e),e[1]}async function ps(r,t,e){let i=t+"."+h.pageTypes.page,n=r[2]+"/"+i,s=h.fullWebSitePath+n,o;if(F.DevMode&&await m.existsFile(s))!await m.existsFile(r[1]+i+".cjs")||await ot(n)?(await De(t+"."+h.pageTypes.page,r),o=await Vr(n)):N.PageLoadRam[n]?.[1]?o=N.PageLoadRam[n][1]:o=await Vr(n,N.PageLoadRam[n]?.[0]);else if(N.PageLoadRam[n]?.[1])o=N.PageLoadRam[n][1];else if(!N.PageRam&&await m.existsFile(s))o=await Vr(n,N.PageLoadRam[n]?.[0]);else if(r!=S.Logs){let{arrayType:a,code:l,url:c}=Ee(404,"notFound");return ps(a,c,l)}else s=null;return{DynamicFunc:o,code:e,fullPageUrl:s}}async function rl(r,t){if(r.redirectPath?.file)t.sendFile(r.redirectPath.file),await new Promise(e=>t.on("finish",e));else if(r.redirectPath)t.writeHead(302,{Location:r.redirectPath}),t.end();else{let e=r.out_run_script.trim();e?t.send(e):t.end()}r.redirectPath.deleteAfter&&await m.unlinkIfExists(t.redirectPath.file)}async function il(r,t,e,i,n,s){let{DynamicFunc:o,fullPageUrl:a,code:l}=await ps(e,i,n);if(!a||!o&&n==500)return t.sendStatus(l);try{let c=await s(),p=await o(t,r,r.body,r.query,r.cookies,r.session,r.files,F.DevMode);c(),await rl(p,t)}catch(c){w.error(c),r.error=c;let p=Ee(500,"serverError");return Ie(r,t,p.url,p.arrayType,p.code),!1}return!0}async function Ie(r,t,e,i=S.Static,n=200){let s=await el(r,e,n),o=tl(r);if(s){F.CacheDays&&t.setHeader("Cache-Control","max-age="+F.CacheDays*24*60*60),await Hn(e,F.DevMode,r,t),ls(o);return}let a=()=>Ya(r,t,n);!await os(r,t,e,F.DevMode,a)&&!await il(r,t,i,e,n,a)||ls(o)}function ms(r){return r=="/"&&(r="/index"),decodeURIComponent(r)}import{v4 as gs}from"uuid";import{cookieParser as nl}from"@tinyhttp/cookie-parser";import sl from"cookie-encrypter";import ds from"express-session";import ol from"body-parser";import al from"memorystore";var Qr=gs().substring(0,32),hs=gs(),ll=al(ds),Ss=nl(Qr),ys=sl(Qr,{}),zr={httpOnly:!0,signed:!0,maxAge:864e5*30};F.Cookies=Ss;F.CookieEncrypter=ys;F.CookieSettings=zr;var Qt=!0,Re,Gr,xs,bs,E={sessionTotalRamMB:150,sessionTimeMinutes:40,sessionCheckPeriodMinutes:30,fileLimitMB:10,requestLimitMB:4},Xr;function ws(){return Xr}var Ts=[...h.ReqFileTypesArray,...h.pageTypesArray,...h.pageCodeFileArray],ks=[r=>r.split(".").at(-2)!="serv"],T={get settingsPath(){return O+h.WebSiteFolder+"/Settings"},set development(r){Qt!=r&&(Qt=r,r||(Re=ts(T),process.env.NODE_ENV="production"),F.DevMode=r,si(r))},get development(){return Qt},middleware:{get cookies(){return Ss},get cookieEncrypter(){return ys},get session(){return Gr},get formidable(){return xs},get bodyParser(){return bs}},secret:{get cookies(){return Qr},get session(){return hs}},general:{importOnLoad:[],set pageInRam(r){Y.PageRam=r,Xr=async()=>{await(await Re)?.(),r?await cs(T.development):us()}},get pageInRam(){return Y.PageRam}},compile:{set compileSyntax(r){G.AddCompileSyntax=r},get compileSyntax(){return G.AddCompileSyntax},set ignoreError(r){oe.PreventErrors=r},get ignoreError(){return oe.PreventErrors},set plugins(r){G.plugins.length=0,G.plugins.push(...r)},get plugins(){return G.plugins},get define(){return Be.define},set define(r){Be.define=r}},routing:{rules:{},urlStop:[],validPath:ks,ignoreTypes:Ts,ignorePaths:[],sitemap:!0,get errorPages(){return F.ErrorPages},set errorPages(r){F.ErrorPages=r}},serveLimits:{get cacheDays(){return F.CacheDays},set cacheDays(r){F.CacheDays=r},get cookiesExpiresDays(){return zr.maxAge/864e5},set cookiesExpiresDays(r){zr.maxAge=r*864e5},set sessionTotalRamMB(r){E.sessionTotalRamMB!=r&&(E.sessionTotalRamMB=r,Xt())},get sessionTotalRamMB(){return E.sessionTotalRamMB},set sessionTimeMinutes(r){E.sessionTimeMinutes!=r&&(E.sessionTimeMinutes=r,Xt())},get sessionTimeMinutes(){return E.sessionTimeMinutes},set sessionCheckPeriodMinutes(r){E.sessionCheckPeriodMinutes!=r&&(E.sessionCheckPeriodMinutes=r,Xt())},get sessionCheckPeriodMinutes(){return E.sessionCheckPeriodMinutes},set fileLimitMB(r){E.fileLimitMB!=r&&(E.fileLimitMB=r,Oe())},get fileLimitMB(){return E.fileLimitMB},set requestLimitMB(r){E.requestLimitMB!=r&&(E.requestLimitMB=r,Oe(),Zr())},get requestLimitMB(){return E.requestLimitMB}},serve:{port:8080,http2:!1,greenLock:{staging:null,cluster:null,email:null,agent:null,agreeToTerms:!1,sites:[]}}};function Oe(){xs={maxFileSize:T.serveLimits.fileLimitMB*1048576,uploadDir:D+"/UploadFiles/",multiples:!0,maxFieldsSize:T.serveLimits.requestLimitMB*1048576}}function Zr(){bs=ol.json({limit:T.serveLimits.requestLimitMB+"mb"})}function Xt(){if(!T.serveLimits.sessionTimeMinutes||!T.serveLimits.sessionTotalRamMB){Gr=(r,t,e)=>e();return}Gr=ds({cookie:{maxAge:T.serveLimits.sessionTimeMinutes*60*1e3,sameSite:!0},secret:hs,resave:!1,saveUninitialized:!1,store:new ll({checkPeriod:T.serveLimits.sessionCheckPeriodMinutes*60*1e3,max:T.serveLimits.sessionTotalRamMB*1048576})})}function ct(r,t,e=[],i="ignore"){if(!t)return!1;let n=!1;for(let s in t){let o=e.includes(s);(i=="only"&&o||i=="ignore"&&!o)&&(n=!0,r[s]=t[s])}return n}async function Kr(){let r=await zn(T.settingsPath,Qt);if(r==null)return;r.development?Object.assign(r,r.implDev):Object.assign(r,r.implProd),ct(T.compile,r.compile),ct(T.routing,r.routing,["ignoreTypes","validPath"]);let t=(e,i)=>r.routing?.[e]&&(T.routing[e]=r.routing[e].concat(i));t("ignoreTypes",Ts),t("validPath",ks),ct(T.serveLimits,r.serveLimits,["cacheDays","cookiesExpiresDays"],"only"),ct(E,r.serveLimits,["sessionTotalRamMB","sessionTimeMinutes","sessionCheckPeriodMinutes"],"only")&&Xt(),ct(E,r.serveLimits,["fileLimitMB","requestLimitMB"],"only")&&Oe(),ct(E,r.serveLimits,["requestLimitMB"],"only")&&Zr(),ct(T.serve,r.serve),T.development=r.development,r.general?.importOnLoad&&(T.general.importOnLoad=await Vn(r.general.importOnLoad,Qt)),!ct(T.general,r.general,["pageInRam"],"only")&&r.development&&(Xr=await Re),T.development&&T.routing.sitemap&&Qn(T)}async function cl(){await Re}function vs(){Xt(),Oe(),Zr()}import Sl from"formidable";import ul from"http";import pl from"http2";import*as Cs from"selfsigned";import*as Ps from"greenlock-express";async function ml(r,t){let e=O+"/SystemSave/";if(await m.mkdirIfNotExists(e),e+=r,await m.mkdirIfNotExists(e),t){e+="/";let i=e+t.name;await m.existsFile(i)?t.exits&&await m.writeFile(i,await t.exits(await m.readFile(i,"utf8"),i,e)):await m.writeFile(i,t.value)}}async function fl(){let r,t=D+"/Certificate.json";return await m.existsFile(t)?r=m.readJsonFile(t):(r=await new Promise(e=>{Cs.generate(null,{days:36500},(i,n)=>{if(i)throw i;e({key:n.private,cert:n.cert})})}),m.writeJsonFile(t,r)),r}function gl(r){let t=ul.createServer(r.attach);return{server:t,listen(e){return new Promise(i=>{t.listen(e,i)})},close(){t.close()}}}async function As(r){if(!(T.serve.http2||T.serve.greenLock?.agreeToTerms))return await gl(r);if(!T.serve.greenLock.agreeToTerms){let n=pl.createSecureServer(R(P({},await fl()),{allowHTTP1:!0}),r.attach);return{server:n,listen(s){n.listen(s)},stop(){n.close()}}}await ml("greenlock",{name:"config.json",value:JSON.stringify({sites:T.serve.greenLock.sites}),async exits(n,s,o){n=JSON.parse(n);for(let l in n.sites){let c=n.sites[l],p;for(let u of T.serve.greenLock.sites)if(u.subject==c.subject){p=!0,(u.altnames.length!=c.altnames.length||u.altnames.some(g=>c.altnames.includes(g)))&&(c.altnames=u.altnames,delete c.renewAt);break}if(!p){n.sites.splice(l,l);let u=o+"live/"+c.subject;await m.exists(u)&&(await Mt(u),await m.rmdir(u))}}let a=T.serve.greenLock.sites.filter(l=>!n.sites.find(c=>c.subject==l.subject));return n.sites.push(...a),JSON.stringify(n)}});let t=await m.readJsonFile(O+"package.json"),e=await new Promise(n=>Ps.init({packageRoot:O,configDir:"SystemSave/greenlock",packageAgent:T.serve.greenLock.agent||t.name+"/"+t.version,maintainerEmail:T.serve.greenLock.email,cluster:T.serve.greenLock.cluster,staging:T.serve.greenLock.staging}).ready(n));function i(n,s,o){let a=()=>{},l=e[n](o,s);return{server:l,listen:u=>{let g=e.httpServer();return a=()=>g.close(),Promise.all([new Promise(d=>l.listen(443,"0.0.0.0",d)),new Promise(d=>g.listen(u,"0.0.0.0",d))])},close:()=>{l.close(),a()}}}return T.serve.http2?i("http2Server",r.attach,{allowHTTP1:!0}):i("httpsServer",r.attach)}async function Yr(r,t){return T.development&&await Kr(),await yl(r,t)}async function yl(r,t){let e=ms(r.path);for(let n of T.routing.urlStop)if(e.startsWith(n))return n.endsWith("/")&&(n=n.substring(0,n.length-1)),await _s(r,t,n);let i=Object.keys(T.routing.rules).find(n=>e.startsWith(n));i&&(e=await T.routing.rules[i](e,r,t)),await _s(r,t,e)}async function _s(r,t,e){let i=T.routing.ignorePaths.find(n=>e.startsWith(n))||T.routing.ignoreTypes.find(n=>e.endsWith("."+n));if(!i){for(let n of T.routing.validPath)if(!await n(e,r,t)){i=!0;break}}if(i){let n=Ee(404,"notFound");return await Ie(r,t,n.url,n.arrayType,n.code)}await Ie(r,t,e.substring(1))}var Pt;async function xl(r){let t=new dl;T.serve.http2||t.use(hl()),F.SessionStore=async(i,n,s)=>T.middleware.session(i,n,s);let e=await wl(t,r);for(let i of T.general.importOnLoad)await i(t,Pt.server,T);await ws()?.(),t.all("*",bl),await e(T.serve.port),console.log("App listing at port: "+T.serve.port)}async function bl(r,t){r.method=="POST"?r.headers["content-type"]?.startsWith?.("application/json")?T.middleware.bodyParser(r,t,()=>Yr(r,t)):new Sl.IncomingForm(T.middleware.formidable).parse(r,(e,i,n)=>{e&&w.error(e),r.fields=i,r.files=n,Yr(r,t)}):Yr(r,t)}async function wl(r,t){Pt&&Pt.close&&await Pt.close();let{server:e,listen:i,close:n}=await t(r);return Pt={server:e,close:n},i}async function ti({SitePath:r="./",HttpServer:t=As}={}){return h.WebSiteFolder=r,vs(),await Kr(),await xl(t),Pt}var ey=(r,t="async import")=>K([t],r,S.Static,{isDebug:T.development});var ry=ti;export{ey as AsyncImport,vt as SearchRecord,T as Settings,ry as default,cl as waitProductionPromise};
